<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>5&nbsp; Case studies – Model-based geostatistics for global public health using R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./04_geostatistical-prediction.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-0de45b8b5f35a93596f1d788d60c4c11.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-b4a315dc253c0adfed1371f8f6efb9a0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./05_case-studies.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Case studies</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Model-based geostatistics for global public health using R</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./author.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Author</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_handling-spatial-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Handling of spatial data in R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_model-fitting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Model formulation and parameter estimation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_geostatistical-prediction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geostatistical prediction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_case-studies.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Case studies</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Appendix</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li>
<a href="#sec-ghana" id="toc-sec-ghana" class="nav-link active" data-scroll-target="#sec-ghana"><span class="header-section-number">5.1</span> Mapping stunting and underwieght risk in Ghana</a>
  <ul class="collapse">
<li><a href="#exploratory-analysis" id="toc-exploratory-analysis" class="nav-link" data-scroll-target="#exploratory-analysis"><span class="header-section-number">5.1.1</span> Exploratory analysis</a></li>
  <li><a href="#assessing-residual-spatial-correlation-and-model-fitting" id="toc-assessing-residual-spatial-correlation-and-model-fitting" class="nav-link" data-scroll-target="#assessing-residual-spatial-correlation-and-model-fitting"><span class="header-section-number">5.1.2</span> Assessing residual spatial correlation and model fitting</a></li>
  <li><a href="#prediction-and-assessment-of-model-calibration" id="toc-prediction-and-assessment-of-model-calibration" class="nav-link" data-scroll-target="#prediction-and-assessment-of-model-calibration"><span class="header-section-number">5.1.3</span> Prediction and assessment of model calibration</a></li>
  <li><a href="#summary-and-conclusions" id="toc-summary-and-conclusions" class="nav-link" data-scroll-target="#summary-and-conclusions"><span class="header-section-number">5.1.4</span> Summary and conclusions</a></li>
  </ul>
</li>
  <li>
<a href="#mapping-malaria-in-malawi" id="toc-mapping-malaria-in-malawi" class="nav-link" data-scroll-target="#mapping-malaria-in-malawi"><span class="header-section-number">5.2</span> Mapping malaria in Malawi</a>
  <ul class="collapse">
<li><a href="#downloading-prevalence-and-raster-data" id="toc-downloading-prevalence-and-raster-data" class="nav-link" data-scroll-target="#downloading-prevalence-and-raster-data"><span class="header-section-number">5.2.1</span> Downloading prevalence and raster data</a></li>
  <li><a href="#exploratory-analysis-1" id="toc-exploratory-analysis-1" class="nav-link" data-scroll-target="#exploratory-analysis-1"><span class="header-section-number">5.2.2</span> Exploratory analysis</a></li>
  <li><a href="#model-fitting-and-spatial-prediction" id="toc-model-fitting-and-spatial-prediction" class="nav-link" data-scroll-target="#model-fitting-and-spatial-prediction"><span class="header-section-number">5.2.3</span> Model fitting and spatial prediction</a></li>
  <li><a href="#comparison-of-the-predictive-performance-between-models" id="toc-comparison-of-the-predictive-performance-between-models" class="nav-link" data-scroll-target="#comparison-of-the-predictive-performance-between-models"><span class="header-section-number">5.2.4</span> Comparison of the predictive performance between models</a></li>
  <li><a href="#summary-and-conclusions-1" id="toc-summary-and-conclusions-1" class="nav-link" data-scroll-target="#summary-and-conclusions-1"><span class="header-section-number">5.2.5</span> Summary and conclusions</a></li>
  </ul>
</li>
  <li>
<a href="#sec-wnv" id="toc-sec-wnv" class="nav-link" data-scroll-target="#sec-wnv"><span class="header-section-number">5.3</span> Mapping the vector index for West Nile Virus in the Sacramento Metropolitan Area, United States</a>
  <ul class="collapse">
<li><a href="#sec-abund-model" id="toc-sec-abund-model" class="nav-link" data-scroll-target="#sec-abund-model"><span class="header-section-number">5.3.1</span> Modelling the abundance of <em>Culex pipiens</em></a></li>
  <li><a href="#sec-wnv-model" id="toc-sec-wnv-model" class="nav-link" data-scroll-target="#sec-wnv-model"><span class="header-section-number">5.3.2</span> Modelling West Nile virus infection with pooled mosquito testing</a></li>
  <li><a href="#sec-summary-wnv" id="toc-sec-summary-wnv" class="nav-link" data-scroll-target="#sec-summary-wnv"><span class="header-section-number">5.3.3</span> Summary and conclusions</a></li>
  </ul>
</li>
  <li>
<a href="#theory" id="toc-theory" class="nav-link" data-scroll-target="#theory"><span class="header-section-number">5.4</span> Theory</a>
  <ul class="collapse">
<li><a href="#sec-sim-re" id="toc-sec-sim-re" class="nav-link" data-scroll-target="#sec-sim-re"><span class="header-section-number">5.4.1</span> Simulating from the predictive of non-spatial mixed models</a></li>
  <li><a href="#sec-nonspat-anpit" id="toc-sec-nonspat-anpit" class="nav-link" data-scroll-target="#sec-nonspat-anpit"><span class="header-section-number">5.4.2</span> The non-randomized probability integral transform for non-spatial models</a></li>
  </ul>
</li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">5.5</span> Exercises</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-case-studies" class="quarto-section-identifier"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Case studies</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="sec-ghana" class="level2" data-number="5.1"><h2 data-number="5.1" class="anchored" data-anchor-id="sec-ghana">
<span class="header-section-number">5.1</span> Mapping stunting and underwieght risk in Ghana</h2>
<p>Malnutrition remains a critical public health issue in many low- and middle-income countries, particularly affecting children under five years of age. It can have long-term consequences on physical growth, cognitive development, and susceptibility to disease. Monitoring childhood nutritional status is essential for evaluating the effectiveness of health interventions and informing policy decisions.</p>
<p>Two widely used anthropometric indicators derived from child growth measurements are:</p>
<ul>
<li><p>Height-for-Age Z-score (HAZ): A measure of stunting, which reflects chronic malnutrition. Children with a HAZ below -2 standard deviations from the WHO growth reference median are considered stunted, indicating long-term nutritional deprivation or repeated infections.</p></li>
<li><p>Weight-for-Age Z-score (WAZ): A composite indicator of underweight, capturing both acute and chronic malnutrition. Children with WAZ below -2 are considered underweight. This measure is commonly used in population-based surveys because it is relatively easy to collect and interpret.</p></li>
</ul>
<p>These Z-scores are calculated by comparing individual anthropometric measurements to the WHO Child Growth Standards, which were developed based on data from healthy children under optimal environmental and nutritional conditions <span class="citation" data-cites="who2006">(<a href="references.html#ref-who2006" role="doc-biblioref">WHO 2006</a>)</span>.</p>
<p>Geostatistical models applied to HAZ and WAZ, or to the prevalence of stunting and underweight derived from these scores, can help answer critical questions such as: <em>Where is the burden of malnutrition highest? How does it relate to socioeconomic or environmental factors? And which areas should be prioritized for targeted nutritional interventions?</em></p>
<p>In this case study, we analyse HAZ and WAZ as continuous outcomes to assess the spatial variation in child malnutrition across Ghana and its association with socioeconomic and demographic covariates.</p>
<section id="exploratory-analysis" class="level3" data-number="5.1.1"><h3 data-number="5.1.1" class="anchored" data-anchor-id="exploratory-analysis">
<span class="header-section-number">5.1.1</span> Exploratory analysis</h3>
<p>We begin by loading the necessary R packages and the <code>malnutrition</code> dataset. This geostatistical dataset is derived from the 2014 Ghana Demographic and Health Survey (DHS) <span class="citation" data-cites="ghanaDHS2014">(<a href="references.html#ref-ghanaDHS2014" role="doc-biblioref">Ghana Statistical Service, Ghana Health Service, and ICF International 2015</a>)</span>, which provides nationally representative data on child health and nutrition. The dataset includes anthropometric measurements, household characteristics, and georeferenced sampling cluster coordinates, making it suitable for spatial analysis of child malnutrition.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://claudiofronterre.github.io/RiskMap/">RiskMap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load the data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">malnutrition</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The explanatory variables considered in this analysis are <code>age</code> and <code>wealth</code>. Figure <a href="#fig-maln-expl" class="quarto-xref">Figure&nbsp;<span>5.1</span></a> displays scatterplots of the two nutritional outcomes (<code>HAZ</code> and <code>WAZ</code>) against age, alongside boxplots stratified by the three levels of the <code>wealth</code> variable.</p>
<p>To explore the relationship between age and nutritional status, the code below applies locally estimated scatterplot smoothing (LOESS) to highlight potential non-linear trends. In addition, we fit linear splines using the function <code><a href="https://rdrr.io/r/base/Extremes.html">pmax()</a></code> to model a change in slope at specified knots—2 months for HAZ and 1 month for WAZ. These change points were selected heuristically based on visual inspection of the LOESS curves.</p>
<p>As shown in Figure <a href="#fig-maln-expl" class="quarto-xref">Figure&nbsp;<span>5.1</span></a>, the linear splines (green dashed lines) closely follow the LOESS fits (solid red lines), indicating that the piecewise linear models provide an adequate approximation of the age-nutrition relationship.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Filter complete cases for relevant variables</span></span>
<span><span class="va">mal</span> <span class="op">&lt;-</span> <span class="va">malnutrition</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">HAZ</span><span class="op">)</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">WAZ</span><span class="op">)</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">wealth</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit spline model for HAZ with knot at 2 months</span></span>
<span><span class="va">mod_haz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">HAZ</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">age</span> <span class="op">-</span> <span class="fl">2</span>, <span class="fl">0</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">mal</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit spline model for WAZ with knot at 1 month</span></span>
<span><span class="va">mod_waz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">WAZ</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">age</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">mal</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prediction grid for HAZ</span></span>
<span><span class="va">newdat_haz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">mal</span><span class="op">$</span><span class="va">age</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">mal</span><span class="op">$</span><span class="va">age</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fl">200</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">newdat_haz</span><span class="op">$</span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">mod_haz</span>, newdata <span class="op">=</span> <span class="va">newdat_haz</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prediction grid for WAZ</span></span>
<span><span class="va">newdat_waz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">mal</span><span class="op">$</span><span class="va">age</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">mal</span><span class="op">$</span><span class="va">age</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fl">200</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">newdat_waz</span><span class="op">$</span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">mod_waz</span>, newdata <span class="op">=</span> <span class="va">newdat_waz</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot HAZ vs Age</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">mal</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">HAZ</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>, colour <span class="op">=</span> <span class="st">"red"</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">newdat_haz</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">fit</span><span class="op">)</span>, </span>
<span>            colour <span class="op">=</span> <span class="st">"green"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, linewidth <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"HAZ vs Age"</span>, x <span class="op">=</span> <span class="st">"Age (months)"</span>, y <span class="op">=</span> <span class="st">"HAZ"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot WAZ vs Age</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">mal</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">WAZ</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>, colour <span class="op">=</span> <span class="st">"red"</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">newdat_waz</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">fit</span><span class="op">)</span>, </span>
<span>            colour <span class="op">=</span> <span class="st">"green"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, linewidth <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"WAZ vs Age"</span>, x <span class="op">=</span> <span class="st">"Age (months)"</span>, y <span class="op">=</span> <span class="st">"WAZ"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Boxplots for HAZ and WAZ by wealth</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">mal</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">wealth</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">HAZ</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"HAZ by Wealth Group"</span>, x <span class="op">=</span> <span class="st">"Wealth (1 = Poor, 3 = Rich)"</span>, y <span class="op">=</span> <span class="st">"HAZ"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">mal</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">wealth</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">WAZ</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"lightgreen"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"WAZ by Wealth Group"</span>, x <span class="op">=</span> <span class="st">"Wealth (1 = Poor, 3 = Rich)"</span>, y <span class="op">=</span> <span class="st">"WAZ"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine plots</span></span>
<span><span class="op">(</span><span class="va">p1</span> <span class="op">|</span> <span class="va">p2</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">p3</span> <span class="op">|</span> <span class="va">p4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-maln-expl" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-maln-expl-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05_case-studies_files/figure-html/fig-maln-expl-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-maln-expl-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.1: Exploratory analysis of HAZ and WAZ by age and wealth. The red lines correspond to LOESS smoothed curves and the green lines to linear splines with change points at 2 months (HAZ) and 1 month (WAZ) of age. Boxplots show variation by household wealth group.
</figcaption></figure>
</div>
</div>
</div>
<p>We begin by fitting a non-spatial model to assess whether there is residual spatial correlation that remains after accounting for the effects of age and wealth. Let <span class="math inline">\(Y_{ij}\)</span> represent either the HAZ or WAZ score for the <span class="math inline">\(j\)</span>-th child in the <span class="math inline">\(i\)</span>-th cluster. The model takes the following form:</p>
<p><span id="eq-model-haz-waz"><span class="math display">\[
Y_{ij} = \beta_0 + \beta_1 a_{ij} + \beta_2 \max\{a_{ij} - c, 0\} + \beta_3 w_i + Z_i + U_{ij},
\tag{5.1}\]</span></span></p>
<p>where <span class="math inline">\(a_{ij}\)</span> denotes the age in months of child <span class="math inline">\(j\)</span> in cluster <span class="math inline">\(i\)</span>, and <span class="math inline">\(w_i\)</span> is the wealth score associated with cluster <span class="math inline">\(i\)</span>; as previously stated, the change point <span class="math inline">\(c\)</span> of the linear spline is set to 2 months for HAZ and 1 month for WAZ. The term <span class="math inline">\(Z_i\)</span> is a Gaussian random effect with mean zero and variance <span class="math inline">\(\tau^2\)</span>, capturing between-cluster variation not explained by the covariates. The error term <span class="math inline">\(U_{ij}\)</span> represents child-specific residual variation and is assumed to be Gaussian with mean zero and variance <span class="math inline">\(\omega^2\)</span>.</p>
<p>To fit this model, we create a cluster ID variable based on the sampling coordinates and include it as a random intercept in the <code>lmer</code> function to incorporate the term <span class="math inline">\(Z_i\)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create ID for the location</span></span>
<span><span class="va">malnutrition</span> <span class="op">&lt;-</span> <span class="va">malnutrition</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">lng</span>, <span class="va">lat</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>loc_id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">cur_group_id</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then fit the models using the <code>lmer</code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/">lme4</a></span><span class="op">)</span></span>
<span><span class="va">haz_lmer</span> <span class="op">&lt;-</span> </span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">HAZ</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">age</span> <span class="op">-</span> <span class="fl">2</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> <span class="va">wealth</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">loc_id</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">malnutrition</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">haz_lmer</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: HAZ ~ age + pmax(age - 2, 0) + wealth + (1 | loc_id)
   Data: malnutrition

REML criterion at convergence: 8593.6

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.6407 -0.5992  0.0154  0.6098  5.6443 

Random effects:
 Groups   Name        Variance Std.Dev.
 loc_id   (Intercept) 0.06939  0.2634  
 Residual             1.39362  1.1805  
Number of obs: 2671, groups:  loc_id, 410

Fixed effects:
                 Estimate Std. Error t value
(Intercept)      -0.39571    0.08170  -4.844
age              -0.77185    0.04471 -17.265
pmax(age - 2, 0)  0.88486    0.06698  13.211
wealth            0.38630    0.03611  10.699

Correlation of Fixed Effects:
            (Intr) age    p(-2,0
age         -0.654              
pmax(g-2,0)  0.521 -0.932       
wealth      -0.616 -0.034  0.038</code></pre>
</div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">waz_lmer</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span><span class="op">(</span><span class="va">WAZ</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">age</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> <span class="va">wealth</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">loc_id</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">malnutrition</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">waz_lmer</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: WAZ ~ age + pmax(age - 1, 0) + wealth + (1 | loc_id)
   Data: malnutrition

REML criterion at convergence: 7997.3

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-6.5967 -0.5816  0.0098  0.6312  5.7860 

Random effects:
 Groups   Name        Variance Std.Dev.
 loc_id   (Intercept) 0.05625  0.2372  
 Residual             1.11823  1.0575  
Number of obs: 2668, groups:  loc_id, 410

Fixed effects:
                 Estimate Std. Error t value
(Intercept)      -0.50444    0.08951  -5.636
age              -0.72230    0.09615  -7.512
pmax(age - 1, 0)  0.73510    0.10754   6.835
wealth            0.27359    0.03238   8.450

Correlation of Fixed Effects:
            (Intr) age    p(-1,0
age         -0.765              
pmax(g-1,0)  0.716 -0.989       
wealth      -0.494 -0.036  0.037</code></pre>
</div>
</div>
<p>Of particular interest in the summary of the fitted models above are the estimates of the variances associated with the random effects: <span class="math inline">\(\tau^2\)</span> for the cluster-level terms <span class="math inline">\(Z_i\)</span>, and <span class="math inline">\(\omega^2\)</span> for the child-specific residuals <span class="math inline">\(U_{ij}\)</span>. The estimates suggest that <span class="math inline">\(\omega^2\)</span> is more than twenty times larger than <span class="math inline">\(\tau^2\)</span>, indicating that the majority of the unexplained variation occurs at the individual child level rather than between clusters. This has important implications for interpretation: any subsequent mapping of the prevalence of stunting or underweight should acknowledge the high degree of within-cluster variability as a limitation. In particular, predictions at unsampled locations may be subject to substantial uncertainty driven by this fine-scale heterogeneity.</p>
</section><section id="assessing-residual-spatial-correlation-and-model-fitting" class="level3" data-number="5.1.2"><h3 data-number="5.1.2" class="anchored" data-anchor-id="assessing-residual-spatial-correlation-and-model-fitting">
<span class="header-section-number">5.1.2</span> Assessing residual spatial correlation and model fitting</h3>
<p>We next explore the residual spatial correlation through the empirical variogram. Hence, we extract the estimate of the random effects from <a href="#eq-model-haz-waz" class="quarto-xref">Equation&nbsp;<span>5.1</span></a> and input these into the <code>s_variogram</code> function that generates the empirical variogram.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extract random effects for HAZ and WAZ and combine them</span></span>
<span><span class="va">re</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  loc_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/random.effects.html">ranef</a></span><span class="op">(</span><span class="va">haz_lmer</span><span class="op">)</span><span class="op">$</span><span class="va">loc_id</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  Z_hat_haz <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/random.effects.html">ranef</a></span><span class="op">(</span><span class="va">haz_lmer</span><span class="op">)</span><span class="op">$</span><span class="va">loc_id</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>  Z_hat_waz <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/random.effects.html">ranef</a></span><span class="op">(</span><span class="va">waz_lmer</span><span class="op">)</span><span class="op">$</span><span class="va">loc_id</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract one row per location with coordinates</span></span>
<span><span class="va">loc_coords</span> <span class="op">&lt;-</span> <span class="va">malnutrition</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">loc_id</span>, <span class="va">lng</span>, <span class="va">lat</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Merge coordinates into random effects</span></span>
<span><span class="va">re</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">re</span>, <span class="va">loc_coords</span>, by <span class="op">=</span> <span class="st">"loc_id"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert to sf and transform into UTM</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="va">re</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">re</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lng"</span>,<span class="st">"lat"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span>
<span><span class="va">re</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">re</span>, crs <span class="op">=</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/propose_utm.html">propose_utm</a></span><span class="op">(</span><span class="va">re</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Variogram for HAZ</span></span>
<span><span class="va">var_haz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/s_variogram.html">s_variogram</a></span><span class="op">(</span><span class="va">re</span>, <span class="st">"Z_hat_haz"</span>, scale_to_km <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                       n_permutation <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">var_waz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/s_variogram.html">s_variogram</a></span><span class="op">(</span><span class="va">re</span>, <span class="st">"Z_hat_waz"</span>, scale_to_km <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                       n_permutation <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create ggplot objects</span></span>
<span><span class="va">p_haz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/plot_s_variogram.html">plot_s_variogram</a></span><span class="op">(</span><span class="va">var_haz</span>, plot_envelope <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"HAZ"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_waz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/plot_s_variogram.html">plot_s_variogram</a></span><span class="op">(</span><span class="va">var_waz</span>, plot_envelope <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"WAZ"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_haz</span> <span class="op">+</span> <span class="va">p_waz</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-maln-vari" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-maln-vari-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05_case-studies_files/figure-html/fig-maln-vari-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-maln-vari-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.2: Empirical variograms for HAZ and WAZ based on the estimated random effects from <a href="#eq-model-haz-waz" class="quarto-xref">Equation&nbsp;<span>5.1</span></a>.
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-maln-vari" class="quarto-xref">Figure&nbsp;<span>5.2</span></a> shows the variogram for both HAZ and WAZ. In both cases, we observe that is residual spatial correlation in the data that is not explained by either age or the wealth index. We next extend the model in <a href="#eq-model-haz-waz" class="quarto-xref">Equation&nbsp;<span>5.1</span></a> to address this issue.</p>
<p>For our geostatistical analysis of HAZ and WAZ, we consider the following model:</p>
<p><span class="math display">\[
Y_{ij} = \beta_0 + \beta_1 a_{ij} + \beta_2 \max\{a_{ij} - c, 0\} + \beta_3 w_i + S(x_i) + U_{ij},
\]</span></p>
<p>where <span class="math inline">\(S(x)\)</span> is a zero-mean, stationary, and isotropic Gaussian process with variance <span class="math inline">\(\sigma^2\)</span> and an exponential correlation function with scale parameter <span class="math inline">\(\phi\)</span>. In this geostatistical extension, we replace the cluster-level random effect <span class="math inline">\(Z_i\)</span> from <a href="#eq-model-haz-waz" class="quarto-xref">Equation&nbsp;<span>5.1</span></a> with the spatial process <span class="math inline">\(S(x_i)\)</span>. The random effect <span class="math inline">\(Z_i\)</span> was previously used in the Binomial mixed model to account for unexplained variation between clusters. It is also possible to include both <span class="math inline">\(S(x_i)\)</span> and <span class="math inline">\(Z_i\)</span> in the model, so that the total unexplained variation between clusters is decomposed into a spatially structured component, <span class="math inline">\(S(x_i)\)</span>, and an unstructured component, <span class="math inline">\(Z_i\)</span>. However, this approach is not recommended in the initial model specification, as it may lead to identifiability issues. It can be considered later in the analysis if justified by model diagnostics.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Remove missing data from the WAZ outcome</span></span>
<span><span class="va">malnutrition</span> <span class="op">&lt;-</span> <span class="va">malnutrition</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">malnutrition</span><span class="op">[</span>,<span class="st">"WAZ"</span><span class="op">]</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span><span class="co"># Converting the data-frame into an sf object</span></span>
<span><span class="va">malnutrition_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">malnutrition</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lng"</span>, <span class="st">"lat"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span>
<span><span class="va">malnutrition_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">malnutrition_sf</span>, crs <span class="op">=</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/propose_utm.html">propose_utm</a></span><span class="op">(</span><span class="va">malnutrition_sf</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Maximum likelihood estimation for the HAZ and WAZ outcomes</span></span>
<span><span class="va">haz_fit</span> <span class="op">&lt;-</span> </span>
<span><span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/glgpm.html">glgpm</a></span><span class="op">(</span><span class="va">HAZ</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">age</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> <span class="va">wealth</span> <span class="op">+</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/gp.html">gp</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      data<span class="op">=</span><span class="va">malnutrition_sf</span>, family <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">waz_fit</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/glgpm.html">glgpm</a></span><span class="op">(</span><span class="va">HAZ</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">age</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> <span class="va">wealth</span> <span class="op">+</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/gp.html">gp</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        data<span class="op">=</span><span class="va">malnutrition_sf</span>, family <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then summarize the fit of models.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">haz_fit</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
glgpm(formula = HAZ ~ age + pmax(age - 1, 0) + wealth + gp(), 
    data = malnutrition_sf, family = "gaussian")

Linear geostatistical model
Link: identity 
Inverse link function = x 
 
'Lower limit' and 'Upper limit' are the limits of the 95% confidence level intervals

Regression coefficients
                   Estimate Lower limit Upper limit     StdErr  z.value p.value
(Intercept)      -0.2158950  -0.4338747   0.0020848  0.1112162  -1.9412 0.05223
age              -1.3073560  -1.4135715  -1.2011404  0.0541926 -24.1243 &lt; 2e-16
pmax(age - 1, 0)  1.2288215   1.1496224   1.3080207  0.0404085  30.4100 &lt; 2e-16
wealth            0.3520544   0.3319696   0.3721393  0.0102476  34.3550 &lt; 2e-16
                    
(Intercept)      .  
age              ***
pmax(age - 1, 0) ***
wealth           ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

                        Estimate Lower limit Upper limit
Measuremment error var.   1.4371      1.4254      1.4489

Spatial Gaussian process
Matern covariance parameters (kappa=0.5)
                      Estimate Lower limit Upper limit
Spatial process var.  0.069453    0.061423      0.0785
Spatial corr. scale  36.529380   30.187727     44.2032
Variance of the nugget effect fixed at 0

Log-likelihood: -1859.246
AIC: 3732.491</code></pre>
</div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">waz_fit</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
glgpm(formula = WAZ ~ age + pmax(age - 1, 0) + wealth + gp(), 
    data = malnutrition_sf, family = "gaussian")

Linear geostatistical model
Link: identity 
Inverse link function = x 
 
'Lower limit' and 'Upper limit' are the limits of the 95% confidence level intervals

Regression coefficients
                   Estimate Lower limit Upper limit     StdErr  z.value
(Intercept)      -0.4580088  -0.6499668  -0.2660509  0.0979395  -4.6764
age              -0.7295504  -0.8235412  -0.6355596  0.0479554 -15.2131
pmax(age - 1, 0)  0.7421647   0.6720850   0.8122443  0.0357556  20.7566
wealth            0.2254477   0.2076797   0.2432157  0.0090655  24.8689
                   p.value    
(Intercept)      2.919e-06 ***
age              &lt; 2.2e-16 ***
pmax(age - 1, 0) &lt; 2.2e-16 ***
wealth           &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

                        Estimate Lower limit Upper limit
Measuremment error var.   1.1253      1.1161      1.1346

Spatial Gaussian process
Matern covariance parameters (kappa=0.5)
                      Estimate Lower limit Upper limit
Spatial process var.  0.049912    0.043750      0.0569
Spatial corr. scale  35.836303   28.815346     44.5679
Variance of the nugget effect fixed at 0

Log-likelihood: -1530.593
AIC: 3075.187</code></pre>
</div>
</div>
<p>The spatial component of the models reveals a moderate degree of spatial structure in the HAZ and WAZ outcomes. For HAZ, the estimated spatial variance is approximately 0.069, while the individual-level radom effect’s variance is substantially larger at around 1.437. For WAZ, the spatial variance is estimated at 0.050, compared to the variance of the individual-level radom effect’s variance of 1.125. In both models, as already observed when fitting Binomial mixed models, this indicates that the majority of the residual variation is due to individual-level noise or unstructured heterogeneity rather than spatially structured effects. The relative contribution of the spatial process to the total unexplained variation is therefore relatively small. Nevertheless, geostatistical analysis remains valuable also in this context. Even when spatial effects explain only a modest proportion of the variation, the model still enables spatial prediction of the average spatial pattern for the outcome of interest across the study area. This is useful for identifying areas where child malnutrition is systematically higher or lower, guiding targeted interventions and informing resource allocation. We explore these implications further in the next section on geostatistical prediction for HAZ and WAZ.</p>
</section><section id="prediction-and-assessment-of-model-calibration" class="level3" data-number="5.1.3"><h3 data-number="5.1.3" class="anchored" data-anchor-id="prediction-and-assessment-of-model-calibration">
<span class="header-section-number">5.1.3</span> Prediction and assessment of model calibration</h3>
<p>Stunting and underweight are standard indicators used to assess child malnutrition. A child is defined as if their height-for-age <span class="math inline">\(z\)</span>-score (HAZ) is below <span class="math inline">\(-2\)</span> standard deviations from the median of the WHO Child Growth Standards, i.e., HAZ &lt; -2. Similarly, a child is considered if their weight-for-age <span class="math inline">\(z\)</span>-score (WAZ) falls below <span class="math inline">\(-2\)</span>, i.e., WAZ &lt; -2 <span class="citation" data-cites="sdg2201meta2025">(<a href="references.html#ref-sdg2201meta2025" role="doc-biblioref">United Nations Statistics Division, World Health Organization, and UNICEF 2025</a>)</span>. These thresholds are based on the World Health Organization (WHO) growth reference standards, which provide a normative basis for assessing nutritional status in children under five years of age <span class="citation" data-cites="who_underweight2024">(<a href="references.html#ref-who_underweight2024" role="doc-biblioref">Organization 2024</a>)</span>.</p>
<p>We now define the predictive targets for stunting and underweight prevalence in terms of the adopted geostatistical model. Both indicators correspond to the probability that a child’s z-score falls below <span class="math inline">\(-2\)</span>, that is, <span class="math inline">\(Y(x) &lt; -2\)</span>, where <span class="math inline">\(Y(x)\)</span> denotes either the HAZ or WAZ score at location <span class="math inline">\(x\)</span>. Under the model specification, the prevalence is therefore defined as</p>
<p><span id="eq-prev-maln"><span class="math display">\[
T(x) = P\left\{ Y(x) &lt; -2 \,\middle|\, S(x) \right\} = \Phi\left( -\frac{\mu + S(x) + 2}{\omega} \right),
\tag{5.2}\]</span></span></p>
<p>where <span class="math inline">\(\Phi(\cdot)\)</span> is the cumulative distribution function of the standard normal distribution, <span class="math inline">\(\mu\)</span> is the linear predictor including the effects of covariates at individual- and cluster-level (as defined by the coefficients <span class="math inline">\(\beta_1\)</span> to <span class="math inline">\(\beta_3\)</span> of <a href="#eq-model-haz-waz" class="quarto-xref">Equation&nbsp;<span>5.1</span></a>) as well as the intercept, and <span class="math inline">\(\omega^2\)</span> is the variance of the individual-level residual term. In <a href="#eq-prev-maln" class="quarto-xref">Equation&nbsp;<span>5.2</span></a>, we condition on <span class="math inline">\(S(x)\)</span> because this allows us to define both stunting an underweight prevalence as a spatially varying predictive target.</p>
<p>To implement this in <code>RiskMap</code>, we begin by generating a predictive grid over the study region. In this case, we use a regular grid with 10 km by 10 km resolution. We then draw predictive samples of the spatial effect <span class="math inline">\(S(x)\)</span> at each grid location, conditional on the observed data. For the <code>age</code> variable, we fix it at 2 months for HAZ and 1 month for WAZ, respectively. The <code>wealth</code> variable is set to its lowest value of 1. These choices are made to visualize the predictive target for the subgroup of children most at risk of stunting and underweight, as identified through exploratory analysis and the estimated regression coefficients. The code below illustrates this procedure.</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Boundaries of Ghana</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/wmgeolab/rgeoboundaries">rgeoboundaries</a></span><span class="op">)</span></span>
<span><span class="va">ghana</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rgeoboundaries/man/geoboundaries.html">geoboundaries</a></span><span class="op">(</span>country <span class="op">=</span> <span class="st">"Ghana"</span>, adm_lvl <span class="op">=</span> <span class="st">"adm0"</span><span class="op">)</span></span>
<span><span class="va">ghana</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">ghana</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">malnutrition_sf</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ghana_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/create_grid.html">create_grid</a></span><span class="op">(</span><span class="va">ghana</span>, spat_res <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">ghana_grid</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prediction of S(x) and covariates effects over the grid for</span></span>
<span></span>
<span><span class="co"># HAZ</span></span>
<span><span class="va">haz_pred_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/pred_over_grid.html">pred_over_grid</a></span><span class="op">(</span><span class="va">haz_fit</span>,</span>
<span>                                grid_pred <span class="op">=</span> <span class="va">ghana_grid</span>,</span>
<span>                                predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>                                  <span class="co"># Setting age to 2 months</span></span>
<span>                                  age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">n_pred</span><span class="op">)</span>,</span>
<span>                                  <span class="co"># Setting wealth to 1 (least wealthy)</span></span>
<span>                                  wealth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n_pred</span><span class="op">)</span></span>
<span>                                <span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># WAZ</span></span>
<span><span class="va">waz_pred_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/pred_over_grid.html">pred_over_grid</a></span><span class="op">(</span><span class="va">waz_fit</span>,</span>
<span>                                grid_pred <span class="op">=</span> <span class="va">ghana_grid</span>,</span>
<span>                                predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>                                  <span class="co"># Setting age to 1 month</span></span>
<span>                                  age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n_pred</span><span class="op">)</span>,</span>
<span>                                  <span class="co"># Setting wealth to 1 (least wealthy)</span></span>
<span>                                  wealth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n_pred</span><span class="op">)</span></span>
<span>                                <span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then use the <code>pred_target_grid</code> function to generate predictive summaries of stunting and underweight prevalence, as defined in <a href="#eq-prev-maln" class="quarto-xref">Equation&nbsp;<span>5.2</span></a>. To quantify uncertainty in the predictions, we report the coefficient of variation, which provides a standardized measure of relative uncertainty across the prediction grid.</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Prediction of stunting prevalence</span></span>
<span><span class="va">sd_ind_haz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">haz_fit</span><span class="op">)</span><span class="op">$</span><span class="va">sigma2_me</span><span class="op">)</span></span>
<span><span class="va">stunting_prev</span> <span class="op">&lt;-</span></span>
<span><span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/pred_target_grid.html">pred_target_grid</a></span><span class="op">(</span><span class="va">haz_pred_grid</span>,</span>
<span>                 f_target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>prev <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="op">(</span><span class="op">-</span><span class="fl">2</span><span class="op">-</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="va">sd_ind_haz</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 pd_summary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="va">mean</span>,</span>
<span>                                       cv <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prediction of underweight prevalence</span></span>
<span><span class="va">sd_ind_waz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">waz_fit</span><span class="op">)</span><span class="op">$</span><span class="va">sigma2_me</span><span class="op">)</span></span>
<span><span class="va">underw_prev</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/pred_target_grid.html">pred_target_grid</a></span><span class="op">(</span><span class="va">waz_pred_grid</span>,</span>
<span>                   f_target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>prev <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="op">(</span><span class="op">-</span><span class="fl">2</span><span class="op">-</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="va">sd_ind_waz</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                   pd_summary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="va">mean</span>,</span>
<span>                                     cv <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we visualize the results in the map shown in <a href="#fig-maln-pred" class="quarto-xref">Figure&nbsp;<span>5.3</span></a>. The maps reveal a clear hotspot for both stunting and underweight, with predicted prevalence values reaching approximately <span class="math inline">\(45\%\)</span> and <span class="math inline">\(24\%\)</span>, respectively. Notably, this same region also exhibits lower predictive uncertaint, measured by the coefficient of variation, compared to other areas in Ghana.</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Set up a 2x2 layout</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/layout.html">layout</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, nrow <span class="op">=</span> <span class="fl">2</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Adjust margins</span></span>
<span></span>
<span><span class="co"># Top row: stunting</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">stunting_prev</span>, which_target <span class="op">=</span> <span class="st">"prev"</span>, which_summary <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Stunting: Predictive Mean"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">stunting_prev</span>, which_target <span class="op">=</span> <span class="st">"prev"</span>, which_summary <span class="op">=</span> <span class="st">"cv"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Stunting: Coefficient of Variation"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bottom row: underweight</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">underw_prev</span>, which_target <span class="op">=</span> <span class="st">"prev"</span>, which_summary <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Underweight: Predictive Mean"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">underw_prev</span>, which_target <span class="op">=</span> <span class="st">"prev"</span>, which_summary <span class="op">=</span> <span class="st">"cv"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Underweight: Coefficient of Variation"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-maln-pred" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-maln-pred-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05_case-studies_files/figure-html/fig-maln-pred-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-maln-pred-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.3: Predictive mean and coefficient of variation for stunting and underweight prevalence estimates. The top row shows predictions for stunting, while the bottom row corresponds to underweight. For each indicator, the left panel shows the predictive mean and the right panel the coefficient of variation.
</figcaption></figure>
</div>
</div>
</div>
<p>To assess the predictive performance and calibration of our geostatistical models for HAZ and WAZ, we perform a cross-validation exercise using the <code>assess_pp</code> function. Cross-validation is conducted by repeatedly splitting the data into training and testing sets, ensuring that prediction locations are at least 5 km away from the nearest training point. Specifically, we set <code>n_size = 100</code> prediction locations for the test set, impose a minimum distance constraint of 5 km (<code>min_dist = 5</code>), and repeat the process over 10 test sets randomly drawn under those conditions (<code>iter = 10</code>) using <code>method="regularized"</code> as the sampling method.</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># HAZ</span></span>
<span><span class="va">assess_haz</span> <span class="op">&lt;-</span></span>
<span><span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/assess_pp.html">assess_pp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>HAZ <span class="op">=</span> <span class="va">haz_fit</span><span class="op">)</span>,</span>
<span>          n_size <span class="op">=</span> <span class="fl">100</span>,</span>
<span>          min_dist <span class="op">=</span> <span class="fl">5</span>,</span>
<span>          iter <span class="op">=</span> <span class="fl">10</span>,</span>
<span>          method <span class="op">=</span> <span class="st">"regularized"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># WAZ</span></span>
<span><span class="va">assess_waz</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/assess_pp.html">assess_pp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>WAZ <span class="op">=</span> <span class="va">waz_fit</span><span class="op">)</span>,</span>
<span>            n_size <span class="op">=</span> <span class="fl">100</span>,</span>
<span>            min_dist <span class="op">=</span> <span class="fl">5</span>,</span>
<span>            iter <span class="op">=</span> <span class="fl">10</span>,</span>
<span>            method <span class="op">=</span> <span class="st">"regularized"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We note that for a Gaussian linear geostatistical model, the <code>assess_pp</code> function does not compute the average non-randomized probability integral transform (AnPIT, introduced in <a href="04_geostatistical-prediction.html#sec-anpit" class="quarto-xref"><span>Section 4.5.2</span></a>), as this measure is specifically designed for count outcomes. Instead, it employs the standard probability integral transform (PIT), defined as <span class="math inline">\(\text{PIT}(y) = F_{M}(y)\)</span>, where <span class="math inline">\(F_{M}(y)\)</span> is the cumulative distribution function of the predictive distribution evaluated at the observed value <span class="math inline">\(y\)</span>. The PIT transforms the observed outcomes in the test set such that, if the model is well-calibrated, these transformed values should follow a uniform distribution. Deviations from uniformity indicate potential issues with calibration and predictive accuracy.</p>
<p><a href="#fig-maln-pit" class="quarto-xref">Figure&nbsp;<span>5.4</span></a> shows the results of the cross-validation exercise visualized through PIT curves for HAZ and WAZ. Similarly to the way we have interpreted the AnPIT curves, the PIT curves indicate good calibration when they lie close to the identity line, meaning the predictive distributions accurately reflect the observed variability in the test sets. The results shown in <a href="#fig-maln-pit" class="quarto-xref">Figure&nbsp;<span>5.4</span></a> demonstrate that, for all ten test sets and for both HAZ and WAZ, the PIT curves closely align with the identity line, confirming that the models are well-calibrated and provide reliable uncertainty quantification.</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Generate PIT plots</span></span>
<span><span class="va">p_haz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/plot_AnPIT.html">plot_AnPIT</a></span><span class="op">(</span><span class="va">assess_haz</span>, mode <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span>
<span><span class="va">p_waz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/plot_AnPIT.html">plot_AnPIT</a></span><span class="op">(</span><span class="va">assess_waz</span>, mode <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Arrange side-by-side</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span><span class="op">(</span><span class="va">p_haz</span>, <span class="va">p_waz</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-maln-pit" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-maln-pit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05_case-studies_files/figure-html/fig-maln-pit-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-maln-pit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.4: Assessment of the models calibration. The left panel shows the probability integral transform (PIT) curve for HAZ, and the right panel for WAZ. In both panels, the red dahsed line corresponds to the identity line.
</figcaption></figure>
</div>
</div>
</div>
</section><section id="summary-and-conclusions" class="level3" data-number="5.1.4"><h3 data-number="5.1.4" class="anchored" data-anchor-id="summary-and-conclusions">
<span class="header-section-number">5.1.4</span> Summary and conclusions</h3>
<p>This case study demonstrated the utility of geostatistical modeling for mapping child malnutrition in Ghana using continuous anthropometric measurements, namely HAZ and WAZ Z-scores. By modeling these outcomes directly, we were able to define stunting and underweight prevalence as predictive probabilities based on threshold exceedance (e.g., HAZ &lt; -2), rather than by dichotomizing the data prior to analysis. This approach allowed us to retain the full information content of the measurements and to produce spatially resolved predictions of prevalence along with associated uncertainty estimates. Readers interested in a more in-depth treatment of this modeling strategy are referred to <span class="citation" data-cites="kyomuhangi2021">Kyomuhangi et al. (<a href="references.html#ref-kyomuhangi2021" role="doc-biblioref">2021</a>)</span>, which discusses the loss of information and degradation in predictive performance that can result from dichotomizing continuous outcomes in geostatistical settings.</p>
<p>More broadly, this case study illustrated how geostatistical models can be used to analyze individual-level outcomes while accounting for both child-level and household-level covariates. Aggregation of data across individuals, such as using average HAZ or WAZ scores per location, is not required and can in fact introduce several complications. In particular, the number of children per cluster varies, which implies that an analysis based on cluster-level averages would require a heteroscedastic specification for the residual term to appropriately reflect varying precision across locations. Ignoring this could lead to unreliable predictive inferences.</p>
<p>In conclusion, this analysis showed that neither dichotomization nor aggregation is necessary in geostaistical analysis. Instead, geostatistical models should be fitted to individual-level continuous outcomes, and suitable predictive targets and summaries of uncertainty can then be derived from the fitted model.</p>
</section></section><section id="mapping-malaria-in-malawi" class="level2" data-number="5.2"><h2 data-number="5.2" class="anchored" data-anchor-id="mapping-malaria-in-malawi">
<span class="header-section-number">5.2</span> Mapping malaria in Malawi</h2>
<p>In this section, we demonstrate how to conduct a geostatistical analysis using Malaria Indicator Survey (MIS) data accessed through the <code>malariaAtlas</code> R package <span class="citation" data-cites="malariaAtlas">(<a href="references.html#ref-malariaAtlas" role="doc-biblioref">Lucas et al. 2020</a>)</span>. This package provides streamlined access to a curated repository of georeferenced malaria data, including prevalence surveys and associated metadata, making it a valuable resource for spatial epidemiological studies. The primary aim here is to illustrate how relevant environmental covariates can be obtained via Google Earth Engine and incorporated into a geostatistical model for prevalence mapping. Although the analysis is not guided by a specific research question, its value lies in showcasing the full workflow and technical aspects introduced in previous chapters, including data preparation, covariate extraction, exploratory analysis, model fitting, and spatial prediction of disease prevalence.</p>
<section id="downloading-prevalence-and-raster-data" class="level3" data-number="5.2.1"><h3 data-number="5.2.1" class="anchored" data-anchor-id="downloading-prevalence-and-raster-data">
<span class="header-section-number">5.2.1</span> Downloading prevalence and raster data</h3>
<p>This section illustrates how to access and visualize Malaria Indicator Survey data using the <code>malariaAtlas</code> R package, focusing on <em>Plasmodium falciparum</em> prevalence in Malawi for the year 2006. We walk through the steps to extract survey data, obtain country boundaries, and produce a basic map of raw prevalence data.</p>
<p>We begin by loading the necessary packages and initializing the Earth Engine API via the <code>rgee</code> package.</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/malaria-atlas-project/malariaAtlas">malariaAtlas</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/rgee/">rgee</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/wmgeolab/rgeoboundaries">rgeoboundaries</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Initialize Earth Engine</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/rgee/reference/ee_Initialize.html">ee_Initialize</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then use <code>rgeoboundaries</code> to obtain Malawi’s administrative boundary and extract P. falciparum prevalence survey data from the <code>malariaAtlas</code> package for surveys conducted in or overlapping the year 2006.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Get Malawi boundary</span></span>
<span><span class="va">mlw_admin0_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rgeoboundaries/man/geoboundaries.html">geoboundaries</a></span><span class="op">(</span>country <span class="op">=</span> <span class="st">"Malawi"</span>, adm_lvl <span class="op">=</span> <span class="st">"adm0"</span><span class="op">)</span></span>
<span><span class="va">mlw_admin0_ee</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/rgee/reference/sf_as_ee.html">sf_as_ee</a></span><span class="op">(</span><span class="va">mlw_admin0_sf</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Download PfPR survey data</span></span>
<span><span class="va">mlw_pfpr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/malariaAtlas/man/getPR.html">getPR</a></span><span class="op">(</span>country <span class="op">=</span> <span class="st">"Malawi"</span>, species <span class="op">=</span> <span class="st">"Pf"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">year_start</span> <span class="op">&lt;=</span> <span class="fl">2006</span> <span class="op">&amp;</span> <span class="va">year_end</span> <span class="op">&gt;=</span> <span class="fl">2006</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">longitude</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">latitude</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert to sf object</span></span>
<span><span class="va">mlw_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">mlw_pfpr</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"longitude"</span>, <span class="st">"latitude"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert to UTM </span></span>
<span><span class="va">mlw_crs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/propose_utm.html">propose_utm</a></span><span class="op">(</span><span class="va">mlw_sf</span><span class="op">)</span></span>
<span><span class="va">mlw_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">mlw_sf</span>, crs <span class="op">=</span> <span class="va">mlw_crs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remove columns with all NAs</span></span>
<span><span class="va">mlw_sf</span> <span class="op">&lt;-</span> <span class="va">mlw_sf</span><span class="op">[</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/rowSums.html">colSums</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">mlw_sf</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following map displays the raw prevalence data at each survey location. The size and color of each point reflect the estimated malaria prevalence (pr) at that location.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Compute prevalence</span></span>
<span><span class="co"># Compute observed prevalence</span></span>
<span><span class="va">mlw_sf</span><span class="op">$</span><span class="va">pr</span> <span class="op">&lt;-</span> <span class="va">mlw_sf</span><span class="op">$</span><span class="va">positive</span> <span class="op">/</span> <span class="va">mlw_sf</span><span class="op">$</span><span class="va">examined</span></span>
<span></span>
<span><span class="co"># Plot raw PfPR data with uniform point size and no axis labels</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">mlw_admin0_sf</span>, fill <span class="op">=</span> <span class="st">"white"</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">mlw_sf</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">pr</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_color_viridis_c</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"PfPR"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Malaria Prevalence in Malawi (2006)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-malawi-raw-map" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-malawi-raw-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05_case-studies_files/figure-html/fig-malawi-raw-map-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-malawi-raw-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.5: Raw PfPR survey data for Malawi in 2006. Each point represents a georeferenced survey location, with color and size indicating estimated prevalence.
</figcaption></figure>
</div>
</div>
</div>
<p>In the next step we retrieve a suite of environmental covariates that are mechanistically linked to malaria transmission and therefore commonly included in spatial risk-mapping studies. All layers are clipped to the Malawi national boundary and combined into a single multi-band image ready for extraction at the survey points.</p>
<p>These covariates are summarised in Table&nbsp;<a href="#tbl-covariates" class="quarto-xref">Table&nbsp;<span>5.1</span></a>, which also explains their epidemiological relevance in the context of malaria transmission.</p>
<div id="tbl-covariates" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-covariates-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;5.1: Environmental covariates extracted from Google Earth Engine and their relevance for malaria risk modelling.
</figcaption><div aria-describedby="tbl-covariates-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead><tr class="header">
<th>Covariate</th>
<th>Source</th>
<th>Processing</th>
<th>Relevance</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Precipitation</td>
<td>CHIRPS Daily</td>
<td>Annual mean (mm · day⁻¹)</td>
<td>Determines suitability of breeding sites for <em>Anopheles</em> mosquitoes.</td>
</tr>
<tr class="even">
<td>Land-surface temperature</td>
<td>MODIS MOD11A2</td>
<td>Kelvin converted to °C; annual mean</td>
<td>Affects mosquito survival and parasite development rates.</td>
</tr>
<tr class="odd">
<td>NDVI</td>
<td>MODIS MOD13A2</td>
<td>Scaled to 0–1; annual mean</td>
<td>Proxy for habitat moisture and vegetation cover.</td>
</tr>
<tr class="even">
<td>Elevation</td>
<td>SRTM DEM</td>
<td>90 m; clipped to country boundary</td>
<td>Integrates climatic variation; highlands tend to have lower transmission.</td>
</tr>
<tr class="odd">
<td>Relative humidity</td>
<td>ERA5-Land</td>
<td>Derived from temperature and dew-point; annual mean (%)</td>
<td>High humidity increases mosquito survival.</td>
</tr>
<tr class="even">
<td>Urbanicity (built-up areas)</td>
<td>MODIS MCD12Q1</td>
<td>Binary indicator (class 13 = urban)</td>
<td>Urban areas generally have lower risk due to infrastructure and fewer breeding sites.</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>We point out that in order to compute relative humidity, we first extract hourly estimates of air temperature and dew-point temperature at 2 meters above ground level from the ERA5-Land reanalysis product. These two quantities are then combined using a standard empirical formula derived from the Clausius–Clapeyron relation: <span class="math display">\[
\text{RH} = 100 \times \left( \frac{e^{\frac{17.625 \cdot T_d}{243.04 + T_d}}}{e^{\frac{17.625 \cdot T}{243.04 + T}}} \right)
\]</span> where <span class="math inline">\(T_d\)</span> is the dew-point temperature and <span class="math inline">\(T\)</span> is the air temperature, both in degrees Celsius. This yields the mean annual relative humidity over the target region, expressed as a percentage.</p>
<p><a href="#tbl-covariates" class="quarto-xref">Table&nbsp;<span>5.1</span></a> does not provide an exhaustive list of covariates, and other factors such as soil moisture, land surface water, nighttime temperature, or socio-economic indicators like night-time light intensity and land surface emissivity, which may serve as proxies for human activity, infrastructure, or economic development, could also influence malaria risk. However, to maintain this illustrative analysis simpler, we restrict our attention to a core set of covariates that capture key climatic, ecological, and anthropogenic drivers.</p>
<p>In the code below, all layers are clipped to the boundary of Malawi and combined into a single multi-band image, ready to be extracted at survey point locations for subsequent modeling.</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># -------------------------------</span></span>
<span><span class="co"># STEP 2: Covariates from Earth Engine</span></span>
<span><span class="co"># -------------------------------</span></span>
<span><span class="va">scale_m</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span></span>
<span><span class="co"># Precipitation</span></span>
<span><span class="va">precip</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"UCSB-CHG/CHIRPS/DAILY"</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">filterDate</span><span class="op">(</span><span class="st">"2006-01-01"</span>, <span class="st">"2006-12-31"</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">mean</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">rename</span><span class="op">(</span><span class="st">"precip"</span><span class="op">)</span><span class="op">$</span><span class="fu">clip</span><span class="op">(</span><span class="va">mlw_admin0_ee</span><span class="op">)</span><span class="op">$</span><span class="fu">toFloat</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Temperature</span></span>
<span><span class="va">lst</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"MODIS/061/MOD11A2"</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">filterDate</span><span class="op">(</span><span class="st">"2006-01-01"</span>, <span class="st">"2006-12-31"</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="st">"LST_Day_1km"</span><span class="op">)</span><span class="op">$</span><span class="fu">mean</span><span class="op">(</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">multiply</span><span class="op">(</span><span class="fl">0.02</span><span class="op">)</span><span class="op">$</span><span class="fu">subtract</span><span class="op">(</span><span class="fl">273.15</span><span class="op">)</span><span class="op">$</span><span class="fu">rename</span><span class="op">(</span><span class="st">"lst_c"</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">clip</span><span class="op">(</span><span class="va">mlw_admin0_ee</span><span class="op">)</span><span class="op">$</span><span class="fu">toFloat</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># NDVI</span></span>
<span><span class="va">ndvi</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"MODIS/061/MOD13A2"</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">filterDate</span><span class="op">(</span><span class="st">"2006-01-01"</span>, <span class="st">"2006-12-31"</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="st">"NDVI"</span><span class="op">)</span><span class="op">$</span><span class="fu">mean</span><span class="op">(</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">multiply</span><span class="op">(</span><span class="fl">0.0001</span><span class="op">)</span><span class="op">$</span><span class="fu">rename</span><span class="op">(</span><span class="st">"ndvi"</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">clip</span><span class="op">(</span><span class="va">mlw_admin0_ee</span><span class="op">)</span><span class="op">$</span><span class="fu">toFloat</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Elevation</span></span>
<span><span class="va">elev</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">Image</span><span class="op">(</span><span class="st">"USGS/SRTMGL1_003"</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">rename</span><span class="op">(</span><span class="st">"elev"</span><span class="op">)</span><span class="op">$</span><span class="fu">clip</span><span class="op">(</span><span class="va">mlw_admin0_ee</span><span class="op">)</span><span class="op">$</span><span class="fu">toFloat</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Humidity from ERA5 (computed from dewpoint and temperature)</span></span>
<span><span class="va">era5</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"ECMWF/ERA5_LAND/HOURLY"</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">filterDate</span><span class="op">(</span><span class="st">"2006-01-01"</span>, <span class="st">"2006-12-31"</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"dewpoint_temperature_2m"</span>, <span class="st">"temperature_2m"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">mean</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">clip</span><span class="op">(</span><span class="va">mlw_admin0_ee</span><span class="op">)</span></span>
<span></span>
<span><span class="va">td</span> <span class="op">&lt;-</span> <span class="va">era5</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"dewpoint_temperature_2m"</span><span class="op">)</span><span class="op">$</span><span class="fu">subtract</span><span class="op">(</span><span class="fl">273.15</span><span class="op">)</span></span>
<span><span class="va">t</span> <span class="op">&lt;-</span> <span class="va">era5</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"temperature_2m"</span><span class="op">)</span><span class="op">$</span><span class="fu">subtract</span><span class="op">(</span><span class="fl">273.15</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rh</span> <span class="op">&lt;-</span> <span class="va">td</span><span class="op">$</span><span class="fu">expression</span><span class="op">(</span></span>
<span>  <span class="st">"100 * (exp((17.625 * TD)/(243.04 + TD)) / exp((17.625 * T)/(243.04 + T)))"</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>TD <span class="op">=</span> <span class="va">td</span>, T <span class="op">=</span> <span class="va">t</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="fu">rename</span><span class="op">(</span><span class="st">"humidity"</span><span class="op">)</span><span class="op">$</span><span class="fu">toFloat</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use MODIS Land Cover, version 061</span></span>
<span><span class="va">urban_raw</span> <span class="op">&lt;-</span> <span class="va">ee</span><span class="op">$</span><span class="fu">ImageCollection</span><span class="op">(</span><span class="st">"MODIS/061/MCD12Q1"</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">filterDate</span><span class="op">(</span><span class="st">"2006-01-01"</span>, <span class="st">"2006-12-31"</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">first</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="st">"LC_Type1"</span><span class="op">)</span><span class="op">$</span><span class="fu">clip</span><span class="op">(</span><span class="va">mlw_admin0_ee</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Urban areas are class 13 in IGBP classification</span></span>
<span><span class="va">built_up</span> <span class="op">&lt;-</span> <span class="va">urban_raw</span><span class="op">$</span><span class="fu">eq</span><span class="op">(</span><span class="fl">13</span><span class="op">)</span><span class="op">$</span><span class="fu">rename</span><span class="op">(</span><span class="st">"built_up"</span><span class="op">)</span><span class="op">$</span><span class="fu">toFloat</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># Combine all covariates</span></span>
<span><span class="va">covariates</span> <span class="op">&lt;-</span> <span class="va">precip</span><span class="op">$</span></span>
<span>  <span class="fu">addBands</span><span class="op">(</span><span class="va">lst</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">addBands</span><span class="op">(</span><span class="va">ndvi</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">addBands</span><span class="op">(</span><span class="va">elev</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">addBands</span><span class="op">(</span><span class="va">rh</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">addBands</span><span class="op">(</span><span class="va">built_up</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After defining the multi-band raster image <code>covariates</code> in Google Earth Engine, we download it as a GeoTIFF file using the <code><a href="https://r-spatial.github.io/rgee/reference/ee_as_rast.html">ee_as_rast()</a></code> function from the <code>rgee</code> package. The file is saved temporarily and clipped to the bounding box of Malawi. We then read the raster into R using the <code>terra</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># -------------------------------</span></span>
<span><span class="co"># STEP 3: Download Earth Engine raster</span></span>
<span><span class="co"># -------------------------------</span></span>
<span><span class="va">out_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"malawi_covariates_2006.tif"</span><span class="op">)</span></span>
<span><span class="va">region</span> <span class="op">&lt;-</span> <span class="va">mlw_admin0_ee</span><span class="op">$</span><span class="fu">geometry</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">bounds</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">rgee</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/rgee/reference/ee_as_rast.html">ee_as_rast</a></span><span class="op">(</span></span>
<span>  image <span class="op">=</span> <span class="va">covariates</span>,</span>
<span>  region <span class="op">=</span> <span class="va">region</span>,</span>
<span>  scale <span class="op">=</span> <span class="va">scale_m</span>,</span>
<span>  dsn <span class="op">=</span> <span class="va">out_file</span>,</span>
<span>  via <span class="op">=</span> <span class="st">"drive"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load raster</span></span>
<span><span class="va">r_covs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html">rast</a></span><span class="op">(</span><span class="va">out_file</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># -------------------------------</span></span>
<span><span class="co"># STEP 4: Extract covariates at survey locations</span></span>
<span><span class="co"># -------------------------------</span></span>
<span><span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">r_covs</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html">vect</a></span><span class="op">(</span><span class="va">mlw_sf</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mlw_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="va">mlw_sf</span>, <span class="va">vals</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>  <span class="co"># remove ID column</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following code generates six raster maps, one for each covariate, using ggplot2. We first convert the raster stack to a data frame and then create a separate ggplot object for each variable, ensuring a consistent and clean visual style across all maps. The plots in <a href="#fig-covariates-map" class="quarto-xref">Figure&nbsp;<span>5.6</span></a> are arranged in a 2 × 3 grid using the base grid package.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 1. Prepare a data frame</span></span>
<span></span>
<span><span class="va">r_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">r_covs</span>, xy <span class="op">=</span> <span class="cn">TRUE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rename layers for clarity</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html">names</a></span><span class="op">(</span><span class="va">r_df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>,</span>
<span>                 <span class="st">"Precipitation"</span>,          </span>
<span>                 <span class="st">"Temperature"</span>,            </span>
<span>                 <span class="st">"NDVI"</span>,                   </span>
<span>                 <span class="st">"Elevation"</span>,              </span>
<span>                 <span class="st">"Humidity"</span>,               </span>
<span>                 <span class="st">"Urbanicity"</span><span class="op">)</span>             </span>
<span></span>
<span><span class="co"># Urbanicity as a factor for a discrete palette</span></span>
<span><span class="va">r_df</span><span class="op">$</span><span class="va">Urbanicity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">r_df</span><span class="op">$</span><span class="va">Urbanicity</span>,</span>
<span>                          levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                          labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Rural"</span>, <span class="st">"Urban"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Build one map per covariate, each with its own colour scale </span></span>
<span><span class="va">p_precip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">r_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, fill <span class="op">=</span> <span class="va">Precipitation</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"mm"</span>, low <span class="op">=</span> <span class="st">"lightblue"</span>, high <span class="op">=</span> <span class="st">"darkblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Precipitation"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">r_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, fill <span class="op">=</span> <span class="va">Temperature</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"°C"</span>, low <span class="op">=</span> <span class="st">"lemonchiffon"</span>, high <span class="op">=</span> <span class="st">"red3"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"LST"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_ndvi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">r_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, fill <span class="op">=</span> <span class="va">NDVI</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">" "</span>, low <span class="op">=</span> <span class="st">"cornsilk"</span>, high <span class="op">=</span> <span class="st">"darkgreen"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"NDVI"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_elev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">r_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, fill <span class="op">=</span> <span class="va">Elevation</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"m"</span>, low <span class="op">=</span> <span class="st">"grey90"</span>, high <span class="op">=</span> <span class="st">"sienna4"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Elevation"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_humid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">r_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, fill <span class="op">=</span> <span class="va">Humidity</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"%"</span>, low <span class="op">=</span> <span class="st">"white"</span>, high <span class="op">=</span> <span class="st">"darkcyan"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Humidity"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_urban</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">r_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, fill <span class="op">=</span> <span class="va">Urbanicity</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lightgrey"</span>, <span class="st">"black"</span><span class="op">)</span>,</span>
<span>                    name <span class="op">=</span> <span class="st">" "</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Urban vs Rural"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Arrange the six plots in a 2 × 3 grid using base 'grid'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/viewports.html">pushViewport</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grid/viewport.html">viewport</a></span><span class="op">(</span>layout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.layout.html">grid.layout</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">vplayout</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">row</span>, <span class="va">col</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grid/viewport.html">viewport</a></span><span class="op">(</span>layout.pos.row <span class="op">=</span> <span class="va">row</span>, layout.pos.col <span class="op">=</span> <span class="va">col</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p_precip</span>, vp <span class="op">=</span> <span class="fu">vplayout</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p_temp</span>,   vp <span class="op">=</span> <span class="fu">vplayout</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p_ndvi</span>,   vp <span class="op">=</span> <span class="fu">vplayout</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p_elev</span>,   vp <span class="op">=</span> <span class="fu">vplayout</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p_humid</span>,  vp <span class="op">=</span> <span class="fu">vplayout</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p_urban</span>,  vp <span class="op">=</span> <span class="fu">vplayout</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-covariates-map" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-covariates-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05_case-studies_files/figure-html/fig-covariates-map-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-covariates-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.6: Raster maps of environmental covariates extracted from Google Earth Engine for Malawi in 2006. Each panel shows one covariate: precipitation, land surface temperature (LST), vegetation cover (NDVI), elevation, relative humidity, and urbanicity. These layers are used as predictors in the geostatistical modelling of malaria prevalence.
</figcaption></figure>
</div>
</div>
</div>
</section><section id="exploratory-analysis-1" class="level3" data-number="5.2.2"><h3 data-number="5.2.2" class="anchored" data-anchor-id="exploratory-analysis-1">
<span class="header-section-number">5.2.2</span> Exploratory analysis</h3>
<p>To investigate how <em>Plasmodium falciparum</em> prevalence varies with environmental conditions, we begin by computing the empirical logit transformation of the observed prevalence at each survey location. Each covariate is then explored in relation to the empirical logit using scatterplots. For continuous covariates, we produce scatter plots with two fitted curves: a LOESS smoother shown in red, and a linear spline model with a single change point shown in blue. The LOESS curve serves as a flexible, nonparametric reference for assessing the general trend in the data. The spline model provides a simple parametric approximation to this trend, with the change point selected based on visual inspection of where the LOESS curve departs from linearity.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="co"># 1. Prepare data</span></span>
<span><span class="va">mlw_sf</span> <span class="op">&lt;-</span> <span class="va">mlw_sf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    elogit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="op">(</span><span class="va">positive</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">examined</span> <span class="op">-</span> <span class="va">positive</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    `Precipitation` <span class="op">=</span> <span class="va">precip</span>,</span>
<span>    `Temperature (°C)` <span class="op">=</span> <span class="va">lst_c</span>,</span>
<span>    `NDVI` <span class="op">=</span> <span class="va">ndvi</span>,</span>
<span>    `Elevation (m)` <span class="op">=</span> <span class="va">elev</span>,</span>
<span>    `Humidity (%)` <span class="op">=</span> <span class="va">humidity</span>,</span>
<span>    `Urbanicity` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">built_up</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Rural"</span>, <span class="st">"Urban"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Drop geometry and reshape</span></span>
<span><span class="va">plot_data_cont</span> <span class="op">&lt;-</span> <span class="va">mlw_sf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">elogit</span>, <span class="va">`Precipitation`</span>, <span class="va">`Temperature (°C)`</span>, <span class="va">`NDVI`</span>, <span class="va">`Elevation (m)`</span>, <span class="va">`Humidity (%)`</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="va">elogit</span>, names_to <span class="op">=</span> <span class="st">"Covariate"</span>, values_to <span class="op">=</span> <span class="st">"Value"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_data_cat</span> <span class="op">&lt;-</span> <span class="va">mlw_sf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">elogit</span>, <span class="va">Urbanicity</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Define change points</span></span>
<span><span class="va">knots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"Precipitation"</span> <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  <span class="st">"Temperature (°C)"</span> <span class="op">=</span> <span class="fl">33</span>,</span>
<span>  <span class="st">"NDVI"</span> <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  <span class="st">"Elevation (m)"</span> <span class="op">=</span> <span class="fl">400</span>,</span>
<span>  <span class="st">"Humidity (%)"</span> <span class="op">=</span> <span class="fl">65</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4. Create individual continuous plots</span></span>
<span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/split.html">split</a></span><span class="op">(</span><span class="va">plot_data_cont</span>, <span class="va">plot_data_cont</span><span class="op">$</span><span class="va">Covariate</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html">unique</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Covariate</span><span class="op">)</span></span>
<span>  <span class="va">knot</span> <span class="op">&lt;-</span> <span class="va">knots</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      linear_part <span class="op">=</span> <span class="va">Value</span>,</span>
<span>      spline_part <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">Value</span> <span class="op">-</span> <span class="va">knot</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Value</span>, y <span class="op">=</span> <span class="va">elogit</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>, se <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"red"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>,</span>
<span>                formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">knot</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>                se <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"blue"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">var</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 5. Add Urbanicity boxplot</span></span>
<span><span class="va">p_urban</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">plot_data_cat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Urbanicity</span>, y <span class="op">=</span> <span class="va">elogit</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>outlier.size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Urbanicity"</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 6. Assemble 2 x 3 plot grid</span></span>
<span><span class="va">final_plot</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">plots</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">|</span> <span class="va">plots</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">|</span> <span class="va">plots</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span></span>
<span>  <span class="op">(</span><span class="va">plots</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span> <span class="op">|</span> <span class="va">plots</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span> <span class="op">|</span> <span class="va">p_urban</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html">plot_annotation</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Empirical logit of prevalence vs environmental covariates"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">final_plot</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-elogit-vs-covariates" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-elogit-vs-covariates-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05_case-studies_files/figure-html/fig-elogit-vs-covariates-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-elogit-vs-covariates-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.7: Exploratory plots showing the relationship between the empirical logit of <em>P. falciparum</em> prevalence and the chosen environmental covariates. Scatter plots show continuous covariates with LOESS (red) and linear spline (blue) fits. A boxplot is used for the binary urbanicity variable. Change points for splines are based on graphical inspection of the LOESS fitted relationship.
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-elogit-vs-covariates" class="quarto-xref">Figure&nbsp;<span>5.7</span></a> shows the results of this exploratory approach for the relationship between prevalence and covariates. For some variables, such as temperature, elevation, and humidity, there is a clear nonlinear association that is reasonably captured by a single change point. For others, including precipitation and NDVI, the relationship appears approximately linear, and for this reason no change point is used in the spline fit.</p>
<p>Urbanicity is treated separately as a binary covariate and visualized with a boxplot comparing the empirical logit of prevalence between rural and urban settings. The boxplot indicates that, as we expect, the level of prevalence in urban areas is considerable lower than in rural areas.</p>
<p>To assess the degree of correlation between covariates, we compute the pairwise Pearson correlation coefficients among the continuous environmental variables.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.sthda.com/english/wiki/ggcorrplot-visualization-of-a-correlation-matrix-using-ggplot2">ggcorrplot</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Select continuous covariates only</span></span>
<span><span class="va">cont_vars</span> <span class="op">&lt;-</span> <span class="va">mlw_sf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>Precipitation <span class="op">=</span> <span class="va">precip</span>,</span>
<span>         Temperature <span class="op">=</span> <span class="va">lst_c</span>,</span>
<span>         NDVI <span class="op">=</span> <span class="va">ndvi</span>,</span>
<span>         Elevation <span class="op">=</span> <span class="va">elev</span>,</span>
<span>         Humidity <span class="op">=</span> <span class="va">humidity</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute correlation matrix</span></span>
<span><span class="va">corr_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">cont_vars</span>, use <span class="op">=</span> <span class="st">"complete.obs"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot correlation matrix</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ggcorrplot/man/ggcorrplot.html">ggcorrplot</a></span><span class="op">(</span><span class="va">corr_mat</span>,</span>
<span>           method <span class="op">=</span> <span class="st">"circle"</span>,</span>
<span>           type <span class="op">=</span> <span class="st">"lower"</span>,</span>
<span>           lab <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>           lab_size <span class="op">=</span> <span class="fl">3</span>,</span>
<span>           colors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span>,</span>
<span>           title <span class="op">=</span> <span class="st">"Correlation between covariates"</span>,</span>
<span>           ggtheme <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-correlation-heatmap" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-correlation-heatmap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05_case-studies_files/figure-html/fig-correlation-heatmap-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-correlation-heatmap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.8: Pairwise Pearson correlation matrix between continuous environmental covariates.
</figcaption></figure>
</div>
</div>
</div>
<p>The correlations, shown in Figure&nbsp;<a href="#fig-correlation-heatmap" class="quarto-xref">Figure&nbsp;<span>5.8</span></a>, are generally moderate in magnitude, ranging from –0.66 between temperature and precipitation to 0.54 between elevation and relative humidity. These values indicate that collinearity is not a major concern in our model development. Each covariate is likely to provide complementary information about malaria risk, and the absence of strong dependencies also supports the reliability of the scatterplots used to explore their individual relationships with prevalence.</p>
<p>We also perform a principal component analysis (PCA) on the standardized continuous environmental covariates to assess the potential for reducing dimensionality in our model. The code below shows the implementation of the PCA.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.sthda.com/english/rpkgs/factoextra">factoextra</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prepare only continuous covariates and standardize</span></span>
<span><span class="va">pca_data</span> <span class="op">&lt;-</span> <span class="va">mlw_sf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>Precipitation <span class="op">=</span> <span class="va">precip</span>,</span>
<span>         Temperature <span class="op">=</span> <span class="va">lst_c</span>,</span>
<span>         NDVI <span class="op">=</span> <span class="va">ndvi</span>,</span>
<span>         Elevation <span class="op">=</span> <span class="va">elev</span>,</span>
<span>         Humidity <span class="op">=</span> <span class="va">humidity</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/scale.html">scale</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Perform PCA</span></span>
<span><span class="va">pca_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/prcomp.html">prcomp</a></span><span class="op">(</span><span class="va">pca_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Scree plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/factoextra/man/eigenvalue.html">fviz_eig</a></span><span class="op">(</span><span class="va">pca_result</span>, addlabels <span class="op">=</span> <span class="cn">TRUE</span>, barfill <span class="op">=</span> <span class="st">"steelblue"</span>, barcolor <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-pca-scree" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-pca-scree-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05_case-studies_files/figure-html/fig-pca-scree-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pca-scree-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.9: Proportion of variance explained by the principal components computed from standardized continuous environmental covariates.
</figcaption></figure>
</div>
</div>
</div>
<p>The scree plot in Figure&nbsp;<a href="#fig-pca-scree" class="quarto-xref">Figure&nbsp;<span>5.9</span></a> shows the proportion of variance explained by each principal component. The first principal component (PC1) explains approximately 50% of the total variation, suggesting it captures a substantial environmental gradient across the study region. Although additional components may carry useful information, PC1 stands out as a potential candidate for use in model building as a composite environmental index and spatial predictor of malaria prevalence.</p>
<div class="cell">
<div id="tbl-pca-loadings" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-pca-loadings-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;5.2: Loadings of the first two principal components. Each value indicates the contribution of a standardized covariate to the corresponding component.
</figcaption><div aria-describedby="tbl-pca-loadings-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">Covariate</th>
<th style="text-align: center;">PC1</th>
<th style="text-align: center;">PC2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Precipitation</td>
<td style="text-align: center;">-0.480</td>
<td style="text-align: center;">-0.339</td>
</tr>
<tr class="even">
<td style="text-align: left;">Temperature</td>
<td style="text-align: center;">0.596</td>
<td style="text-align: center;">0.043</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NDVI</td>
<td style="text-align: center;">-0.338</td>
<td style="text-align: center;">-0.605</td>
</tr>
<tr class="even">
<td style="text-align: left;">Elevation</td>
<td style="text-align: center;">-0.391</td>
<td style="text-align: center;">0.560</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Humidity</td>
<td style="text-align: center;">-0.385</td>
<td style="text-align: center;">0.451</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>Table&nbsp;<a href="#tbl-pca-loadings" class="quarto-xref">Table&nbsp;<span>5.2</span></a> displays the loadings of the first two principal components. The sign and magnitude of each loading reflect how much each standardized covariate contributes to the corresponding component. PC1 shows strong positive loading for temperature and strong negative loadings for precipitation, humidity, and elevation. This suggests that PC1 represents a gradient from cool, humid, high-elevation areas with more rainfall to hotter, drier lowland regions. NDVI also contributes negatively, implying more vegetation cover in cooler, wetter zones. We can thus interpret PC1 as a general heat-aridity gradient, which well aligns with known ecological drivers of malaria risk.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create raster for PC1</span></span>
<span><span class="va">r_stack_std</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/scale.html">scale</a></span><span class="op">(</span><span class="va">r_covs</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"precip"</span>, <span class="st">"lst_c"</span>, <span class="st">"ndvi"</span>, <span class="st">"elev"</span>, <span class="st">"humidity"</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">pc1_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.480</span>, <span class="fl">0.596</span>, <span class="op">-</span><span class="fl">0.338</span>, <span class="op">-</span><span class="fl">0.391</span>, <span class="op">-</span><span class="fl">0.385</span><span class="op">)</span></span>
<span><span class="va">pc1_rast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">r_stack_std</span> <span class="op">*</span> <span class="va">pc1_weights</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html">names</a></span><span class="op">(</span><span class="va">pc1_rast</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"PC1"</span></span>
<span></span>
<span><span class="co"># Extract PC1 values</span></span>
<span><span class="va">pc1_vals</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">pc1_rast</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html">vect</a></span><span class="op">(</span><span class="va">mlw_sf</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mlw_sf</span><span class="op">$</span><span class="va">PC1</span> <span class="op">&lt;-</span> <span class="va">pc1_vals</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Convert raster to df for ggplot</span></span>
<span><span class="va">pc1_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">pc1_rast</span>, xy <span class="op">=</span> <span class="cn">TRUE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html">names</a></span><span class="op">(</span><span class="va">pc1_df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"PC1"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># --- Create PC1 map plot ---</span></span>
<span><span class="va">p_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">pc1_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">PC1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"C"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"PC1: Environmental Gradient"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># --- Create scatterplot with LOESS and spline ---</span></span>
<span><span class="va">knot_pc1</span> <span class="op">&lt;-</span> <span class="fl">0.75</span></span>
<span><span class="va">scatter_df</span> <span class="op">&lt;-</span> <span class="va">mlw_sf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>spline_part <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">PC1</span> <span class="op">-</span> <span class="va">knot_pc1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_scatter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">scatter_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PC1</span>, y <span class="op">=</span> <span class="va">elogit</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>, se <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"red"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">knot_pc1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>              se <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"blue"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"PC1"</span>, y <span class="op">=</span> <span class="st">"Empirical logit"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Empirical logit vs PC1"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># --- Combine using patchwork ---</span></span>
<span><span class="co"># Also add some margin space</span></span>
<span><span class="va">p_map</span> <span class="op">&lt;-</span> <span class="va">p_map</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span>r <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p_scatter</span> <span class="op">&lt;-</span> <span class="va">p_scatter</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span>l <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p_map</span> <span class="op">+</span> <span class="va">p_scatter</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-pca1-map-scatter" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-pca1-map-scatter-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05_case-studies_files/figure-html/fig-pca1-map-scatter-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pca1-map-scatter-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.10: Left: Spatial distribution of the first principal component (PC1). Right: Empirical logit of malaria prevalence plotted against PC1 with LOESS (red) and linear spline (blue) fits.
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-pca1-map-scatter" class="quarto-xref">Figure&nbsp;<span>5.10</span></a> displays the map of PC1 alongside its relationship with malaria prevalence. As done previously, to aid interpretation, we fit a LOESS curve (red) to visualise the general trend, and a linear spline (blue) with a change point at 0.75 to capture a simplified parametric relationship. The spline fit suggests a nonlinear association: malaria risk increases with PC1 up to around 0.75, after which it begins to decline. This pattern implies that malaria prevalence is highest in areas with intermediate PC1 values, i.e.&nbsp;environments that are neither too cold and wet nor too hot and arid. In other words, there appears to be an optimal range of environmental conditions, as summarised by PC1, that are most conducive to malaria transmission. Beyond this range, particularly in more heat-arid regions, the risk may decline due to ecological constraints on mosquito survival or parasite development.</p>
<p>In the next section, we compare two modelling approaches. The first model includes the original environmental covariates using the linear spline specifications identified during our exploratory analysis. The second model replaces these covariates with PC1 alone, treating it as a composite spatial predictor that summarises the dominant environmental gradient in the study area. In both models, we include urbanicity as a separate fixed effect. Urbanicity is excluded from the PCA because it is a binary variable and highly unbalanced, with most survey locations classified as rural. Modelling it separately ensures that its distinct contribution to malaria risk, more linked to infrastructure, housing conditions, and land use, is properly accounted for.</p>
</section><section id="model-fitting-and-spatial-prediction" class="level3" data-number="5.2.3"><h3 data-number="5.2.3" class="anchored" data-anchor-id="model-fitting-and-spatial-prediction">
<span class="header-section-number">5.2.3</span> Model fitting and spatial prediction</h3>
<p>In this section, we fit two geostatistical models to malaria prevalence data from Malawi, comparing the effects of using separate environmental covariates versus summarizing them into a principal component.</p>
<p>The first model (<code>mod_all_cov</code>) includes all environmental covariates as separate predictors. Namely these are precipitation <span class="math inline">\(d_{\text{prec}}(x)\)</span>, NDVI <span class="math inline">\(d_{\text{ndvi}}(x)\)</span>, temperature <span class="math inline">\(d_{\text{temp}}(x)\)</span>, elevation <span class="math inline">\(d_{\text{elev}}(x)\)</span>, humidity <span class="math inline">\(d_{\text{hum}}(x)\)</span>, and urbanicity <span class="math inline">\(d_{\text{urb}}(x)\)</span>. Following from the results of the exploratory analysis, nonlinear effects for temperature, elevation, and humidity are modeled using linear splines with thresholds at 33°C, 400 m, and 65%, respectively. The logit-linear model is:</p>
<p><span class="math display">\[
\begin{aligned}
\log\left\{\frac{p(x)}{1 - p(x)}\right\} =\; &amp;
\beta_0 +
\beta_1 d_{\text{prec}}(x) +
\beta_2 d_{\text{ndvi}}(x) +
\beta_3 d_{\text{temp}}(x) + \beta_4 \max\{d_{\text{temp}}(x) - 33,\; 0\} \\\\
&amp; +
\beta_5 d_{\text{elev}}(x) + \beta_6 \max\{d_{\text{elev}}(x) - 400,\; 0\} \\\\
&amp; +
\beta_7 d_{\text{hum}}(x) + \beta_8 \max\{d_{\text{hum}}(x) - 65,\; 0\} \\\\
&amp; +
\beta_9 d_{\text{urb}}(x) + S(x)
\end{aligned}
\]</span>.</p>
<p>The second model (<code>mod_pca</code>) replaces the continuous covariates with their first principal component <span class="math inline">\(\text{PC}_1(x)\)</span>, allowing for a spline above 0.75. The model becomes:</p>
<p><span class="math display">\[
\log\left\{\frac{p(x)}{1-p(x)}\right\} = \beta_0 +
\beta_1 \text{PC}_1(x) +
\beta_2 \max\{\text{PC}_1(x) - 0.75,0\} +
\beta_3 d_{\text{urb}}(x) + S(x)
\]</span></p>
<p>This formulation allows us to assess whether the dimensionality reduction via PCA retains the essential variation in environmental risk while simplifying the model structure.</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Model with all the covariates as separate predictors</span></span>
<span><span class="va">mod_all_cov</span> <span class="op">&lt;-</span></span>
<span><span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/glgpm.html">glgpm</a></span><span class="op">(</span><span class="va">positive</span> <span class="op">~</span></span>
<span>    <span class="va">precip</span> <span class="op">+</span></span>
<span>    <span class="va">ndvi</span> <span class="op">+</span></span>
<span>    <span class="va">lst_c</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">lst_c</span> <span class="op">-</span> <span class="fl">33</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="va">elev</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">elev</span> <span class="op">-</span> <span class="fl">400</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="va">humidity</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">humidity</span> <span class="op">-</span> <span class="fl">65</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="va">built_up</span> <span class="op">+</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/gp.html">gp</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    den <span class="op">=</span> <span class="va">examined</span>,</span>
<span>    data <span class="op">=</span> <span class="va">mlw_sf</span>,</span>
<span>    family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Model with all the covariates (except `built_up`)</span></span>
<span><span class="co"># combined into PC1 which is then used as predictor</span></span>
<span><span class="va">mod_pca</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/glgpm.html">glgpm</a></span><span class="op">(</span><span class="va">positive</span> <span class="op">~</span></span>
<span>          <span class="va">PC1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">PC1</span> <span class="op">-</span> <span class="fl">0.75</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>          <span class="va">built_up</span> <span class="op">+</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/gp.html">gp</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        den <span class="op">=</span> <span class="va">examined</span>,</span>
<span>        data <span class="op">=</span> <span class="va">mlw_sf</span>,</span>
<span>        family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After fitting the two models, when can then compare the summaries of the fits.</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summary.html">summary</a></span><span class="op">(</span><span class="va">mod_all_cov</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
glgpm(formula = positive ~ precip + ndvi + lst_c + pmax(lst_c - 
    33, 0) + elev + pmax(elev - 400, 0) + humidity + pmax(humidity - 
    65, 0) + built_up + gp(), data = mlw_sf, family = "binomial", 
    den = examined)

Binomial geostatistical linear model
Link: canonical (logit) 
Inverse link function = 1 / (1 + exp(-x)) 
 
'Lower limit' and 'Upper limit' are the limits of the 95% confidence level intervals

Regression coefficients
                          Estimate Lower limit Upper limit      StdErr  z.value
(Intercept)            -4.1484e+01 -5.4098e+01 -2.8871e+01  6.4356e+00  -6.4461
precip                  3.6000e-01  2.0822e-01  5.1178e-01  7.7441e-02   4.6487
ndvi                    5.1991e+00  4.3228e+00  6.0754e+00  4.4710e-01  11.6285
lst_c                   9.9929e-02  6.9301e-02  1.3056e-01  1.5626e-02   6.3948
pmax(lst_c - 33, 0)     3.0237e-01  2.5342e-01  3.5132e-01  2.4973e-02  12.1076
elev                    1.0984e-02  1.0581e-02  1.1386e-02  2.0527e-04  53.5074
pmax(elev - 400, 0)    -1.1358e-02 -1.1732e-02 -1.0984e-02  1.9088e-04 -59.5030
humidity                4.7098e-01  4.4719e-01  4.9476e-01  1.2135e-02  38.8129
pmax(humidity - 65, 0) -6.8110e-01 -7.0309e-01 -6.5912e-01  1.1217e-02 -60.7232
built_up               -6.8574e-01 -7.4216e-01 -6.2931e-01  2.8788e-02 -23.8200
                         p.value    
(Intercept)            1.148e-10 ***
precip                 3.340e-06 ***
ndvi                   &lt; 2.2e-16 ***
lst_c                  1.607e-10 ***
pmax(lst_c - 33, 0)    &lt; 2.2e-16 ***
elev                   &lt; 2.2e-16 ***
pmax(elev - 400, 0)    &lt; 2.2e-16 ***
humidity               &lt; 2.2e-16 ***
pmax(humidity - 65, 0) &lt; 2.2e-16 ***
built_up               &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Spatial Gaussian process
Matern covariance parameters (kappa=0.5)
                     Estimate Lower limit Upper limit
Spatial process var.  0.95284     0.91937      0.9875
Spatial corr. scale  15.60594    15.02071     16.2140
Variance of the nugget effect fixed at 0

Log-likelihood: 13.833</code></pre>
</div>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summary.html">summary</a></span><span class="op">(</span><span class="va">mod_pca</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
glgpm(formula = positive ~ PC1 + pmax(PC1 - 0.75, 0) + built_up + 
    gp(), data = mlw_sf, family = "binomial", den = examined)

Binomial geostatistical linear model
Link: canonical (logit) 
Inverse link function = 1 / (1 + exp(-x)) 
 
'Lower limit' and 'Upper limit' are the limits of the 95% confidence level intervals

Regression coefficients
                     Estimate Lower limit Upper limit    StdErr  z.value
(Intercept)         -0.496575   -0.595285   -0.397866  0.050363  -9.8600
PC1                  0.258180    0.194448    0.321912  0.032517   7.9399
pmax(PC1 - 0.75, 0) -1.076688   -1.170656   -0.982719  0.047944 -22.4572
built_up            -0.542019   -0.654257   -0.429781  0.057265  -9.4650
                      p.value    
(Intercept)         &lt; 2.2e-16 ***
PC1                 2.024e-15 ***
pmax(PC1 - 0.75, 0) &lt; 2.2e-16 ***
built_up            &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Spatial Gaussian process
Matern covariance parameters (kappa=0.5)
                     Estimate Lower limit Upper limit
Spatial process var.   2.0008      1.7939      2.2316
Spatial corr. scale   30.6995     27.8239     33.8724
Variance of the nugget effect fixed at 0

Log-likelihood: 15.90143</code></pre>
</div>
</div>
<p>In the output above, we see that, compared to the model using all covariates as separate predictors, the model including only PC1 exhibits both a larger estimated spatial correlation scale and higher spatial variance. This indicates that replacing the original covariates with PC1 captures a smaller proportion of the spatial variation in prevalence, leaving the spatial Gaussian process to account for more of the structured residual variability.</p>
<p>We then compare the predicted prevalence from each model using a regular 5 by 5 km grid covering the whole of Malawi, and display the results in <a href="#fig-pred_models" class="quarto-xref">Figure&nbsp;<span>5.11</span></a>. The maps show broadly similar spatial patterns, with both models identifying areas of high and low predicted prevalence in the southern region of the country. However, these visual comparisons do not allow us to determine which model performs better. We address this question in the next stage of the analysis by formally assessing the calibration and sharpness of the predictions generated by each model.</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create a 5 by 5 regular grid </span></span>
<span><span class="va">grid_mlw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/create_grid.html">create_grid</a></span><span class="op">(</span><span class="va">mlw_admin0_sf</span>, spat_res <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract the covariates over the grid</span></span>
<span><span class="va">r_covs</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/project.html">project</a></span><span class="op">(</span><span class="va">r_covs</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"epsg:"</span>,<span class="va">mlw_crs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pc1_rast</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/project.html">project</a></span><span class="op">(</span><span class="va">pc1_rast</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"epsg:"</span>,<span class="va">mlw_crs</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">predictors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">r_covs</span>,  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">grid_mlw</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html">extract</a></span><span class="op">(</span><span class="va">pc1_rast</span>,  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">grid_mlw</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prevalence prediction over the grid for the two fitted models </span></span>
<span><span class="va">pred_all_cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/pred_over_grid.html">pred_over_grid</a></span><span class="op">(</span><span class="va">mod_all_cov</span>,</span>
<span>                               grid_pred <span class="op">=</span> <span class="va">grid_mlw</span>,</span>
<span>                               predictors <span class="op">=</span> <span class="va">predictors</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/pred_over_grid.html">pred_over_grid</a></span><span class="op">(</span><span class="va">mod_pca</span>,</span>
<span>                           grid_pred <span class="op">=</span> <span class="va">grid_mlw</span>,</span>
<span>                           predictors <span class="op">=</span> <span class="va">predictors</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_all_cov_prev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/pred_target_grid.html">pred_target_grid</a></span><span class="op">(</span><span class="va">pred_all_cov</span>,</span>
<span>                                      f_target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>prev <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_pca_prev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/pred_target_grid.html">pred_target_grid</a></span><span class="op">(</span><span class="va">pred_pca</span>,</span>
<span>                             f_target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>prev <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">pred_all_cov_prev</span>, which_target <span class="op">=</span> <span class="st">"prev"</span>, which_summary <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Model: 'all_cov'"</span>, range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">pred_pca_prev</span>, which_target <span class="op">=</span> <span class="st">"prev"</span>, which_summary <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Model: 'pca'"</span>, range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-pred_models" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-pred_models-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05_case-studies_files/figure-html/fig-pred_models-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pred_models-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.11: Predictive mean of prevalence obtained from geostatistical models using all covariates (‘all_cov’) versus the first principal component (‘pca’) of the standardized continuous environmental variables.
</figcaption></figure>
</div>
</div>
</div>
</section><section id="comparison-of-the-predictive-performance-between-models" class="level3" data-number="5.2.4"><h3 data-number="5.2.4" class="anchored" data-anchor-id="comparison-of-the-predictive-performance-between-models">
<span class="header-section-number">5.2.4</span> Comparison of the predictive performance between models</h3>
<p>To evaluate predictive performance, we use three spatially distinct hold-out test sets corresponding to the Northern, Central, and Southern regions of Malawi, as illustrated in <a href="#fig-mlw-tests" class="quarto-xref">Figure&nbsp;<span>5.12</span></a>. These were constructed using the <code>assess_pp</code> function with <code>method = "cluster"</code> and <code>fold = 3</code>, ensuring geographically stratified cross-validation.</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">assess_pred_mlw</span> <span class="op">&lt;-</span></span>
<span><span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/assess_pp.html">assess_pp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>all_cov <span class="op">=</span> <span class="va">mod_all_cov</span>,</span>
<span>               pca <span class="op">=</span> <span class="va">mod_pca</span><span class="op">)</span>,</span>
<span>          method <span class="op">=</span> <span class="st">"cluster"</span>,</span>
<span>          which_metric <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"AnPIT"</span>, <span class="st">"CRPS"</span><span class="op">)</span>,</span>
<span>          iter <span class="op">=</span> <span class="fl">1</span>,</span>
<span>          fold <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-mlw-tests" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-mlw-tests-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figures/mlw_tests.png" class="img-fluid figure-img" style="width:80.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mlw-tests-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.12: Geographic distribution of sampled locations in Malawi, coloured by their assignment to one of three cross-validation test sets.
</figcaption></figure>
</div>
</div>
</div>
<p>The CRPS score shows that the model including all environmental covariates achieves better predictive accuracy across all test sets. Specifically, it yields a lower average CRPS. This improvement is consistent across the three hold-out data, with particularly notable gains in Test Set 1. Additionally, the non-randomized probability integral transform (AnPIT) plot, shown in <a href="#fig-pit-mlw" class="quarto-xref">Figure&nbsp;<span>5.13</span></a>, demonstrates that the full covariate model is better calibrated: its cumulative distribution curves lie closer to the identity line, suggesting that the predicted probabilities align more closely with observed prevalence.</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/plot_AnPIT.html">plot_AnPIT</a></span><span class="op">(</span><span class="va">assess_pred_mlw</span>, mode <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summary.html">summary</a></span><span class="op">(</span><span class="va">assess_pred_mlw</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Summary of Cross-Validation Scores
----------------------------------
Model: all_cov
  Test Set 1:
    CRPS: 1.9452
  Test Set 2:
    CRPS: 2.1383
  Test Set 3:
    CRPS: 1.5148
  Overall average across test sets:
    CRPS: 1.9067

Model: pca
  Test Set 1:
    CRPS: 2.8064
  Test Set 2:
    CRPS: 2.5029
  Test Set 3:
    CRPS: 1.9321
  Overall average across test sets:
    CRPS: 2.6220</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-pit-mlw" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-pit-mlw-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05_case-studies_files/figure-html/fig-pit-mlw-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pit-mlw-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.13: Plot of the average non-randomized probability integral transform (AnPIT) function to assess the calibration of the two geostatistical models (‘all_cov’ and ‘pca’) for the malaria prevalence data from Malawi.
</figcaption></figure>
</div>
</div>
</div>
</section><section id="summary-and-conclusions-1" class="level3" data-number="5.2.5"><h3 data-number="5.2.5" class="anchored" data-anchor-id="summary-and-conclusions-1">
<span class="header-section-number">5.2.5</span> Summary and conclusions</h3>
<p>In this case study, we have walked through the full pipeline of conducting a geostatistical analysis of malaria prevalence using Malaria Indicator Survey data from Malawi. We began by downloading geo-referenced survey data from the <code>malariaAtlas</code> R package and retrieving relevant environmental covariates from Google Earth Engine. These covariates, selected for their mechanistic relevance to malaria transmission, were processed, clipped to the national boundary, and extracted at survey locations to be used as predictors in subsequent modelling.</p>
<p>A critical step in the analysis involved the exploration of relationships between environmental conditions and malaria prevalence. Through scatterplots and spline fits, we identified key nonlinearities in variables such as temperature, elevation, and humidity, which informed the functional form of covariate effects in the regression model. This exploratory work is essential not only for model formulation but also for understanding the ecological underpinnings of disease risk.</p>
<p>To address potential collinearity and reduce the complexity of the model, we also illustrated the use of PCA as a method for dimensionality reduction. The first principal component (PC1) captured a dominant environmental gradient, summarizing variation across temperature, humidity, elevation, and vegetation, which was then used as a composite predictor in a reduced model. A simpler alternative is to let the data guide you through stepwise selection based on p-values—for example, adding or removing covariates until all retained terms meet a preset significance threshold. When the pool of candidate predictors is large relative to the sample size, however, stepwise methods can become unstable and over-fit; in such cases penalised approaches (e.g.&nbsp;ridge, lasso) or resampling-based strategies are usually preferred. A thorough discussion of these issues, with practical recommendations, is given in Section 4.7 of <span class="citation" data-cites="harrell2015">Harrell (<a href="references.html#ref-harrell2015" role="doc-biblioref">2015</a>)</span>.</p>
<p>We compared two geostatistical models: one using all environmental covariates as separate predictors (with spline terms for nonlinear effects), and another using PC1 as a summary predictor. Cross-validation based on geographically stratified folds revealed that the full model was better calibrated and achieved sharper predictions, as measured by lower CRPS and AnPIT curves closer to the identity line.</p>
<p>We encourage the reader to explore Exercise 2 at the end of this chapter, where you will investigate whether including a second principal component (PC2) alongside PC1 leads to improved predictive performance. This offers an opportunity to assess whether PCA-based dimensionality reduction can match or exceed the predictive accuracy of models that include all covariates, while potentially offering greater parsimony.</p>
</section></section><section id="sec-wnv" class="level2" data-number="5.3"><h2 data-number="5.3" class="anchored" data-anchor-id="sec-wnv">
<span class="header-section-number">5.3</span> Mapping the vector index for West Nile Virus in the Sacramento Metropolitan Area, United States</h2>
<p>In this section, we analyse entomological surveillance data on <em>Culex pipiens</em> in the Sacramento Metropolitan Area (SMA), California, from 2015 to 2021. <em>Cx. pipiens</em> is one of the primary vectors of West Nile virus (WNV) in North America <span class="citation" data-cites="petersen2013wnv kramer2007wnv">(<a href="references.html#ref-petersen2013wnv" role="doc-biblioref">Petersen, Brault, and Nasci 2013</a>; <a href="references.html#ref-kramer2007wnv" role="doc-biblioref">Kramer, Li, and Shi 2007</a>)</span>. WNV is a mosquito borne flavivirus sustained in an enzootic cycle, that is, persistent circulation of the virus within non human animal populations, primarily birds, in a defined geographic area. Transmission is maintained between <em>Culex</em> mosquitoes and birds, while humans and other mammals are incidental dead end hosts that do not contribute to further transmission. Most human infections are asymptomatic, a minority present with febrile illness, and a small proportion develop neuroinvasive disease <span class="citation" data-cites="petersen2013wnv">(<a href="references.html#ref-petersen2013wnv" role="doc-biblioref">Petersen, Brault, and Nasci 2013</a>)</span>. Surveillance of both vector abundance and WNV infection prevalence is therefore important for anticipating human risk and guiding public health interventions.</p>
<p>In this analysis, we quantify local entomological risk using the vector index (VI), defined as <span id="eq-vi"><span class="math display">\[
\text{VI} \;=\; \text{abundance} \times \text{infection prevalence}.  
\tag{5.3}\]</span></span> Here, <em>abundance</em> is the mean number of female mosquitoes collected per trap night, and <em>infection prevalence</em> is the estimated proportion of mosquitoes infected with WNV in the vector population. In practice, prevalence is inferred from pooled PCR testing using maximum likelihood estimators for pooled samples <span class="citation" data-cites="cdc_wnv_guidelines_2024">(<a href="references.html#ref-cdc_wnv_guidelines_2024" role="doc-biblioref">Centers for Disease Control and Prevention 2024</a>)</span>. Many operational analyses also report the minimum infection rate and apply either the maximum likelihood estimate or the minimum infection rate when computing the vector index <span class="citation" data-cites="bolling2009vi jones2011vi">(e.g., <a href="references.html#ref-bolling2009vi" role="doc-biblioref">Bolling et al. 2009</a>; <a href="references.html#ref-jones2011vi" role="doc-biblioref">Jones et al. 2011</a>)</span>. In this section, we extend these approaches using model-based geostatistics.</p>
<p>In what follows, we model abundance and infection prevalence for <em>Cx. pipiens</em> as two independent processes and combine the resulting estimates to obtain VI. We return to this assumption and other limitations of the analysis in <a href="#sec-summary-wnv" class="quarto-xref"><span>Section 5.3.3</span></a>.</p>
<section id="sec-abund-model" class="level3" data-number="5.3.1"><h3 data-number="5.3.1" class="anchored" data-anchor-id="sec-abund-model">
<span class="header-section-number">5.3.1</span> Modelling the abundance of <em>Culex pipiens</em>
</h3>
<p>We begin by loading the necessary libraries and the data derived from the <code>vectorsurvR</code> package in R. The original datasets, <code>sample_pools</code> and <code>sample_collections</code>, contain mosquito surveillance data from California, including species identification, collection date, location, pathogen testing results, trap type, and trapping effort. For this case study, these have been processed to produce <code>abund_sma</code> in the <code>RiskMap</code> package, which summarises the abundance of female <em>Culex pipiens</em> within the Sacramento Metropolitan Area (SMA).</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">abund_sma</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">abund_sma</span><span class="op">)</span></span>
<span><span class="co">## 'data.frame':    1551 obs. of  6 variables:</span></span>
<span><span class="co">##  $ lon          : num  -121 -121 -121 -121 -121 ...</span></span>
<span><span class="co">##  $ lat          : num  38.9 38.8 38.9 38.8 38.9 ...</span></span>
<span><span class="co">##  $ total_females: int  1 36 6 31 1 1 1 1 1 4 ...</span></span>
<span><span class="co">##  $ date         : Date, format: "2015-01-02" "2015-01-02" ...</span></span>
<span><span class="co">##  $ trap_nights  : int  15 15 15 8 8 8 8 6 6 6 ...</span></span>
<span><span class="co">##  $ trap_type    : chr  "NJLT" "NJLT" "NJLT" "GRVD" ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The outcome variable for this analysis is <code>total_females</code>, which records the total number of <em>Cx. pipiens</em> captured in a single trap. The variable <code>trap_nights</code> indicates the number of nights the trap was deployed and is used to account for variation in sampling effort across traps. The dataset also records the type of trap used (<code>trap_type</code>), which can influence capture rates. Trap types include New Jersey Light Traps (<code>NJLT</code>), Gravid Traps (<code>GRVD</code>), Mosquito Magnet Traps (<code>MMT</code>), BG-Sentinel Traps (<code>BGSENT</code>), <span class="math inline">\(\text{CO}_2\)</span>-baited traps (<code>CO2</code>), Backpack aspirators (<code>BACKPACK</code>), Lockyer traps (<code>LCKR</code>), and Ovitraps (<code>OVI</code>). These traps differ in their mode of attraction: for example, light traps attract host-seeking females using light, gravid traps target egg-laying females with an infusion lure, <span class="math inline">\(\text{CO}_2\)</span>-baited and BG-Sentinel traps mimic host cues through carbon dioxide and human scent, and backpack or hand-collection methods are opportunistic. Based on average catch per trap-night, we group these into low-yield traps (Backpack, Lockyer, New Jersey Light Trap, Ovitrap), moderate-yield traps (Gravid Trap, Mosquito Magnet), and high-yield traps (<span class="math inline">\(\text{CO}_2\)</span>-baited and BG-Sentinel), providing a more interpretable classification for analysing trap efficiency in subsequent modelling. We thus create the variable <code>trap_group</code> for later use in the model fitting as follows.</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">abund_sma</span> <span class="op">&lt;-</span> <span class="va">abund_sma</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>trap_group <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">trap_type</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"BACKPACK"</span>, <span class="st">"LCKR"</span>, <span class="st">"NJLT"</span>, <span class="st">"OVI"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"low yeild"</span>,</span>
<span>    <span class="va">trap_type</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"GRVD"</span>, <span class="st">"MMT"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"moderate yeild"</span>,</span>
<span>    <span class="va">trap_type</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CO2"</span>, <span class="st">"BGSENT"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"high yield"</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To provide spatial context, we use the <code>rgeoboundaries</code> package to download second-level administrative boundaries (ADM2) for the United States. We extract the boundaries for Placer, El Dorado and Sacrament counties which make up the SMA.</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/wmgeolab/rgeoboundaries">rgeoboundaries</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get California ADM2 units and filter to relevant counties</span></span>
<span><span class="va">ca_counties</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rgeoboundaries/man/geoboundaries.html">geoboundaries</a></span><span class="op">(</span><span class="st">"United States of America"</span>, adm_lvl <span class="op">=</span> <span class="st">"ADM2"</span><span class="op">)</span></span>
<span><span class="va">sma_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Sacramento"</span>, <span class="st">"Placer"</span>, <span class="st">"El Dorado"</span><span class="op">)</span></span>
<span><span class="va">sma_boundaries</span> <span class="op">&lt;-</span> <span class="va">ca_counties</span><span class="op">[</span><span class="va">ca_counties</span><span class="op">$</span><span class="va">shapeName</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html">%in%</a></span> <span class="va">sma_names</span>, <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Given the time span of the data, it is important to consider the potential for temporal variation in mosquito abundance and infection prevalence. Changes in environmental conditions, climate, or vector control efforts may lead to substantial year-to-year fluctuations in mosquito populations. Additionally, if different geographic areas were sampled in different years, this could introduce spatial confounding, making it difficult to disentangle spatial from temporal effects.</p>
<p>The top panel of <a href="#fig-wnv-years" class="quarto-xref">Figure&nbsp;<span>5.14</span></a> reveals that while some spatial variation in sampling locations is present across years, there remains sufficient geographic overlap to enable estimation of temporal trends in mosquito counts. Overall, <em>Cx. pipiens</em> abundance declines over time, although the trend is more pronounced in high-yield traps, while moderate- and low-yield traps exhibit a more variable pattern. The decline in <em>Cx. pipiens</em> likely reflects two key drivers: reduced availability of aquatic breeding sites due to drought, and intensified vector control efforts. <span class="citation" data-cites="bhattachan2023drought">Bhattachan et al. (<a href="references.html#ref-bhattachan2023drought" role="doc-biblioref">2023</a>)</span> reported that <em>Cx. pipiens</em> populations in southern California dropped by about <span class="math inline">\(40%\)</span> during the 2012–2016 drought, linked to water-use restrictions that limited larval habitat in storm drains and catch basins. At the same time, vector control districts expanded targeted interventions. For example, the Sacramento–Yolo district treated over 160,000 drains in 2018 alone <span class="citation" data-cites="sacramento2018annual">(<a href="references.html#ref-sacramento2018annual" role="doc-biblioref">Sacramento-Yolo Mosquito and Vector Control District 2018</a>)</span>, and the statewide response plan formalised such practices as part of integrated mosquito management <span class="citation" data-cites="cdph2025response">(<a href="references.html#ref-cdph2025response" role="doc-biblioref">California Department of Public Health 2025</a>)</span>. For these reasons, our model shall include a covariate for year, with a log-linear effect on the mean number of <em>Cx. pipiens</em>, under the expectation that abundance will show a decreasing trend over time.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Creation of the variable year</span></span>
<span><span class="va">abund_sma</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">abund_sma</span><span class="op">$</span><span class="va">date</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># bbox for coord_sf limits</span></span>
<span><span class="va">bb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">sma_boundaries</span><span class="op">)</span></span>
<span><span class="va">abund_sma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">abund_sma</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lon"</span>,<span class="st">"lat"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span>, remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Panel 1: faceted map, colored by trap_group (scales fixed!)</span></span>
<span><span class="va">p_locs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sma_boundaries</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">abund_sma</span>, color <span class="op">=</span> <span class="st">"black"</span>, alpha <span class="op">=</span> <span class="fl">0.85</span>, size <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">bb</span><span class="op">[</span><span class="st">"xmin"</span><span class="op">]</span>, <span class="va">bb</span><span class="op">[</span><span class="st">"xmax"</span><span class="op">]</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">bb</span><span class="op">[</span><span class="st">"ymin"</span><span class="op">]</span>, <span class="va">bb</span><span class="op">[</span><span class="st">"ymax"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">year</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Trap locations by year"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">13</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span>, face <span class="op">=</span> <span class="st">"bold"</span>, hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Panel 2: average mosquitoes per trap by year &amp; trap_group</span></span>
<span><span class="va">annual_summary</span> <span class="op">&lt;-</span> <span class="va">abund_sma</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">trap_group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    total_mosquitoes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">total_females</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    total_traps <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    mosq_per_trap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">total_traps</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">total_mosquitoes</span> <span class="op">/</span> <span class="va">total_traps</span>, <span class="cn">NA_real_</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">p_pertrap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">annual_summary</span>,</span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">mosq_per_trap</span>, fill <span class="op">=</span> <span class="va">trap_group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Average mosquitoes per trap by year and trap group"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Year"</span>, y <span class="op">=</span> <span class="st">"Mosquitoes per trap"</span>, fill <span class="op">=</span> <span class="st">"Trap group"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">14</span>, face <span class="op">=</span> <span class="st">"bold"</span>, hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine</span></span>
<span><span class="op">(</span><span class="va">p_locs</span> <span class="op">/</span> <span class="va">p_pertrap</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-wnv-years" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-wnv-years-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05_case-studies_files/figure-html/fig-wnv-years-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wnv-years-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.14: Spatial and temporal overview of <em>Cx. pipiens</em> surveillance in the Sacramento Metropolitan Area from 2015 to 2021. The top panel shows the spatial distribution of trap locations for each year. The bottom panel displays the annual average number of mosquitoes captured per trap by trap group, illustrating variation in abundance over time.
</figcaption></figure>
</div>
</div>
</div>
<p>In our analysis, we first assess whether there is residual spatial correlation in mosquito counts by fitting the following Poisson mixed-effects model. Let <span class="math inline">\(Y_i\)</span> denote the number of trapped female <em>Cx. pipiens</em> at location <span class="math inline">\(x_i\)</span> and year <span class="math inline">\(t_i\)</span>. Conditionally on independent and identically distributed zero-mean Gaussian random effects <span class="math inline">\(Z_i \sim \mathcal{N}(0, \sigma^2)\)</span>, we assume: <span class="math display">\[
Y_i \mid Z_i \sim \text{Poisson}(m_i\lambda_i),
\]</span> where <span class="math inline">\(m_i\)</span> is the number of nights during which the trap has been deployed, and <span class="math inline">\(\lambda_i\)</span> is the average number of <span class="math inline">\(Cx. pipiens\)</span> per trap-night, which we model as: <span id="eq-wnv-counts"><span class="math display">\[
\begin{aligned}
\log\{\lambda_i\} = &amp;
\sum_{j=1}^3 d_{j}(x_i, t_i) \beta_j + \beta_4 t_i +
Z_i \\\\
=&amp; \: \mu_i + Z_i,
\end{aligned}
\tag{5.4}\]</span></span> where the <span class="math inline">\(d_{j}(x_i, t_i)\)</span> are binary indicators for the type of trap (<span class="math inline">\(j=1\)</span> corresponding to “high-yield”, <span class="math inline">\(j=2\)</span> to “moderate-yield” and <span class="math inline">\(j=3\)</span> to “low-yield”) and <span class="math inline">\(\mu_i = \sum_{j=1}^3 d_{j}(x_i, t_i) \beta_j + \beta_4 t_i\)</span>. We then fit this model using the <code>glmer</code> function from the <code>lme4</code> package as follows.</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">abund_sma</span><span class="op">$</span><span class="va">loc</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html">nrow</a></span><span class="op">(</span><span class="va">abund_sma</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># In the fit, we scale the variable year to help convergence</span></span>
<span><span class="va">glmer_wvn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span><span class="op">(</span><span class="va">total_females</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">trap_group</span> <span class="op">+</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/scale.html">scale</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html">offset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">trap_nights</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">loc</span><span class="op">)</span>,</span>
<span>                   data <span class="op">=</span> <span class="va">abund_sma</span>, family <span class="op">=</span> <span class="va">poisson</span>,</span>
<span>                   nAGQ <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summary.html">summary</a></span><span class="op">(</span><span class="va">glmer_wvn</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized linear mixed model fit by maximum likelihood (Adaptive
  Gauss-Hermite Quadrature, nAGQ = 100) [glmerMod]
 Family: poisson  ( log )
Formula: 
total_females ~ -1 + trap_group + scale(year) + offset(log(trap_nights)) +  
    (1 | loc)
   Data: abund_sma

      AIC       BIC    logLik -2*log(L)  df.resid 
   5715.5    5742.2   -2852.7    5705.5      1546 

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-0.81365 -0.27049 -0.02063  0.10058  0.40034 

Random effects:
 Groups Name        Variance Std.Dev.
 loc    (Intercept) 2.356    1.535   
Number of obs: 1551, groups:  loc, 1551

Fixed effects:
                         Estimate Std. Error z value Pr(&gt;|z|)    
trap_grouphigh yield      1.68272    0.06643  25.331  &lt; 2e-16 ***
trap_grouplow yeild      -0.41146    0.08736  -4.710 2.48e-06 ***
trap_groupmoderate yeild  0.29882    0.06762   4.419 9.92e-06 ***
scale(year)              -0.20370    0.04206  -4.843 1.28e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            trp_grphy trp_grply trp_grpmy
trp_grplwyl  0.006                       
trp_grpmdry -0.013     0.002             
scale(year) -0.119    -0.014     0.150   </code></pre>
</div>
</div>
<p>The model summary indicates that, as expected, average mosquito counts decline over time. The effects associated with the different levels of <code>trap_group</code> also follow expectations, with high-yield traps having the highest average counts, followed by moderate- and low-yield traps. The relatively large estimate of the variance <span class="math inline">\(\sigma^2\)</span> of the random effect <span class="math inline">\(Z_i\)</span> suggests substantial extra-Poisson variation between traps that is not explained by the yearly decline and the type of trap.</p>
<p>We then use the empirical variogram computed on the estimated <span class="math inline">\(Z_i\)</span> to assess the presence of residual spatial correlation.</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extracting the estimates of the random effects</span></span>
<span><span class="va">wnv_summary</span><span class="op">$</span><span class="va">Z_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/random.effects.html">ranef</a></span><span class="op">(</span><span class="va">glmer_wvn</span><span class="op">)</span><span class="op">$</span><span class="va">loc</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Computing the empirical variogram</span></span>
<span><span class="va">variogram_wnv</span> <span class="op">&lt;-</span> </span>
<span><span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/s_variogram.html">s_variogram</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">wnv_summary</span>, </span>
<span>            variable <span class="op">=</span> <span class="st">"Z_hat"</span>,</span>
<span>            n_permutation <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>            scale_to_km <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>            bins <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">10</span>, length <span class="op">=</span> <span class="fl">15</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We plot the empirical variogram and add the envelope generated under the assumption of absence of spatial correlation.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/plot_s_variogram.html">plot_s_variogram</a></span><span class="op">(</span><span class="va">variogram_wnv</span>, plot_envelope <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-wnv-variogram" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-wnv-variogram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05_case-studies_files/figure-html/fig-wnv-variogram-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wnv-variogram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.15: Empirical variogram (black line) for based on the random effects fitted from the model in <a href="#eq-wnv-counts" class="quarto-xref">Equation&nbsp;<span>5.4</span></a>. The shaded blue area correspond to the envelope of spatial independence at 95% confidence level generated using a permuation test.
</figcaption></figure>
</div>
</div>
</div>
<p>The empirical variogram shown in <a href="#fig-wnv-variogram" class="quarto-xref">Figure&nbsp;<span>5.15</span></a> lies entirely within the simulation envelope, indicating no detectable spatial correlation in the residuals. This lack of evidence may be due to the fact that mosquito abundance is influenced by very local environmental conditions such as vegetation, drainage, or breeding site availability, which vary at spatial scales smaller than 1 km. Since only a few trap locations in the dataset are spaced closely enough to capture such fine-scale variation, the analysis may lack the resolution needed to detect spatial dependence. Therefore, although a geostatistical model is not justified in this case, we can still pursue our objective of estimating the average number of mosquitoes at the sampled locations using the model in <a href="#eq-wnv-counts" class="quarto-xref">Equation&nbsp;<span>5.4</span></a>.</p>
<p>The principles used in this case to derive the predictive distribution of <span class="math inline">\(\lambda(x_i)\)</span>, the expected number of mosquitoes at a sampled location <span class="math inline">\(x_i\)</span>, are similar to those applied in geostatistical models. However, they take a simplified form here because we do not need to account for spatial correlation. The predictive distribution is given by: <span id="eq-pred-distr"><span class="math display">\[
\left[\lambda(x_i) \:\middle | \: Y_i = y_i \right] = \int [Z_i] \, [Y_i \mid Z_i] \, dZ_i
\tag{5.5}\]</span></span> In this expression, <span class="math inline">\([Z_i]\)</span> denotes the density of a Gaussian distribution with mean zero and variance <span class="math inline">\(\sigma^2\)</span>, and <span class="math inline">\([Y_i \mid Z_i]\)</span> is the likelihood from a Poisson model with mean <span class="math inline">\(\lambda(x_i)\)</span>. The integral in <a href="#eq-pred-distr" class="quarto-xref">Equation&nbsp;<span>5.5</span></a> can be computed numerically in R with relative efficiency. This approach also allows for direct simulation from the predictive distribution, enabling us to compute any desired summary statistics.</p>
<p>For this analysis, we use a custom function called <code>simulate_random_effects</code>, which can be copied from <a href="#sec-sim-re" class="quarto-xref"><span>Section 5.4.1</span></a> and pasted into an R script, as it is not included in the <code>RiskMap</code> package. Further details of its implementation are provided in <a href="#sec-sim-re" class="quarto-xref"><span>Section 5.4.1</span></a>; here, we focus solely on the analysis.</p>
<p>Hence, we first simulate 1000 samples from the predictive distribution of <span class="math inline">\(Z_i\)</span> and denote those by <span class="math inline">\(Z_i^{(j)}\)</span>, for <span class="math inline">\(i=1,\ldots,598\)</span>, and <span class="math inline">\(j=1\ldots,1000\)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">samples_z</span> <span class="op">&lt;-</span> <span class="fu">simulate_random_effects</span><span class="op">(</span><span class="va">glmer_wvn</span>, n_sim <span class="op">=</span> <span class="va">n_samples</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then obtain predictive samples for <span class="math inline">\(\lambda(x_i)\)</span> by applying the exponential transformation to the linear predictor <span class="math inline">\(\hat{\mu}_i + Z_{i}^{(j)}\)</span>, where in <span class="math inline">\(\hat{\mu}_i\)</span> we have plugged in the maximum likelihood estimates of the regression coefficients.</p>
<p>The predictions shown in <a href="#fig-mosq-predictions" class="quarto-xref">Figure&nbsp;<span>5.16</span></a> indicate that the pattern of the mean number of mosquitoes across sampled locations is broadly comparable across time.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create dataframe</span></span>
<span><span class="va">mosq_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html">nrow</a></span><span class="op">(</span><span class="va">abund_sma</span><span class="op">)</span>,</span>
<span>  mean <span class="op">=</span> <span class="va">mosq_mean</span>,</span>
<span>  lower <span class="op">=</span> <span class="va">mosq_lower</span>,</span>
<span>  upper <span class="op">=</span> <span class="va">mosq_upper</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Adding trap_group and year</span></span>
<span><span class="va">mosq_df</span><span class="op">$</span><span class="va">trap_group</span> <span class="op">&lt;-</span> <span class="va">abund_sma</span><span class="op">$</span><span class="va">trap_group</span><span class="op">[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/match.html">match</a></span><span class="op">(</span><span class="va">mosq_df</span><span class="op">$</span><span class="va">id</span>, <span class="va">abund_sma</span><span class="op">$</span><span class="va">loc</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">mosq_df</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;-</span> <span class="va">abund_sma</span><span class="op">$</span><span class="va">year</span><span class="op">[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/match.html">match</a></span><span class="op">(</span><span class="va">mosq_df</span><span class="op">$</span><span class="va">id</span>, <span class="va">abund_sma</span><span class="op">$</span><span class="va">loc</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Rearranging the data-frame in increasing order based</span></span>
<span><span class="co"># on the mean number of mosquitoes</span></span>
<span><span class="co"># by year and trap group</span></span>
<span></span>
<span><span class="va">mosq_df</span> <span class="op">&lt;-</span> <span class="va">mosq_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">trap_group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">mean</span>, .by_group <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>x_order <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org">scales</a></span><span class="op">)</span>  <span class="co"># Used for reporting the y-axis on the log-scale</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">mosq_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_order</span>, y <span class="op">=</span> <span class="va">mean</span>,</span>
<span>                    color <span class="op">=</span> <span class="va">trap_group</span>, fill <span class="op">=</span> <span class="va">trap_group</span>, group <span class="op">=</span> <span class="va">trap_group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.20</span>, linewidth <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op">(</span></span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span>, <span class="fl">100</span>, <span class="fl">1000</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/label_number.html">label_number</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">year</span>, scales <span class="op">=</span> <span class="st">"free_x"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Locations (ordered within trap group)"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Predicted no. mosquitoes (per trap-night)"</span>,</span>
<span>       color <span class="op">=</span> <span class="st">"Trap group"</span>, fill <span class="op">=</span> <span class="st">"Trap group"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-mosq-predictions" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-mosq-predictions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05_case-studies_files/figure-html/fig-mosq-predictions-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mosq-predictions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.16: Predictive mean number of mosquitoes per trap-night for each location with 95% prediction intervals, stratified by year and trap group. Within each panel, locations are ordered by increasing predicted mean abundance. Shaded areas represent 95% prediction intervals for the number of mosquitoes at sampled locations. The y-axis is on a log scale, with tick labels shown on the original scale.
</figcaption></figure>
</div>
</div>
</div>
<p>To understand whether we can trust the inferences shown in <a href="#fig-mosq-predictions" class="quarto-xref">Figure&nbsp;<span>5.16</span></a>, we use the AnPIT graphical check as used in the previous case studies. Since we are not using a geostatistical model in this case, we will use a simplified implementation of the AnPIT for the Poisson mixed model fitted in this section. The function that we use to compute the AnPIT is called <code>anpit_wnv</code> and has been implemented specifically for this case study. For more details on its implementation, read <a href="#sec-nonspat-anpit" class="quarto-xref"><span>Section 5.4.2</span></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">wnv_anpit_res</span> <span class="op">&lt;-</span> <span class="fu">anpit_wnv</span><span class="op">(</span><span class="va">glmer_wvn</span>, test_prop <span class="op">=</span> <span class="fl">0.30</span>, nsim <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the code above the AnPIT is computed using a test-set corresponding to <span class="math inline">\(30\%\)</span> of the original data-set. The number of simulation used to approximate the AnPIT is set to 1000. Finally, we plot the results.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">plot_anpit</span><span class="op">(</span><span class="va">wnv_anpit_res</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-wnv-anpit" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-wnv-anpit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05_case-studies_files/figure-html/fig-wnv-anpit-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wnv-anpit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.17: Average non-randomized probability integral transform (AnPIT) for the Poisson mixed model specified in <a href="#eq-wnv-counts" class="quarto-xref">Equation&nbsp;<span>5.4</span></a>. The dahsed line corresponds to the identity line.
</figcaption></figure>
</div>
</div>
</div>
<p>The results shown in <a href="#fig-wnv-anpit" class="quarto-xref">Figure&nbsp;<span>5.17</span></a> an AnPIT curve from the fitted Poisson mixed model in <a href="#fig-wnv-anpit" class="quarto-xref">Figure&nbsp;<span>5.17</span></a> that closely follows the identity line. Hence, we can conclude that we find no evidence against the compatibility of the model in <a href="#fig-wnv-anpit" class="quarto-xref">Figure&nbsp;<span>5.17</span></a> with the data.</p>
</section><section id="sec-wnv-model" class="level3" data-number="5.3.2"><h3 data-number="5.3.2" class="anchored" data-anchor-id="sec-wnv-model">
<span class="header-section-number">5.3.2</span> Modelling West Nile virus infection with pooled mosquito testing</h3>
<p>Pooled testing is widely used in mosquito surveillance. Rather than testing each mosquito individually for a pathogen, multiple mosquitoes collected from the same location and week are combined into a single pool and assayed by PCR. The test returns positive if at least one mosquito in the pool is infected and negative otherwise. This approach greatly reduces laboratory time and costs, but statistical analysis must account for variation in pool size, as larger pools have a higher probability of testing positive even if the underlying infection risk per mosquito is low.</p>
<p>We illustrate this using West Nile virus (WNV) PCR results from pools of female <em>Culex pipiens</em> collected in the Sacramento Metropolitan Area, available in the <code>infect_sma</code> data set of the <code>RiskMap</code> package.</p>
<p>Let <span class="math inline">\(k_i\)</span> be the number of mosquitoes in pool <span class="math inline">\(i\)</span>. Define the binary outcome <span class="math inline">\(Y_i=1\)</span> if the PCR test for pool <span class="math inline">\(i\)</span> is positive and <span class="math inline">\(Y_i=0\)</span> otherwise. Conditional on a stationary and isotropic spatial Gaussian process <span class="math inline">\(S(x_i)\)</span>, the probability that pool <span class="math inline">\(i\)</span> is positive is<br><span id="eq-wnv-pos-model"><span class="math display">\[
P(Y_i=1\mid S(x_i))=1-\left[1-p(x_i)\right]^{k_i},
\tag{5.6}\]</span></span> where <span class="math inline">\(p(x_i)\)</span> is the probability that an individual mosquito at location <span class="math inline">\(x_i\)</span> is infected with WNV. We model <span class="math inline">\(p(x_i)\)</span> using a logit-linear form<br><span id="eq-wnv-lp"><span class="math display">\[
\log\left\{\frac{p(x_i)}{1-p(x_i)}\right\}=\beta+S(x_i),
\tag{5.7}\]</span></span> which explicitly incorporates the dependence of the pool positivity probability on pool size <span class="math inline">\(k_i\)</span>.</p>
<p>We must emphasize that in the <code>infect_sma</code> data set the pool sizes <span class="math inline">\(k_i\)</span> are not taken directly from laboratory records but are estimated. For each pool, mosquito collections from nearby locations in the same epidemiological week and within a given spatial radius, for example 2 km, are identified. The total number of female mosquitoes from these nearby collections, denoted <span class="math inline">\(T_{\text{near}}\)</span>, is divided by the number of pools formed from the same nearby collections in that week, denoted <span class="math inline">\(m_{\text{near}}\)</span>, to obtain an estimate of pool size. The estimated pool size is therefore<br><span class="math display">\[
\widehat{k}_i=\text{round}\left(\max\{1,T_{\text{near}}/m_{\text{near}}\}\right),
\]</span> and a default conservative value, such as 25, is used if no nearby collections are available.</p>
<p>The data comprise 596 responses, of which only 18 pools test positive. This very low prevalence constrains our modelling choices, for example by limiting the feasibility of incorporating temporal dynamics. As a result, the model in <a href="#eq-wnv-pos-model" class="quarto-xref">Equation&nbsp;<span>5.6</span></a> represents the simplest specification that can still capture spatial correlation, under the simplifying assumption that WNV risk remains relatively stable over the study period. Furthermore, because there is only a single binary outcome per location, overdispersion cannot occur (see box “Why Bernoulli extra‐variation does not exist” in Section 5.1.1 of <span class="citation" data-cites="diggleBook2019">P. J. Diggle and Giorgi (<a href="references.html#ref-diggleBook2019" role="doc-biblioref">2019</a>)</span>), and the empirical variogram provides limited value for assessing spatial correlation due to its high uncertainty in this context. We therefore proceed directly to fitting a geostatistical model and assess the estimate of the spatial correlation parameter, which quantifies the strength and range of spatial dependence in the data.</p>
<p>We then proceed in R as follows. We first load the data and convert them into an <code>sf</code> object with the appropriate UTM projection.</p>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">infect_sma</span><span class="op">)</span></span>
<span></span>
<span><span class="va">infect_sma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">infect_sma</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span>
<span><span class="va">wnv_crs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/propose_utm.html">propose_utm</a></span><span class="op">(</span><span class="va">infect_sma</span><span class="op">)</span></span>
<span><span class="va">infect_sma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">infect_sma</span>, <span class="va">wnv_crs</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We define the inverse link function based on <a href="#eq-wnv-pos-model" class="quarto-xref">Equation&nbsp;<span>5.6</span></a> and <a href="#eq-wnv-lp" class="quarto-xref">Equation&nbsp;<span>5.7</span></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">invlink_wnv</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="va">infect_sma</span><span class="op">$</span><span class="va">est_pool_n</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then fit the model by passing the inverse link function to the argument <code>invlink</code> within the <code>glgpm</code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">inf_fit</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/glgpm.html">glgpm</a></span><span class="op">(</span><span class="va">wnv_pos</span> <span class="op">~</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/gp.html">gp</a></span><span class="op">(</span><span class="va">lon</span>,<span class="va">lat</span><span class="op">)</span>,</span>
<span>        crs <span class="op">=</span> <span class="va">wnv_crs</span>,</span>
<span>        family <span class="op">=</span> <span class="st">"binomial"</span>,</span>
<span>        invlink <span class="op">=</span> <span class="va">invlink_wnv</span>,</span>
<span>        data<span class="op">=</span><span class="va">infect_sma</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we examine the the summary of the fitted model.</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summary.html">summary</a></span><span class="op">(</span><span class="va">inf_fit</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
glgpm(formula = wnv_pos ~ gp(lon, lat), data = infect_sma, family = "binomial", 
    invlink = invlink_wnv, crs = wnv_crs, par0 = coef(inf_fit), 
    start_pars = coef(inf_fit))

Binomial geostatistical linear model
Link: custom 
Inverse link function = 1 - (1 - exp(x)/(1 + exp(x)))^infect_sma$est_pool_n 
 
'Lower limit' and 'Upper limit' are the limits of the 95% confidence level intervals

Regression coefficients
            Estimate Lower limit Upper limit  StdErr z.value  p.value    
(Intercept)  -4.9648     -7.0190     -2.9105  1.0481 -4.7369 2.17e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Spatial Gaussian process
Matern covariance parameters (kappa=0.5)
                     Estimate Lower limit Upper limit
Spatial process var.   5.9851      1.5402      23.259
Spatial corr. scale   24.5370      9.1354      65.905
Variance of the nugget effect fixed at 0

Log-likelihood: 0.4061681</code></pre>
</div>
</div>
<p>The fitted model indicates a substantial spatial residual component, with the estimated scale parameter corresponding to a practical range of approximately 70 km. This represents a long‐range correlation relative to the spatial extent of the study area.</p>
<p>We first carry out predictions over a regular grid covering the area of the data collection efforts from 2015 to 2021. To achieve this, we create a regular grid 250 meters within the convex hull boundaries obtained by the full set of locations sampled from 2015 to 2021 (see <a href="#fig-wnv-convex-hull" class="quarto-xref">Figure&nbsp;<span>5.18</span></a>).</p>
<div class="cell">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Compute convex hull</span></span>
<span><span class="va">geom_union</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union</a></span><span class="op">(</span><span class="va">inf_fit</span><span class="op">$</span><span class="va">data_sf</span><span class="op">)</span></span>
<span><span class="va">chull_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_convex_hull</a></span><span class="op">(</span><span class="va">geom_union</span><span class="op">)</span></span>
<span><span class="va">chull_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>geometry <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="va">chull_sf</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">inf_fit</span><span class="op">$</span><span class="va">data_sf</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot points and convex hull</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">inf_fit</span><span class="op">$</span><span class="va">data_sf</span>, color <span class="op">=</span> <span class="st">"blue"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">chull_sf</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"red"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-wnv-convex-hull" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-wnv-convex-hull-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05_case-studies_files/figure-html/fig-wnv-convex-hull-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wnv-convex-hull-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.18: Sampling locations of pooled mosquito collections testing for West Nile virus in the Sacramento Metropolitan Area (blue points) and their convex hull (red outline) defining the minimal polygon enclosing all sites.
</figcaption></figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">grid_pred_sac</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/create_grid.html">create_grid</a></span><span class="op">(</span><span class="va">chull_sf</span>, spat_res <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_S_inf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/pred_over_grid.html">pred_over_grid</a></span><span class="op">(</span><span class="va">inf_fit</span>,</span>
<span>                             grid_pred <span class="op">=</span> <span class="va">grid_pred_sac</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_inf_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/pred_target_grid.html">pred_target_grid</a></span><span class="op">(</span><span class="va">pred_S_inf</span>,</span>
<span>                                  f_target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>prev <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-wnv-pred-map" class="quarto-xref">Figure&nbsp;<span>5.19</span></a> displays the predictive mean of <span class="math inline">\(p(x)\)</span> over the regular grid. Overall, the predicted prevalence of WNV is very low across the study area, with a small zone in the south‐west showing a relatively higher value of approximately <span class="math inline">\(0.40\%\)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">pred_inf_grid</span>,<span class="st">"prev"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-wnv-pred-map" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-wnv-pred-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05_case-studies_files/figure-html/fig-wnv-pred-map-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wnv-pred-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.19: Map of the predictive mean for the prevalence of West Nile Virus infection among female <em>Culex pipiens</em> mosquitoes in an area of the Sacramento Metropolitan Area.
</figcaption></figure>
</div>
</div>
</div>
<p>Finally, we predict the vector index as defined in <a href="#eq-vi" class="quarto-xref">Equation&nbsp;<span>5.3</span></a>. Because <em>Cx. pipiens</em> abundance and WNV infection prevalence have been modelled as independent processes, the predictions from the two models can be combined directly. Specifically, for each location in the <code>abund_sma</code> data set, we take predictive samples of WNV prevalence and multiply them by the corresponding predictive samples of the mean number of female <em>Cx. pipiens</em> per trap‐night. This yields predictive samples of the vector index, which can then be summarised or mapped as required. In R, this is implemented as follows.</p>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Converting the abund_sma into an sf object</span></span>
<span><span class="va">loc_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">abund_sma</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lon"</span>,<span class="st">"lat"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span>, crs <span class="op">=</span> <span class="va">wnv_crs</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prediction of the sptial process S(x) over the locations of the </span></span>
<span><span class="co"># abund_sma data-set</span></span>
<span><span class="va">pred_S_loc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://claudiofronterre.github.io/RiskMap/reference/pred_over_grid.html">pred_over_grid</a></span><span class="op">(</span><span class="va">inf_fit</span>, grid_pred <span class="op">=</span> <span class="va">loc_pred</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Computation of the samples for West Nile Virus prevalence</span></span>
<span><span class="va">beta_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">inf_fit</span><span class="op">)</span><span class="op">$</span><span class="va">beta</span></span>
<span><span class="va">prev_inf_samples</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">beta_hat</span> <span class="op">+</span></span>
<span>                                 <span class="va">pred_S_loc</span><span class="op">$</span><span class="va">S_samples</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Predictive samples for the vector index (VI)</span></span>
<span><span class="va">vi_samples</span> <span class="op">&lt;-</span> <span class="va">mean_nmosq</span> <span class="op">*</span> <span class="va">prev_inf_samples</span></span>
<span></span>
<span><span class="co"># Calculate predictive summaries for VI</span></span>
<span><span class="va">vi_mean</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">vi_samples</span>, <span class="fl">1</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">vi_lower</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">vi_samples</span>, <span class="fl">1</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fl">0.025</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">vi_upper</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">vi_samples</span>, <span class="fl">1</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fl">0.975</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build dataframe directly from original abund_sma order</span></span>
<span><span class="va">vi_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  id    <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html">nrow</a></span><span class="op">(</span><span class="va">abund_sma</span><span class="op">)</span>,</span>
<span>  mean  <span class="op">=</span> <span class="va">vi_mean</span>,</span>
<span>  lower <span class="op">=</span> <span class="va">vi_lower</span>,</span>
<span>  upper <span class="op">=</span> <span class="va">vi_upper</span>,</span>
<span>  trap_group <span class="op">=</span> <span class="va">abund_sma</span><span class="op">$</span><span class="va">trap_group</span>,</span>
<span>  year       <span class="op">=</span> <span class="va">abund_sma</span><span class="op">$</span><span class="va">year</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Order within (year, trap_group) by increasing mean</span></span>
<span><span class="va">vi_df</span> <span class="op">&lt;-</span> <span class="va">vi_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">trap_group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">mean</span>, .by_group <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>x_order <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Several U.S. programs consider a vector index (VI) of 0.75 or higher as indicative of likely human transmission and use this threshold to trigger intensified control measures <span class="citation" data-cites="cityofboulder_wnv_vectorindex_2025 fortcollins_localdata_vi_2025 fortcollins_wnv_program_manual_2014">(<a href="references.html#ref-cityofboulder_wnv_vectorindex_2025" role="doc-biblioref">City of Boulder 2025</a>; <a href="references.html#ref-fortcollins_localdata_vi_2025" role="doc-biblioref">City of Fort Collins 2025</a>, <a href="references.html#ref-fortcollins_wnv_program_manual_2014" role="doc-biblioref">2014</a>)</span>. In <a href="#fig-vi" class="quarto-xref">Figure&nbsp;<span>5.20</span></a>, the dashed red line marks this operational threshold for elevated WNV risk. We observe that only in few instances before the year 2020 the predicted VI exceeded this threshold. We thus conclude that between 2015 and 2021 the risk for WNV based as measured by the VI was relatively low in the SMA.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">vi_df</span>,</span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_order</span>, y <span class="op">=</span> <span class="va">mean</span>,</span>
<span>           color <span class="op">=</span> <span class="va">trap_group</span>, fill <span class="op">=</span> <span class="va">trap_group</span>, group <span class="op">=</span> <span class="va">trap_group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0.75</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span>, linewidth <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.20</span>, linewidth <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op">(</span></span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_number.html">label_number</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">year</span>, scales <span class="op">=</span> <span class="st">"free_x"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Locations (ordered within trap group)"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Vector index (infected mosquitoes per trap night)"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"West Nile Virus"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Trap group"</span>, fill <span class="op">=</span> <span class="st">"Trap group"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-vi" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-vi-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="05_case-studies_files/figure-html/fig-vi-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-vi-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5.20: Predicted vector index (infected mosquitoes per trap night) by location, stratified by year and trap group. Locations within each panel are ordered by increasing predicted VI. Shaded bands represent 95% prediction intervals. The dashed red line marks the 0.75 threshold commonly used in U.S. West Nile virus surveillance to indicate elevated transmission risk. The y-axis is on a log scale with labels shown on the original scale.
</figcaption></figure>
</div>
</div>
</div>
</section><section id="sec-summary-wnv" class="level3" data-number="5.3.3"><h3 data-number="5.3.3" class="anchored" data-anchor-id="sec-summary-wnv">
<span class="header-section-number">5.3.3</span> Summary and conclusions</h3>
<p>In this analysis, our predictive target was the vector index (VI) in <a href="#eq-vi" class="quarto-xref">Equation&nbsp;<span>5.3</span></a>. Our proposed modelling approach was based on the assumption that abundance and infection prevalence are two independent processes. Treating prevalence as independent of vector density is a practical simplification. It can be reasonable when the fraction of infected mosquitoes at a place and time is driven mainly by host infection dynamics, temperature dependent incubation, and mosquito age structure, whereas trap counts reflect local production, as well as catchability. An interesting result of our analysis is that abundance showed no detectable residual spatial correlation, while infection prevalence did. The empirical variogram of random effects from the abundance model lay within the envelope in <a href="#fig-wnv-variogram" class="quarto-xref">Figure&nbsp;<span>5.15</span></a>, suggesting that remaining variation after accounting for year and trap group is dominated by micro scale heterogeneity and trap specific noise at distances smaller than those represented by the sampling design. In contrast, the infection model estimated a spatial scale of correlation that is large relative to the study area, and may be explained in terms of processes that operate over broader extents, such as movement and aggregation of avian reservoir hosts, shared urban landscape features, and temperature fields. However, as a result of the disparity in the scales of spatial dependence for the two processes and the inability of the model for abundance to interpolate at unobserved locations, we could only predict the VI at the observed locations of the abundance data.</p>
<p>All West Nile virus data analysed in this section originate from the <code>vectorsurvR</code> workflow and are simulated rather than observed in the field. The <code>vectorsurvR</code> package provides a framework for generating realistic mosquito surveillance data by mimicking the structure, spatial layout, and sampling frequency of actual surveillance programmes. Hence, the results presented here should not be used to draw scientific conclusions about West Nile virus in the Sacramento Metropolitan Area. In addition to this, pool size is a key input when analysing pooled infection outcomes (see Exercise 6 below) and strongly affects the predictive inferences in prevalence (see Exercise 6 below). In this case study we used an estimated pool size (denoted in the text above by <span class="math inline">\(k_i\)</span>) rather than laboratory recorded counts, which adds additional uncertainty that we did not propagate. The results illustrate modelling steps, diagnostics, and how to combine components to obtain the vector index, which remains useful for pedagogical purposes.</p>
</section></section><section id="theory" class="level2" data-number="5.4"><h2 data-number="5.4" class="anchored" data-anchor-id="theory">
<span class="header-section-number">5.4</span> Theory</h2>
<p>In the following two sections we explain the coding of the functions used in <a href="#sec-abund-model" class="quarto-xref"><span>Section 5.3.1</span></a>. These functions are not part of any existing R package. They are written for clarity rather than computational efficiency, and they are tailored to the current modelling example without attempts at generalisation. The aim is to present code that is correct and easy to follow, so that by understanding each component you can adapt and extend it to fit your own modelling requirements and learn more efficient implementations your own.</p>
<section id="sec-sim-re" class="level3" data-number="5.4.1"><h3 data-number="5.4.1" class="anchored" data-anchor-id="sec-sim-re">
<span class="header-section-number">5.4.1</span> Simulating from the predictive of non-spatial mixed models</h3>
<p>In this section, we provide a detailed explanation of the simulate_random_effects function used in this case study.</p>
<p>Simulating from the conditional distribution of <span class="math inline">\(Z_i\)</span>​ given the observed counts <span class="math inline">\(y_i\)</span>​ under a Poisson mixed model can be done in several ways in R, often more efficiently than the approach illustrated here. However, our goal is not to present the fastest implementation, but to offer a transparent, step-by-step example. This level of detail is useful for readers who wish to understand the underlying computations, or who may want to adapt and generalize the function for other analyses. From a pedagogical perspective, dissecting such a function provides a hands-on introduction to computational methods for generalized linear mixed models and illustrates ideas that are extended in more advanced Bayesian and likelihood-based approaches.</p>
<p>The function is reproduced below:</p>
<div class="cell">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">simulate_random_effects</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">nsim</span> <span class="op">=</span> <span class="fl">1000</span>, <span class="va">grid_range</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span>, <span class="va">grid_length</span> <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Extract fixed effects and RE variance</span></span>
<span>  <span class="va">beta_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/fixed.effects.html">fixef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span>  <span class="va">sigma2_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/VarCorr.html">VarCorr</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Extract model frame and grouping</span></span>
<span>  <span class="va">mf</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">@</span><span class="va">frame</span></span>
<span>  <span class="va">group_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/random.effects.html">ranef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">group_ids</span> <span class="op">&lt;-</span> <span class="va">mf</span><span class="op">[[</span><span class="va">group_var</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">unique_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html">unique</a></span><span class="op">(</span><span class="va">group_ids</span><span class="op">)</span></span>
<span>  <span class="va">ngroups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">unique_groups</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Design matrix for fixed effects</span></span>
<span>  <span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Create result matrix</span></span>
<span>  <span class="va">u_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">ngroups</span>, ncol <span class="op">=</span> <span class="va">nsim</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">u_samples</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">unique_groups</span></span>
<span>  </span>
<span>  <span class="co"># Log-predictive density function for one group</span></span>
<span>  <span class="va">log_pd_u</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">u</span>, <span class="va">y_j</span>, <span class="va">D_j</span>, <span class="va">beta_hat</span>, <span class="va">sigma2_hat</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">eta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">D_j</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">beta_hat</span><span class="op">)</span> <span class="op">+</span> <span class="va">u</span></span>
<span>    <span class="va">loglik</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">dpois</a></span><span class="op">(</span><span class="va">y_j</span>, lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">eta</span><span class="op">)</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">logprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">u</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">sigma2_hat</span><span class="op">)</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">loglik</span> <span class="op">+</span> <span class="va">logprior</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># For each group, compute predictive samples of u_j</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">unique_groups</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">gid</span> <span class="op">&lt;-</span> <span class="va">unique_groups</span><span class="op">[</span><span class="va">j</span><span class="op">]</span></span>
<span>    <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">group_ids</span> <span class="op">==</span> <span class="va">gid</span><span class="op">)</span></span>
<span>    <span class="va">y_j</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">@</span><span class="va">resp</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span></span>
<span>    <span class="va">D_j</span> <span class="op">&lt;-</span> <span class="va">D</span><span class="op">[</span><span class="va">idx</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># Create grid and compute log predictive density</span></span>
<span>    <span class="va">u_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">grid_range</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">grid_range</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, length.out <span class="op">=</span> <span class="va">grid_length</span><span class="op">)</span></span>
<span>    <span class="va">logdens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">u_grid</span>, <span class="va">log_pd_u</span>, y_j <span class="op">=</span> <span class="va">y_j</span>, D_j <span class="op">=</span> <span class="va">D_j</span>,</span>
<span>                      beta_hat <span class="op">=</span> <span class="va">beta_hat</span>, sigma2_hat <span class="op">=</span> <span class="va">sigma2_hat</span><span class="op">)</span></span>
<span>    <span class="va">logdens</span> <span class="op">&lt;-</span> <span class="va">logdens</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">logdens</span><span class="op">)</span></span>
<span>    <span class="va">dens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">logdens</span><span class="op">)</span></span>
<span>    <span class="va">pdf_u</span> <span class="op">&lt;-</span> <span class="va">dens</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">dens</span><span class="op">)</span></span>
<span>    <span class="va">cdf_u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">pdf_u</span><span class="op">)</span></span>
<span>    <span class="va">cdf_u</span> <span class="op">&lt;-</span> <span class="va">cdf_u</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">cdf_u</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Drop duplicated CDF values (necessary for approx)</span></span>
<span>    <span class="va">keep</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span><span class="op">(</span><span class="va">cdf_u</span><span class="op">)</span></span>
<span>    <span class="va">u_samples</span><span class="op">[</span><span class="va">j</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/approxfun.html">approx</a></span><span class="op">(</span><span class="va">cdf_u</span><span class="op">[</span><span class="va">keep</span><span class="op">]</span>, <span class="va">u_grid</span><span class="op">[</span><span class="va">keep</span><span class="op">]</span>, xout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">nsim</span><span class="op">)</span>, rule <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="va">y</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">u_samples</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Below, we break down the function step by step.</p>
<p>First, we extract the fixed-effect estimates and the random effect variance from the fitted model:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">beta_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/fixed.effects.html">fixef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>                        <span class="co"># Fixed effect coefficients (MLEs)</span></span>
<span><span class="va">sigma2_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/VarCorr.html">VarCorr</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="co"># Estimated variance of random intercepts</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These parameters will be treated as known when simulating the predictive of the random effects. Next, we identify the grouping variable for the random effects and compute the fixed-effects design matrix:</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mf</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">@</span><span class="va">frame</span>                      <span class="co"># Model frame containing the data</span></span>
<span><span class="va">group_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/random.effects.html">ranef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>     <span class="co"># Name of the grouping variable</span></span>
<span><span class="va">group_ids</span> <span class="op">&lt;-</span> <span class="va">mf</span><span class="op">[[</span><span class="va">group_var</span><span class="op">]</span><span class="op">]</span>            <span class="co"># Group ID for each observation</span></span>
<span><span class="va">unique_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html">unique</a></span><span class="op">(</span><span class="va">group_ids</span><span class="op">)</span>      <span class="co"># Unique group levels</span></span>
<span><span class="va">ngroups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">unique_groups</span><span class="op">)</span>        <span class="co"># Number of groups</span></span>
<span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>                <span class="co"># Fixed-effects design matrix</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here, <code>group_ids</code> associates each observation with its random effect, and <code>D</code> is the design matrix used to compute the linear predictor for the fixed effects.</p>
<p>We initialize a results matrix to store the predictive samples for each group:</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">u_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">ngroups</span>, ncol <span class="op">=</span> <span class="va">nsim</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">u_samples</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">unique_groups</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Each row corresponds to a group and each column to a predictive sample of <span class="math inline">\(u_j\)</span>.</p>
<p>We then define a helper function to compute the unnormalized log-predictive density of a single random effect <span class="math inline">\(u_j\)</span> given the data for that group:</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">log_pd_u</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">u</span>, <span class="va">y_j</span>, <span class="va">D_j</span>, <span class="va">beta_hat</span>, <span class="va">sigma2_hat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">eta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">D_j</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">beta_hat</span><span class="op">)</span> <span class="op">+</span> <span class="va">u</span>      <span class="co"># Linear predictor</span></span>
<span>  <span class="va">loglik</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">dpois</a></span><span class="op">(</span><span class="va">y_j</span>, lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">eta</span><span class="op">)</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>   <span class="co"># Poisson likelihood</span></span>
<span>  <span class="va">logprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">u</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">sigma2_hat</span><span class="op">)</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># Normal prior</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">loglik</span> <span class="op">+</span> <span class="va">logprior</span><span class="op">)</span>                   <span class="co"># Unnormalized log-posterior</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This combines the Poisson likelihood for the observations in group <span class="math inline">\(j\)</span> with the Gaussian prior on the random effect.</p>
<p>For each group, we first compute the predictive on a grid of <span class="math inline">\(u\)</span> values, then normalize it to form a cumulative distribution function (CDF), and finally draw samples using inverse CDF sampling.</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">unique_groups</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">gid</span> <span class="op">&lt;-</span> <span class="va">unique_groups</span><span class="op">[</span><span class="va">j</span><span class="op">]</span></span>
<span>  <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">group_ids</span> <span class="op">==</span> <span class="va">gid</span><span class="op">)</span></span>
<span>  <span class="va">y_j</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">@</span><span class="va">resp</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span></span>
<span>  <span class="va">D_j</span> <span class="op">&lt;-</span> <span class="va">D</span><span class="op">[</span><span class="va">idx</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Step 1: Compute predictive density on a grid</span></span>
<span>  <span class="va">u_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">grid_range</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">grid_range</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, length.out <span class="op">=</span> <span class="va">grid_length</span><span class="op">)</span></span>
<span>  <span class="va">logdens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">u_grid</span>, <span class="va">log_pd_u</span>, y_j <span class="op">=</span> <span class="va">y_j</span>, D_j <span class="op">=</span> <span class="va">D_j</span>,</span>
<span>                    beta_hat <span class="op">=</span> <span class="va">beta_hat</span>, sigma2_hat <span class="op">=</span> <span class="va">sigma2_hat</span><span class="op">)</span></span>
<span>  <span class="va">logdens</span> <span class="op">&lt;-</span> <span class="va">logdens</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">logdens</span><span class="op">)</span>    <span class="co"># Stabilize exponentiation</span></span>
<span>  <span class="va">dens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">logdens</span><span class="op">)</span></span>
<span>  <span class="va">pdf_u</span> <span class="op">&lt;-</span> <span class="va">dens</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">dens</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Step 2: Compute cumulative distribution</span></span>
<span>  <span class="va">cdf_u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">pdf_u</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pdf_u</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Step 3: Sample from predictive using inverse CDF</span></span>
<span>  <span class="va">keep</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span><span class="op">(</span><span class="va">cdf_u</span><span class="op">)</span>  <span class="co"># Remove duplicates to avoid interpolation warnings</span></span>
<span>  <span class="va">u_samples</span><span class="op">[</span><span class="va">j</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/approxfun.html">approx</a></span><span class="op">(</span><span class="va">cdf_u</span><span class="op">[</span><span class="va">keep</span><span class="op">]</span>, <span class="va">u_grid</span><span class="op">[</span><span class="va">keep</span><span class="op">]</span>, xout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">nsim</span><span class="op">)</span>, rule <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="va">y</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The function uses a grid-based approximation, evaluating the predictive on a fine grid to avoid running MCMC for these one-dimensional distributions.<br>
The computation <code>logdens - max(logdens)</code> provides numerical stabilization, preventing underflow when exponentiating very small log-likelihood values.<br>
Finally, the function <code><a href="https://rdrr.io/r/stats/approxfun.html">approx()</a></code> performs inverse transform sampling. This works by first computing the CDF of the random effect on a fine grid, which maps each candidate value of the random effect to its cumulative probability. We then draw random numbers from a uniform distribution on <span class="math inline">\([0,1]\)</span> and use <code><a href="https://rdrr.io/r/stats/approxfun.html">approx()</a></code> to interpolate the CDF to find the corresponding values of the random effect. In other words, we are transforming uniform draws into samples from the desired predictive distribution by inverting the CDF numerically, a method commonly known as the inverse transform method; for a thorough explanation of this approach, <span class="citation" data-cites="robert2004">Robert and Casella (<a href="references.html#ref-robert2004" role="doc-biblioref">2004</a>)</span> is a highly recommended reading.</p>
<p>As a self-directed learning activity for readers interested in the computational aspects of model fitting, we invite them to work through Exercise 4 at the end of this chapter.</p>
</section><section id="sec-nonspat-anpit" class="level3" data-number="5.4.2"><h3 data-number="5.4.2" class="anchored" data-anchor-id="sec-nonspat-anpit">
<span class="header-section-number">5.4.2</span> The non-randomized probability integral transform for non-spatial models</h3>
<p>The function for generating and plotting the average non-randomized probability transform (AnPIT) used in <a href="#sec-abund-model" class="quarto-xref"><span>Section 5.3.1</span></a> are given below.</p>
<div class="cell">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">anpit_wnv</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">test_prop</span> <span class="op">=</span> <span class="fl">0.25</span>, <span class="va">nsim</span> <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>                      <span class="va">u_grid</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">101</span><span class="op">)</span>, <span class="va">seed</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">model</span>, <span class="st">"glmerMod"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">test_prop</span> <span class="op">&lt;=</span> <span class="fl">0</span> <span class="op">||</span> <span class="va">test_prop</span> <span class="op">&gt;=</span> <span class="fl">1</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"test_prop must be in (0,1)"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Extract pieces from the fitted model</span></span>
<span>  <span class="va">D</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>                 <span class="co"># fixed-effects design as used at fit</span></span>
<span>  <span class="va">off</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">@</span><span class="va">frame</span><span class="op">$</span><span class="va">`offset(log(trap_nights))`</span></span>
<span>  <span class="va">y</span>   <span class="op">&lt;-</span> <span class="va">model</span><span class="op">@</span><span class="va">resp</span><span class="op">$</span><span class="va">y</span></span>
<span>  <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/fixed.effects.html">fixef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/VarCorr.html">VarCorr</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html">nrow</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span></span>
<span>  <span class="va">test_idx</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">test_prop</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">train_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, <span class="va">test_idx</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Linear predictor without REs</span></span>
<span>  <span class="va">eta0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">D</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">beta</span><span class="op">)</span> <span class="op">+</span> <span class="va">off</span></span>
<span></span>
<span>  <span class="co"># For these data loc is unique per row; for test rows we integrate over prior u ~ N(0, sigma^2)</span></span>
<span>  <span class="co"># Draw nsim random-effect values once and reuse across test rows (common random numbers)</span></span>
<span>  <span class="va">u_draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nsim</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">y_test</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">test_idx</span><span class="op">]</span></span>
<span>  <span class="va">eta0_test</span> <span class="op">&lt;-</span> <span class="va">eta0</span><span class="op">[</span><span class="va">test_idx</span><span class="op">]</span></span>
<span>  <span class="va">n_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">test_idx</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Posterior predictive CDFs at y and y-1 via Monte Carlo over u</span></span>
<span>  <span class="va">Fi_y</span>      <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">n_test</span><span class="op">)</span></span>
<span>  <span class="va">Fi_yminus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">n_test</span><span class="op">)</span></span>
<span>  <span class="va">y_minus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">y_test</span> <span class="op">-</span> <span class="fl">1L</span>, <span class="op">-</span><span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">n_test</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">lam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">eta0_test</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">u_draws</span><span class="op">)</span></span>
<span>    <span class="va">Fi_y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">ppois</a></span><span class="op">(</span><span class="va">y_test</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, lambda <span class="op">=</span> <span class="va">lam</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">Fi_yminus</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">y_minus</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="fl">0</span> <span class="kw">else</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">ppois</a></span><span class="op">(</span><span class="va">y_minus</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, lambda <span class="op">=</span> <span class="va">lam</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">Fi_y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">Fi_yminus</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span> <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="va">Fi_y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>; <span class="va">Fi_y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Fi_yminus</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>; <span class="va">Fi_yminus</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tmp</span> <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Nonrandomized PIT for each u in u_grid and average across test observations</span></span>
<span>  <span class="va">npit_avg</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">u</span>, <span class="va">Fy</span>, <span class="va">Fym1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">denom</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">Fy</span> <span class="op">-</span> <span class="va">Fym1</span>, <span class="va">.Machine</span><span class="op">$</span><span class="va">double.eps</span><span class="op">)</span></span>
<span>    <span class="va">lt</span> <span class="op">&lt;-</span> <span class="va">u</span> <span class="op">&lt;=</span> <span class="va">Fym1</span>; <span class="va">gt</span> <span class="op">&lt;-</span> <span class="va">u</span> <span class="op">&gt;=</span> <span class="va">Fy</span>; <span class="va">mid</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="op">(</span><span class="va">lt</span> <span class="op">|</span> <span class="va">gt</span><span class="op">)</span></span>
<span>    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">Fy</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">out</span><span class="op">[</span><span class="va">lt</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>; <span class="va">out</span><span class="op">[</span><span class="va">gt</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>; <span class="va">out</span><span class="op">[</span><span class="va">mid</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">u</span> <span class="op">-</span> <span class="va">Fym1</span><span class="op">[</span><span class="va">mid</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="va">denom</span><span class="op">[</span><span class="va">mid</span><span class="op">]</span></span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html">mean</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">anpit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="va">u_grid</span>, <span class="va">npit_avg</span>, FUN.VALUE <span class="op">=</span> <span class="fl">0.0</span>, Fy <span class="op">=</span> <span class="va">Fi_y</span>, Fym1 <span class="op">=</span> <span class="va">Fi_yminus</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>u <span class="op">=</span> <span class="va">u_grid</span>,</span>
<span>       anpit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">anpit</span><span class="op">)</span>,</span>
<span>       Fi_y <span class="op">=</span> <span class="va">Fi_y</span>,</span>
<span>       Fi_yminus <span class="op">=</span> <span class="va">Fi_yminus</span>,</span>
<span>       test_index <span class="op">=</span> <span class="va">test_idx</span>,</span>
<span>       train_index <span class="op">=</span> <span class="va">train_idx</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">plot_anpit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"ggplot2"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Need ggplot2 for plotting."</span><span class="op">)</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>u <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">u</span>, anpit <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">anpit</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">u</span>, <span class="va">anpit</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, intercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"u"</span>, y <span class="op">=</span> <span class="st">"Average nPIT"</span>, title <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We start by defining the function and adding input checks.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>anpit_wnv <span class="ot">&lt;-</span> <span class="cf">function</span>(model, <span class="at">test_prop =</span> <span class="fl">0.25</span>, <span class="at">nsim =</span> <span class="dv">2000</span>,</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">u_grid =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">101</span>), <span class="at">seed =</span> <span class="cn">NULL</span>) {</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">inherits</span>(model, <span class="st">"glmerMod"</span>))</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (test_prop <span class="sc">&lt;=</span> <span class="dv">0</span> <span class="sc">||</span> test_prop <span class="sc">&gt;=</span> <span class="dv">1</span>) <span class="fu">stop</span>(<span class="st">"test_prop must be in (0,1)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The function accepts a fitted Poisson mixed model, a proportion for the test set, number of Monte Carlo draws, a grid of u values (used as input of the AnPIT), and an optional seed for reproducibility. It checks that the model is of class <code>glmerMod</code> and that the test proportion is valid.</p>
<div class="cell">
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span>  <span class="va">D</span>    <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span>  <span class="va">off</span>  <span class="op">&lt;-</span> <span class="va">model</span><span class="op">@</span><span class="va">offset</span>; <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">off</span><span class="op">)</span><span class="op">)</span> <span class="va">off</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html">nrow</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">y</span>    <span class="op">&lt;-</span> <span class="va">model</span><span class="op">@</span><span class="va">resp</span><span class="op">$</span><span class="va">y</span></span>
<span>  <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/fixed.effects.html">fixef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/VarCorr.html">VarCorr</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This block extracts the design matrix, the offset (log of trap nights in our case), the response counts, the fixed effects, and the standard deviation of the random intercept.</p>
<div class="cell">
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html">nrow</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span></span>
<span>  <span class="va">test_idx</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">test_prop</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">train_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, <span class="va">test_idx</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here we randomly split the data into a test and training set according to <code>test_prop</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span>  <span class="va">eta0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">D</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">beta</span><span class="op">)</span> <span class="op">+</span> <span class="va">off</span></span>
<span>  <span class="va">u_draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nsim</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We compute the linear predictor without random effects and generate random intercept samples from the marginal distribution of the random effects <span class="math inline">\(Z_i\)</span>, namely a Gaussian distribution with mean 0 and standard deviation <code>sigma</code>. Since each location is unique, we integrate over the prior for the test rows.</p>
<div class="cell">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span>  <span class="va">y_test</span>    <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">test_idx</span><span class="op">]</span></span>
<span>  <span class="va">eta0_test</span> <span class="op">&lt;-</span> <span class="va">eta0</span><span class="op">[</span><span class="va">test_idx</span><span class="op">]</span></span>
<span>  <span class="va">n_test</span>    <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">test_idx</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">Fi_y</span>      <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">n_test</span><span class="op">)</span></span>
<span>  <span class="va">Fi_yminus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">n_test</span><span class="op">)</span></span>
<span>  <span class="va">y_minus</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">y_test</span> <span class="op">-</span> <span class="fl">1L</span>, <span class="op">-</span><span class="fl">1L</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The response, linear predictor, and number of test observations are stored. We also prepare storage for the predictive CDFs.</p>
<div class="cell">
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">n_test</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">lam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">eta0_test</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">u_draws</span><span class="op">)</span></span>
<span>    <span class="va">Fi_y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>      <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">ppois</a></span><span class="op">(</span><span class="va">y_test</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,    lambda <span class="op">=</span> <span class="va">lam</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">Fi_yminus</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">y_minus</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="fl">0</span> <span class="kw">else</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">ppois</a></span><span class="op">(</span><span class="va">y_minus</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, lambda <span class="op">=</span> <span class="va">lam</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">Fi_y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">Fi_yminus</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span> <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="va">Fi_y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>; <span class="va">Fi_y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Fi_yminus</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>; <span class="va">Fi_yminus</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tmp</span> <span class="op">}</span></span>
<span>  <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For each test observation, we compute the predictive CDF at <span class="math inline">\(y\)</span> and <span class="math inline">\(y−1\)</span> via Monte Carlo integration over the u draws. These quantities are then used to compute the AnPIT below.</p>
<div class="cell">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span>  <span class="va">npit_avg</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">u</span>, <span class="va">Fy</span>, <span class="va">Fym1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">denom</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">Fy</span> <span class="op">-</span> <span class="va">Fym1</span>, <span class="va">.Machine</span><span class="op">$</span><span class="va">double.eps</span><span class="op">)</span></span>
<span>    <span class="va">lt</span> <span class="op">&lt;-</span> <span class="va">u</span> <span class="op">&lt;=</span> <span class="va">Fym1</span>; <span class="va">gt</span> <span class="op">&lt;-</span> <span class="va">u</span> <span class="op">&gt;=</span> <span class="va">Fy</span>; <span class="va">mid</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="op">(</span><span class="va">lt</span> <span class="op">|</span> <span class="va">gt</span><span class="op">)</span></span>
<span>    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">Fy</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">out</span><span class="op">[</span><span class="va">lt</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>; <span class="va">out</span><span class="op">[</span><span class="va">gt</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>; <span class="va">out</span><span class="op">[</span><span class="va">mid</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">u</span> <span class="op">-</span> <span class="va">Fym1</span><span class="op">[</span><span class="va">mid</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="va">denom</span><span class="op">[</span><span class="va">mid</span><span class="op">]</span></span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html">mean</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">anpit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="va">u_grid</span>, <span class="va">npit_avg</span>, FUN.VALUE <span class="op">=</span> <span class="fl">0.0</span>, Fy <span class="op">=</span> <span class="va">Fi_y</span>, Fym1 <span class="op">=</span> <span class="va">Fi_yminus</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We define a helper to compute the AnPIT for a given u and average it over the test set (see <a href="04_geostatistical-prediction.html#eq-anpit" class="quarto-xref">Equation&nbsp;<span>4.6</span></a> for the definition of the AnPIT). This is repeated for each u in the grid.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">u =</span> u_grid,</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">anpit =</span> <span class="fu">as.numeric</span>(anpit),</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">Fi_y =</span> Fi_y,</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">Fi_yminus =</span> Fi_yminus,</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">test_index =</span> test_idx,</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">train_index =</span> train_idx)</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The function returns a list with the u grid, the averaged nPIT values, the predictive CDFs, and the indices of the test and training sets.</p>
<div class="cell">
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_anpit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"ggplot2"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Need ggplot2 for plotting."</span><span class="op">)</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>u <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">u</span>, anpit <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">anpit</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">u</span>, <span class="va">anpit</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, intercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"u"</span>, y <span class="op">=</span> <span class="st">"Average nPIT"</span>, title <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This helper function takes the output and produces a plot of the averaged nPIT curve against the identity line.</p>
</section></section><section id="exercises" class="level2" data-number="5.5"><h2 data-number="5.5" class="anchored" data-anchor-id="exercises">
<span class="header-section-number">5.5</span> Exercises</h2>
<ol type="1">
<li>
<p>Re-analyse the Ghana malnutrition data set (see <a href="#sec-ghana" class="quarto-xref"><span>Section 5.1</span></a>) after dichotomising the height-for-age Z-score (HAZ) and weight-for-age Z-score (WAZ). Define two binary outcomes:</p>
<ul>
<li>
<code>HAZ_bin</code> = 1 if HAZ &lt; −2, and 0 otherwise<br>
</li>
<li>
<code>WAZ_bin</code> = 1 if WAZ &lt; −2, and 0 otherwise</li>
</ul>
<p>Fit binomial geostatistical models to the individual-level data and compare the point estimates and spatial predictions to those obtained from the geostatistical models described in <a href="#sec-ghana" class="quarto-xref"><span>Section 5.1</span></a>. Discuss which model provides a better fit and why.</p>
</li>
<li>
<p>In the Malawi prevalence mapping analysis, we used the first principal component (PC1) of the environmental covariates to summarize covariate variation and reduce dimensionality. In this exercise, you will investigate whether including the second principal component (PC2) improves the model.</p>
<ul>
<li><p>Compute the second principal component (PC2) from the same set of standardized covariates used to derive PC1. What is the interpretation of PC2? What kind of relationship does PC2 show with the empirical logit?</p></li>
<li><p>Fit a geostatistical model that includes both PC1 and PC2 as covariates. How do the covariance parameters of the spatial process change after including PC2 compared to the model with PC1 only?</p></li>
<li>
<p>Compare this model to:</p>
<ul>
<li>the model using only PC1, and</li>
<li>the model using all covariates as separate predictors.</li>
</ul>
<p>Use the AnPIT plot and CRPS/SCRPS scores to assess predictive performance.</p>
</li>
<li><p>Discuss whether adding PC2 captures additional meaningful variation or introduces multicollinearity or overfitting. What implications does this have for model interpretability and parsimony?</p></li>
</ul>
</li>
<li>
<p>In this exercise, you will repeat the full analysis pipeline developed for Malawi using data from a different country.</p>
<ul>
<li><p>Choose a different country available in the <code>malariaAtlas</code> package (e.g., Zambia or Nigeria), and download parasite prevalence survey data for a specific year.</p></li>
<li><p>Obtain the same set of environmental covariates used in the Malawi analysis, and prepare them for analysis (e.g., resample, standardize, and extract values at survey locations).</p></li>
<li>
<p>Fit and compare two geostatistical models:</p>
<ul>
<li>A model using the environmental covariates as separate fixed effects.</li>
<li>A model using the first principal component (PC1) as a synthetic covariate summarizing the covariate space.</li>
</ul>
</li>
<li><p>Evaluate model performance using the AnPIT plot and CRPS/SCRPS scores.</p></li>
<li><p>Reflect on which model performs better in this new setting. Do your conclusions align with what was observed in the Malawi case study? What might explain any differences in performance across countries?</p></li>
</ul>
</li>
<li><p>The function <code>simulate_random_effects()</code> in <a href="#sec-sim-re" class="quarto-xref"><span>Section 5.4.1</span></a> samples random effects using a simple grid-based inverse CDF approach.<br>
While easy to understand, this method can be slow when the number of groups or simulations is large. Rewrite the function using a more efficient sampling strategy such as slice sampling <span class="citation" data-cites="neal2003">(<a href="references.html#ref-neal2003" role="doc-biblioref">Neal 2003</a>)</span> or a simple Metropolis–Hastings sampler <span class="citation" data-cites="gelman2013bayesian">(<a href="references.html#ref-gelman2013bayesian" role="doc-biblioref">Gelman et al. 2013</a>)</span>. After implementing your new function, compare the sampled random effect distributions to those obtained from <code>simulate_random_effects</code> and discuss any differences in accuracy and computational speed.</p></li>
<li><p>The function <code>anpit_wnv()</code> computes the average non-randomized probability integral transform for the specific model in <a href="#eq-wnv-counts" class="quarto-xref">Equation&nbsp;<span>5.4</span></a>. Full details of the implementation are given in <a href="#sec-nonspat-anpit" class="quarto-xref"><span>Section 5.4.2</span></a>. You may wish to enhance this function in one of two ways: first, by generalising it so that it can be applied to any generalized linear mixed model with the same random effects structure; second, by replacing the Monte Carlo step that samples from a Gaussian distribution with a numerical integration approach. Once you have implemented this function, you can apply it to the analysed data-sets of the previous chapter and compare the generated AnPIT against those of the fitted geostatistical models. Does the AnPIT show an unsatisfactory diagnostic in some cases?</p></li>
<li><p>Repeat the analysis in <a href="#sec-wnv" class="quarto-xref"><span>Section 5.3</span></a> from the beginning to predict the vector index, but this time assume alternative fixed values for the PCR pool size <span class="math inline">\(k_i\)</span> in <a href="#sec-wnv-model" class="quarto-xref"><span>Section 5.3.2</span></a>, setting all <span class="math inline">\(k_i\)</span> to 10, 25, and 50 in turn. Compare the resulting inferences on West Nile virus infection prevalence and the vector index across these three scenarios, and discuss how they differ from each other as well as from the results presented earlier in this chapter.</p></li>
</ol>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-amazigo2008" class="csl-entry" role="listitem">
Amazigo, U. 2008. <span>“The African Programme for Onchocerciasis Control (APOC).”</span> <em>Ann Trop Med Parasitol</em> 102 (Suppl 1): 19–22. <a href="https://doi.org/10.1179/136485908X337436">https://doi.org/10.1179/136485908X337436</a>.
</div>
<div id="ref-bates2015" class="csl-entry" role="listitem">
Bates, Douglas, Martin Mächler, Ben Bolker, and Steve Walker. 2015. <span>“Fitting Linear Mixed-Effects Models Using <span class="nocase">lme4</span>.”</span> <em>Journal of Statistical Software</em> 67 (1): 1–48. <a href="https://doi.org/10.18637/jss.v067.i01">https://doi.org/10.18637/jss.v067.i01</a>.
</div>
<div id="ref-bhattachan2023drought" class="csl-entry" role="listitem">
Bhattachan, Abhinav, Rachel Barrios, Laura Harrington, Valerie A. Paz-Soldan, and A. Marm Kilpatrick. 2023. <span>“Drought-Associated Reductions in Urban Mosquito Abundance During California’s Historic Drought.”</span> <em>Science of The Total Environment</em> 891: 164519. <a href="https://doi.org/10.1016/j.scitotenv.2023.164519">https://doi.org/10.1016/j.scitotenv.2023.164519</a>.
</div>
<div id="ref-bishop2006" class="csl-entry" role="listitem">
Bishop, Christopher M. 2006. <em>Pattern Recognition and Machine Learning</em>. Springer.
</div>
<div id="ref-bolin2023" class="csl-entry" role="listitem">
Bolin, David, and Jonas Wallin. 2023. <span>“<span class="nocase">Local scale invariance and robustness of proper scoring rules</span>.”</span> <em>Statistical Science</em> 38 (1): 140–59. <a href="https://doi.org/10.1214/22-STS864">https://doi.org/10.1214/22-STS864</a>.
</div>
<div id="ref-bolling2009vi" class="csl-entry" role="listitem">
Bolling, Bethany G., Christopher M. Barker, Chester G. Moore, W. John Pape, and Lars Eisen. 2009. <span>“Seasonal Patterns for Entomological Measures of Risk for Exposure to <em>Culex</em> Vectors and West Nile Virus in Relation to Human Disease Cases in Northeastern Colorado.”</span> <em>Journal of Medical Entomology</em> 46 (6): 1519–31. <a href="https://doi.org/10.1603/033.046.0641">https://doi.org/10.1603/033.046.0641</a>.
</div>
<div id="ref-bowman1997" class="csl-entry" role="listitem">
Bowman, A. W. 1997. <em>Applied Smoothing Techniques for Data Analysis : The Kernel Approach with s-Plus Illustrations</em>. Oxford Statistical Science Series ; 18. Oxford : New York: Clarendon Press ; Oxford University Press.
</div>
<div id="ref-breslow1993" class="csl-entry" role="listitem">
Breslow, N. E., and D. G. Clayton. 1993. <span>“Approximate Inference in Generalized Linear Mixed Models.”</span> <em>Journal of the American Statistical Association</em> 88: 9–25.
</div>
<div id="ref-brooks2011handbook" class="csl-entry" role="listitem">
Brooks, Steve, Andrew Gelman, Galin L. Jones, and Xiao-Li Meng. 2011. <em>Handbook of Markov Chain Monte Carlo</em>. CRC Press.
</div>
<div id="ref-cdph2025response" class="csl-entry" role="listitem">
California Department of Public Health. 2025. <span>“California Mosquito-Borne Virus Surveillance and Response Plan.”</span> Online.
</div>
<div id="ref-cdc_wnv_guidelines_2024" class="csl-entry" role="listitem">
Centers for Disease Control and Prevention. 2024. <span>“West Nile Virus Surveillance and Control Guidelines.”</span> CDC guidance. <a href="https://www.cdc.gov/west-nile-virus/php/surveillance-and-control-guidelines/index.html">https://www.cdc.gov/west-nile-virus/php/surveillance-and-control-guidelines/index.html</a>.
</div>
<div id="ref-chilesdelfiner2016" class="csl-entry" role="listitem">
Chilès, J-P, and P. Delfiner. 2016. <em>Geostatistics (Second Edition)</em>. Hoboken: Wiley.
</div>
<div id="ref-christensen2006" class="csl-entry" role="listitem">
Christensen, OF, GO Roberts, and M Sköld. 2006. <span>“Robust Markov Chain Monte Carlo Methods for Spatial Generalized Linear Mixed Models.”</span> <em>Journal of Computational and Graphical Statistics</em> 15 (1): 1–17.
</div>
<div id="ref-christensen2004" class="csl-entry" role="listitem">
Christensen, Ole F. 2004. <span>“Monte Carlo Maximum Likelihood in Model-Based Geostatistics.”</span> <em>Journal of Computational and Graphical Statistics</em> 13 (3): 702–18.
</div>
<div id="ref-cityofboulder_wnv_vectorindex_2025" class="csl-entry" role="listitem">
City of Boulder. 2025. <span>“West Nile Virus — Estimating Risk to People: The Vector Index.”</span> <a href="https://bouldercolorado.gov/west-nile-virus">https://bouldercolorado.gov/west-nile-virus</a>.
</div>
<div id="ref-fortcollins_wnv_program_manual_2014" class="csl-entry" role="listitem">
City of Fort Collins. 2014. <span>“West Nile Virus Program Manual.”</span> City of Fort Collins. <a href="https://www.fcgov.com/westnile/pdf/wnv_program_manual.pdf">https://www.fcgov.com/westnile/pdf/wnv_program_manual.pdf</a>.
</div>
<div id="ref-fortcollins_localdata_vi_2025" class="csl-entry" role="listitem">
———. 2025. <span>“Local Data — West Nile Virus.”</span> <a href="https://www.fcgov.com/westnile/local-data">https://www.fcgov.com/westnile/local-data</a>.
</div>
<div id="ref-cowles1996markov" class="csl-entry" role="listitem">
Cowles, Mary Kathryn, and Bradley P. Carlin. 1996. <span>“Markov Chain Monte Carlo Convergence Diagnostics: A Comparative Review.”</span> <em>Journal of the American Statistical Association</em> 91 (434): 883–904.
</div>
<div id="ref-cressie1991" class="csl-entry" role="listitem">
Cressie, N. A. C. 1991. <em>Statistics for Spatial Data</em>. New York: Wiley.
</div>
<div id="ref-cressie1985" class="csl-entry" role="listitem">
Cressie, Noel. 1985. <span>“Fitting Variogram Models by Weighted Least Squares.”</span> <em>Mathematical Geology</em> 17 (5): 563–86.
</div>
<div id="ref-czado2009" class="csl-entry" role="listitem">
Czado, Claudia, Tilmann Gneiting, and Leonhard Held. 2009. <span>“<span class="nocase">Predictive Model Assessment for Count Data</span>.”</span> <em>Biometrics</em> 65 (4): 1254–61. <a href="https://doi.org/10.1111/j.1541-0420.2009.01191.x">https://doi.org/10.1111/j.1541-0420.2009.01191.x</a>.
</div>
<div id="ref-dawid1984" class="csl-entry" role="listitem">
Dawid, A. P. 1984. <span>“Statistical Theory: The Prequential Approach.”</span> <em>Journal of the Royal Statistical Society: Series A (General)</em> 147 (2): 278–92.
</div>
<div id="ref-diggleBook2019" class="csl-entry" role="listitem">
Diggle, P J, and E Giorgi. 2019. <em>Model-Based Geostatistics for Global Public Health : Methods and Applications.</em> Chapman and Hall/CRC Interdisciplinary Statistics Ser. Milton: Chapman; Hall/CRC.
</div>
<div id="ref-diggle1998" class="csl-entry" role="listitem">
Diggle, P. J., J. A. Tawn, and R. A. Moyeed. 1998. <span>“Model-Based Geostatistics.”</span> <em>Journal of the Royal Statistical Society: Series C (Applied Statistics)</em> 47 (3): 299–350. <a href="https://doi.org/10.1111/1467-9876.00113">https://doi.org/10.1111/1467-9876.00113</a>.
</div>
<div id="ref-diggle2007book" class="csl-entry" role="listitem">
Diggle, Peter, and Paulo Justiniano Ribeiro. 2007. <em>Model-Based Geostatistics</em>. Springer Series in Statistics. Springer.
</div>
<div id="ref-dobson2008" class="csl-entry" role="listitem">
Dobson, A. J., and A. Barnett. 2008. <em>An Introduction to Generalized Linear Models</em>. Third. Chapman; Hall/CRC.
</div>
<div id="ref-efron1979" class="csl-entry" role="listitem">
Efron, Bradley. 1979. <span>“Bootstrap Methods: Another Look at the Jackknife.”</span> <em>The Annals of Statistics</em> 7 (1): 1–26.
</div>
<div id="ref-evans2021" class="csl-entry" role="listitem">
Evans, Jeffrey S., and Melanie A. Murphy. 2021. <em>spatialEco</em>. <a href="https://github.com/jeffreyevans/spatialEco">https://github.com/jeffreyevans/spatialEco</a>.
</div>
<div id="ref-fernandez2000" class="csl-entry" role="listitem">
Fernández, J. A, A Rey, and A Carballeira. 2000. <span>“An Extended Study of Heavy Metal Deposition in Galicia (NW Spain) Based on Moss Analysis.”</span> <em>Science of The Total Environment</em> 254 (1): 31–44. <a href="https://doi.org/10.1016/S0048-9697(00)00431-9">https://doi.org/10.1016/S0048-9697(00)00431-9</a>.
</div>
<div id="ref-gelman2013bayesian" class="csl-entry" role="listitem">
Gelman, Andrew, John B. Carlin, Hal S. Stern, David B. Dunson, Aki Vehtari, and Donald B. Rubin. 2013. <em>Bayesian Data Analysis</em>. 3rd ed. CRC Press.
</div>
<div id="ref-gelman1992inference" class="csl-entry" role="listitem">
Gelman, Andrew, and Donald B Rubin. 1992. <span>“Inference from Iterative Simulation Using Multiple Sequences.”</span> <em>Statistical Science</em> 7 (4): 457–72.
</div>
<div id="ref-geweke1992evaluating" class="csl-entry" role="listitem">
Geweke, John. 1992. <span>“Evaluating the Accuracy of Sampling‐based Approaches to the Calculation of Posterior Moments.”</span> Edited by Jose M. Bernardo, James O. Berger, A. Philip Dawid, and Adrian F. M. Smith, 169–93.
</div>
<div id="ref-geyer1991" class="csl-entry" role="listitem">
Geyer, Charles J. 1991. <span>“Markov Chain Monte Carlo Maximum Likelihood.”</span> <em>Journal of Computational and Graphical Statistics</em> 1 (4): 39–55.
</div>
<div id="ref-geyer1994" class="csl-entry" role="listitem">
Geyer, Charles J. 1994. <span>“Likelihood and Exponential Families.”</span> <em>Department of Statistics, University of Minnesota</em>.
</div>
<div id="ref-geyer1996" class="csl-entry" role="listitem">
———. 1996. <span>“Markov Chain Monte Carlo Maximum Likelihood.”</span> <em>Department of Statistics, University of Minnesota</em>.
</div>
<div id="ref-geyer2019handbook" class="csl-entry" role="listitem">
———. 2019. <span>“Monte Carlo Methods in MCMC.”</span> In <em>Handbook of MCMC</em>, edited by Steve Brooks, Andrew Gelman, Galin L. Jones, and Xiao-Li Meng, 3–48. CRC Press.
</div>
<div id="ref-ghanaDHS2014" class="csl-entry" role="listitem">
Ghana Statistical Service, Ghana Health Service, and ICF International. 2015. <em>Ghana Demographic and Health Survey 2014</em>. Rockville, Maryland, USA: Ghana Statistical Service, Ghana Health Service,; ICF International. <a href="https://dhsprogram.com/publications/publication-FR307-DHS-Final-Reports.cfm">https://dhsprogram.com/publications/publication-FR307-DHS-Final-Reports.cfm</a>.
</div>
<div id="ref-gneiting2007" class="csl-entry" role="listitem">
Gneiting, Tilmann, Fadoua Balabdaoui, and Adrian E Raftery. 2007. <span>“Probabilistic Forecasts, Calibration and Sharpness.”</span> <em>Journal of the Royal Statistical Society: Series B (Statistical Methodology)</em> 69 (2): 243–68.
</div>
<div id="ref-gneiting2007jasa" class="csl-entry" role="listitem">
Gneiting, Tilmann, and Adrian E Raftery. 2007. <span>“Strictly Proper Scoring Rules, Prediction, and Estimation.”</span> <em>Journal of the American Statistical Association</em> 102 (477): 359–78. <a href="https://doi.org/10.1198/016214506000001437">https://doi.org/10.1198/016214506000001437</a>.
</div>
<div id="ref-harrell2015" class="csl-entry" role="listitem">
Harrell, Frank E. 2015. <em>Regression Modeling Strategies</em>. 2nd ed. New York: Springer.
</div>
<div id="ref-hastie2001" class="csl-entry" role="listitem">
Hastie, Trevor, Robert Tibshirani, and Jerome Friedman. 2001. <em>The Elements of Statistical Learning</em>. Springer Series in Statistics. New York, NY, USA: Springer New York Inc.
</div>
<div id="ref-hastings1970monte" class="csl-entry" role="listitem">
Hastings, W. K. 1970. <span>“Monte Carlo Sampling Methods Using Markov Chains and Their Applications.”</span> <em>Biometrika</em> 57 (1): 97–109.
</div>
<div id="ref-johnson2021" class="csl-entry" role="listitem">
Johnson, Olatunji, Claudio Fronterre, Benjamin Amoah, Antonio Montresor, Emanuele Giorgi, Nicholas Midzi, Masceline Jenipher Mutsaka-Makuvaza, et al. 2021. <span>“Model-Based Geostatistical Methods Enable Efficient Design and Analysis of Prevalence Surveys for Soil-Transmitted Helminth Infection and Other Neglected Tropical Diseases.”</span> <em>Clinical Infectious Diseases</em> 72 (Supplement_3): S172–79. <a href="https://doi.org/10.1093/cid/ciab192">https://doi.org/10.1093/cid/ciab192</a>.
</div>
<div id="ref-jones2011vi" class="csl-entry" role="listitem">
Jones, Roderick C., Kingsley N. Weaver, Shamika Smith, Claudia Blanco, Cristina Flores, Kevin Gibbs, Daniel Markowski, and John-Paul Mutebi. 2011. <span>“Use of the Vector Index and Geographic Information System to Prospectively Inform West Nile Virus Interventions.”</span> <em>Journal of the American Mosquito Control Association</em> 27 (3): 315–19. <a href="https://doi.org/10.2987/10-6098.1">https://doi.org/10.2987/10-6098.1</a>.
</div>
<div id="ref-gates2020" class="csl-entry" role="listitem">
Katz, Elizabeth, and Bill &amp; Melinda Gates Foundation. 2020. <span>“Gender and Malaria Evidence Reivew.”</span> Bill &amp; Melinda Gates Foundation. <a href="https://www.gatesgenderequalitytoolbox.org/wp-content/uploads/BMGF_Malaria-Review_FC.pdf">https://www.gatesgenderequalitytoolbox.org/wp-content/uploads/BMGF_Malaria-Review_FC.pdf</a>.
</div>
<div id="ref-kilpatrick2013predicting" class="csl-entry" role="listitem">
Kilpatrick, A. Marm, and W. John Pape. 2013. <span>“Predicting Human West Nile Virus Infections with Mosquito Surveillance Data.”</span> <em>American Journal of Epidemiology</em> 178 (5): 829–35. <a href="https://doi.org/10.1093/aje/kwt046">https://doi.org/10.1093/aje/kwt046</a>.
</div>
<div id="ref-kramer2007wnv" class="csl-entry" role="listitem">
Kramer, Laura D., Jun Li, and Pei-Yong Shi. 2007. <span>“West Nile Virus.”</span> <em>The Lancet Neurology</em> 6 (2): 171–81. <a href="https://doi.org/10.1016/S1474-4422(07)70030-3">https://doi.org/10.1016/S1474-4422(07)70030-3</a>.
</div>
<div id="ref-krige1951" class="csl-entry" role="listitem">
Krige, D. G. 1951. <span>“A Statistical Approach to Some Basic Mine Valuation Problems on the Witwatersrand.”</span> <em>Journal of the Chemical, Metallurgical and Mining Society of South Africa</em> 52: 119–39.
</div>
<div id="ref-kyomuhangi2021" class="csl-entry" role="listitem">
Kyomuhangi, Irene, Tarekegn A. Abeku, Matthew J. Kirby, Gezahegn Tesfaye, and Emanuele Giorgi. 2021. <span>“Understanding the Effects of Dichotomization of Continuous Outcomes on Geostatistical Inference.”</span> <em>Spatial Statistics</em> 42: 100424. https://doi.org/<a href="https://doi.org/10.1016/j.spasta.2020.100424">https://doi.org/10.1016/j.spasta.2020.100424</a>.
</div>
<div id="ref-Lovelace2020-iq" class="csl-entry" role="listitem">
Lovelace, Robin, Jakub Nowosad, and Jannes Muenchow. 2020. <em>Geocomputation with <span>R</span></em>. London, England: CRC Press. <a href="https://r.geocompx.org/">https://r.geocompx.org/</a>.
</div>
<div id="ref-malariaAtlas" class="csl-entry" role="listitem">
Lucas, Tim C. D., Anita K. Nandi, Rosalind E. Howes, Daniel J. Weiss, Ewan Cameron, Nick Golding, and Peter W. Gething. 2020. <span>“malariaAtlas: An r Interface to Global Malariometric Data Hosted by the Malaria Atlas Project.”</span> <em>Wellcome Open Research</em> 5: 74. <a href="https://doi.org/10.12688/wellcomeopenres.15987.1">https://doi.org/10.12688/wellcomeopenres.15987.1</a>.
</div>
<div id="ref-mahoney2023" class="csl-entry" role="listitem">
Mahoney, Michael J, Lucas K Johnson, Julia Silge, Hannah Frick, Max Kuhn, and Colin M Beier. 2023. <span>“Assessing the Performance of Spatial Cross-Validation Approaches for Models of Spatially Structured Data.”</span> <a href="https://doi.org/10.48550/arXiv.2303.07334">https://doi.org/10.48550/arXiv.2303.07334</a>.
</div>
<div id="ref-matern2013" class="csl-entry" role="listitem">
Matern, B. 2013. <em>Spatial Variation</em>. Lecture Notes in Statistics. Springer New York. <a href="https://books.google.co.uk/books?id=HrbSBwAAQBAJ">https://books.google.co.uk/books?id=HrbSBwAAQBAJ</a>.
</div>
<div id="ref-matheron1963" class="csl-entry" role="listitem">
Matheron, G. 1963. <span>“Principles of Geostatistics.”</span> <em>Economic Geology</em> 58: 1246–66.
</div>
<div id="ref-metropolis1953equation" class="csl-entry" role="listitem">
Metropolis, Nicholas, Arianna W. Rosenbluth, Marshall N. Rosenbluth, Augusta H. Teller, and Edward Teller. 1953. <span>“Equation of State Calculations by Fast Computing Machines.”</span> <em>The Journal of Chemical Physics</em> 21 (6): 1087–92.
</div>
<div id="ref-neal2003" class="csl-entry" role="listitem">
Neal, Radford M. 2003. <span>“Slice Sampling.”</span> <em>The Annals of Statistics</em> 31 (3): 705–67.
</div>
<div id="ref-nelder1972" class="csl-entry" role="listitem">
Nelder, J. A., and R. W. M. Wedderburn. 1972. <span>“Generalized Linear Models.”</span> <em>Journal of the Royal Statistical Society A</em> 135: 370–84.
</div>
<div id="ref-who_underweight2024" class="csl-entry" role="listitem">
Organization, World Health. 2024. <span>“Indicator Metadata Registry: Child Malnutrition—Underweight Among Children Under Five Years of Age (Weight-for-Age &lt;-2 SD).”</span> <a href="https://www.who.int/data/gho/indicator-metadata-registry/imr-details/27" class="uri">https://www.who.int/data/gho/indicator-metadata-registry/imr-details/27</a>.
</div>
<div id="ref-pawitan2001" class="csl-entry" role="listitem">
Pawitan, Yudi. 2001. <em>In All Likelihood : Statistical Modelling and Inference Using Likelihood</em>. Oxford ; New York: Clarendon Press : Oxford University Press.
</div>
<div id="ref-petersen2013wnv" class="csl-entry" role="listitem">
Petersen, Lyle R., Aaron C. Brault, and Roger S. Nasci. 2013. <span>“West Nile Virus: Review of the Literature.”</span> <em>JAMA</em> 310 (3): 308–15. <a href="https://doi.org/10.1001/jama.2013.8042">https://doi.org/10.1001/jama.2013.8042</a>.
</div>
<div id="ref-puranik2024" class="csl-entry" role="listitem">
Puranik, Amitha, Peter J. Diggle, Maurice R. Odiere, Katherine Gass, Stella Kepha, Collins Okoyo, Charles Mwandawiro, et al. 2024. <span>“Understanding the Impact of Covariates on the Classification of Implementation Units for Soil-Transmitted Helminths Control: A Case Study from Kenya.”</span> <em>BMC Medical Research Methodology</em> 24 (1): 294. <a href="https://doi.org/10.1186/s12874-024-02420-1">https://doi.org/10.1186/s12874-024-02420-1</a>.
</div>
<div id="ref-ripley1981" class="csl-entry" role="listitem">
Ripley, B. D. 1981. <em>Spatial Statistics</em>. New York: Wiley.
</div>
<div id="ref-robert2004" class="csl-entry" role="listitem">
Robert, Christian P, and George Casella. 2004. <em>Monte Carlo Statistical Methods</em>. 2nd ed. Springer.
</div>
<div id="ref-roberts1996exponential" class="csl-entry" role="listitem">
Roberts, Gareth O., and Richard L. Tweedie. 1996. <span>“Exponential Convergence of Langevin Distributions and Their Discrete Approximations.”</span> <em>Bernoulli</em> 2 (4): 341–63.
</div>
<div id="ref-ross2013" class="csl-entry" role="listitem">
Ross, Sheldon. 2013. <em>First Course in Probability, a.</em> 9th ed. Harlow: Pearson Education UK.
</div>
<div id="ref-rossky1978brownian" class="csl-entry" role="listitem">
Rossky, Peter J., J. D. Doll, and Harold L. Friedman. 1978. <span>“Brownian Dynamics as Smart Monte Carlo Simulation.”</span> <em>The Journal of Chemical Physics</em> 69 (10): 4628–33.
</div>
<div id="ref-rue2009" class="csl-entry" role="listitem">
Rue, H., S. Martino, and N. Chopin. 2009. <span>“Approximate Bayesian Inference for Latent Gaussian Models by Using Integrated Nested Laplace Approximations.”</span> <em>Journal of the Royal Statistical Society: Series B (Statistical Methodology)</em> 71 (2): 319–92. <a href="https://doi.org/10.1111/j.1467-9868.2008.00700.x">https://doi.org/10.1111/j.1467-9868.2008.00700.x</a>.
</div>
<div id="ref-sacramento2018annual" class="csl-entry" role="listitem">
Sacramento-Yolo Mosquito and Vector Control District. 2018. <span>“2018 Annual Report.”</span> Online.
</div>
<div id="ref-shmueli2010" class="csl-entry" role="listitem">
Shmueli, Galit. 2010. <span>“To Explain or to Predict?”</span> <em>Statistical Science</em> 25 (3): 289–310.
</div>
<div id="ref-smith2007" class="csl-entry" role="listitem">
Smith, David L, Carlos A Guerra, Robert W Snow, and Simon I Hay. 2007. <span>“Standardizing Estimates of the Plasmodium Falciparum Parasite Rate.”</span> <em>Malaria Journal</em> 6 (1): 131–31.
</div>
<div id="ref-stein1999" class="csl-entry" role="listitem">
Stein, Michael L. 1999. <em>Interpolation of Spatial Data Some Theory for Kriging</em>. 1st ed. 1999. Springer Series in Statistics. New York, NY: Springer New York : Imprint: Springer.
</div>
<div id="ref-stevenson2013" class="csl-entry" role="listitem">
Stevenson, Gillian H. AND Gitonga, Jennifer C. AND Stresman. 2013. <span>“Reliability of School Surveys in Estimating Geographic Variation in Malaria Transmission in the Western Kenyan Highlands.”</span> <em>PLOS ONE</em> 8 (10). <a href="https://doi.org/10.1371/journal.pone.0077641">https://doi.org/10.1371/journal.pone.0077641</a>.
</div>
<div id="ref-fossog2015" class="csl-entry" role="listitem">
Tene Fossog, Billy, Diego Ayala, Pelayo Acevedo, Pierre Kengne, Ignacio Ngomo Abeso Mebuy, Boris Makanga, Julie Magnus, et al. 2015. <span>“Habitat Segregation and Ecological Character Displacement in Cryptic African Malaria Mosquitoes.”</span> <em>Evolutionary Applications</em> 8 (4): 326–45. <a href="https://doi.org/10.1111/eva.12242">https://doi.org/10.1111/eva.12242</a>.
</div>
<div id="ref-tobler1970" class="csl-entry" role="listitem">
Tobler, W. R. 1970. <span>“A Computer Movie Simulating Urban Growth in the Detroit Region.”</span> <em>Economic Geography</em> 46: 234–40.
</div>
<div id="ref-sdg2201meta2025" class="csl-entry" role="listitem">
United Nations Statistics Division, World Health Organization, and UNICEF. 2025. <span>“SDG Indicator 2.2.1 Metadata: Prevalence of Stunting (Height-for-Age &lt;-2 SD) Among Children Under Five Years of Age.”</span> <a href="https://unstats.un.org/sdgs/metadata/files/Metadata-02-02-01.pdf" class="uri">https://unstats.un.org/sdgs/metadata/files/Metadata-02-02-01.pdf</a>.
</div>
<div id="ref-watson1971" class="csl-entry" role="listitem">
Watson, G. S. 1971. <span>“Trend -Surface Analysis.”</span> <em>Mathematical Geology</em> 3: 215–26.
</div>
<div id="ref-watson1972" class="csl-entry" role="listitem">
———. 1972. <span>“Trend Surface Analysis and Spatial Correlation.”</span> <em>Geological Society of America Special Paper</em> 146: 39–46.
</div>
<div id="ref-weisberg2014" class="csl-entry" role="listitem">
Weisberg, Sanford. 2014. <em>Applied Linear Regression</em>. Fourth. Hoboken <span>NJ</span>: Wiley. <a href="http://z.umn.edu/alr4ed">http://z.umn.edu/alr4ed</a>.
</div>
<div id="ref-who2006" class="csl-entry" role="listitem">
WHO. 2006. <span>“WHO Child Growth Standards: Length/Height-for-Age, Weight-for-Age, Weight-for-Length, Weight-for-Height and Body Mass Index-for-Age: Methods and Development.”</span> Geneva: WHO. <a href="https://www.who.int/publications/i/item/924154693X">https://www.who.int/publications/i/item/924154693X</a>.
</div>
<div id="ref-yin2024" class="csl-entry" role="listitem">
Yin, Hui, Yutong Wang, Yuxin Wang, Zihan Li, Yujie Li, and Yuxin Wang. 2024. <span>“A Rapid Review of Clustering Algorithms.”</span> <em>arXiv Preprint arXiv:2401.07389</em>.
</div>
<div id="ref-zhang2002" class="csl-entry" role="listitem">
Zhang, Hao. 2002. <span>“On Estimation and Prediction for Spatial Generalized Linear Mixed Models.”</span> <em>Biometrics</em> 58 (1): 129–36.
</div>
<div id="ref-zhang2004" class="csl-entry" role="listitem">
———. 2004. <span>“Inconsistent Estimation and Asymptotically Equal Interpolations in Model-Based Geostatistics.”</span> <em>Journal of the American Statistical Association</em> 99 (465): 250–61.
</div>
<div id="ref-zoure2014" class="csl-entry" role="listitem">
Zouré, Honorat GM, Mounkaila Noma, Afework H Tekle, Uche V Amazigo, Peter J Diggle, Emanuele Giorgi, and Jan HF Remme. 2014. <span>“Geographic Distribution of Onchocerciasis in the 20 Participating Countries of the African Programme for Onchocerciasis Control: (2) Pre-Control Endemicity Levels and Estimated Number Infected.”</span> <em>Parasites &amp; Vectors</em> 7 (1): 326–26.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./04_geostatistical-prediction.html" class="pagination-link" aria-label="Geostatistical prediction">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geostatistical prediction</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link" aria-label="References">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>