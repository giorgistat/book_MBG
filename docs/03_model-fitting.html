<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>3&nbsp; Model formulation and parameter estimation – Model-based geostatistics for global public health using R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./04_geostatistical-prediction.html" rel="next">
<link href="./02_handling-spatial-data.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-0de45b8b5f35a93596f1d788d60c4c11.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-51aeb3c3e75aa4fd935c6ef44004bc43.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./03_model-fitting.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Model formulation and parameter estimation</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Model-based geostatistics for global public health using R</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./author.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Author</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_handling-spatial-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Handling of spatial data in R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_model-fitting.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Model formulation and parameter estimation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_geostatistical-prediction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geostatistical prediction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_case-studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Case studies</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Appendix</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#list-of-the-main-functions-used-in-the-chapter" id="toc-list-of-the-main-functions-used-in-the-chapter" class="nav-link active" data-scroll-target="#list-of-the-main-functions-used-in-the-chapter">List of the main functions used in the chapter</a></li>
  <li>
<a href="#exploratory-analysis" id="toc-exploratory-analysis" class="nav-link" data-scroll-target="#exploratory-analysis"><span class="header-section-number">3.1</span> Exploratory analysis</a>
  <ul class="collapse">
<li><a href="#sec-expl-assoc" id="toc-sec-expl-assoc" class="nav-link" data-scroll-target="#sec-expl-assoc"><span class="header-section-number">3.1.1</span> Exploring associations with risk factors using count data</a></li>
  <li><a href="#sec-overdispersion" id="toc-sec-overdispersion" class="nav-link" data-scroll-target="#sec-overdispersion"><span class="header-section-number">3.1.2</span> Exploring overdispersion in count data</a></li>
  <li><a href="#sec-expl-spatial" id="toc-sec-expl-spatial" class="nav-link" data-scroll-target="#sec-expl-spatial"><span class="header-section-number">3.1.3</span> Exploring residual spatial correlation</a></li>
  </ul>
</li>
  <li>
<a href="#sec-linear-model" id="toc-sec-linear-model" class="nav-link" data-scroll-target="#sec-linear-model"><span class="header-section-number">3.2</span> The linear geostatistical model</a>
  <ul class="collapse">
<li><a href="#sec-glm-parest" id="toc-sec-glm-parest" class="nav-link" data-scroll-target="#sec-glm-parest"><span class="header-section-number">3.2.1</span> Evaluating the inclusion of the measurement error term <span class="math inline">\(U_i\)</span> and the specification of the smoothness parameter <span class="math inline">\(\kappa\)</span></a></li>
  <li><a href="#sec-add-re-glgm" id="toc-sec-add-re-glgm" class="nav-link" data-scroll-target="#sec-add-re-glgm"><span class="header-section-number">3.2.2</span> Modelling hierarchical geostatistical data using the <code>re()</code> function</a></li>
  </ul>
</li>
  <li>
<a href="#generalized-linear-geostatistical-models" id="toc-generalized-linear-geostatistical-models" class="nav-link" data-scroll-target="#generalized-linear-geostatistical-models"><span class="header-section-number">3.3</span> Generalized linear geostatistical models</a>
  <ul class="collapse">
<li><a href="#sec-liberia-estim1" id="toc-sec-liberia-estim1" class="nav-link" data-scroll-target="#sec-liberia-estim1"><span class="header-section-number">3.3.1</span> Example: river-blindness in Liberia</a></li>
  <li><a href="#sec-anopheles-fit" id="toc-sec-anopheles-fit" class="nav-link" data-scroll-target="#sec-anopheles-fit"><span class="header-section-number">3.3.2</span> Example: <em>Anopheles Gambiae</em> mosquitoes in Cameroon</a></li>
  <li><a href="#sec-bootstrap" id="toc-sec-bootstrap" class="nav-link" data-scroll-target="#sec-bootstrap"><span class="header-section-number">3.3.3</span> Using parametric bootstrap for computing confidence intervals</a></li>
  </ul>
</li>
  <li><a href="#the-residuals-of-a-geostatistical-model-issues-to-consider" id="toc-the-residuals-of-a-geostatistical-model-issues-to-consider" class="nav-link" data-scroll-target="#the-residuals-of-a-geostatistical-model-issues-to-consider"><span class="header-section-number">3.4</span> The residuals of a geostatistical model: issues to consider</a></li>
  <li>
<a href="#theory" id="toc-theory" class="nav-link" data-scroll-target="#theory"><span class="header-section-number">3.5</span> Theory</a>
  <ul class="collapse">
<li><a href="#maximum-likelihood-estimation-for-non-guassian-mixed-models-with-independent-random-effects" id="toc-maximum-likelihood-estimation-for-non-guassian-mixed-models-with-independent-random-effects" class="nav-link" data-scroll-target="#maximum-likelihood-estimation-for-non-guassian-mixed-models-with-independent-random-effects"><span class="header-section-number">3.5.1</span> Maximum likelihood estimation for non-Guassian mixed models with independent random effects</a></li>
  <li><a href="#sec-glgm-lik" id="toc-sec-glgm-lik" class="nav-link" data-scroll-target="#sec-glgm-lik"><span class="header-section-number">3.5.2</span> Maximum likelihood estimation for non-Guassian generalized linear geostatistical models</a></li>
  <li><a href="#sec-h-matrix" id="toc-sec-h-matrix" class="nav-link" data-scroll-target="#sec-h-matrix"><span class="header-section-number">3.5.3</span> The Hat matrix in linear geostatistical models</a></li>
  </ul>
</li>
  <li><a href="#review-questions" id="toc-review-questions" class="nav-link" data-scroll-target="#review-questions"><span class="header-section-number">3.6</span> Review questions</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">3.7</span> Exercises</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-estimation" class="quarto-section-identifier"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Model formulation and parameter estimation</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="list-of-the-main-functions-used-in-the-chapter" class="level2 unnumbered"><h2 class="unnumbered anchored" data-anchor-id="list-of-the-main-functions-used-in-the-chapter">List of the main functions used in the chapter</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead><tr class="header">
<th>Function</th>
<th>R Package</th>
<th>Used for</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>lmer</code></td>
<td><code>lme4</code></td>
<td>Fitting linear mixed models</td>
</tr>
<tr class="even">
<td><code>glmer</code></td>
<td><code>lme4</code></td>
<td>Fitting generalized linear mixed models</td>
</tr>
<tr class="odd">
<td><code>glgm</code></td>
<td><code>RiskMap</code></td>
<td>Fitting generalized linear geostatistical models</td>
</tr>
<tr class="even">
<td><code>s_variogram</code></td>
<td><code>RiskMap</code></td>
<td>Computing the empirical variogram and carrying out permutation test for spatial independence</td>
</tr>
</tbody>
</table></section><section id="exploratory-analysis" class="level2" data-number="3.1"><h2 data-number="3.1" class="anchored" data-anchor-id="exploratory-analysis">
<span class="header-section-number">3.1</span> Exploratory analysis</h2>
<p>As illustrated in <a href="01_intro.html#fig-stages" class="quarto-xref">Figure&nbsp;<span>1.8</span></a>, exploratory analysis is the first step that should be carried out in a statistical analysis. This stage is essential to inform how covariates should be introduced in the model and, in our case, whether the variation unexplained by those covariates exhibits spatial correlation.</p>
<p>In the exploratory analysis of count data, we will also look at how overdispersion, which is a necessary, though not sufficient, condition for residual spatial correlation.</p>
<section id="sec-expl-assoc" class="level3" data-number="3.1.1"><h3 data-number="3.1.1" class="anchored" data-anchor-id="sec-expl-assoc">
<span class="header-section-number">3.1.1</span> Exploring associations with risk factors using count data</h3>
<p>Assessment of the association between the health outcome of interest and non-categorical (i.e.&nbsp;continuous) risk factors can be carried using graphical tools, such scatter plots. The graphical inspection of the empirical association between the outcome and the covariates is especially useful to identify non-linear patterns in the relationship which should then be accounted for in the model formulation.</p>
<p>In this section, we look more closely at the case when the observed outcome is a count which requires a different treatment from continuously measured outcomes, which are generally covered by most statistics textbooks (see, for example, Chapter 1 of <span class="citation" data-cites="weisberg2014">Weisberg (<a href="references.html#ref-weisberg2014" role="doc-biblioref">2014</a>)</span>).</p>
<section id="sec-agg-count-exp" class="level4" data-number="3.1.1.1"><h4 data-number="3.1.1.1" class="anchored" data-anchor-id="sec-agg-count-exp">
<span class="header-section-number">3.1.1.1</span> When the outcome is an aggregated count</h4>
<p>Let us first consider the example of the river-blindness data in Liberia (<a href="01_intro.html#sec-rb-ch1" class="quarto-xref"><span>Section 1.4.2</span></a>), and examine the association between prevalence and elevation. We first generate a plot of the prevalence against the measured elevation at each of the sample locations</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">liberia</span><span class="op">$</span><span class="va">prev</span> <span class="op">&lt;-</span> <span class="va">liberia</span><span class="op">$</span><span class="va">npos</span><span class="op">/</span><span class="va">liberia</span><span class="op">$</span><span class="va">ntest</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">liberia</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">elevation</span>, y <span class="op">=</span> <span class="va">prev</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">"Elevation (meters)"</span>,y<span class="op">=</span><span class="st">"Prevalence"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-prev-elev-liberia" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-prev-elev-liberia-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03_model-fitting_files/figure-html/fig-prev-elev-liberia-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-prev-elev-liberia-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.1: Scatter plot of the empirical prevalence for river-blindess against elevation, measured in meters.
</figcaption></figure>
</div>
</div>
</div>
<p>The plot shown in <a href="#fig-prev-elev-liberia" class="quarto-xref">Figure&nbsp;<span>3.1</span></a> shows that, as elevation increases from 0 to around 150 meters, prevalence rapidly increases to around 0.25 and, for larger values in elevation than 150 meters, the relationship levels off. This begs the question of how we can account for this in a regression model. To answer this question rigorously, however, the plot in <a href="#fig-prev-elev-liberia" class="quarto-xref">Figure&nbsp;<span>3.1</span></a> cannot be used. This is because, when the modelled outcome is a bounded Binomial count, regression relationships are specified on the logit-transformed prevalence (log-odds) scale; see <a href="01_intro.html#tbl-glm" class="quarto-xref">Table&nbsp;<span>1.3</span></a> in Section <a href="01_intro.html#sec-geostat-models" class="quarto-xref"><span>Section 1.5</span></a> . To explore regression relationships in the case of prevalence data, it is convenient to use the so-called empirical logit in place of the empirical prevalence. The empirical logit is defined as</p>
<p><span id="eq-empirical-logit"><span class="math display">\[
l_{i} = \log\left\{\frac{y_i + 1/2}{n_i - y_i + 1/2}\right\}
\tag{3.1}\]</span></span></p>
<p>where <span class="math inline">\(y_i\)</span> are the number of individuals who tested positive for river-blindness and <span class="math inline">\(n_i\)</span> is the total number of people tested at a location. The reason for using the empirical logit, rather than the standard logit transformation applied directly to the empirical prevalence, is that it allows to generate finite values for empirical prevalence values of 0 and 1, for which the standard logit transformation is not defined.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># The empirical logit</span></span>
<span><span class="va">liberia</span><span class="op">$</span><span class="va">elogit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="op">(</span><span class="va">liberia</span><span class="op">$</span><span class="va">npos</span><span class="op">+</span><span class="fl">0.5</span><span class="op">)</span><span class="op">/</span></span>
<span>                      <span class="op">(</span><span class="va">liberia</span><span class="op">$</span><span class="va">ntest</span><span class="op">-</span><span class="va">liberia</span><span class="op">$</span><span class="va">npos</span><span class="op">+</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">liberia</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">elevation</span>, y <span class="op">=</span> <span class="va">elogit</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># Adding a smoothing spline</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">"Elevation (meters)"</span>,y<span class="op">=</span><span class="st">"Empirical logit"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"gam"</span>, formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,se<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># Adding linear regression fit with log-transformed elevation</span></span>
<span>  <span class="fu">stat_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>              col<span class="op">=</span><span class="st">"green"</span>,lty<span class="op">=</span><span class="st">"dashed"</span>,se<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="co"># Adding linear regression fit with change point in 150 meters</span></span>
<span>  <span class="fu">stat_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">x</span><span class="op">-</span><span class="fl">150</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>              col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="st">"dashed"</span>,se<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> </span>
<span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-elogit-elev-liberia" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-elogit-elev-liberia-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03_model-fitting_files/figure-html/fig-elogit-elev-liberia-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-elogit-elev-liberia-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.2: Scatter plot of the empirical prevalence for river-blindess against elevation, measured in meters.
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-elogit-elev-liberia" class="quarto-xref">Figure&nbsp;<span>3.2</span></a> shows the scatter plot of the empirical logit against elevation. In this plot, we have also added three lines though the <code>stat_smooth</code> from the <code>ggplot2</code> package. Using this function, we first pass the term <code>gam</code> to <code>method</code> to add a penalized smoothing spline <span class="citation" data-cites="hastie2001">(<a href="references.html#ref-hastie2001" role="doc-biblioref">Hastie, Tibshirani, and Friedman 2001</a>)</span>, represented by the blue solid line. The smoothing spline allows us to better discern how the type of relationship and how to best capture it using a standard regression approach. As er can see from <a href="#fig-elogit-elev-liberia" class="quarto-xref">Figure&nbsp;<span>3.2</span></a>, the smoothing spline corroborates our initial observation of a positive relationship up to about 150 meters, followed by a plateau.</p>
<p>To capture this non-linear relationship, we can use the two following approaches. The first is based on a simple log-transformation of elevation and is represented in <a href="#fig-elogit-elev-liberia" class="quarto-xref">Figure&nbsp;<span>3.2</span></a> by the green line. If were to express this relationship using a standard Binomial regression model, this would take the form <span id="eq-log-elev-glm"><span class="math display">\[
\log\left\{\frac{p(x_i)}{1-p(x_i)}\right\} = \beta_0 + \beta_1 \log\{e(x_i)\}
\tag{3.2}\]</span></span> where <span class="math inline">\(p(x_i)\)</span> and <span class="math inline">\(e(x_i)\)</span> are the river-blindness prevalence and elevation at sampled location <span class="math inline">\(x_i\)</span>, respectively.</p>
<p>Alternatively, the non-linear effect of elevation on prevalence could be captured using a linear spline. Put in simple terms, we want to fit a linear regression model that allows for a change in slope above 150 meters. Formally, this is expressed in a Binomial regression model as <span id="eq-lspline-elev-glm"><span class="math display">\[
\log\left\{\frac{p(x_i)}{1-p(x_i)}\right\} = \beta_0 + \beta_1 e(x_i) + \beta_{2} \max\{e(x_i)-150, 0\}.
\tag{3.3}\]</span></span> Based on the equation above, the effect of elevation below 150 meters is quantified by the parameter <span class="math inline">\(\beta_1\)</span>. Above 150 meters, instead, the effect of elevation becomes <span class="math inline">\(\beta_1 + \beta_2\)</span>. Note that the function <code>pmax</code> (and not the standard base function <code>max</code>) should be used in R when the computation of the maximum between a scalar value and each of the components of a numeric vector is required.</p>
<p>Before proceeding further, it is important to explain the differences between the use of the logarithmic transformation (<a href="#eq-log-elev-glm" class="quarto-xref">Equation&nbsp;<span>3.2</span></a>) and the linear spline (<a href="#eq-lspline-elev-glm" class="quarto-xref">Equation&nbsp;<span>3.3</span></a>). We observe that both curves provide a similar fit to the data, with larger differences observed for larger values in elevation, where the log-transformed elevation models yields larger values for the predicted prevalence. This also suggests that if we were to extrapolate the predictions beyond 600 meters in elevation the implied pattern by the model with the log-transformed elevation would predict an increasingly larger elevation, which is unrealistic, since the fly that transmits the diseases cannot breed at those altitudes. The linear spline model instead would generate predictions that would be very similar to those observed between 150 and 600 meters. From this point view, the linear spline model would thus have more scientific validity than the other model. However, which of the two approaches should be chosen to model the effect of elevation is a question that closely depends on the research question to be addressed.</p>
<p>If the interest of the study was in better understanding the association between elevation and prevalence, the linear spline model does not only provide a more credible explanation but also its regression parameters can be more easily interpreted. In fact, for a unit increase in elevation, the multiplicative change in the odds for river-blindness is <span class="math inline">\(\exp\{\beta_1\}\)</span>, if elevation is below 150 meters, and <span class="math inline">\(\exp\{\beta_1+\beta_2\}\)</span>, if elevation is above 150 meters. When instead we use the log-transformed elevation, the interpretation of <span class="math inline">\(\beta_1\)</span> in <a href="#eq-log-elev-glm" class="quarto-xref">Equation&nbsp;<span>3.2</span></a> is slightly more complicated, as it is based on the multiplicative increase in elevation by the same amount given by the base of the algorithm, which is about <span class="math inline">\(e \approx 2.718\)</span><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. To avoid this, one could rescale the regression coefficient as, for example, <span class="math inline">\(\beta_1/\log_{2}(e)\)</span> which would be interpreted as the multiplicative change in the odds for river-blindness for a doubling in elevation. However, a doubling in elevation is less meaningful when considering larger values of elevation.</p>
<p>When the goal of statistical analysis is instead in developing a predictive model for the outcome of interest, the explanatory power and interpretability of the model may be of less concern. For this reason, the model with the log-transformed model could be preferred over the model with the linear spline, if it shown to yield more predictive power. We will come back to this point again in <a href="04_geostatistical-prediction.html" class="quarto-xref"><span>Chapter 4</span></a>, where will show how to assess and compare the predictive performance of different geostatistical models.</p>
<p>The other type of aggregated count data that we consider are unbounded counts. The Anopheles mosquitoes data-set (<a href="01_intro.html#sec-mosq-data-ch1" class="quarto-xref"><span>Section 1.4.4</span></a>) is an example of this, since there is no upper limit to the number of mosquitoes that can be trapped at a location. Let us consider the covariate represented by elevation. In this case, the simplest model that can be used to analyse the data is a Poisson regression, where the linear predictor is defined on the log of the mean number of mosquitoes (<a href="01_intro.html#tbl-glm" class="quarto-xref">Table&nbsp;<span>1.3</span></a>). Hence, exploratory plots for the association with covariates should be generated using the log transformed counts of mosquitoes. In this instance, to avoid taking the log of zero, we can add 1 to the reported counts, if required. The variable of the <code>An.gambiae</code> in the <code>anopheles</code> data-set does not contain any 0, hence we simply apply the log tranformation without adding 1.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">anopheles</span><span class="op">$</span><span class="va">log_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">anopheles</span><span class="op">$</span><span class="va">An.gambiae</span><span class="op">)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">anopheles</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">elevation</span>, y <span class="op">=</span> <span class="va">log_counts</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># Adding a smoothing spline</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">"Elevation (meters)"</span>,y<span class="op">=</span><span class="st">"Log number of An. gambiae mosquitoes"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, se<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-logcounts-elev-mosq" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-logcounts-elev-mosq-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03_model-fitting_files/figure-html/fig-logcounts-elev-mosq-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-logcounts-elev-mosq-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.3: Scatter plot of the log tranformed number of <em>Anopheles gambiae</em> mosquitoes against elevation, measured in meters. The blue line is generated using the least squares fit.
</figcaption></figure>
</div>
</div>
</div>
<p>The scatter plot of <a href="#fig-logcounts-elev-mosq" class="quarto-xref">Figure&nbsp;<span>3.3</span></a> shows that there is a negative, though weak, association, with the average number of mosquitoes decreasing for increasing elevation. In this instance, the assumption of a linear relationship with elevation would be a reasonable choice.</p>
</section><section id="sec-indiv-expl-analysis" class="level4" data-number="3.1.1.2"><h4 data-number="3.1.1.2" class="anchored" data-anchor-id="sec-indiv-expl-analysis">
<span class="header-section-number">3.1.1.2</span> When the outcome is an invidual-level binary indicator</h4>
<p>We now consider the malaria data from Kenya (<a href="01_intro.html#sec-malaria-ch1" class="quarto-xref"><span>Section 1.4.3</span></a>) where the main outcome is the result from a rapid diagnostic test (RDT) for malaria from individuals within households. In this case, because the outcome only takes two values, 1 for a positive RDT test result and 0 otherwise, the direct application of the empirical logit from <a href="#eq-empirical-logit" class="quarto-xref">Equation&nbsp;<span>3.1</span></a> would not help us to generate informative scatter plots. Throughout the book, we will consider the data from the community survey only, hence we work with a subset of the data which we shall name <code>malkenya_comm</code></p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">malkenya_comm</span> <span class="op">&lt;-</span> <span class="va">malkenya</span><span class="op">[</span><span class="va">malkenya</span><span class="op">$</span><span class="va">Survey</span><span class="op">==</span><span class="st">"community"</span>, <span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To show how this issue can be overcome, let us consider the variables age and gender. To generate a plot that can help us understand between the relationship with malaria prevalence and the two risk factors, we proceed as follows.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Grouping of ages into classes defined through "breaks"</span></span>
<span><span class="va">malkenya_comm</span><span class="op">$</span><span class="va">Age_class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">malkenya_comm</span><span class="op">$</span><span class="va">Age</span>, </span>
<span>                            breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">30</span>, <span class="fl">40</span>, <span class="fl">50</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>                            include.lowest <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using the <code>cut</code> function, we first split age (in years) into classes through the argument <code>breaks</code>. The classification of age into <span class="math inline">\([0,5]\)</span>, <span class="math inline">\((5, 10]\)</span> and <span class="math inline">\((10, 15]\)</span> is common in many malaria epidemiology studies, as children are one of the groups at highest risk malaria. The choice of the other classes of age reflects instead the need to balance the number of observations falling in each of the classes.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Computation of the empirical logit by age groups and gender</span></span>
<span><span class="va">age_class_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">RDT</span> <span class="op">~</span> <span class="va">Age_class</span> <span class="op">+</span> <span class="va">Gender</span>, </span>
<span>                                    data <span class="op">=</span> <span class="va">malkenya_comm</span>, </span>
<span>                                    FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> </span>
<span>                                    <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">+</span><span class="fl">0.5</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">+</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then compute the empirical logit, using the total number of cases within age group and by gender. For a given age group and gender, which we denote as <span class="math inline">\(\mathcal{C}\)</span>, the empirical logit in <a href="#eq-empirical-logit" class="quarto-xref">Equation&nbsp;<span>3.1</span></a>, now takes the form <span id="eq-empirical-logit-bin"><span class="math display">\[
l_{\mathcal{C}} = \log\left\{\frac{\sum_{i \in \mathcal{C}} y_{i} + 0.5}{|\mathcal{C}|- \sum_{i \in \mathcal{C}} y_{i} + 0.5} \right\}
\tag{3.4}\]</span></span> where <span class="math inline">\(y_i\)</span> are the individual binary outcomes and <span class="math inline">\(i\in \mathcal{C}\)</span> is used to indicate that the sum is carried out over all the individuals who belong the class <span class="math inline">\(\mathcal{C}\)</span>, identified by a specific age group and gender. Finally, <span class="math inline">\(|\mathcal{C}|\)</span> is the number of individuals who fall within <span class="math inline">\(\mathcal{C}\)</span>. In the code above, the empirical logit in <a href="#eq-empirical-logit-bin" class="quarto-xref">Equation&nbsp;<span>3.4</span></a> is computed using the <code>aggregate</code> function. An inspection of the object <code>age_class_data</code>, a data frame, shows that the empirical is found in the column named <code>RDT</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Computation of the average age within each age group </span></span>
<span><span class="va">age_class_data</span><span class="op">$</span><span class="va">age_mean_point</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">Age</span> <span class="op">~</span> <span class="va">Age_class</span> <span class="op">+</span> <span class="va">Gender</span>, </span>
<span>                                 data <span class="op">=</span> <span class="va">malkenya_comm</span>, </span>
<span>                                 FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">$</span><span class="va">Age</span></span>
<span></span>
<span></span>
<span><span class="co"># Number of individuals within each age group, by gender</span></span>
<span><span class="va">age_class_data</span><span class="op">$</span><span class="va">n_obs</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">Age</span> <span class="op">~</span> <span class="va">Age_class</span> <span class="op">+</span> <span class="va">Gender</span>, </span>
<span>                         data <span class="op">=</span> <span class="va">malkenya_comm</span>, </span>
<span>                         FUN <span class="op">=</span> <span class="va">length</span><span class="op">)</span><span class="op">$</span><span class="va">Age</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In order to generate the scatter-plot, we compute the average age within each age group by gender, and use these as our values for the x-axis. Note that since we only need to obtain the average age from this output, we use <code>$Age</code> to extract this only and allocate to the column <code>age_mean_point</code>. Finally, we also compute the number of observations within each of classes and place this in <code>n_obs</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">age_class_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">age_mean_point</span>, y <span class="op">=</span> <span class="va">RDT</span>, </span>
<span>                           size <span class="op">=</span> <span class="va">n_obs</span>, </span>
<span>                           colour <span class="op">=</span> <span class="va">Gender</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">"Age (years)"</span>,y<span class="op">=</span><span class="st">"Empirical logit"</span><span class="op">)</span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-elogit-age-malkenya" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-elogit-age-malkenya-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03_model-fitting_files/figure-html/fig-elogit-age-malkenya-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-elogit-age-malkenya-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.4: Plot of the empirical logit against age, for males and females. The size of each solid point is rendered proportional to the number of individuals within age group, as indicated in the legend.
</figcaption></figure>
</div>
</div>
</div>
<p>The resulting plot in <a href="#fig-elogit-age-malkenya" class="quarto-xref">Figure&nbsp;<span>3.4</span></a> shows the empirical logit against age by gender, with the size of each of the points proportional to the number of observations falling within each class. The observed patterns are explained by the fact that young children, especially those under the age of five, are particularly vulnerable to severe malaria infections. This is primarily due to their immature immune systems and lack of acquired immunity. As individuals grow older, they generally develop partial immunity to malaria through repeated exposure to the disease. This acquired immunity can provide some level of protection against severe malaria. At the same time, gender roles and activities can influence exposure to malaria-carrying mosquitoes. For example, men may spend more time outdoors for work or other activities, increasing their exposure to mosquito bites and thus their risk of infection. In addition, there are also biological factors to consider. Hormonal and genetic differences between males and females may also contribute to variations in immune responses to malaria infection. The interaction between age and gender is complex and may vary depending on the specific context and population being studied. A 2020 report from the Bill &amp; Melinda Gates foundation provides a detailed overview of this and other aspects related to gender and malaria <span class="citation" data-cites="gates2020">(<a href="references.html#ref-gates2020" role="doc-biblioref">Katz and Bill &amp; Melinda Gates Foundation 2020</a>)</span>.</p>
<p>To account for age in a model for malaria prevalence, several approaches are possible, some of which have been developed using biological models <span class="citation" data-cites="smith2007">(<a href="references.html#ref-smith2007" role="doc-biblioref">Smith et al. 2007</a>)</span>. To model the patterns observed in <a href="#fig-elogit-age-malkenya" class="quarto-xref">Figure&nbsp;<span>3.4</span></a>, we can follow the same approach used in the previous section to model the relationship between elevation and river-blindness prevalence. First, let us consider age without the effect of gender. Let <span class="math inline">\(p_{j}(x_i)\)</span> denote the probability of a positive RDT for the <span class="math inline">\(j\)</span>-th individual living in a household at location <span class="math inline">\(x_i\)</span>. Assuming that malaria risk reaches its peak at 15 years of age, we can capture the non-linear relationship using a linear spline with two knots, one at 15 years and a second one at 40 years. This is expressed as <span id="eq-age-only-reg"><span class="math display">\[
\begin{aligned}
\log\left\{\frac{p_{j}(x_i)}{1-p_j(x_i)}\right\} = \beta_{0} + \beta_{1}a_{ij}+\beta_{2} \times\max\{a_{ij}-15, 0\} + \beta_{3}\max\{a_{ij}-40, 0\}
\end{aligned}
\tag{3.5}\]</span></span> where <span class="math inline">\(a_{ij}\)</span> is the age, in years, for the <span class="math inline">\(j\)</span>-th individual at household <span class="math inline">\(i\)</span>. Based on this model the effect of age on RDT prevalence is <span class="math inline">\(\beta_{1}\)</span>, for <span class="math inline">\(a_{ij} &lt; 15\)</span>, <span class="math inline">\(\beta_{1}+\beta_{2}\)</span>, for <span class="math inline">\(15 &lt; a_{ij} &lt; 40\)</span>, and <span class="math inline">\(\beta_{1}+\beta_{2}+\beta_{3}\)</span> for <span class="math inline">\(a_{ij} &gt; 40\)</span>.</p>
<p><a href="#fig-elogit-age-malkenya" class="quarto-xref">Figure&nbsp;<span>3.4</span></a> indicates that age may interact with gender, meaning that the effect of gender on RDT prevalence changes across age, with larger differences observed between males and females for ages above 20 years. To assess such differences using a standard Binomial regression model, the linear predictor for RDT prevalence can be formulated as <span id="eq-age-inter-reg"><span class="math display">\[
\begin{aligned}
\log\left\{\frac{p_{j}(x_i)}{1-p_j(x_i)}\right\} = \beta_{0} + (\beta_{1} + \beta_{1}^*g_{ij})\times a_{ij}+(\beta_{2} + \beta_{2}^*g_{ij})\times\max\{a_{ij}-15, 0\} + \\
(\beta_{3} + \beta_{3}^*g_{ij}) \times \max\{a_{ij}-40, 0\}
\end{aligned}
\tag{3.6}\]</span></span> where <span class="math inline">\(g_{ij}\)</span> is the indicator for gender, with 1 corresponding to male and 0 to female. The coefficients <span class="math inline">\(\beta_{1}^*\)</span>, <span class="math inline">\(\beta_{2}^*\)</span> and <span class="math inline">\(\beta_{3}^*\)</span> thus quantify the differences in risk between the two genders for ages below 15 years, betwee 15 and 40 years, and above 40 years, respectively. If all of those coefficients were 0, the model in <a href="#eq-age-only-reg" class="quarto-xref">Equation&nbsp;<span>3.5</span></a> would be recovered.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">glm_age_gender_interaction</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">RDT</span> <span class="op">~</span> <span class="va">Age</span> <span class="op">+</span> <span class="va">Gender</span><span class="op">:</span><span class="va">Age</span> <span class="op">+</span> </span>
<span>                                  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">Age</span><span class="op">-</span><span class="fl">15</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> <span class="va">Gender</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">Age</span><span class="op">-</span><span class="fl">15</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                                  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">Age</span><span class="op">-</span><span class="fl">40</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> <span class="va">Gender</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">Age</span><span class="op">-</span><span class="fl">40</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>                              data <span class="op">=</span> <span class="va">malkenya_comm</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">glm_age_gender_interaction</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## glm(formula = RDT ~ Age + Gender:Age + pmax(Age - 15, 0) + Gender:pmax(Age - </span></span>
<span><span class="co">##     15, 0) + pmax(Age - 40, 0) + Gender:pmax(Age - 40, 0), family = binomial, </span></span>
<span><span class="co">##     data = malkenya_comm)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Coefficients:</span></span>
<span><span class="co">##                              Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span><span class="co">## (Intercept)                  -1.05835    0.10245 -10.331  &lt; 2e-16 ***</span></span>
<span><span class="co">## Age                          -0.03384    0.01310  -2.584  0.00978 ** </span></span>
<span><span class="co">## pmax(Age - 15, 0)            -0.03975    0.02356  -1.687  0.09162 .  </span></span>
<span><span class="co">## pmax(Age - 40, 0)             0.09170    0.02482   3.695  0.00022 ***</span></span>
<span><span class="co">## Age:GenderMale                0.01428    0.01221   1.170  0.24202    </span></span>
<span><span class="co">## GenderMale:pmax(Age - 15, 0) -0.03625    0.03145  -1.153  0.24908    </span></span>
<span><span class="co">## GenderMale:pmax(Age - 40, 0)  0.02451    0.04320   0.567  0.57052    </span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## (Dispersion parameter for binomial family taken to be 1)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     Null deviance: 2875.8  on 3351  degrees of freedom</span></span>
<span><span class="co">## Residual deviance: 2673.8  on 3345  degrees of freedom</span></span>
<span><span class="co">## AIC: 2687.8</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Number of Fisher Scoring iterations: 5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The code above shows how to fit the model specified in <a href="#eq-age-inter-reg" class="quarto-xref">Equation&nbsp;<span>3.6</span></a>. The terms <code>Age</code>, <code>pmax(Age-15, 0)</code> and <code>pmax(Age-40, 0)</code> respectively correspond to <span class="math inline">\(\beta_{1}\)</span>, <span class="math inline">\(\beta_{2}\)</span> and <span class="math inline">\(\beta_{3}\)</span>, whilst the <code>Gender:Age</code>, <code>Gender:pmax(Age-15, 0)</code> and <code>Gender:pmax(Age-40, 0)</code> to <span class="math inline">\(\beta_{1}^*\)</span>, <span class="math inline">\(\beta_{2}^*\)</span> and <span class="math inline">\(\beta_{3}^*\)</span>, respectively. In the summary of the fitted model, we observe that the interaction coefficients are non-statistically significant. However, removing the interaction based on the fact that each of the coefficients have each p-values larger than the conventional level of 5% would be wrong. Instead we should carry out the likelihood ratio test, as shown below.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">glm_age_gender_no_interaction</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">RDT</span> <span class="op">~</span> <span class="va">Age</span> <span class="op">+</span>  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">Age</span><span class="op">-</span><span class="fl">15</span>, <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="va">Age</span><span class="op">-</span><span class="fl">40</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>                              data <span class="op">=</span> <span class="va">malkenya_comm</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/anova.html">anova</a></span><span class="op">(</span><span class="va">glm_age_gender_no_interaction</span>, <span class="va">glm_age_gender_interaction</span>, test <span class="op">=</span> <span class="st">"Chisq"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["Resid. Df"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["Resid. Dev"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["Df"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["Deviance"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["Pr(>Chi)"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"3348","2":"2675.620","3":"NA","4":"NA","5":"NA","_rn_":"1"},{"1":"3345","2":"2673.815","3":"3","4":"1.805058","5":"0.6138348","_rn_":"2"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>To carry out the likelihood ratio test to assess the null hypothesis that <span class="math inline">\(\beta_{1}^*=\beta_{2}^*=\beta_{3}^*=0\)</span>, we first fit the simplified nested model under this null hypothesis. The likelihood ratio test can then be carried out using the <code>anova</code> command as shown. The p-value indicates that the we do not find evidence against the null hypothesis, hence in our analysis of the data we might favour the simplified model that does not assumes an interaction between the two genders.</p>
<p>The approach just illustrated, can also be applied to explore the association with other continuous variables that are a property of the household and not of the individual. Let us, for example, consider the variable <code>elevation</code> from the <code>malkenya</code> data-set.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">malkenya_comm</span><span class="op">$</span><span class="va">elevation_class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">malkenya_comm</span><span class="op">$</span><span class="va">elevation</span>,</span>
<span>                            breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">malkenya_comm</span><span class="op">$</span><span class="va">elevation</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                            include.lowest <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Following the same approach used for age, we first split elevation into classes. To define these, we use the deciles of the empirical distribution of <code>elevation</code> which we calculate using the <code>quantile</code> function above. In this way we also ensure that the number of observations falling within each class of elevation is approximately the same.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Computation of the empirical logit by classes of elevation</span></span>
<span><span class="va">elev_class_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">RDT</span> <span class="op">~</span> <span class="va">elevation_class</span>, </span>
<span>                                    data <span class="op">=</span> <span class="va">malkenya_comm</span>, </span>
<span>                                    FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> </span>
<span>                                    <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">+</span><span class="fl">0.5</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">+</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Computation of the average elevation within each class of elevation</span></span>
<span><span class="va">elev_class_data</span><span class="op">$</span><span class="va">elevation_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">elevation</span> <span class="op">~</span> <span class="va">elevation_class</span>, </span>
<span>                                    data <span class="op">=</span> <span class="va">malkenya_comm</span>, </span>
<span>                                    FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">$</span><span class="va">elevation</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then compute the empirical logit and the average elevation for each class of elevation. The empirical logit is computed as already defined in <a href="#eq-empirical-logit-bin" class="quarto-xref">Equation&nbsp;<span>3.4</span></a>, where now the definition of <span class="math inline">\(\mathcal{C}\)</span> is given by a specific decile used to split the distribution of elevation.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">elev_class_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">elevation_mean</span>, y <span class="op">=</span> <span class="va">RDT</span><span class="op">)</span>, </span>
<span>                           size <span class="op">=</span> <span class="va">n_obs</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">"Elevation (meters)"</span>,y<span class="op">=</span><span class="st">"Empirical logit"</span><span class="op">)</span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-elogit-elev-malkenya" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-elogit-elev-malkenya-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03_model-fitting_files/figure-html/fig-elogit-elev-malkenya-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-elogit-elev-malkenya-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.5: Plot of the empirical logit against elevation measured in meters.
</figcaption></figure>
</div>
</div>
</div>
<p>The resulting plot in <a href="#fig-elogit-elev-malkenya" class="quarto-xref">Figure&nbsp;<span>3.5</span></a> shows an approximately linear relationship with decreasing values of the empirical logit for increasing elevation. This is expected because the cooler environment at higher altitudes is less favourable to the development of the overall mosquito life cycle.</p>
<p>An alternative approach to generate a scatter plot for assessing the association between elevation and the empirical logit would be to aggregate the data at household level, rather than using classes of elevation. However, this approach does not work as the one illustrated above when only one individual is sampled for each location. In the case of the <code>malkenya</code> data, the great majority of the locations only include one individual making this second approach less useful than the one illustrated.</p>
<p>Other more sophisticated approaches for the exploration of the associations between covariates and binary outcomes are available. For example, the use of the empirical logit could be avoided by using non-parametric regression methods for Binomial outcomes <span class="citation" data-cites="bowman1997">(<a href="references.html#ref-bowman1997" role="doc-biblioref">Bowman 1997</a>)</span>, also implemented in <code>sm</code> package in R. Our view is that a careful exploratory analysis based on simpler methods, as those illustrated above, can be equally effective to inform the module formulation.</p>
</section></section><section id="sec-overdispersion" class="level3" data-number="3.1.2"><h3 data-number="3.1.2" class="anchored" data-anchor-id="sec-overdispersion">
<span class="header-section-number">3.1.2</span> Exploring overdispersion in count data</h3>
<p>One of the main advantages in the use of covariates is the ability to attribute part of the variation of the outcome to a set of measured variables and, hence, reduce the uncertainty of our inferences. However, it almost always the case that the finite number of covariates at our disposal is not enough to fully explain the variation in the outcome. In other words, the existence of unmeasured covariates that are related to the modelled outcome give rise to the so called residual variation. In a standard linear regression model the extent to which we are able to account for important covariates is directly linked to the size of the variance of the residuals. In the case of count data, instead, this link is less well defined and one of the main consequences of the omission of covariates, which we address in this chapter, is <em>overdispersion</em>.</p>
<p>Overdispersion occurs when the variability of the data is larger than that implied by the generalized linear model (GLM) fitted to them. For example, if we consider the Binomial distribution, the presence of overdispersion implies that <span class="math inline">\(V(Y_i) &gt; n_i \mu_{i}(1-\mu_i)\)</span>, where we recall that <span class="math inline">\(n_i\)</span> is the Binomial denominator and <span class="math inline">\(mu_i\)</span> is the probability of “success” for each of the <span class="math inline">\(n_i\)</span> Bernoulli trials; for a Poisson distribution with <span class="math inline">\(E(Y_i) = \mu_i\)</span>, instead, overdispersion implies that <span class="math inline">\(V(Y_i) &gt; \mu_{i}\)</span>.</p>
<p>Assessment of the overdispersion for count data can be carried out in different ways depending on the goal of the statistical analysis. Since the focus of this book is to illustrate how to formulate and apply geostatistical models, the most natural approach to assess overdispersion is through the use of generalized linear mixed models (GLMMs). The class of GLMMs that we consider in this and the next section are obtained by replacing the spatial Gaussian process <span class="math inline">\(S(x_i)\)</span> in introduced in <a href="01_intro.html#eq-linear-predictor-ch1" class="quarto-xref">Equation&nbsp;<span>1.4</span></a> with a set of mutually independent random effects, which we denote as <span class="math inline">\(Z_i\)</span>, and thus write <span id="eq-linear-predictor-glmms-ch2"><span class="math display">\[
g(\mu_i) = d(x_i)^\top \beta + Z_i.
\tag{3.7}\]</span></span> The model above accounts for the overdispersion in the data through <span class="math inline">\(Z_i\)</span> whose variance can be interpreted as an indicator of the amount of overdispersion. To show this, we carry out a small simulation as follows. For simplicity, we consider the Binomial mixed model with an intercept only, hence <span id="eq-bin-glmm-example"><span class="math display">\[
\log\left\{\frac{\mu_i}{1-\mu_i}\right\} = \beta_0 + Z_i
\tag{3.8}\]</span></span> and assume that the <span class="math inline">\(Z_i\)</span> follow a set of mutually independent Gaussian variables with mean 0 and variance <span class="math inline">\(\tau^2\)</span>. In our simulation we vary <span class="math inline">\(\beta_0\)</span> over the set <span class="math inline">\(\{-3, -2, -1, 0, 1, 2, 3\}\)</span> and set <span class="math inline">\(\tau^2=0.1\)</span> and the binomial denominators to <span class="math inline">\(n_i = 100\)</span>. For a given value of <span class="math inline">\(\beta_0\)</span>, we then proceed through the following iterative steps.</p>
<ul>
<li><p>Simulate 10,000 values for <span class="math inline">\(Z_i\)</span> from a Gaussian distribution with mean 0 and variance <span class="math inline">\(\tau^2\)</span>.</p></li>
<li><p>Compute the probabilities <span class="math inline">\(\mu_i\)</span> based on <a href="#eq-bin-glmm-example" class="quarto-xref">Equation&nbsp;<span>3.8</span></a>.</p></li>
<li><p>Simulate 10,000 values from a Binomial model with probability of success <span class="math inline">\(\mu_i\)</span> and denominator <span class="math inline">\(n_i\)</span>.</p></li>
<li><p>Compute the empirical variance of the counts <span class="math inline">\(y_i\)</span> simulated in the previous step.</p></li>
<li><p>Change the value of <span class="math inline">\(\beta_0\)</span> and repeat the previous steps, for all the values of <span class="math inline">\(\beta_0\)</span>.</p></li>
</ul>
<p>The code below shows the implementation of the above steps in R.</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Number of simulations</span></span>
<span><span class="va">n_sim</span> <span class="op">&lt;-</span> <span class="fl">10000</span></span>
<span></span>
<span><span class="co"># Variance of the Z_i</span></span>
<span><span class="va">tau2</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span></span>
<span><span class="co"># Binomial denominator </span></span>
<span><span class="va">bin_denom</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span></span>
<span><span class="co"># Intercept values</span></span>
<span><span class="va">beta0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="op">-</span><span class="fl">2</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Vector where we store the computed variance from</span></span>
<span><span class="co"># the simulated counts from the Binomial mixed model</span></span>
<span><span class="va">var_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">beta0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">beta0</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Simulation of the random effects Z_i</span></span>
<span>  <span class="va">Z_i_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n_sim</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">tau2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Linear predictor of the Binomial mixed model</span></span>
<span>  <span class="va">lp</span> <span class="op">&lt;-</span> <span class="va">beta0</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>  <span class="op">+</span> <span class="va">Z_i_sim</span></span>
<span>  </span>
<span>  <span class="co"># Probabilities of the Binomial distribution conditional on Z_i</span></span>
<span>  <span class="va">prob_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">lp</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">lp</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Simulation of the counts from the Binomial mixed model</span></span>
<span>  <span class="va">y_i_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">n_sim</span>, size <span class="op">=</span> <span class="va">bin_denom</span>, prob <span class="op">=</span> <span class="va">prob_sim</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Empirical variance from the simulated counts</span></span>
<span>  <span class="va">var_data</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">y_i_sim</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Probabilities from the standard Binomial model (Z_i = 0)</span></span>
<span><span class="va">probs_binomial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">beta0</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">beta0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Variance from the standard Binomial model</span></span>
<span><span class="va">var_bimomial</span> <span class="op">&lt;-</span> <span class="va">bin_denom</span><span class="op">*</span><span class="va">probs_binomial</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">probs_binomial</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="va">beta0</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">var_data</span>, <span class="va">var_bimomial</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"b"</span>, pch <span class="op">=</span> <span class="fl">20</span>,</span>
<span>        lty <span class="op">=</span> <span class="st">"solid"</span>, ylab <span class="op">=</span> <span class="st">"Variance"</span>, xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">beta</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">80</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Binomial mixed model"</span>, <span class="st">"Standard Binomial model"</span><span class="op">)</span>,</span>
<span>       col<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, lty <span class="op">=</span> <span class="st">"solid"</span>, cex <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-var-bin-glmm" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-var-bin-glmm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03_model-fitting_files/figure-html/fig-var-bin-glmm-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-var-bin-glmm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.6: Plot of the variances of the standard Binomial model and the Binomial mixed model (see <a href="#eq-bin-glmm-example" class="quarto-xref">Equation&nbsp;<span>3.8</span></a>) against <span class="math inline">\(\beta_0\)</span>
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-var-bin-glmm" class="quarto-xref">Figure&nbsp;<span>3.6</span></a> shows the results of the simulation. In this figure, the red line corresponds to the variance of a standard Binomial model, obtained by setting <span class="math inline">\(Z_i=0\)</span> and computed as <span class="math inline">\(n_i \mu_i (1-\mu_i)\)</span> with <span class="math inline">\(\mu_i = \exp\{\beta_0\}/(1+\exp\{\beta_0\})\)</span>. As expected, this plot shows that the variance of the simulated counts from the mixed model in <a href="#eq-bin-glmm-example" class="quarto-xref">Equation&nbsp;<span>3.8</span></a> exhibit a larger variance than would be expected under the standard Binomial model. It also indicates that the chosen value for the variance of <span class="math inline">\(Z_i\)</span> of <span class="math inline">\(\tau^2 = 0.1\)</span> corresponds to a significant amount of dispersion. One way to relate <span class="math inline">\(\tau^2\)</span> to the amount of overdispersion is by considering that, following from the properties of a univariate Gaussian distribution, <em>a priori</em> the <span class="math inline">\(Z_i\)</span> will take values between <span class="math inline">\(-1.96 \sqrt{\tau^2}\)</span> and <span class="math inline">\(+1.96 \sqrt{\tau^2}\)</span> with approximately 95<span class="math inline">\(\%\)</span> probability. That implies that <span class="math inline">\(\exp\{Z_i\}\)</span>, which expresses the effect of the random effects on the odds ratios, will be with 95<span class="math inline">\(\%\)</span> probability between <span class="math inline">\(\exp\{-1.96 \sqrt{\tau^2}\}\)</span> and <span class="math inline">\(\exp\{+1.96 \sqrt{\tau^2}\}\)</span>. By replacing <span class="math inline">\(\tau^2\)</span> with the chosen values for the simulation, those two becomes about 0.54 and 1.86, meaning that with the <span class="math inline">\(Z_i\)</span> with <span class="math inline">\(95\%\)</span> probability will have a multiplicative effect on the odds ratios between <span class="math inline">\(0.54\)</span> and <span class="math inline">\(1.86\)</span>.</p>
<p>We encourage you to do Exercise 1 and Exercise 2 at the end of this chapter, to further explore how generalized linear mixed models can be used as a tool to account for overdispersion.</p>
<section id="maximum-likelihood-estimation-of-generalized-linear-mixed-models-for-count-data" class="level4" data-number="3.1.2.1"><h4 data-number="3.1.2.1" class="anchored" data-anchor-id="maximum-likelihood-estimation-of-generalized-linear-mixed-models-for-count-data">
<span class="header-section-number">3.1.2.1</span> Maximum likelihood estimation of generalized linear mixed models for count data</h4>
<p>We now illustrate how to fit a generalize linear mixed, using the <code>anopheles</code> data-set as an example. We consider two models: an intercept-only model and one that uses elevation as a covariate. Let <span class="math inline">\(\mu(x_i)\)</span> be the number of mosquitoes captured at a location <span class="math inline">\(x_i\)</span>; then the linear predictor with elevation as a covariate takes the form <span id="eq-anopheles-glmm"><span class="math display">\[
\log\{\mu_i\} = \beta_{0} + \beta_{1} d(x_i) + Z_i
\tag{3.9}\]</span></span> where <span class="math inline">\(d(x_i)\)</span> indicates the elevation in meters at location <span class="math inline">\(x_i\)</span> and the <span class="math inline">\(Z_i\)</span> are independent and identically distributed Gaussian variables with mean 0 and variance <span class="math inline">\(\tau^2\)</span>. The model with an intercept only is simply obtained by setting <span class="math inline">\(\beta_1 = 0\)</span>.</p>
<p>We carry out the estimation in R using the <code>glmer</code> function from the <code>lme4</code> package (see <span class="citation" data-cites="bates2015">Bates et al. (<a href="references.html#ref-bates2015" role="doc-biblioref">2015</a>)</span> for a detailed tutorial). The <code>glmer</code> function implements the maximum likelihood estimation for generalized linear mixed models. The code below shows how the <code>glmer</code> is used to carry out this step for the model in <a href="#eq-anopheles-glmm" class="quarto-xref">Equation&nbsp;<span>3.9</span></a> and the one withuot covariates.</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create the ID of the location</span></span>
<span><span class="va">anopheles</span><span class="op">$</span><span class="va">ID_loc</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">anopheles</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Poisson mixed model with elevation</span></span>
<span><span class="va">fit_glmer_elev</span> <span class="op">&lt;-</span> <span class="fu">glmer</span><span class="op">(</span><span class="va">An.gambiae</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">elevation</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">ID_loc</span><span class="op">)</span>, family <span class="op">=</span> <span class="va">poisson</span>, </span>
<span>                        data <span class="op">=</span> <span class="va">anopheles</span>, nAGQ <span class="op">=</span> <span class="fl">25</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Poisson mixed model with intercept only</span></span>
<span><span class="va">fit_glmer_int</span> <span class="op">&lt;-</span> <span class="fu">glmer</span><span class="op">(</span><span class="va">An.gambiae</span> <span class="op">~</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">ID_loc</span><span class="op">)</span>, family <span class="op">=</span> <span class="va">poisson</span>, </span>
<span>                        data <span class="op">=</span> <span class="va">anopheles</span>, nAGQ <span class="op">=</span> <span class="fl">25</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To fit the model with <code>glmer</code>, we first must create a variable in our data-set that allows us to identify the location associated with each count. In this case, since every row corresponds to a different location, we simply use the row number to identify the locations and save this in the <code>ID_loc</code> variable. The random effects <span class="math inline">\(Z_i\)</span> are then included in the model by adding <code>(1 | ID_loc)</code> in the formula of the <code>glmer</code> function.</p>
<p>When introducing the variable elevation, we standardize the variable so that its mean is 0 and its variance is 1. This is done to aid the convergence of the algorithm used to fit the model and it is generally considered good practice, especially when many variables with different scales are used as covariates. However, we emphasize that standardizing a variable does not affect the fit of the model to the data. This is because the model with the standardized variable is a reparametrization of the model with the unstandardized variable. In other words, a model that uses standardized covariates only attaches a different interpretation to its regression coefficients while maintaining the same goodness of fit of the model with that uses the covariates on their original scale.</p>
<p>The argument <code>nAGQ</code> is used to define the precision of the approximation of the maximum likelihood estimation algorithm. By default <code>nAGQ = 1</code>, which corresponds to the Laplace approximation. Values for <code>nAGQ</code> larger than 1 are used to define the number of points of the adaptive Gaussian-Hermite quadrature. The general principle is that the larger <code>nAGQ</code> the better, but at the expense of an increased computing time. Based on the guidelines and help pages of the <code>lme4</code> package, it is stated that a reasonable value for <code>nAGQ</code> is 25. For more technical details on this aspect, we refer the reader to <span class="citation" data-cites="bates2015">Bates et al. (<a href="references.html#ref-bates2015" role="doc-biblioref">2015</a>)</span>.</p>
<p>We can now look at the summary of the fitted models to the mosquitoes data-set.</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Summary of the model with elevation</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit_glmer_elev</span><span class="op">)</span></span>
<span><span class="co">## Generalized linear mixed model fit by maximum likelihood (Adaptive</span></span>
<span><span class="co">##   Gauss-Hermite Quadrature, nAGQ = 25) [glmerMod]</span></span>
<span><span class="co">##  Family: poisson  ( log )</span></span>
<span><span class="co">## Formula: An.gambiae ~ scale(elevation) + (1 | ID_loc)</span></span>
<span><span class="co">##    Data: anopheles</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##       AIC       BIC    logLik -2*log(L)  df.resid </span></span>
<span><span class="co">##     291.8     300.1    -142.9     285.8       113 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Scaled residuals: </span></span>
<span><span class="co">##      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">## -0.89574 -0.42469 -0.09483  0.29445  0.53352 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Random effects:</span></span>
<span><span class="co">##  Groups Name        Variance Std.Dev.</span></span>
<span><span class="co">##  ID_loc (Intercept) 0.7146   0.8453  </span></span>
<span><span class="co">## Number of obs: 116, groups:  ID_loc, 116</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Fixed effects:</span></span>
<span><span class="co">##                  Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span><span class="co">## (Intercept)       1.53042    0.09365  16.342   &lt;2e-16 ***</span></span>
<span><span class="co">## scale(elevation) -0.19794    0.08950  -2.212    0.027 *  </span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Correlation of Fixed Effects:</span></span>
<span><span class="co">##             (Intr)</span></span>
<span><span class="co">## scale(lvtn) 0.036</span></span>
<span></span>
<span><span class="co">### Summary of the model with the intercept only</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit_glmer_int</span><span class="op">)</span></span>
<span><span class="co">## Generalized linear mixed model fit by maximum likelihood (Adaptive</span></span>
<span><span class="co">##   Gauss-Hermite Quadrature, nAGQ = 25) [glmerMod]</span></span>
<span><span class="co">##  Family: poisson  ( log )</span></span>
<span><span class="co">## Formula: An.gambiae ~ (1 | ID_loc)</span></span>
<span><span class="co">##    Data: anopheles</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##       AIC       BIC    logLik -2*log(L)  df.resid </span></span>
<span><span class="co">##     294.6     300.1    -145.3     290.6       114 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Scaled residuals: </span></span>
<span><span class="co">##      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">## -0.73816 -0.42718 -0.06941  0.26564  0.45022 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Random effects:</span></span>
<span><span class="co">##  Groups Name        Variance Std.Dev.</span></span>
<span><span class="co">##  ID_loc (Intercept) 0.761    0.8724  </span></span>
<span><span class="co">## Number of obs: 116, groups:  ID_loc, 116</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Fixed effects:</span></span>
<span><span class="co">##             Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span><span class="co">## (Intercept)  1.52849    0.09584   15.95   &lt;2e-16 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>From the summary of the model that uses elevation, we observe the that the estimated regression coefficient <span class="math inline">\(\beta_{1}\)</span> is statistically significant different from 0. The interpretation of the estimated regression coefficient is the following: for an increase of about 100 meters in elevation, all other things being equal, the average number of mosquitoes decreases by about <span class="math inline">\(100\% \times [1-\exp\{-0.19794\}] \approx 18\%\)</span>. Note that when using a standardized variable, a unit increase for this corresponds to an increase in the original unstandardized variable equal to its standard deviation, which for the <code>elevation</code> variable is about 100 meters.</p>
<p>From the summaries of the two models, under <code>Random effects:</code>, we obtain the estimates associates with the random effects introduced in the model. In this case, since we only have introduced <span class="math inline">\(Z_i\)</span>, this part of summary provides the maximum likelihood estimate for <span class="math inline">\(\tau^2\)</span>, the variance of <span class="math inline">\(Z_i\)</span>, which found on the line where <code>ID_loc</code> is printed. We then observe that the estimates for <span class="math inline">\(\tau^2\)</span> for the intercept-only model is <code>0.761</code>, whilst for the model with elevation this is <code>0.7146</code>. Note that the figures reported under <code>Std.Dev.</code> are simply the square root of the value reported under <code>Variance</code>. As expected, the introduction of elevation contributes to the explanation of the residual variation captured by <span class="math inline">\(Z_i\)</span>, though by a very small amount. The estimated values of <span class="math inline">\(\tau^2\)</span> thus suggest that there is extra-Binomial variation in the data that is not account for by elevation.</p>
<p>In the next section, we will illustrate how to assess the presence of residual correlation for continuous measurements and overdispersed count data.</p>
</section></section><section id="sec-expl-spatial" class="level3" data-number="3.1.3"><h3 data-number="3.1.3" class="anchored" data-anchor-id="sec-expl-spatial">
<span class="header-section-number">3.1.3</span> Exploring residual spatial correlation</h3>
<p>In its most basic form, the concept of spatial correlation can be succinctly encapsulated by <span class="citation" data-cites="tobler1970">Tobler (<a href="references.html#ref-tobler1970" role="doc-biblioref">1970</a>)</span> first law of geography, which posits that “everything is interconnected, but objects in close proximity exhibit stronger relationships than those situated farther apart.” After we have identified the key variables to introduce as covariates in the model (<a href="#sec-expl-assoc" class="quarto-xref"><span>Section 3.1.1</span></a>) and, in the case of count data, assessed the presence of overdispersion (<a href="#sec-overdispersion" class="quarto-xref"><span>Section 3.1.2</span></a>), our final exploratory step consists of assessing whether the residuals of the non spatial model show evidence of spatial correlation. Hence, in geostatistical modelling, the interest is not in the spatial correlation of the data, but rather on understanding whether the variation in the outcome unexplained by the covariates exhibits spatial correlation. We call this <em>residual spatial correlation</em>, to emphasize that spatial correlation is a concept relative to the covariates that we have introduced in the model.</p>
<p>In the context of geostatistical analysis, the tool that is generally used to assess the residual spatial correlation is the the so called <em>empirical variogram</em>. Before looking at the mathematical definition of the empirical variogram, let us consider a generalized linear mixed model as expressed in <a href="#eq-linear-predictor-glmms-ch2" class="quarto-xref">Equation&nbsp;<span>3.7</span></a>. Our goal is then to question the assumption of independently distributed random effects <span class="math inline">\(Z_i\)</span> by asking whether the <span class="math inline">\(Z_i\)</span> show evidence of spatial correlation. Let <span class="math inline">\(Z_i\)</span> and <span class="math inline">\(Z_j\)</span> be two random effects that are associate with two different locations <span class="math inline">\(x_i\)</span> and <span class="math inline">\(x_j\)</span>, respectively, and let us take the squared difference between the two <span id="eq-squared-diff"><span class="math display">\[
V_{ij} = (Z_i - Z_j)^2.
\tag{3.10}\]</span></span> How does the spatial correlation affect the value of <span class="math inline">\(V_{ij}\)</span>? To answer this question, we can refer to the aforementioned Tobler’s law of geography. When <span class="math inline">\(x_i\)</span> and <span class="math inline">\(x_j\)</span> will be closer to each other, then <span class="math inline">\(Z_i\)</span> and <span class="math inline">\(Z_j\)</span> will also tend to be more similar to each other, thus making <span class="math inline">\(V_{ij}\)</span> smaller, on average. On the contrary, when <span class="math inline">\(x_i\)</span> and <span class="math inline">\(x_j\)</span> will be further apart, then <span class="math inline">\(V_{ij}\)</span> will become larger, on average. We can then construct the empirical variogram by considering all possible pairs of locations <span class="math inline">\(x_i\)</span> and <span class="math inline">\(x_j\)</span>, for which we then compute <span class="math inline">\(V_{ij}\)</span> and plot this against the distance between <span class="math inline">\(x_i\)</span> and <span class="math inline">\(x_j\)</span>, which we denote as <span class="math inline">\(u_{ij}\)</span>. If there is spatial correlation in the random effects <span class="math inline">\(Z_i\)</span>, then this will manifest as an average increase in the <span class="math inline">\(V_{ij}\)</span> as <span class="math inline">\(u_{ij}\)</span> increases. However, there are still two issues that we have to address before we can generate and plot the empirical variogram.</p>
<p>The first issue is that we do not observe <span class="math inline">\(Z_i\)</span> as, by definition, this is a latent variable. Hence, we require an estimate for <span class="math inline">\(Z_i\)</span> which we can then feed into <span class="math inline">\(V_{ij}\)</span>. To emphasize this point, from now on, we shall replace <a href="#eq-squared-diff" class="quarto-xref">Equation&nbsp;<span>3.10</span></a> with <span id="eq-hat-squared-diff"><span class="math display">\[
\hat{V}_{ij} = (\hat{Z}_{i} - \hat{Z}_j)^2.
\tag{3.11}\]</span></span> Several options are available for estimating <span class="math inline">\(Z_{i}\)</span>. Our choice is to use the model of the predictive distribution of <span class="math inline">\(Z_i\)</span>, that is the distribution of <span class="math inline">\(Z_{i}\)</span> conditioned to the data <span class="math inline">\(y_i\)</span>. This estimator for <span class="math inline">\(Z_i\)</span> is also readily available from the output of the <code>lmer</code> and <code>glmer</code> functions of the <code>lme4</code> package, as we will illustrate later in our example in this section.</p>
<p>The second issue is that if simply plot <span class="math inline">\(\hat{V}_{ij}\)</span> against the distances <span class="math inline">\(u_{ij}\)</span> (also knwon as <em>cloud variogram</em>), due to the high noiseness in the <span class="math inline">\(\hat{V}_{ij}\)</span>, it may be quite difficult to assess the presence of an increasing trend in the <span class="math inline">\(\hat{V}_{ij}\)</span> and thus detect spatial correlation. Hence, it is general practice to group the distances <span class="math inline">\(u_{ij}\)</span> into classes, say <span class="math inline">\(\mathcal{U}\)</span>, and then take average of all the <span class="math inline">\(\hat{V}_{ij}\)</span> that fall within <span class="math inline">\(\mathcal{U}\)</span>.</p>
<p>We can now write the formal definition of the empirical variogram as <span id="eq-empirical-variogram"><span class="math display">\[
\hat{V}(\mathcal{U}) = \frac{1}{2 |\mathcal{U}|} \sum_{(i, j): (u_i, u_j) \in \mathcal{U}} \hat{V}_{ij}
\tag{3.12}\]</span></span> where <span class="math inline">\(|\mathcal{U}|\)</span> denotes the number of pairs of locations that fall within the distance class <span class="math inline">\(\mathcal{U}\)</span>. The rationale behind dividing by 2 in <span class="math inline">\(1/2 |\mathcal{U}|\)</span> from the above equation, will be elucidated in <a href="#sec-linear-model" class="quarto-xref"><span>Section 3.2</span></a>, and there is no need for us to delve into this matter at this juncture. When creating the empirical variogram plot, we select the midpoint values of the distance classes <span class="math inline">\(\mathcal{U}\)</span> to represent the x-axis values.</p>
<p>Before we can evaluate residual spatial correlation, there remains one crucial concern: relying solely on a visual inspection of the empirical variogram is susceptible to human subjectivity. Furthermore, it is worth noting that even a seemingly upward trend observed in the empirical variogram might be merely a product of random fluctuations, rather than a reliable indication of actual residual spatial correlation. To address these concerns and enhance the objectivity of the use of the empirical variogram, one approach would involve comparing the observed empirical variogram pattern with those generated in the absence of spatial correlation. Following this principle, we then use a permutation test that allows us to generate empirical variograms under the assumption of absence of spatial correlation through the following iterative steps.</p>
<ol type="1">
<li><p>Permute the order of the locations in the data-set while keeping everything else fixed.</p></li>
<li><p>Compute the empirical variogram <span class="math inline">\(\hat{V}(\mathcal{U})\)</span> for the permuted data-set.</p></li>
<li><p>Repeat 1 and 2 a large number of times, say 10,000.</p></li>
<li><p>Use the resulting 10,000 empirical varigorams to compute 95<span class="math inline">\(\%\)</span> confidence intervals, by taking the 0.025 and 0.975 quantiles of these for each distance class <span class="math inline">\(\hat{V}(\mathcal{U})\)</span>.</p></li>
<li><p>If the observed empirical variogram falls fully within the envelope generated in the previous point, we then conclude that the data do not exhibit residual spatial correlation. If, instead, the observed empirical variogram partly falls outside the envelope we conclude that the data do exhibit residual spatial correlation.</p></li>
</ol>
<p>We now show an application of all the concepts introduced in this section to the Liberia data on river-blindness.</p>
<section id="sec-empirical-variog-bin" class="level4" data-number="3.1.3.1"><h4 data-number="3.1.3.1" class="anchored" data-anchor-id="sec-empirical-variog-bin">
<span class="header-section-number">3.1.3.1</span> Example: assessing spatial correlation for the Liberia data</h4>
<p>We consider the Binomial mixed model that uses the log-transformed elevation as a covariate to model river blindness prevalence, hence <span id="eq-liberia-bin-mixed-elev"><span class="math display">\[
\log\left\{\frac{p(x_i)}{1-p(x_i)}\right\} = \beta_{0} + \beta_{1}\log\{e(x_i)\} + Z_i
\tag{3.13}\]</span></span> where <span class="math inline">\(e(x_i)\)</span> is the elevation in meters at location <span class="math inline">\(x_i\)</span> and the <span class="math inline">\(Z_i\)</span> are i.i.d. Gaussian variables with mean 0 and variance <span class="math inline">\(\tau^2\)</span>. We first fit the model above using the <code>glmer</code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Convert the data-set into an sf object</span></span>
<span><span class="va">liberia</span> <span class="op">&lt;-</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="va">liberia</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lat"</span>, <span class="st">"long"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Create the ID of the location</span></span>
<span><span class="va">liberia</span><span class="op">$</span><span class="va">ID_loc</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">liberia</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Binomial mixed model with log-elevation</span></span>
<span><span class="va">fit_glmer_lib</span> <span class="op">&lt;-</span> <span class="fu">glmer</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">npos</span>, <span class="va">ntest</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">elevation</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">ID_loc</span><span class="op">)</span>, family <span class="op">=</span> <span class="va">binomial</span>,</span>
<span>                        data <span class="op">=</span> <span class="va">liberia</span>, nAGQ <span class="op">=</span> <span class="fl">25</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit_glmer_lib</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized linear mixed model fit by maximum likelihood (Adaptive
  Gauss-Hermite Quadrature, nAGQ = 25) [glmerMod]
 Family: binomial  ( logit )
Formula: cbind(npos, ntest) ~ log(elevation) + (1 | ID_loc)
   Data: liberia

      AIC       BIC    logLik -2*log(L)  df.resid 
    127.9     135.4     -61.0     121.9        87 

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-2.46033 -0.63341 -0.07633  0.61995  3.12732 

Random effects:
 Groups Name        Variance Std.Dev.
 ID_loc (Intercept) 0.003097 0.05565 
Number of obs: 90, groups:  ID_loc, 90

Fixed effects:
               Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)    -2.96292    0.21184 -13.987  &lt; 2e-16 ***
log(elevation)  0.26143    0.04071   6.422 1.35e-10 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr)
log(elevtn) -0.981</code></pre>
</div>
</div>
<p>From the output, we observe that the estimate for <span class="math inline">\(\tau^2\)</span> is about 0.003, indicating a moderate level of overdispersion in the data.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">liberia</span><span class="op">$</span><span class="va">Z_hat</span> <span class="op">&lt;-</span> <span class="fu">ranef</span><span class="op">(</span><span class="va">fit_glmer_lib</span><span class="op">)</span><span class="op">$</span><span class="va">ID_loc</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Through the function <code>ranef</code> when extract the estimates of the random effects <span class="math inline">\(Z_i\)</span> and save these in the data set. We then use the function <code>s_variogram</code> from the <code>RiskMap</code> package to compute the empirical varigoram for the estimated <span class="math inline">\(\hat{Z}_i\)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">liberia_variog</span> <span class="op">&lt;-</span> <span class="fu">s_variogram</span><span class="op">(</span>data <span class="op">=</span> <span class="va">liberia</span>,</span>
<span>                              variable <span class="op">=</span> <span class="st">"Z_hat"</span>,</span>
<span>                              bins <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">30</span>, <span class="fl">40</span>, <span class="fl">80</span>, <span class="fl">120</span>,</span>
<span>                                       <span class="fl">160</span>, <span class="fl">200</span>, <span class="fl">250</span>, <span class="fl">300</span>, <span class="fl">350</span><span class="op">)</span>,</span>
<span>                              scale_to_km <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                              n_permutation <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Through the argument <code>bins</code> we can specify the the classes of distance, previously denoted by <span class="math inline">\(\mathcal{U}\)</span>; check the help page of <code>s_variogram</code> to see how this is defined by default. The value passed to <code>bins</code> in the code above correspond to define the following classes of distance <span class="math inline">\(\mathcal{U}\)</span>: <span class="math inline">\([15, 30]\)</span>, <span class="math inline">\((30, 40]\)</span> and so forth, with the last class being <span class="math inline">\([350, +\infty)\)</span>, i.e.&nbsp;all pairs of locations whose distances are above 350km. The argument <code>n_permutation</code> allows the user to specify the number of permutations that are performed the generate the envelope for absence of spatial correlation previously described.</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">dist_summaries</span><span class="op">(</span>data <span class="op">=</span> <span class="va">liberia</span>,</span>
<span>               scale_to_km <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">## $min</span></span>
<span><span class="co">## [1] 3.204561</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $max</span></span>
<span><span class="co">## [1] 514.9768</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $mean</span></span>
<span><span class="co">## [1] 199.7156</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $median</span></span>
<span><span class="co">## [1] 185.7845</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>dist_summaries</code> function within the <code>RiskMap</code> package can be used for gauging the extent of the area covered by your dataset, aiding in the selection of appropriate values to be passed to the <code>bins</code> argument. In the provided output above, we can observe that for the Liberia dataset, the minimum and maximum distances span approximately 3km and 533km, respectively. While there is not a one-size-fits-all recommendation for setting <code>bins</code>, two fundamental principles should inform your decision-making. Firstly, it is advisable to avoid choosing overly large distance intervals, as the uncertainty associated with the empirical variogram tends to increase with distance due to fewer available pairs of observations for estimation. Secondly, especially when spatial correlation is not strong, it is crucial to carefully explore the behavior of the variogram at smaller distances. Consequently, it is generally advisable to experiment with different <code>bins</code> configurations and observe how they impact the pattern of the empirical variogram.</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">plot_s_variogram</span><span class="op">(</span><span class="va">liberia_variog</span>,</span>
<span>                 plot_envelope <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-liberia-variog" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-liberia-variog-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03_model-fitting_files/figure-html/fig-liberia-variog-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-liberia-variog-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.7: Plot of the empirical variogram (solid line) computed using the estimated random effects from the model in <a href="#eq-liberia-bin-mixed-elev" class="quarto-xref">Equation&nbsp;<span>3.13</span></a>. The blue shaded area is the 95% confidence level envelope generated using the permutation procedure described in <a href="#sec-expl-spatial" class="quarto-xref"><span>Section 3.1.3</span></a>.
</figcaption></figure>
</div>
</div>
</div>
<p>Finally, the <code>plot_s_variogram</code> function enables us to visualize the empirical variogram and, through the <code>plot_envelope</code> argument, include the envelope generated by the permutation procedure. As illustrated in <a href="#fig-liberia-variog" class="quarto-xref">Figure&nbsp;<span>3.7</span></a>, we observe that the empirical variogram falls outside the envelope at relatively short distances, typically below 30km. However, for distances exceeding 30km, the behavior of the empirical variogram does not significantly differ from variograms generated under the assumption of spatial independence. In summary, we interpret the evidence presented in <a href="#fig-liberia-variog" class="quarto-xref">Figure&nbsp;<span>3.7</span></a> as indicative of residual spatial correlation within the data. Nevertheless, it is essential to exercise caution when attempting to ascertain the scale of the spatial correlation using the empirical variogram. As we will emphasize throughout this book, the empirical variogram’s sensitivity to the choice of bins values renders it an unreliable tool for drawing statistical inferences. In other words, we advocate employing the empirical variogram primarily to assess the presence of residual correlation.</p>
</section><section id="sec-empirical-variog-lm" class="level4" data-number="3.1.3.2"><h4 data-number="3.1.3.2" class="anchored" data-anchor-id="sec-empirical-variog-lm">
<span class="header-section-number">3.1.3.2</span> Exploring residual spatial correlation with linear Guassian models</h4>
<p>When using a linear model to assess spatial correlation, it is important to distinguish two cases: 1) when the data contain only one location per location; 2) when more than one observation per location is available. We now consider each of these two scenarios separately.</p>
<section id="one-observation-per-location" class="level5" data-number="3.1.3.2.1"><h5 data-number="3.1.3.2.1" class="anchored" data-anchor-id="one-observation-per-location">
<span class="header-section-number">3.1.3.2.1</span> One observation per location</h5>
<p>To illustrate the use of the variogram under this scenario, we shall use the Gailicia data on lead concentration in moss samples. The simplest possible model for the data is a standard linear model without covariates which assumes independence among the observations, hence <span id="eq-std-lm-galicia"><span class="math display">\[
Y_i = \beta_0 + U_i
\tag{3.14}\]</span></span> where the <span class="math inline">\(U_i\)</span> are i.i.d. Gaussian variables with mean zero and variance <span class="math inline">\(\omega^2\)</span>. At this stage, our goal is then to assess whether the assumption of independence for the <span class="math inline">\(Z_i\)</span> is supported by the data or whether there is evidence of spatial correlation. However, the measurement error of the device may be present as part of the natural random variation in <span class="math inline">\(Z_i\)</span> which might mask the detection of spatial correlation using the residuals <span class="math inline">\(Z_i\)</span> challenging, especially is the measurement error dominates the spatial variation of the data. One would be tempted to introduce an additional, location-specific random effect, say <span class="math inline">\(Z_i\)</span> with mean zero and variance <span class="math inline">\(\tau^2\)</span> and fit the model <span id="eq-std-lm2-galicia"><span class="math display">\[
Y_i = \beta_0 + Z_i + U_i,
\tag{3.15}\]</span></span> where we interpret <span class="math inline">\(U_i\)</span> as random variation due to the measurement device and <span class="math inline">\(Z_i\)</span> as a random effect accounting for unmeasured covariates that contribute to the variation between locations in lead concentration. However, the model in <a href="#eq-std-lm2-galicia" class="quarto-xref">Equation&nbsp;<span>3.15</span></a> is not identifiable because we cannot disentangle the separate contributions of <span class="math inline">\(Z_i\)</span> and <span class="math inline">\(U_i\)</span> from the variation of the data, unless: a) we know the precision of the measurement device, <span class="math inline">\(\omega\)</span> (recall that <span class="math inline">\(\omega^2\)</span> is the variance of <span class="math inline">\(U_i\)</span>); b) or, if we do not know <span class="math inline">\(\omega\)</span>, we can then separate the two sources of variation only if we have multiple observations per location (the scenario which we shall consider in the next section).</p>
<p>For the Galicia data, for we do not know the measurement device precision and we only have one observation per location. However, this does not prevent us from using the variogram based on the residuals from <a href="#eq-std-lm-galicia" class="quarto-xref">Equation&nbsp;<span>3.14</span></a>, while keeping in mind the limitations and uncertainty that are inherent to this exploratory tool as remarked at the end of the last paragraph.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Fitting of the linear model and extraction of the residuals  </span></span>
<span><span class="va">lm_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">lead</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">galicia</span><span class="op">)</span></span>
<span><span class="va">galicia</span><span class="op">$</span><span class="va">residuals</span> <span class="op">&lt;-</span> <span class="va">lm_fit</span><span class="op">$</span><span class="va">residuals</span></span>
<span></span>
<span><span class="co"># Convert the galicia data frame into an "sf" object</span></span>
<span><span class="va">galicia_sf</span> <span class="op">&lt;-</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="va">galicia</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">32629</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute the variogram, using the residuals from the linear model fit,</span></span>
<span><span class="co"># and the 95% confidence level envelope for spatial independence</span></span>
<span><span class="va">galicia_variog</span> <span class="op">&lt;-</span> <span class="fu">s_variogram</span><span class="op">(</span><span class="va">galicia_sf</span>, variable <span class="op">=</span> <span class="st">"residuals"</span>,</span>
<span>                              scale_to_km <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                              bins <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">140</span>, length <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,</span>
<span>                              n_permutation <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plotting the results</span></span>
<span><span class="fu">plot_s_variogram</span><span class="op">(</span><span class="va">galicia_variog</span>, plot_envelope <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-galicia-variog" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-galicia-variog-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03_model-fitting_files/figure-html/fig-galicia-variog-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-galicia-variog-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.8: Plot of the empirical variogram (solid line) computed using the estimated residuals from the model in <a href="#eq-std-lm-galicia" class="quarto-xref">Equation&nbsp;<span>3.14</span></a>. The blue shaded area is the 95% confidence level envelope generated using the permutation procedure described in <a href="#sec-expl-spatial" class="quarto-xref"><span>Section 3.1.3</span></a>.
</figcaption></figure>
</div>
</div>
</div>
<p>In the code above, we first fit the linear model in <a href="#eq-std-lm-galicia" class="quarto-xref">Equation&nbsp;<span>3.14</span></a> and then extract the residuals from this. Note that for this simple model, the residuals of the model are obtained by simply centering the outcome to zero by subtracting its mean. However, for more complex linear models that use covariates the computation of the residuals is more involved and can be carried out through a simple extension of the code above by specifying an appropriate <code>formula</code> in the <code>lm</code> function.</p>
<p><a href="#fig-galicia-variog" class="quarto-xref">Figure&nbsp;<span>3.8</span></a> shows the empirical variogram and the 95% envelope for spatial independence. This clearly shows that the measurement of lead concentration are spatially correlated.</p>
</section><section id="sec-explanal-lm" class="level5" data-number="3.1.3.2.2"><h5 data-number="3.1.3.2.2" class="anchored" data-anchor-id="sec-explanal-lm">
<span class="header-section-number">3.1.3.2.2</span> More than one observation per location</h5>
<p>For the case of more than one observation per location, we shall consider the <code>italy_sim</code> data-set. This data-set contains 10 observations per location, for a total of 200 locations. The variable <code>ID_loc</code> is a numeric indicator that can be used to identify the location each observation belong to. For this data-set, we use the population density, named <code>pop_dens</code>, as a log-transformed covariate; we leave you as an exercise to assess that is a reasonable modelling choice.</p>
<p>To specify a non-spatial mixed model for the outcome, we then use two subscripts: <span class="math inline">\(i\)</span> to identify a given location; <span class="math inline">\(j\)</span> to identify the <span class="math inline">\(j\)</span>-th observation for a given location <span class="math inline">\(i\)</span>. We denote as <span class="math inline">\(Z_i\)</span> the location-specific random effect ans as <span class="math inline">\(U_{ij}\)</span> the random variation due to the measurement error inherent to each observation. Hence, we write <span id="eq-italy-sim-lmm"><span class="math display">\[
Y_{ij} = \beta_0 + \beta_1 \log\{d(x_i)\} + Z_i + U_{ij},
\tag{3.16}\]</span></span> where <span class="math inline">\(d(x_i)\)</span> is the population density at location <span class="math inline">\(x_i\)</span>; as before, we use <span class="math inline">\(\tau^2\)</span> and <span class="math inline">\(\omega^2\)</span> to denote the variances of <span class="math inline">\(Z_i\)</span> and <span class="math inline">\(U_{ij}\)</span>, respectively. To fit this model to the data we use the <code>lmer</code> function from the <code>lme4</code> package.</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Fitting a linear mixed model to the italy_sim data-set</span></span>
<span><span class="co"># See main text for model specification</span></span>
<span><span class="va">lmer_fit</span> <span class="op">&lt;-</span> <span class="fu">lmer</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">pop_dens</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">ID_loc</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">italy_sim</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">lmer_fit</span><span class="op">)</span></span>
<span><span class="co">## Linear mixed model fit by REML ['lmerMod']</span></span>
<span><span class="co">## Formula: y ~ log(pop_dens) + (1 | ID_loc)</span></span>
<span><span class="co">##    Data: italy_sim</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## REML criterion at convergence: 3390.9</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Scaled residuals: </span></span>
<span><span class="co">##      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">## -2.85209 -0.64198 -0.01832  0.66014  3.01870 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Random effects:</span></span>
<span><span class="co">##  Groups   Name        Variance Std.Dev.</span></span>
<span><span class="co">##  ID_loc   (Intercept) 2.5006   1.5813  </span></span>
<span><span class="co">##  Residual             0.1959   0.4426  </span></span>
<span><span class="co">## Number of obs: 2000, groups:  ID_loc, 200</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Fixed effects:</span></span>
<span><span class="co">##               Estimate Std. Error t value</span></span>
<span><span class="co">## (Intercept)   -0.40448    0.57613  -0.702</span></span>
<span><span class="co">## log(pop_dens)  1.33798    0.07643  17.506</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Correlation of Fixed Effects:</span></span>
<span><span class="co">##             (Intr)</span></span>
<span><span class="co">## log(pp_dns) -0.981</span></span>
<span></span>
<span><span class="co"># Incorporating the estimated random effects into the data</span></span>
<span><span class="va">italy_sim</span><span class="op">$</span><span class="va">rand_eff</span> <span class="op">&lt;-</span><span class="fu">ranef</span><span class="op">(</span><span class="va">lmer_fit</span><span class="op">)</span><span class="op">$</span><span class="va">ID_loc</span><span class="op">[</span><span class="va">italy_sim</span><span class="op">$</span><span class="va">ID_loc</span>,<span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Converting the italy_sim data frame into an "sf" object </span></span>
<span><span class="va">italy_sim_sf</span> <span class="op">&lt;-</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="va">italy_sim</span>, coords<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x1"</span>, <span class="st">"x2"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">32634</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute the variogram, using the random effects from the linear mixed model fit,</span></span>
<span><span class="co"># and the 95% confidence level envelope for spatial independence</span></span>
<span><span class="va">italy_sim_variog</span> <span class="op">&lt;-</span> <span class="fu">s_variogram</span><span class="op">(</span><span class="va">italy_sim_sf</span>, variable <span class="op">=</span> <span class="st">"rand_eff"</span>, </span>
<span>                                scale_to_km <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                n_permutation <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plotting the results</span></span>
<span><span class="fu">plot_s_variogram</span><span class="op">(</span><span class="va">italy_sim_variog</span>, plot_envelope <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-italy-sim-variog" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-italy-sim-variog-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03_model-fitting_files/figure-html/fig-italy-sim-variog-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-italy-sim-variog-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.9: Plot of the empirical variogram (solid line) computed using the estimated random effects from the model in <a href="#eq-italy-sim-lmm" class="quarto-xref">Equation&nbsp;<span>3.16</span></a>. The blue shaded area is the 95% confidence level envelope generated using the permutation procedure described in <a href="#sec-expl-spatial" class="quarto-xref"><span>Section 3.1.3</span></a>.
</figcaption></figure>
</div>
</div>
</div>
<p>In the code above, the introduction of the <span class="math inline">\(Z_i\)</span> random effect is specified in the <code>lmer</code> function though <code>(1|ID_loc)</code> in the formula; recall that <code>ID_loc</code> is the numerical indicator that identifies each location. From the summary of the model, we obtain both the estimates of the regression coefficients <span class="math inline">\(\beta_{0}\)</span> and <span class="math inline">\(\beta_{1}\)</span>, as well for the variances <span class="math inline">\(\tau^2\)</span> listed under <code>Random effects:</code>. The estimate of <span class="math inline">\(\sigma^2\)</span> is found on the line of printed output starting with <code>ID_loc</code>, whilst that for $^2 is next to <code>Residual</code>.</p>
<p>The application of the empirical variogram, whose results are shown in <a href="#fig-italy-sim-variog" class="quarto-xref">Figure&nbsp;<span>3.9</span></a>, indicate the presence of residual correlation. This is because we observe that the solid line representing the empirical variogram falls outside of the 95% envelope for spatial independence.</p>
</section></section></section></section><section id="sec-linear-model" class="level2" data-number="3.2"><h2 data-number="3.2" class="anchored" data-anchor-id="sec-linear-model">
<span class="header-section-number">3.2</span> The linear geostatistical model</h2>
<p>In this section, we consider spatially referenced outcomes <span class="math inline">\(Y_i\)</span> that are continuous. We first consider the simpler case of a single measurement <span class="math inline">\(Y_i\)</span> per location <span class="math inline">\(x_i\)</span>. Recalling the class of generalized linear models introduced in <a href="01_intro.html#sec-geostat-models" class="quarto-xref"><span>Section 1.5</span></a>, the linear predictor takes the form <span id="eq-linear-geostat-model-lp"><span class="math display">\[
\mu_{i} = d(x_i)^\top \beta + S(x_i).
\tag{3.17}\]</span></span> Hence, in this case, we interpret <span class="math inline">\(\beta\)</span> as the effect on <span class="math inline">\(\mu_i\)</span> for a unit increase in <span class="math inline">\(d(x_i)\)</span>. Let <span class="math inline">\(U_i\)</span> denote i.i.d. random variables representing the measurement error associated with <span class="math inline">\(Y_i\)</span>, each having mean zero and variance <span class="math inline">\(\omega^2\)</span>. Thanks to the linear properties of Gaussian random variables, we can also express the linear model in a compact expression, as <span id="eq-linear-geostat-model"><span class="math display">\[
Y_i = \mu_i + U_i = d(x_i)^\top \beta + S(x_i) + U_i.
\tag{3.18}\]</span></span> To fully specify a geostatistical model for our dataset, we must address two critical aspects.</p>
<ol type="1">
<li>Defining the relationship between each covariate and the mean value <span class="math inline">\(\mu_i\)</span>.</li>
<li>Selecting an appropriate correlation function for <span class="math inline">\(S(x)\)</span>.</li>
</ol>
<p>As illustrated in the previous sections, the initial step of exploratory analysis allows us to handle the first aspect, where we determine the regression relationship between covariates and the mean value <span class="math inline">\(\mu_i\)</span>. However, based on existing methods of exploratory analysis, it is difficult to understand what is a suitable correlation function at this stage. A commonly recommended starting point is the Matern correlation function (see <a href="01_intro.html#eq-matern" class="quarto-xref">Equation&nbsp;<span>1.5</span></a>), which offers considerable flexibility in capturing a wide range of correlation structures, under the assumption stationarity and isotropy. As we shall illustrate in the next example, even estimating a Matern correlation function is a task that poses many inferential challenges due to the poor identifiability, especially, of its smoothness parameter <span class="math inline">\(\kappa\)</span>.</p>
<section id="sec-glm-parest" class="level3" data-number="3.2.1"><h3 data-number="3.2.1" class="anchored" data-anchor-id="sec-glm-parest">
<span class="header-section-number">3.2.1</span> Evaluating the inclusion of the measurement error term <span class="math inline">\(U_i\)</span> and the specification of the smoothness parameter <span class="math inline">\(\kappa\)</span>
</h3>
<p>In this section we analyse the Galicia data using a linear geostatistical geostatitsical model for the log-transformed lead concentration, which we denote as <span class="math inline">\(Y_i\)</span>. Since we do not use covariates, we then write the model as <span id="eq-galicia-lgm"><span class="math display">\[
Y_i = \mu + S(x_i) + U_i
\tag{3.19}\]</span></span> where were <span class="math inline">\(S(x)\)</span> is a Matern process with variance <span class="math inline">\(\sigma^2\)</span>, scale parameter <span class="math inline">\(\phi\)</span> and and smothness parameter <span class="math inline">\(\kappa\)</span>; the <span class="math inline">\(U_i\)</span> correspond to the measurement error term and denote with <span class="math inline">\(\omega^2\)</span> their variance.</p>
<p>We carry out the parameter estimation of the model using the <code>glgpm</code> function from the <code>RiskMap</code> package. This function implements maximum likelihood estimation for generalized linear mixed models using a Matern correlation function, while fixing the smoothness parameter <span class="math inline">\(\kappa\)</span> at prespecified value by the user. The object passed to the argument <code>data</code> in <code>glpm</code> can either be a <code>data.frame</code> object or an <code>sf</code> object. Below we illustrate the use of <code>glgpm</code> while distinguishing between these two cases.</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Parameter estimation when the argument passed to `data` is a data-frame</span></span>
<span><span class="va">fit_galicia</span> <span class="op">&lt;-</span> </span>
<span><span class="fu">glgpm</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">lead</span><span class="op">)</span> <span class="op">~</span> <span class="fu">gp</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, kappa <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span>, data<span class="op">=</span><span class="va">galicia</span>, family <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>      crs <span class="op">=</span> <span class="fl">32629</span>, scale_to_km <span class="op">=</span> <span class="cn">TRUE</span>, messages <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The code above shows the use of <code>glgpm</code> by passing <code>galicia</code> as a <code>data.frame</code> object to <code>data</code>. The specification of the Guassian process <span class="math inline">\(S(x)\)</span> is done through the addition of the term <code>gp()</code> in the formula. The function <code>gp</code> allows you to specify the columns of the coordinates in the data, in this case <code>x</code> and <code>y</code>, the smoothness parameter through the argument <code>kappa</code>, set to 1.5 in this example. In the help page of <code>gp</code>, you can see that by default the nugget term (denoted in this book by the random variable <span class="math inline">\(Z_i\)</span>) is excluded from the model by default; to include and estimate the variance parameter of the nugget, you should set <code>nugget=NULL</code> in the <code>gp()</code> function. However, doing so for a linear model that only has one observation per location will generate error message as this is a non-identifiable model for the same reasons given in <a href="#sec-explanal-lm" class="quarto-xref"><span>Section 3.1.3.2.2</span></a>. However, if the measurement error variance is known this can be fixed by the user using the argument <code>fix_var_me</code> and the inclusion of the nugget term is then possible (to better understand this point, try Exercise 7 at the end of this chapter).</p>
<p>The argument <code>crs</code> is used to specify the coordinate reference system (CRS) of the data. For the Galicia data, as well as for every other data-set used in this book, the CRS is reported in the help page description of the data-set. If <code>crs</code> is not specified, the function will assume that the coordinates are in longitude/latitude format and will use these without applying any transformation. Finally, the argument <code>scale_to_km</code>, is used to specify whether the distances between locations should be scaled to kilometers or maintained in meter; this argument will not affect the scale, and thus the interpretation of the spatial correlation parameter <span class="math inline">\(\phi\)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Parameter estimation when the argument passed to `data` is an sf object</span></span>
<span><span class="va">galicia_sf</span> <span class="op">&lt;-</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="va">galicia</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">32629</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_galicia_sf</span> <span class="op">&lt;-</span> </span>
<span><span class="fu">glgpm</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">lead</span><span class="op">)</span> <span class="op">~</span> <span class="fu">gp</span><span class="op">(</span>kappa <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span>, data<span class="op">=</span><span class="va">galicia_sf</span>, family <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>      scale_to_km <span class="op">=</span> <span class="cn">TRUE</span>, messages <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The code above shows the alternative approach to estimate the model, when the argument passed to <code>data</code> is an <code>sf</code> object. In this case, the data-set <code>galicia</code> is converted into an <code>sf</code> object before the use of the <code>glgpm</code> function using <code>st_as_sf</code>. When when then fit the linear geostatistical model with <code>galicia_sf</code>, the only differences with the previous chunk of code that used <code>galicia</code> instead, is that the coordinates names in <code>gp()</code> and the <code>crs</code> argument in <code>glgpm</code> do not need to be specified as they are both directly obtained from <code>galicia_sf</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit_galicia</span><span class="op">)</span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## glgpm(formula = log(lead) ~ gp(x, y, kappa = 1.5), data = galicia, </span></span>
<span><span class="co">##     family = "gaussian", crs = 32629, scale_to_km = TRUE, messages = FALSE)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Linear geostatistical model</span></span>
<span><span class="co">## Link: identity </span></span>
<span><span class="co">## Inverse link function = x </span></span>
<span><span class="co">##  </span></span>
<span><span class="co">## 'Lower limit' and 'Upper limit' are the limits of the 95% confidence level intervals</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Regression coefficients</span></span>
<span><span class="co">##             Estimate Lower limit Upper limit   StdErr z.value   p.value    </span></span>
<span><span class="co">## (Intercept) 0.707418    0.552762    0.862075 0.078908  8.9651 &lt; 2.2e-16 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##                          Estimate Lower limit Upper limit</span></span>
<span><span class="co">## Measuremment error var. 0.0154636   0.0051797      0.0462</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Spatial Gaussian process</span></span>
<span><span class="co">## Matern covariance parameters (kappa=1.5)</span></span>
<span><span class="co">##                      Estimate Lower limit Upper limit</span></span>
<span><span class="co">## Spatial process var.  0.17127     0.13303      0.2205</span></span>
<span><span class="co">## Spatial corr. scale   9.02085     7.59521     10.7141</span></span>
<span><span class="co">## Variance of the nugget effect fixed at 0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Log-likelihood: 69.03029</span></span>
<span><span class="co">## AIC: -130.0606</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then inspect the point and interval estimates for the model through the <code>summary</code> function of the model as shown in the code chunk above. This outputs is presented in three sections: in the first section, we have the results for the regression coefficients; in the second section, we have the estimate for the variance of the measurement error component, <span class="math inline">\(\omega^2\)</span> whose point estimate is about 0.015; in the final section, we have the estimates for the parameters of the spatial covariance function, <span class="math inline">\(\sigma^2\)</span> and <span class="math inline">\(\phi\)</span> which are about 0.171 and 9.021 (km), respectively. The message <code>Variance of the nugget effect fixed at 0</code> indicates that the nugget has not been included in the mode; try Exercise 7 to see how this summary changes in the presence of the nugget term.</p>
<p>At this point, you may be wondering, why we have used 1.5 for the value of <span class="math inline">\(\kappa\)</span> and whether there is a statistical approach to find the most suitable value for this. We show such an approach in the code below. However, before examining the code, we would like to point an important aspect that relates to how the value of <span class="math inline">\(\kappa\)</span> can affect the estimate of the measurement error variance <span class="math inline">\(\omega^2\)</span>. As we have shown, in <a href="01_intro.html#sec-matern-correlation" class="quarto-xref"><span>Section 1.5.1</span></a>, values of <span class="math inline">\(\kappa\)</span> that are closer to zero will give a rougher and less regular surface for <span class="math inline">\(S(x)\)</span>. In the case of a single observation, when <span class="math inline">\(\kappa\)</span> is closer to zero, it will thus become increasingly difficult to estimate <span class="math inline">\(\omega^2\)</span> since the likelihood function may attribute most of the noisiness to <span class="math inline">\(S(x)\)</span> and rely less on <span class="math inline">\(U_i\)</span> to explain the unstructured random variation found in the data. As a consequence of this, we can expect that for value of <span class="math inline">\(\kappa\)</span> closer to zero, the estimates of <span class="math inline">\(\omega^2\)</span> will also be smaller and, on the contrary, when <span class="math inline">\(\kappa\)</span> is larger, the estimates of <span class="math inline">\(\omega^2\)</span> will also increase. The results generated in the below clearly illustrate this point.</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="co"># Number of the values chosen for kappa</span></span>
<span><span class="va">n_kappa</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span></span>
<span><span class="co"># Set of values for kappa</span></span>
<span><span class="va">kappa_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">3.5</span>, length <span class="op">=</span> <span class="va">n_kappa</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Vector that will store the values of the likelihood function </span></span>
<span><span class="co"># evaluated at the maximum likelihood estimate</span></span>
<span><span class="va">llik_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, length <span class="op">=</span> <span class="va">n_kappa</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Vector that will store the maximum likelihood estimates</span></span>
<span><span class="co"># of the variance of the measurement error</span></span>
<span><span class="va">sigma2_me_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, length <span class="op">=</span> <span class="va">n_kappa</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># List that will contain all the geostatistical models fitted for </span></span>
<span><span class="co"># the different values of kappa specified in kappa_values</span></span>
<span><span class="va">fit_galicia_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_kappa</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">fit_galicia_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">glgpm</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">lead</span><span class="op">)</span> <span class="op">~</span> <span class="fu">gp</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, kappa <span class="op">=</span> <span class="va">kappa_values</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                                 data<span class="op">=</span><span class="va">galicia</span>, family <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>                                 crs <span class="op">=</span> <span class="fl">32629</span>, scale_to_km <span class="op">=</span> <span class="cn">TRUE</span>, messages <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">llik_values</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">fit_galicia_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">log.lik</span></span>
<span>  <span class="va">sigma2_me_hat</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">fit_galicia_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="st">"sigma2_me"</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-galicia-matern" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-galicia-matern-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03_model-fitting_files/figure-html/fig-galicia-matern-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:8.5in">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-galicia-matern-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.10: (a) plot of the maximum likelihood estimate for the variance of the measurement error <span class="math inline">\(U_i\)</span>, denoted in the text as <span class="math inline">\(\omega^2\)</span>, against the chosen fixed value for <span class="math inline">\(\kappa\)</span>; (b) profile likeihood for <span class="math inline">\(\kappa\)</span> with the horizontal dashed line corresponding to the (approximate) threshold for constructing a 95% confidence interval based on a <span class="math inline">\(\chi^2\)</span> with one degree of freedom.
</figcaption></figure>
</div>
</div>
</div>
<p>By examining the results shown in panel (a) of <a href="#fig-galicia-matern" class="quarto-xref">Figure&nbsp;<span>3.10</span></a>, we observe that, as expected, smaller values for <span class="math inline">\(\kappa\)</span> leads to smaller point estimates for <span class="math inline">\(\omega^2\)</span> and viceversa. This begs the question, what should be our chosen value for <span class="math inline">\(\kappa\)</span>?</p>
<p>To answer this question, a natural approach is to estimate the model for different values of <span class="math inline">\(\kappa\)</span> and see which one give the best fit to the data, according to the likelihood function. In panel (b) of <a href="#fig-galicia-matern" class="quarto-xref">Figure&nbsp;<span>3.10</span></a>, we show the results of this approach where we considered 10 values for <span class="math inline">\(\kappa\)</span> within the range 0.5 to 3.5 (see code above). In this plot, we have also added a horizontal line to help us to approximate a range of the most plausible value for <span class="math inline">\(\kappa\)</span>. More precisely, the horizontal dashed line is computed by taking the maximum observed values of the likelihoods computed for the different values of <span class="math inline">\(\kappa\)</span>, say <span class="math inline">\(\hat{M}\)</span> and we subtract the quantile 0.95 of a <span class="math inline">\(\chi^2\)</span> distribution with 1 degree of freedom. In R this horizontal line is obtained as</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">llik_values</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">pchisq</a></span><span class="op">(</span><span class="fl">0.95</span>, df <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where <code>llik_values</code> is as defined in the previous chunk of code. Note that this approach is essentially constructing the profile likelihood for <span class="math inline">\(\kappa\)</span> which one could use to derive a confidence interval for <span class="math inline">\(\kappa\)</span> with a finer segmentation for <code>kappa_values</code>. However, our current objective is not to derive the confidence interval for <span class="math inline">\(\kappa\)</span>, but rather to gain a broad understanding of the <span class="math inline">\(\kappa\)</span> values supported by the dataset. The values of <span class="math inline">\(\kappa\)</span> that corresponds to likelihood values above the horizontal line are approximately between 0.75 and 2.75. Hence, selecting <span class="math inline">\(\kappa=1.5\)</span> seems to be a reasonable one in this case. Now, you may be pondering: are there value other than <span class="math inline">\(\kappa=1.5\)</span> that could fit the data even better? Our answer is that it is not worth the effort to try estimate <span class="math inline">\(\kappa\)</span> more precisely because it is empirically very difficult and, under some scenarios, even impossible. Estimating <span class="math inline">\(\kappa\)</span> poses a well-documented challenge in geostatistics (<span class="citation" data-cites="zhang2004">Zhang (<a href="references.html#ref-zhang2004" role="doc-biblioref">2004</a>)</span>), which justifies our adoption of a pragmatic approach that sets it at a predefined value. This issue is also further exacerbated when analyzing count data, which tend to be less informative about the correlation structure than continuously measured data.</p>
</section><section id="sec-add-re-glgm" class="level3" data-number="3.2.2"><h3 data-number="3.2.2" class="anchored" data-anchor-id="sec-add-re-glgm">
<span class="header-section-number">3.2.2</span> Modelling hierarchical geostatistical data using the <code>re()</code> function</h3>
<p>We now consider the analysis of geostatistical data with a hierarchical structure and show how to formulate and fit a geostatistical model that accounts for the effects of the different layers of the data. For this purpose, we use the <code>italy_sim</code> where each of the sampled locations can be grouped according to two administrative subdivisions of Italy, regions (Admin level 2) and provinces (Admin level 3), as shown in <a href="#fig-italy-maps" class="quarto-xref">Figure&nbsp;<span>3.11</span></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/wmgeolab/rgeoboundaries">rgeoboundaries</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/mapview">mapview</a></span><span class="op">)</span></span>
<span><span class="va">italy_regions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rgeoboundaries/man/geoboundaries.html">geoboundaries</a></span><span class="op">(</span>country <span class="op">=</span> <span class="st">"italy"</span>, adm_lvl <span class="op">=</span> <span class="st">"adm2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">italy_provinces</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rgeoboundaries/man/geoboundaries.html">geoboundaries</a></span><span class="op">(</span>country <span class="op">=</span> <span class="st">"italy"</span>, adm_lvl <span class="op">=</span> <span class="st">"adm3"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Map of the data with the region boundaries</span></span>
<span><span class="va">map_regions</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">italy_sim_sf</span>, pch <span class="op">=</span> <span class="fl">4</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">italy_regions</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Regions"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Map of the data with the province boundaries</span></span>
<span><span class="va">map_provinces</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">italy_sim_sf</span>, pch <span class="op">=</span> <span class="fl">4</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">italy_provinces</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Provinces"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span><span class="op">(</span><span class="va">map_regions</span>, <span class="va">map_provinces</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-italy-maps" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-italy-maps-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03_model-fitting_files/figure-html/fig-italy-maps-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-italy-maps-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.11: The plot shows the location of the data-set <code>italy_sim</code> (red crosses), with the boundaries of the regions (left) and provinces (right) of Italy.
</figcaption></figure>
</div>
</div>
</div>
<p>Let <span class="math inline">\(V_h\)</span>, for <span class="math inline">\(h=1,\ldots,n_V\)</span> and <span class="math inline">\(Z_k\)</span>, for <span class="math inline">\(k=1,\ldots,n_{Z}\)</span>, be a set of mutually independent Gaussian variables with zero means and variances <span class="math inline">\(\sigma^2_{V}\)</span> and <span class="math inline">\(\sigma^2_{Z}\)</span>, respectively. Finally let <span class="math inline">\(\mathcal{A}_h\)</span>, for <span class="math inline">\(h=1,\ldots,n_V\)</span> and <span class="math inline">\(\mathcal{B}_k\)</span>, for <span class="math inline">\(k=1,\ldots,n_{Z}\)</span>, denote the areas encompassed by the boundaries of the region and provinces, respectively. Since we have 10 repeated observations at each locations, we shall use <span class="math inline">\(Y_{ij}\)</span> to denote the <span class="math inline">\(j\)</span>-th outcome (found in the data under the column <code>y</code>) at the <span class="math inline">\(i\)</span>-th location <span class="math inline">\(x_i\)</span>. The model from which we generated data <span class="math inline">\(y_{ij}\)</span> is <span id="eq-italy-sim-model"><span class="math display">\[
Y_{ij} = \beta_0 + \overbrace{\beta_1 d(x_i) + S(x_i)}^\text{Location-level effect} + \underbrace{\sum_{h=1}^{n_{V}} I(x_i \in \mathcal{A}_h) \times V_h}_\text{Region effect} +\\ \overbrace{\sum_{k=1}^{n_{Z}} I(x_i \in \mathcal{B}_k) \times Z_k}^\text{Province effect} +  \underbrace{U_{ij}}_\text{Measurement error},
\tag{3.20}\]</span></span> for <span class="math inline">\(j=1,\ldots 10\)</span> and <span class="math inline">\(i=1,\ldots,200\)</span>, where, <span class="math inline">\(d(x_i)\)</span> is the log-transformed population density, <span class="math inline">\(I(x \in \mathcal{R})\)</span> is an indicator function that takes value 1 if the location <span class="math inline">\(x\)</span> falls within the boundaries of the area denoted by <span class="math inline">\(\mathcal{R}\)</span> and 0 otherwise. The covariance function chosen in the generation of the data was an exponential correlation function hence <span class="math inline">\({\rm cov}\{S(x), S(x') = \sigma^2 \exp\{-||x-x'||/\phi\}\)</span>.</p>
<p>The inclusion of the random effects <span class="math inline">\(V_h\)</span>, for the region, and <span class="math inline">\(Z_k\)</span>, for the province, can be included by using the <code>re()</code> function into the <code>formula</code> passed to <code>glgpm</code> as shown below.</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span>                        <span class="co"># Location-level effect</span></span>
<span><span class="va">italy_fit</span> <span class="op">&lt;-</span> <span class="fu">glgpm</span><span class="op">(</span> <span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">pop_dens</span><span class="op">)</span> <span class="op">+</span> <span class="fu">gp</span><span class="op">(</span>kappa <span class="op">=</span> <span class="fl">0.5</span>, nugget <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>                        <span class="co"># Region and province effects</span></span>
<span>                        <span class="fu">re</span><span class="op">(</span><span class="va">region</span>, <span class="va">province</span><span class="op">)</span>,</span>
<span>         data <span class="op">=</span> <span class="va">italy_sim_sf</span>, scale_to_km <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>         family <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span></span>
<span><span class="co">##   0:     441.00731: -0.404481  1.33798  0.00000  4.62406  0.00000  0.00000  0.00000</span></span>
<span><span class="co">##   1:    -130.05497: -0.408825  1.35003 -0.0387110  4.66059 -0.910409 -0.00265292 0.0107965</span></span>
<span><span class="co">##   2:    -268.13436: -0.865126  1.39525 -0.0305269  5.92133 -1.96079 -0.666581 0.487537</span></span>
<span><span class="co">##   3:    -329.24560: -1.44091  1.38139 -0.546306  4.98616 -1.67936 -1.15202 0.383821</span></span>
<span><span class="co">##   4:    -331.20861: -1.38498  1.37256 0.165463  5.61366 -1.63033 -2.11435 0.371263</span></span>
<span><span class="co">##   5:    -331.28418: -0.874796  1.37322 -0.271990  5.18071 -1.62887 -0.970704 0.371407</span></span>
<span><span class="co">##   6:    -331.42968: -1.04087  1.37294 -0.119652  5.33634 -1.62883 -1.33321 0.375031</span></span>
<span><span class="co">##   7:    -331.43375: -1.07312  1.37288 -0.0878211  5.36725 -1.62883 -1.42011 0.376251</span></span>
<span><span class="co">##   8:    -331.43375: -1.07445  1.37288 -0.0866254  5.36840 -1.62883 -1.42489 0.376323</span></span>
<span><span class="co">##   9:    -331.43375: -1.07445  1.37288 -0.0866254  5.36840 -1.62883 -1.42489 0.376323</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">italy_fit</span><span class="op">)</span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## glgpm(formula = y ~ log(pop_dens) + gp(kappa = 0.5, nugget = 0) + </span></span>
<span><span class="co">##     re(region, province), data = italy_sim_sf, family = "gaussian", </span></span>
<span><span class="co">##     scale_to_km = TRUE)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Linear geostatistical model</span></span>
<span><span class="co">## Link: identity </span></span>
<span><span class="co">## Inverse link function = x </span></span>
<span><span class="co">##  </span></span>
<span><span class="co">## 'Lower limit' and 'Upper limit' are the limits of the 95% confidence level intervals</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Regression coefficients</span></span>
<span><span class="co">##                Estimate Lower limit Upper limit    StdErr z.value p.value    </span></span>
<span><span class="co">## (Intercept)   -1.074451   -2.031690   -0.117212  0.488396    -2.2 0.02781 *  </span></span>
<span><span class="co">## log(pop_dens)  1.372877    1.352018    1.393735  0.010642   129.0 &lt; 2e-16 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##                         Estimate Lower limit Upper limit</span></span>
<span><span class="co">## Measuremment error var.   1.2167      1.2009      1.2327</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Spatial Gaussian process</span></span>
<span><span class="co">## Matern covariance parameters (kappa=0.5)</span></span>
<span><span class="co">##                       Estimate Lower limit Upper limit</span></span>
<span><span class="co">## Spatial process var.   0.91702     0.59470       1.414</span></span>
<span><span class="co">## Spatial corr. scale  214.51980   153.60751     299.587</span></span>
<span><span class="co">## Variance of the nugget effect fixed at 0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Unstructured random effects</span></span>
<span><span class="co">##                             Estimate Lower limit Upper limit</span></span>
<span><span class="co">## region (random eff. var.)    0.24053     0.14553      0.3976</span></span>
<span><span class="co">## province (random eff. var.)  0.37632     0.35607      0.3977</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Log-likelihood: 331.4338</span></span>
<span><span class="co">## AIC: -648.8675</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the code above, the <code>factor</code> variables <code>region</code> and <code>province</code> found in <code>italy_sim</code> are passed to <code>re()</code> and these are estimated as unstructured random effects as defined by <a href="#eq-italy-sim-model" class="quarto-xref">Equation&nbsp;<span>3.20</span></a>. From the summary of model, we then obtain the parameter and interval estimates as reported in <a href="#tbl-italy-sim-mle" class="quarto-xref">Table&nbsp;<span>3.1</span></a>.</p>
<div id="tbl-italy-sim-mle" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-italy-sim-mle-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3.1: Maximum likelihood estimates and, lower and upper limits of the 95% confidence interval for the parameters of the model in <a href="#eq-italy-sim-lmm" class="quarto-xref">Equation&nbsp;<span>3.16</span></a>.
</figcaption><div aria-describedby="tbl-italy-sim-mle-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<thead><tr class="header">
<th>Parameter</th>
<th>Point estimate</th>
<th>Lower limit</th>
<th>Upper limit</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(\beta_0\)</span></td>
<td>-1.074</td>
<td>-2.032</td>
<td>-0.117</td>
</tr>
<tr class="even">
<td><span class="math inline">\(\beta_1\)</span></td>
<td>1.373</td>
<td>1.352</td>
<td>1.394</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\sigma^2\)</span></td>
<td>0.917</td>
<td>0.595</td>
<td>1.414</td>
</tr>
<tr class="even">
<td><span class="math inline">\(\phi\)</span></td>
<td>214.520</td>
<td>153.608</td>
<td>299.587</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\sigma^2_{V}\)</span></td>
<td>0.241</td>
<td>0.146</td>
<td>0.398</td>
</tr>
<tr class="even">
<td><span class="math inline">\(\sigma^2_{Z}\)</span></td>
<td>1.457</td>
<td>1.379</td>
<td>1.540</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\omega^2\)</span></td>
<td>0.196</td>
<td>0.194</td>
<td>0.199</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>The function <code>to_table</code> from the <code>RiskMap</code> package can be used to obtain the Latex or HTML code directly from a fit of the model. Here is an example.</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">to_table</span><span class="op">(</span><span class="va">italy_fit</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["Estimate"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["Lower limit"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["Upper limit"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"-1.0744513","2":"-2.0316905","3":"-0.1172122","_rn_":"(Intercept)"},{"1":"1.3728765","2":"1.3520182","3":"1.3937349","_rn_":"log(pop_dens)"},{"1":"0.9170206","2":"0.5946974","3":"1.4140413","_rn_":"Spatial process var."},{"1":"214.5198003","2":"153.6075107","3":"299.5865536","_rn_":"Spatial corr. scale"},{"1":"0.2405342","2":"0.1455287","3":"0.3975623","_rn_":"region (random eff. var.)"},{"1":"0.3763228","2":"0.3560707","3":"0.3977268","_rn_":"province (random eff. var.)"},{"1":"1.2167193","2":"1.2009329","3":"1.2327133","_rn_":"Measuremment error var."}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section></section><section id="generalized-linear-geostatistical-models" class="level2" data-number="3.3"><h2 data-number="3.3" class="anchored" data-anchor-id="generalized-linear-geostatistical-models">
<span class="header-section-number">3.3</span> Generalized linear geostatistical models</h2>
<p>We now consider the modelling of count outcomes, focusing our attention to the Binomial and Poisson geostatistical models.</p>
<p>The use of Binomial geostatistical model is appropriate whenever the reported counts have a known upper bound. For example, when analyzing aggregated disease counts from cross-sectional survey data, the total number of people sampled at a location defines the largest number of possible reported disease cases. Recalling the model specification of <a href="01_intro.html#tbl-glm" class="quarto-xref">Table&nbsp;<span>1.3</span></a>, we specify the Binomial geostatistical model by stating that the reported disease counts <span class="math inline">\(Y_i\)</span> out of <span class="math inline">\(n_i\)</span> (the maximum value that <span class="math inline">\(Y_i\)</span> can take) at location <span class="math inline">\(x_i\)</span>, conditionally on the spatial random effects <span class="math inline">\(S(x_i)\)</span>, follow a Binomial distribution with probability <span class="math inline">\(p(x_i)\)</span> and logit-linear predictor <span id="eq-lp-bin"><span class="math display">\[
\log\left\{\frac{p(x_i)}{1-p(x_i)}\right\} = d(x_i)^\top \beta + S(x_i).
\tag{3.21}\]</span></span> In this model, <span class="math inline">\(p(x_i)\)</span> is commonly understood as representing the prevalence of the disease under consideration, defined as the proportion of individuals with the disease at a specific moment. While <span class="math inline">\(p(x_i)\)</span> is not strictly a proportion, its interpretation as disease prevalence is justified by the fact that if we were to sample a sufficiently large population at location <span class="math inline">\(x_i\)</span>, the proportion of individuals with the disease would converge closely to the value of <span class="math inline">\(p(x_i)\)</span>.</p>
<p>A Binomial geostatistical model is also used when analyzing data at individual level where the outcome is binary and usually indicates the positive or negative result of a test for a disease under investigation. In this analysis, a mix of individual-level variables and location-level variables could be introduced to model the probability of a positive test. To formally write the model, we now use <span class="math inline">\(Y_{ij}\)</span> to indicate the binary outcome taking value 1, if the test was positive, and 0, if negative, for the <span class="math inline">\(j\)</span>-th individual sampled at location <span class="math inline">\(x_i\)</span>. The linear predictor now takes the form <span id="eq-lp-bin-ind"><span class="math display">\[
\log\left\{\frac{p_{ij}}{1-p_{ij}}\right\} = e_{ij}^\top \gamma + d(x_{i})^\top \beta + S(x_i).
\tag{3.22}\]</span></span> In the model above we have distinguished between covariates <span class="math inline">\(e_{ij}\)</span>, that express the effect on <span class="math inline">\(p_{ij}\)</span> due to individual traits (such as age and gender), and covariates <span class="math inline">\(d(x_i)\)</span>, that instead quantify the effect on <span class="math inline">\(p_{ij}\)</span> resulting from the environmental attributes of location <span class="math inline">\(x_i\)</span> (such as elevation, temperature, and precipitation). In this model <span class="math inline">\(p_{ij}\)</span> – the probability of a positive test – once again can be interpreted as the disease prevalence for a population characterized by the individual traits <span class="math inline">\(e_{ij}\)</span> and residing at location <span class="math inline">\(x_i\)</span>.</p>
<p>Finally, when the counts arise from a population whose size is unknown or when the occurrence of a disease is very small relative to the size of the target population, one should consider the use of a Poisson geostaistical model. We then use <span class="math inline">\(Y_i\)</span> to denote the reported counts at location <span class="math inline">\(x_i\)</span> and assume that this, conditionally on a Gaussian process <span class="math inline">\(S(x_i)\)</span>, follows a Poisson distribution with mean <span class="math inline">\(\lambda(x_i)\)</span> and log-linear predictor <span id="eq-poisson-lp"><span class="math display">\[
\log\left\{\lambda(x_i)\right\} = d(x_i)^\top \beta + S(x_i).
\tag{3.23}\]</span></span> If for example, <span class="math inline">\(Y_i\)</span> corresponds to the number of new cases reported at a health facility at location <span class="math inline">\(x_i\)</span> over a certain, the <span class="math inline">\(\lambda(x_i)\)</span> is interpreted as the average number of new cases reported over that period. If the information on the size of the population at risk for the diseases were available, this can be incorporated into the model so as to enable the interpretation of <span class="math inline">\(\lambda(x_i)\)</span> as the disease incidence, defined as the total number of new cases reported over a given period of time divided by the population at risk. If we denote the latter as <span class="math inline">\(m_i\)</span>, then we would specify the mean of <span class="math inline">\(Y_i\)</span> as <span class="math inline">\(m_i\lambda(x_i)\)</span> an model <span class="math inline">\(\lambda(x_i)\)</span> as already specified in <a href="#eq-poisson-lp" class="quarto-xref">Equation&nbsp;<span>3.23</span></a>. Another prevalent application of the Poisson geostatistical model in epidemiology involves mapping the abundance of disease vectors. Here, <span class="math inline">\(\lambda(x_i)\)</span> corresponds to the mean number of vectors per unit area. Also, note that in this last scenario <span class="math inline">\(m_i\)</span> cannot be defined as it is the goal of the analysis to infer the vector population size at location <span class="math inline">\(x_i\)</span>.</p>
<p>In all the three models, namely <a href="#eq-lp-bin" class="quarto-xref">Equation&nbsp;<span>3.21</span></a>, <a href="#eq-lp-bin-ind" class="quarto-xref">Equation&nbsp;<span>3.22</span></a> and <a href="#eq-poisson-lp" class="quarto-xref">Equation&nbsp;<span>3.23</span></a>, one might consider the inclusion of an additional random effect <span class="math inline">\(Z_i\)</span>, previously used for the linear geostatistical model, to account for small spatial variation or overdispersion that stems from the omission of covariates that may not necessarily exhibit spatial structure, such as behavioral or genetic traits. We shall further elaborate and provide guidance on this point in the following examples of this section.</p>
<section id="sec-liberia-estim1" class="level3" data-number="3.3.1"><h3 data-number="3.3.1" class="anchored" data-anchor-id="sec-liberia-estim1">
<span class="header-section-number">3.3.1</span> Example: river-blindness in Liberia</h3>
<p>In section <a href="#sec-agg-count-exp" class="quarto-xref"><span>Section 3.1.1.1</span></a>, we carried out the exploratory analysis of the river-blindness prevalence data to assess how the covariate of elevation could be introduced into the model. In <a href="#sec-empirical-variog-bin" class="quarto-xref"><span>Section 3.1.3.1</span></a>, we then tested for residual spatial correlation, when the log-transformed elevation is used as a covariate, using the empirical variogram. Based on these results, we now formulate a fit a Binomial geostatistical model to data. To achieve this, we extend the model presented in <a href="#eq-liberia-bin-mixed-elev" class="quarto-xref">Equation&nbsp;<span>3.13</span></a> through the inclusion of a spatial Gaussian process, <span class="math inline">\(S(x)\)</span>, hence we write <span id="eq-liberia-geostat-bin-elev"><span class="math display">\[
\log\left\{\frac{p(x_i)}{1-p(x_i)}\right\} = \beta_{0} + \beta_{1}\log\{e(x_i)\} + S(x_i) + Z_i.
\tag{3.24}\]</span></span> We shall assume that <span class="math inline">\(S(x_i)\)</span> is a stationary isotropic Gaussian process with an exponential correlation function function <span class="math inline">\(\rho(u) = \exp\{-u/\phi\}\)</span>, with scale parameter <span class="math inline">\(\phi\)</span>.</p>
<p>We apply the Monte Carlo Maximum Likelihood (MCML) method for parameter estimation, which is implemented via the <code>glgpm</code> function. In this section, we set aside the technical details of the estimation process to focus exclusively on interpreting the results. A more detailed explanation of the MCML theory can be found in <a href="#sec-glgm-lik" class="quarto-xref"><span>Section 3.5.2</span></a>, with a concise summary of the practical aspects provided in <a href="#sec-summary" class="quarto-xref"><span>Section 3.5.2.3</span></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fit_liberia</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">glgpm</span><span class="op">(</span><span class="va">npos</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">elevation</span><span class="op">)</span> <span class="op">+</span> <span class="fu">gp</span><span class="op">(</span><span class="va">long</span>, <span class="va">lat</span><span class="op">)</span>,</span>
<span>        den <span class="op">=</span> <span class="va">ntest</span>, data <span class="op">=</span> <span class="va">liberia</span>,</span>
<span>        crs <span class="op">=</span> <span class="fl">4326</span>,</span>
<span>        convert_to_crs <span class="op">=</span> <span class="fl">32629</span>,</span>
<span>        family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  0:    -0.0000000: -2.99847 0.313076  0.00000  4.21726
  1:   -0.23031968: -2.99917 0.308252 -0.00681632  4.22152
  2:   -0.73992643: -3.00062 0.297859 -0.0208491  4.23034
  3:   -0.93646636: -3.00134 0.293494 -0.0249683  4.23309
  4:    -2.2218403: -3.00116 0.283894 -0.0692472  4.26511
  5:    -7.2883809: -2.98516 0.282901 -0.249932  4.39930
  6:    -9.8431801: -2.95921 0.278224 -0.434679  4.51249
  7:    -10.326773: -2.93083 0.273422 -0.624270  4.39419
  8:    -11.528412: -2.92194 0.273881 -1.21246  3.70791
  9:    -12.388377: -2.91619 0.300794 -1.21716  3.70790
 10:    -12.975155: -2.90660 0.284088 -1.24073  3.70835
 11:    -13.254399: -2.89338 0.286917 -1.26836  3.70705
 12:    -14.589349: -2.55215 0.223039 -1.51313  3.45374
 13:    -14.878623: -2.62771 0.236663 -1.68742  3.16553
 14:    -14.923994: -2.62884 0.236869 -1.63922  3.22829
 15:    -14.924284: -2.62905 0.236909 -1.63515  3.23435
 16:    -14.924284: -2.62906 0.236909 -1.63512  3.23440
 17:    -14.924284: -2.62906 0.236909 -1.63512  3.23440
 18:    -14.924284: -2.62906 0.236909 -1.63512  3.23440
 19:    -14.924284: -2.62906 0.236909 -1.63512  3.23440</code></pre>
</div>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit_liberia</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
glgpm(formula = npos ~ log(elevation) + gp(long, lat), data = liberia, 
    family = "binomial", den = ntest, crs = 4326, convert_to_crs = 32629)

Binomial geostatistical linear model
Link: canonical 
Inverse link function = stats::plogis(x) 
 
'Lower limit' and 'Upper limit' are the limits of the 95% confidence level intervals

Regression coefficients
                Estimate Lower limit Upper limit    StdErr z.value   p.value
(Intercept)    -2.629056   -3.072180   -2.185932  0.226088 -11.629 &lt; 2.2e-16
log(elevation)  0.236909    0.194149    0.279669  0.021817  10.859 &lt; 2.2e-16
                  
(Intercept)    ***
log(elevation) ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Spatial Gaussian process
Matern covariance parameters (kappa=0.5)
                     Estimate Lower limit Upper limit
Spatial process var.  0.19493     0.17254      0.2202
Spatial corr. scale  25.39105    21.96521     29.3512
Variance of the nugget effect fixed at 0

Log-likelihood: 14.92428</code></pre>
</div>
</div>
<p>When using the <code>glgpm</code> function to fit a Binomial model, we need to specify the Binomial denominators, i.e.&nbsp;the number of tested at a location in this case, through the argument <code>den</code>. Other arguments of <code>glgpm</code> that are used for carrying out MCML are <code>control_mcmc</code>, that defines the setting parameters of the Monte Carlo Markov Chain algorithm, and <code>par0</code>, which represents our best guess for the unknown parameters of the Binomial geostatistical model. For more information on how the default values of these two arguments, we refer the reader the to the help page of the <code>glgpm</code> function. To understand how to change the default parameters in order to improve the MCML estimation, we advise you to read <a href="#sec-mcml" class="quarto-xref"><span>Section 3.5.2.1</span></a>. Also, remember that to enable the estimation of the nugget effect, <span class="math inline">\(Z_i\)</span>, you should set <code>nugget=NULL</code> in the <code>gp</code> function, since by default the <code>glgpm</code> function excludes <span class="math inline">\(Z_i\)</span> when the out is non-Gaussian.</p>
<p>In the above summary of the model, the interpretation of the regression coefficients is the same as in a standard logistic regression model. Hence, by taking the exponential of the estimate for the regression coefficient <span class="math inline">\(\beta_1\)</span>, we could then express the effect for a unit increase in the covariate – in this case the log-transformed elevation – on the odds of disease prevalence. Finally, the interpretation of estimates of the covariance parameters is not affected by the type of distribution used to model the main outcome. From the above summary, we note the larger estimates of <span class="math inline">\(\sigma^2\)</span> than <span class="math inline">\(\tau^2\)</span> which suggest the dominance of spatial variation over the unstructured variation in the unexplained variation of disease prevalence. Finally, the estimate of <span class="math inline">\(\phi\)</span> indicates a relatively large spatial correlation with a <em>practical range</em> close to (<span class="math inline">\(58.67 \times 3 \approx\)</span>)180km.</p>
</section><section id="sec-anopheles-fit" class="level3" data-number="3.3.2"><h3 data-number="3.3.2" class="anchored" data-anchor-id="sec-anopheles-fit">
<span class="header-section-number">3.3.2</span> Example: <em>Anopheles Gambiae</em> mosquitoes in Cameroon</h3>
<p>In <a href="#sec-agg-count-exp" class="quarto-xref"><span>Section 3.1.1.1</span></a>, we explored the association between elevation and the number of mosquitoes and found that the data showed that on average, the number of “Anopheles Gambiae* (A. Gambiae) decreases for increasing elevation. We now fit a log-linear Poisson geostatistical model, with linear predictor <span id="eq-anopheles"><span class="math display">\[
\lambda(x_i) = \beta_0 + \beta_1 d(x_i) + S(x_i)
\tag{3.25}\]</span></span> where <span class="math inline">\(d(x_i)\)</span> correspond to the elevation in meters at location <span class="math inline">\(x_i\)</span>. This time, we first convert the data frame <code>anopheles</code> into an <code>sf</code> object. This step is optional but recommended as it allows us to simply the code syntax.</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">anopheles</span> <span class="op">&lt;-</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="va">anopheles</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"web_x"</span>, <span class="st">"web_y"</span><span class="op">)</span>,</span>
<span>                      crs <span class="op">=</span> <span class="fl">3857</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then use the following script to fit the model in <code>RiskMap</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">an_fit</span> <span class="op">&lt;-</span> </span>
<span><span class="fu">glgpm</span><span class="op">(</span><span class="va">An.gambiae</span> <span class="op">~</span> <span class="va">elevation</span> <span class="op">+</span> <span class="fu">gp</span><span class="op">(</span><span class="op">)</span>,</span>
<span>      data <span class="op">=</span> <span class="va">anopheles</span>, </span>
<span>      family <span class="op">=</span> <span class="st">"poisson"</span>, messages <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">an_fit</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
glgpm(formula = An.gambiae ~ elevation + gp(), data = anopheles, 
    family = "poisson", messages = FALSE)

Poisson geostatistical linear model
Link: canonical 
Inverse link function = exp(x) 
 
'Lower limit' and 'Upper limit' are the limits of the 95% confidence level intervals

Regression coefficients
               Estimate Lower limit Upper limit      StdErr z.value   p.value
(Intercept)  3.69384399  3.00784989  4.37983809  0.35000342  10.554 &lt; 2.2e-16
elevation   -0.00283997 -0.00336073 -0.00231922  0.00026569 -10.689 &lt; 2.2e-16
               
(Intercept) ***
elevation   ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Spatial Gaussian process
Matern covariance parameters (kappa=0.5)
                     Estimate Lower limit Upper limit
Spatial process var.  0.67165     0.59987      0.7520
Spatial corr. scale   4.38649     3.84756      5.0009
Variance of the nugget effect fixed at 0

Log-likelihood: 9.453628</code></pre>
</div>
</div>
<p>The estimate, <span class="math inline">\(\hat{\beta}_1\)</span>, for the regression coefficient <span class="math inline">\(\beta_1\)</span> suggests that for a 100 meters drop in elevation, the average number of mosquitoes decreases by about <span class="math inline">\((100\times\exp\{100\times -0.018\}\approx)17\%\)</span>. The order of magnitude of the estimates suggest the presence of residual spatial correlation, albeit on a rather small scale.</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">dist_summaries</span><span class="op">(</span><span class="va">anopheles</span>, scale_to_km <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$min
[1] 0.3828559

$max
[1] 160.388

$mean
[1] 54.58734

$median
[1] 43.70518</code></pre>
</div>
</div>
<p>Using the <code>dist_summaries</code> function, we can see that the average distance is about 55km and the minimum is about 387 meters. The estimate of phi of 4km is thus relatively small compared to the the distances between locations in the data. In <a href="04_geostatistical-prediction.html" class="quarto-xref"><span>Chapter 4</span></a>, we will further investigate to what extent this small-scale spatial correlation can affect the predictions of the An. Gambiae counts.</p>
</section><section id="sec-bootstrap" class="level3" data-number="3.3.3"><h3 data-number="3.3.3" class="anchored" data-anchor-id="sec-bootstrap">
<span class="header-section-number">3.3.3</span> Using parametric bootstrap for computing confidence intervals</h3>
<p>The bootstrap is a widely used resampling technique introduced by <span class="citation" data-cites="efron1979">Efron (<a href="references.html#ref-efron1979" role="doc-biblioref">1979</a>)</span> as a general approach to estimating the variability of statistical estimates without relying on strong parametric assumptions. While the classical non-parametric bootstrap resamples directly from the observed data, parametric bootstrap instead relies on simulating new datasets from an assumed parametric model, using plug-in estimated obtain from the original fit of the model to the data. This simulation-based method is particularly useful for complex models, such as those considered in this book, that yield an intractable likelihood function.</p>
<p>We now describe how to carry out parametric bootstrap for geostatsitical models in <code>RiskMap</code>. The use of simulation-based approaches will be more extensively covered in <a href="04_geostatistical-prediction.html" class="quarto-xref"><span>Chapter 4</span></a>, but, for the purpose of this section, it is first important to understand how data can be simulated from a geostatistical model.</p>
<p>The way we have formulated geostatistical models in <a href="01_intro.html#sec-geostat-models" class="quarto-xref"><span>Section 1.5</span></a> provides a hint as to what step should be followed when simulating from a geostatistical model. Using the same notation of <a href="01_intro.html#sec-geostat-models" class="quarto-xref"><span>Section 1.5</span></a>, these are the steps.</p>
<ol type="1">
<li><p>For a given set of predefined locations <span class="math inline">\(X\)</span> compute the covariance matrix <span class="math inline">\(\Sigma\)</span> with <span class="math inline">\((i,j)\)</span>-th entry <span class="math inline">\(\sigma^2 \rho(u_{ij})\)</span>.</p></li>
<li><p>Compute the covariate effects <span class="math inline">\(d(x)^\top \beta\)</span> for all the locations in <span class="math inline">\(X\)</span>.</p></li>
<li><p>Simulate <span class="math inline">\(B\)</span> times from a multivariate Gaussian distribution with mean vector 0 and covariance <span class="math inline">\(\Sigma\)</span> as previously defined. We denote the output from this step as <span class="math inline">\(S_{(j)}(x)\)</span>, for <span class="math inline">\(j = 1, \ldots, B\)</span>.</p></li>
<li><p>Compute the linear predictor at each location of <span class="math inline">\(X\)</span>, by adding the covariate effects from step 2 to the simulated random effects from step 3, hence <span class="math inline">\(g\{\mu_{(j)}(x)\} = d(x)^\top \beta + S_{(j)}(x)\)</span>.</p></li>
</ol>
<p>Note that before performing the steps above, the values of the model parameters must be fixed. For example, if simulating from a model fitted to the data, the values of the model parameters should be the maximum likelihood estimates. If the goal is to simulate actual observations for the outcome <span class="math inline">\(Y\)</span> at the locations <span class="math inline">\(X\)</span>, then we need to add the following steps.</p>
<p>5A. If the nugget term is included in the model, draw samples <span class="math inline">\(Z_{(j)}\)</span> for each location in <span class="math inline">\(X\)</span> from a Gaussian distribution with mean 0 and variance <span class="math inline">\(\tau^2\)</span>. Add the simulated values <span class="math inline">\(Z_{(j)}\)</span> to <span class="math inline">\(g\{\mu_{(j)}(x)\}\)</span>.</p>
<p>6A. Compute <span class="math inline">\(\mu_{(j)}(x)\)</span> by applying the inverse link function <span class="math inline">\(g^{-1}(\cdot)\)</span> to the samples of the linear predictor previously computed.</p>
<p>7A. Simulate from the distribution of <span class="math inline">\(Y\)</span> given <span class="math inline">\(\mu_{(j)}(x)\)</span>, according to the chosen model, for <span class="math inline">\(j = 1, \ldots, B\)</span>.</p>
<p>These steps, from 1 to 7A, have been implemented in the <code>glgpm_sim</code> function. To show how to perform parametric bootstrap in <code>RiskMap</code>, let us consider the Liberia data on riverblindness and fit the following geostatistical model.</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fit_liberia_no_nugget</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">glgpm</span><span class="op">(</span><span class="va">npos</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">elevation</span><span class="op">)</span> <span class="op">+</span> <span class="fu">gp</span><span class="op">(</span><span class="va">long</span>, <span class="va">lat</span><span class="op">)</span>,</span>
<span>        den <span class="op">=</span> <span class="va">ntest</span>, data <span class="op">=</span> <span class="va">liberia</span>,</span>
<span>        crs <span class="op">=</span> <span class="fl">4326</span>,</span>
<span>        convert_to_crs <span class="op">=</span> <span class="fl">32629</span>,</span>
<span>        family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using the fitted Binomial geostatistical above, we can simulate a single dataset as follows:</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">liberia_sim</span> <span class="op">&lt;-</span> <span class="fu">glgpm_sim</span><span class="op">(</span>n_sim <span class="op">=</span> <span class="fl">1</span>, model_fit <span class="op">=</span> <span class="va">fit_liberia_no_nugget</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The output <code>liberia_sim</code> is a list with as many components as indicated by <code>n_sim</code>. In this this case, we can access the simulated data-set as <code>liberia_sim[[1]]</code>. For example, we could refit the same model to the simulated data as</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fit_liberia_no_nugget_sim</span> <span class="op">&lt;-</span> </span>
<span><span class="fu">glgpm</span><span class="op">(</span>formula <span class="op">=</span> <span class="va">npos</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">elevation</span><span class="op">)</span> <span class="op">+</span> <span class="fu">gp</span><span class="op">(</span><span class="va">long</span>, <span class="va">lat</span><span class="op">)</span>, </span>
<span>    data <span class="op">=</span> <span class="va">liberia_sim</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, family <span class="op">=</span> <span class="st">"binomial"</span>, den <span class="op">=</span> <span class="va">ntest</span>, </span>
<span>    crs <span class="op">=</span> <span class="fl">32629</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that if the data’s CRS has been converted, the simulated data-set will inherit the new CRS rather than the original. This means that any transformation applied to the CRS before simulation (e.g., from geographic to projected coordinates) will affect the spatial scale and interpretation of the simulated data.</p>
<p>This idea can be extended naturally to perform parametric bootstrap. The procedure involves simulating multiple data-sets from the fitted model, refitting the model to each of them, and extracting the estimates of interest. For instance, the following code simulates 100 datasets and fits the same model to each, storing the estimated regression coefficients:</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Simulate 100 datasets</span></span>
<span><span class="va">n_sim</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">liberia_boot</span> <span class="op">&lt;-</span> <span class="fu">glgpm_sim</span><span class="op">(</span>n_sim <span class="op">=</span> <span class="va">n_sim</span>, model_fit <span class="op">=</span> <span class="va">fit_liberia_no_nugget</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># List where we will store the estimates from each of the simulated data-sets</span></span>
<span><span class="va">par_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_sim</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Extracting the simulated Binomial data into "npos_sim"</span></span>
<span>  <span class="va">liberia_boot</span><span class="op">$</span><span class="va">data_sim</span><span class="op">$</span><span class="va">npos_sim</span> <span class="op">&lt;-</span>  </span>
<span>    <span class="va">liberia_boot</span><span class="op">$</span><span class="va">data_sim</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"npos_sim"</span>,<span class="va">i</span>,sep<span class="op">=</span><span class="st">""</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Fitting the geostatistical model</span></span>
<span>  <span class="va">fit_sim</span> <span class="op">&lt;-</span> <span class="fu">glgpm</span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">npos_sim</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">elevation</span><span class="op">)</span> <span class="op">+</span> <span class="fu">gp</span><span class="op">(</span><span class="va">long</span>, <span class="va">lat</span><span class="op">)</span>, </span>
<span>    data <span class="op">=</span> <span class="va">liberia_boot</span><span class="op">$</span><span class="va">data_sim</span>, </span>
<span>    family <span class="op">=</span> <span class="st">"binomial"</span>, </span>
<span>    par0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">fit_liberia_no_nugget</span><span class="op">)</span>,</span>
<span>    den <span class="op">=</span> <span class="va">ntest</span>, </span>
<span>    crs <span class="op">=</span> <span class="fl">32629</span></span>
<span>  <span class="op">)</span> </span>
<span>  </span>
<span>  <span class="co"># Extracting the parameter estimates</span></span>
<span>  <span class="va">par_hat</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">fit_sim</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After obtaining the parameter estimates, we extract them and rearrange them in a matrix format to facilitate the computation of any summary, including the confidence intervals as shown in the code below.</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="co"># Extract all parameters maintaining beta as a vector</span></span>
<span><span class="va">all_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_sim</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">par_hat</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">beta</span>,  </span>
<span>     <span class="va">par_hat</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sigma2</span>,</span>
<span>     <span class="va">par_hat</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">phi</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">CI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">all_params</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">CI</span><span class="op">)</span><span class="op">[</span><span class="op">(</span><span class="va">p</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">p</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sigma^2"</span>, <span class="st">"phi"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit_liberia_no_nugget</span><span class="op">)</span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## glgpm(formula = npos ~ log(elevation) + gp(long, lat), data = liberia, </span></span>
<span><span class="co">##     family = "binomial", den = ntest, crs = 4326, convert_to_crs = 32629)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Binomial geostatistical linear model</span></span>
<span><span class="co">## Link: canonical (logit) </span></span>
<span><span class="co">## Inverse link function = 1 / (1 + exp(-x)) </span></span>
<span><span class="co">##  </span></span>
<span><span class="co">## 'Lower limit' and 'Upper limit' are the limits of the 95% confidence level intervals</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Regression coefficients</span></span>
<span><span class="co">##                 Estimate Lower limit Upper limit    StdErr z.value   p.value</span></span>
<span><span class="co">## (Intercept)    -2.847156   -3.272762   -2.421550  0.217150 -13.111 &lt; 2.2e-16</span></span>
<span><span class="co">## log(elevation)  0.264436    0.222902    0.305970  0.021191  12.479 &lt; 2.2e-16</span></span>
<span><span class="co">##                   </span></span>
<span><span class="co">## (Intercept)    ***</span></span>
<span><span class="co">## log(elevation) ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Spatial Gaussian process</span></span>
<span><span class="co">## Matern covariance parameters (kappa=0.5)</span></span>
<span><span class="co">##                      Estimate Lower limit Upper limit</span></span>
<span><span class="co">## Spatial process var.  0.24447     0.21200      0.2819</span></span>
<span><span class="co">## Spatial corr. scale  34.04827    29.21324     39.6835</span></span>
<span><span class="co">## Variance of the nugget effect fixed at 0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Log-likelihood: 13.75077</span></span>
<span></span>
<span><span class="va">CI</span></span>
<span><span class="co">##                      2.5%      97.5%</span></span>
<span><span class="co">## (Intercept)    -3.6210256 -2.2028113</span></span>
<span><span class="co">## log(elevation)  0.1490998  0.4370221</span></span>
<span><span class="co">## sigma^2         0.1134865  0.4085383</span></span>
<span><span class="co">## phi            14.3625701 80.5595429</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By comparing the 95<span class="math inline">\(\%\)</span> confidence intervals obtained from the <code>summary</code> of the fitted model with those derived from the bootstrap approach, we observe that the former are considerably narrower for the covariance parameters, while the intervals are fairly similar for the regression coefficients.</p>
<p>This discrepancy arises because the Wald-type confidence intervals from <code>summary</code> rely on a Gaussian approximation of the maximum likelihood estimator for the covariance parameters, which may not be entirely reliable. (To improve the accuracy of this approximation, <code>RiskMap</code> applies it to the log-transformed parameters and then transforms the confidence intervals back to the original scale.) On the other hand, bootstrap-based confidence intervals tend to be more reliable, as they are not dependent on the Gaussian assumption. However, they are also more computationally demanding. The use of only 100 bootstrap samples, as shown above, may indeed be insufficient. It is generally recommended to use at least 1000 iterations, if computationally feasible, to minimize the Monte Carlo error arising from the bootstrap simulations.</p>
</section></section><section id="the-residuals-of-a-geostatistical-model-issues-to-consider" class="level2" data-number="3.4"><h2 data-number="3.4" class="anchored" data-anchor-id="the-residuals-of-a-geostatistical-model-issues-to-consider">
<span class="header-section-number">3.4</span> The residuals of a geostatistical model: issues to consider</h2>
<p>In geostatistical models, the concept of residuals, which are widely used in regression modelling to carry out model diagnostics, becomes more nuanced than in standard regression models (i.e., models that do not include random effects) . Generally, residuals aim to quantify the discrepancy between observed outcomes and what the model predicts. However, in GLGMs, there are multiple valid definitions of residuals, each offering a different perspective on the unexplained variation.</p>
<p>If we define the residuals as the component of the model that expresses the variation in the outcome not explained by the covariates, then we are effectively referring to the random effects component of the linear predictor—i.e.&nbsp;<span class="math inline">\(S(x_i)\)</span>, or <span class="math inline">\(S(x_i) + Z_i\)</span> if a nugget effect <span class="math inline">\(Z_i\)</span> is included. We refer to these as <em>random effects residuals</em>.</p>
<p>Let <span class="math inline">\(W_i\)</span> denote the sum of all the random effects in the model, whether <span class="math inline">\(W_i = S(x_i)\)</span>, <span class="math inline">\(W_i = S(x_i) + Z_i\)</span>, or any other random effects structure. In addition to RERs, other types of residuals more common in standard regression modeling can also be used.</p>
<p>One such type is the <em>Pearson residual</em>:</p>
<p><span class="math display">\[
{\rm PR}_i = \frac{y_i - \hat{\text{E}}\left[Y_i \mid W_i\right]}{\sqrt{\hat{\text{Var}}\left[Y_i \mid W_i\right]}}
\]</span></p>
<p>where <span class="math inline">\(\hat{\text{E}}\left[Y_i \mid W_i\right]\)</span> and <span class="math inline">\(\hat{\text{Var}}\left[Y_i \mid W_i\right]\)</span> are estimates of the conditional expectation and variance of <span class="math inline">\(Y_i\)</span> given <span class="math inline">\(W_i\)</span>. See <a href="01_intro.html#tbl-glm" class="quarto-xref">Table&nbsp;<span>1.3</span></a> for the expressions of <span class="math inline">\(\text{E}\left[Y_i \mid W_i\right]\)</span>$ and <span class="math inline">\(\text{Var}\left[Y_i \mid W_i\right]\)</span> for the probability distributions considered in this book.</p>
<p>For example, using Monte Carlo samples from <span class="math inline">\(W_i\)</span>, say <span class="math inline">\(W_{i,(j)}\)</span> for <span class="math inline">\(j = 1, \ldots, B\)</span> (see <a href="#sec-mcmc-mala" class="quarto-xref"><span>Section 3.5.2.2</span></a> for how these samples are generated in <code>RiskMap</code>), the expectations can be estimated as:</p>
<p><span class="math display">\[
\hat{\text{E}}\left[Y_i \mid W_i\right] = \frac{1}{B} \sum_{j=1}^B \hat{\text{E}}\left[Y_i \mid W_{i,(j)}\right], \quad
\hat{\text{Var}}\left[Y_i \mid W_i\right] = \frac{1}{B} \sum_{j=1}^B \hat{\text{Var}}\left[Y_i \mid W_{i,(j)}\right]
\]</span></p>
<p>An alternative, especially useful when <span class="math inline">\(Y_i\)</span> is binary, is the <em>deviance residual</em>:</p>
<p><span class="math display">\[
{\rm DR}_i = \text{sign}(y_i - \hat{y}_i) \sqrt{2 \left( \ell_i^{S} - \ell_i^{F} \right)}
\]</span></p>
<p>where <span class="math inline">\(\ell_i^{S}\)</span> is the log-likelihood of the so-called <em>saturated model</em>, and <span class="math inline">\(\ell_i^{F}\)</span> is the log-likelihood of the fitted model, both conditional on <span class="math inline">\(W_i\)</span>. The saturated model is a hypothetical model that fits the data <strong>perfectly</strong>, meaning it has as many parameters as data points. In such a model, the predicted values are exactly equal to the observed values, and therefore the log-likelihood reaches its maximum possible value. This model serves as a benchmark or upper bound against which the fit of any other model, including our fitted model, is compared. Hence, the difference <span class="math inline">\(\ell_i^{S} - \ell_i^{F}\)</span> reflects how much worse our model fits the data compared to this idealized scenario.</p>
<p>While the residuals discussed above can provide useful insights into model fit, they are often less informative in the context of count data, especially for binary data and low counts. Moreover, even in the simpler case of linear geostatistical models where all three types of residuals introduced earlier (random effects residuals, Pearson residuals, and deviance residuals) are mathematically equivalent, it is easy to show that the correlation structure of the estimated residuals is related to the spatial correlation matrix of the fitted geostatistical model (see <a href="#sec-h-matrix" class="quarto-xref"><span>Section 3.5.3</span></a>). Whether this correlation in the estimated residuals is unimportant or poses a problem, particularly when using residuals to assess whether spatial dependence has been fully accounted for by the model, is still an open question and requires further investigation.</p>
<p>Given these complexities, especially in the context of count data, we have chosen not to delve deeper into residual diagnostics in this edition of the book. Instead, model validation will be addressed more comprehensively in the context of geostatistical prediction in <a href="04_geostatistical-prediction.html" class="quarto-xref"><span>Chapter 4</span></a>.</p>
<p>Nevertheless, we note that some standard diagnostic tools from regression analysis (such as scatter plots of fitted values versus residuals) can still be informative and are worth exploring as part of routine model assessment <span class="citation" data-cites="weisberg2014">(Chapter 9, <a href="references.html#ref-weisberg2014" role="doc-biblioref">Weisberg 2014</a>)</span>.</p>
</section><section id="theory" class="level2" data-number="3.5"><h2 data-number="3.5" class="anchored" data-anchor-id="theory">
<span class="header-section-number">3.5</span> Theory</h2>
<section id="maximum-likelihood-estimation-for-non-guassian-mixed-models-with-independent-random-effects" class="level3" data-number="3.5.1"><h3 data-number="3.5.1" class="anchored" data-anchor-id="maximum-likelihood-estimation-for-non-guassian-mixed-models-with-independent-random-effects">
<span class="header-section-number">3.5.1</span> Maximum likelihood estimation for non-Guassian mixed models with independent random effects</h3>
<p>In this section, we provide more technical details on the derivation of the likelihood function for the mixed model specified in <a href="#eq-linear-predictor-glmms-ch2" class="quarto-xref">Equation&nbsp;<span>3.7</span></a>. While not essential for understanding the application and interpretation of geostatistical models, this section provides useful insights into computationally challenges inherent to the models presented in this book. It is also important to point out that in this section we consider the case when the outcome <span class="math inline">\(Y_i\)</span> is a count.</p>
<p>Let <span class="math inline">\(\theta = (\beta, \tau^2)\)</span> denote the vectore of unkown parameters, where <span class="math inline">\(\beta\)</span> is the vector of regression coefficients and <span class="math inline">\(\tau^2\)</span> is the variance of the random effects <span class="math inline">\(Z = (Z_1, \ldots, Z_n)\)</span>. The likelihood function for a set of observations <span class="math inline">\(Y = (Y_1, \ldots, Y_n)\)</span>, for <span class="math inline">\(i=1,\ldots,n\)</span>, under the model in <a href="#eq-linear-predictor-glmms-ch2" class="quarto-xref">Equation&nbsp;<span>3.7</span></a>, is obtained by deriving the marginal distribution of <span class="math inline">\(Y_i\)</span>, hence <span class="math display">\[
L(\theta) = [Y] = \int_{R^n} \: [Z] [Y \:|\: Z] \: d Z
\]</span> Since the elements <span class="math inline">\(Z_i\)</span> in <span class="math inline">\(Z\)</span> are mutually independent, we can write <span class="math display">\[
[Z] = \prod_{i=1}^n [Z_i]
\]</span> and, using the conditional independence among the <span class="math inline">\(Y\)</span> given <span class="math inline">\(Z\)</span>, we obtain <span class="math display">\[
[Y \:|\: Z] = \prod_{i=1}^n [Y_i | Z_i].
\]</span> From these, it then follows that <span id="eq-glmm-final"><span class="math display">\[
L(\theta) = \int_{R^n} \: \prod_{i=1}^n [Z_i] \prod_{i=1}^n [Y_i | Z_i] \: d Z = \prod_{i=1}^n \int_{R} \: [Z_i] [Y_i \:|\: Z_i] \: d Z_i.
\tag{3.26}\]</span></span> This shows that under the model in <a href="#eq-linear-predictor-glmms-ch2" class="quarto-xref">Equation&nbsp;<span>3.7</span></a>, whilst accounting for overdispersion, this model does not account for any source of correlation between the observations. This is because the likelihood function can be expressed, as shown in the equation above, as the product of <span class="math inline">\(n\)</span> likelihoods associated to each of the observations.</p>
<p>Another important observation is that the integrals that express the likelihood in <a href="#eq-glmm-final" class="quarto-xref">Equation&nbsp;<span>3.26</span></a>, cannot be solved analytically and need to be approximated. Several solution are available that either based on maximum likelihood estimation or Bayesian methods of inference. The function <code>glmer</code> used in <a href="#sec-empirical-variog-lm" class="quarto-xref"><span>Section 3.1.3.2</span></a> provides both the Laplace and Gaussian quadrature approximations options. The former consists of finding the <em>peak</em> of the integrand - i.e.&nbsp;the function that is being integrate - and approximating that with a Gaussian distributioncentered at that <em>peak</em>, using the curvature of the original distribution to determine the width of the Gaussian distribution. The Gaussian quadrature is another numerical integration technique used to approximate the integral of a function. It involves choosing specific points (nodes) and weights within the integration interval to approximate the integral. By strategically selecting these points and weights based on a Gaussian distribution, Gaussian quadrature can provide highly accurate results compared to other numerical integration methods, such as the Laplace approximation. For a comprehensive overview of these and other methods of approximations of intractable integrals, we find that <span class="citation" data-cites="bishop2006">Bishop (<a href="references.html#ref-bishop2006" role="doc-biblioref">2006</a>)</span> is one of the most accessible textbooks on this topic.</p>
</section><section id="sec-glgm-lik" class="level3" data-number="3.5.2"><h3 data-number="3.5.2" class="anchored" data-anchor-id="sec-glgm-lik">
<span class="header-section-number">3.5.2</span> Maximum likelihood estimation for non-Guassian generalized linear geostatistical models</h3>
<p>To derive the likelihood function of a generalized linear geostatistical model (GLGM), we consider the special case of a single observation per location without loss of generality. Let <span class="math inline">\(Y\)</span> and <span class="math inline">\(Z\)</span> denote the same vectors of random variables introduced in the previous section, with components <span class="math inline">\(Y_i\)</span> and <span class="math inline">\(Z_i\)</span> corresponding to the set of locations <span class="math inline">\(X = (x_1, \ldots, x_n)\)</span>. Additionally, we define <span class="math inline">\(S(X) = (S(x_1), \ldots, S(x_n))\)</span> to represent the spatial Gaussian process at the sampled locations <span class="math inline">\(X\)</span>. In this case the vector of unknown parameters is <span class="math inline">\(\theta = (\beta, \sigma^2, \phi, \tau^2)\)</span> and, as done in the previous section, we can obtain the likelihood function though the marinal distribution of the data, hence we write <span id="eq-glgm-lik1"><span class="math display">\[
L(\theta) = [Y] = \int_{R^n} \int_{R^n} \: [Z] [S] [Y \:|\: Z, S] \: d Z d S
\tag{3.27}\]</span></span> To simplify the explanation and notation in this section and the following ones, we will first rewrite the likelihood function in terms of the random effect $ W_i = S(x_i) + Z_i $ and will denote this in its vector form as <span class="math inline">\(W = (W_1, \ldots, W_n)\)</span>. Hence we write <span id="eq-glgm-lik2"><span class="math display">\[L(\theta) = [Y] = \int_{R^n} \: [W] [Y \:|\: W] \: d W \tag{3.28}\]</span></span> In this model formulation, we assume that <span class="math inline">\(Y\)</span> conditionally on <span class="math inline">\(W\)</span> is a set of mutually independent outcomes, hence <span class="math display">\[
[Y | W]  = \prod_{i=1}^n [Y_i | W_i].
\]</span> However, unlike in the previous section, the distribution of <span class="math inline">\([W]\)</span> is a Multivariate Gaussian distribution with correlated components, hence we cannot split the integral into separate univariate ones as before. More specifically, <span class="math inline">\(W\)</span> follows a Multivariate Gaussian distribution with mean vector <span class="math inline">\(0\)</span> and covariance matrix <span class="math inline">\(\Omega\)</span>, whose <span class="math inline">\((i, j)\)</span>-th entry is <span class="math display">\[
[\Omega]_{ij} =
\begin{cases}
\sigma^2 \rho(u_{ij}; \phi, \kappa) &amp; \mbox{if }i\neq j \\
\sigma^2 + \tau^2 &amp;  \mbox{if }i = j
\end{cases}
\]</span> where <span class="math inline">\(\rho(u;\phi,\kappa)\)</span> is the Matern correlation function with scale parameter <span class="math inline">\(\phi\)</span> and smoothness parameter <span class="math inline">\(\kappa\)</span>; see <a href="01_intro.html#eq-matern" class="quarto-xref">Equation&nbsp;<span>1.5</span></a>.</p>
<p>In the next two sections we provide a brief overview of Monte Carlo maximum likelihood and the use of Markov chain Monte Carlo to approximate <a href="#eq-glgm-lik2" class="quarto-xref">Equation&nbsp;<span>3.28</span></a>.</p>
<section id="sec-mcml" class="level4" data-number="3.5.2.1"><h4 data-number="3.5.2.1" class="anchored" data-anchor-id="sec-mcml">
<span class="header-section-number">3.5.2.1</span> Monte Carlo maximum likelihood</h4>
<p>In maximum likelihood estimation, we aim to maximize the likelihood function to find the parameters that make our data the most likely to have been observed. Monte Carlo Maximum Likelihood (MCML) is a method introduced by <span class="citation" data-cites="geyer1991">Charles J. Geyer (<a href="references.html#ref-geyer1991" role="doc-biblioref">1991</a>)</span>, designed to handle situations where the likelihood function is difficult or impossible to compute directly. As shown above, non-Gaussian generalized linear geostatistical models yield an intractable likelihood function that involves a high-dimensional integral, hence we use MCML to approximate this.</p>
<p>MCML solves this problem using Monte Carlo methods, which involve random sampling to approximate the value of these integrals. One way to apply Monte Carlo methods in this context is through <em>importance sampling</em>. Importance sampling allows us to approximate the likelihood function by rewriting the likelihood in a form that can be estimated using samples from an easier distribution, known as the <em>importance sampling distribution</em>. To this end, we then rewrite <a href="#eq-glgm-lik2" class="quarto-xref">Equation&nbsp;<span>3.28</span></a> as <span id="eq-mcml1"><span class="math display">\[
\begin{aligned}
L(\theta)
&amp;= \int [W, Y; \theta] \: dW  \\
&amp;= \int \frac{[W, Y; \theta]}{[W, Y; \theta_0]}[W, Y; \theta_0]\: dW   \\
&amp;\propto  \int \frac{[W, Y; \theta]}{[W, Y; \theta_0]} [W | Y; \theta_0] \: dW  \\
&amp;= E\left\{\frac{[W, Y; \theta]}{[W, Y; \theta_0]}\right\},
\end{aligned}
\tag{3.29}\]</span></span> where <span class="math inline">\(\theta_0\)</span> represents our best guess of <span class="math inline">\(\theta_0\)</span> and the expectation in the equation above is taken with respect to <span class="math inline">\([W | Y; \theta_0]\)</span>, which represent our <em>importance sampling distribution</em>.</p>
<p>Let <span class="math inline">\(W_{(j)}\)</span> represent the <span class="math inline">\(j\)</span>-th sample out of <span class="math inline">\(B\)</span> drawn from the distribution <span class="math inline">\([W \mid Y; \theta_0]\)</span>. To simulate samples from <span class="math inline">\([W \mid Y; \theta_0]\)</span>, Markov chain Monte Carlo (MCMC) algorithms are required and we explain more in detail in the next section.</p>
<p>We approximate the expression in <a href="#eq-mcml1" class="quarto-xref">Equation&nbsp;<span>3.29</span></a> as follows: <span id="eq-mcml2"><span class="math display">\[
L_{MC}(\theta) = \frac{1}{B} \sum_{j=1}^B \frac{[W_{(j)}, Y; \theta]}{[W_{(j)}, Y; \theta_0]}.
\tag{3.30}\]</span></span></p>
<p>As <span class="math inline">\(B \rightarrow \infty\)</span>, the Monte Carlo likelihood <span class="math inline">\(L_{MC}\)</span> converges to the exact likelihood function described in <a href="#eq-mcml1" class="quarto-xref">Equation&nbsp;<span>3.29</span></a>. The maximization of this Monte Carlo likelihood is performed using an optimization algorithm that uses the analytical expressions of the first and second derivatives. This approach is especially useful for exploring the likelihood surface, which can be relatively flat, particularly in the space of covariance parameters. To improve the approximation of the likelihood function in equation <a href="#eq-mcml2" class="quarto-xref">Equation&nbsp;<span>3.30</span></a>, this process can be repeated iteratively, replacing <span class="math inline">\(\theta_0\)</span> after each step with the estimate obtained from equation <a href="#eq-mcml2" class="quarto-xref">Equation&nbsp;<span>3.30</span></a>, until convergence is achieved. However, due to Monte Carlo error, the estimates after each iteration may still vary considerably, making convergence difficult to reach if very strict criteria are used.</p>
<p>For spatial prediction, we take a pragmatic approach by running an initial MCML iteration, followed by a second iteration with 10,000 samples, without further iterations. This is because spatial prediction is generally less affected by Monte Carlo error, as will be demonstrated later. On the other hand, when the goal is to draw inferences about model parameters, more iterations may be needed to reduce Monte Carlo error to acceptable levels.</p>
</section><section id="sec-mcmc-mala" class="level4" data-number="3.5.2.2"><h4 data-number="3.5.2.2" class="anchored" data-anchor-id="sec-mcmc-mala">
<span class="header-section-number">3.5.2.2</span> Monte Carlo Markov Chain: sampling from the predictive distribution of the spatial Gaussian process</h4>
<p>Building on the outline of the MCML method from the previous section, we now address the task of sampling from the distribution <span class="math inline">\([W \mid Y]\)</span> to generate the samples <span class="math inline">\(W_{(j)}\)</span> used in equation <a href="#eq-mcml2" class="quarto-xref">Equation&nbsp;<span>3.30</span></a>. To simplify the notation, we will use <span class="math inline">\([W \mid Y]\)</span>$ in place of <span class="math inline">\([W \mid Y; \theta_0]\)</span>, but it is important to emphasize that the parameters <span class="math inline">\(\theta_0\)</span> are considered fixed when sampling from <span class="math inline">\([W \mid Y]\)</span>. Since direct simulation from <span class="math inline">\([W \mid Y]\)</span> is not feasible, we must rely on Markov chain Monte Carlo (MCMC) methods, which we briefly introduce next.</p>
<p>The is a foundational technique in the field of MCMC methods, which are widely used for sampling from complex probability distributions. The primary goal of MCMC methods is to generate a sequence of samples from a target distribution where direct sampling is challenging, such as the distribution of <span class="math inline">\([W | Y]\)</span>. The Metropolis-Hastings algorithm, first introduced by <span class="citation" data-cites="metropolis1953equation">Metropolis et al. (<a href="references.html#ref-metropolis1953equation" role="doc-biblioref">1953</a>)</span> and later generalized by <span class="citation" data-cites="hastings1970monte">Hastings (<a href="references.html#ref-hastings1970monte" role="doc-biblioref">1970</a>)</span>, achieves this by constructing a Markov chain that has <span class="math inline">\([W \| Y]\)</span>$ as its stationary distribution. In what follows, we shall use <span class="math inline">\(\pi(W)\)</span> to denote the density function of <span class="math inline">\([W | Y]\)</span> up to a constant of proportionality.</p>
<p>Given a current realization <span class="math inline">\(W_{(k)}\)</span> of the distribution <span class="math inline">\([W | Y]\)</span> in the Markov chain, the algorithm proceeds as follows.</p>
<ul>
<li>Propose a new realization <span class="math inline">\(W_{(k+1)}\)</span> from <span class="math inline">\(q(W_{(k+1)} \mid W_{(k)})\)</span>, where <span class="math inline">\(q(\cdot \mid \cdot)\)</span> is the density function of a chosen proposal distribution.</li>
<li>Compute the acceptance probability: <span class="math display">\[
\alpha = \min \left(1, \frac{\pi(W_{(k+1)}) q(W_{(k)} \mid W_{(k+1)})}{\pi(W_{(k)}) q(W_{(k+1)} \mid W_{(k)})} \right).
\]</span>
</li>
<li>Accept the proposed realization <span class="math inline">\(W_{(k+1)}\)</span> with probability <span class="math inline">\(\alpha\)</span>; otherwise, retain the current realization <span class="math inline">\(W_{(k)}\)</span>.</li>
</ul>
<p>The algorithm ensures that, under certain conditions, the chain converges to the target distribution <span class="math inline">\(\pi(W)\)</span> as the number of steps increases <span class="citation" data-cites="roberts1996exponential">Roberts and Tweedie (<a href="references.html#ref-roberts1996exponential" role="doc-biblioref">1996</a>)</span>.</p>
<p>The functions of the <code>RiskMap</code> package for fitting Binomial and Poisson geostatistical models implement the , which is an improvement over traditional Metropolis-Hastings MCMC methods. Introduced by <span class="citation" data-cites="rossky1978brownian">Rossky, Doll, and Friedman (<a href="references.html#ref-rossky1978brownian" role="doc-biblioref">1978</a>)</span> and further developed by <span class="citation" data-cites="roberts1996exponential">Roberts and Tweedie (<a href="references.html#ref-roberts1996exponential" role="doc-biblioref">1996</a>)</span>, MALA incorporates gradient information from the target distribution to propose more informed moves, potentially leading to faster convergence and more efficient exploration of the target distribution.</p>
<p>MALA combines the Metropolis-Hastings framework with Langevin dynamics, where proposals <span class="math inline">\(q(\cdot | \cdot)\)</span> are defined as:</p>
<p><span class="math display">\[
W_{(k+1)} = W_{(k)} + \frac{\epsilon^2}{2} \nabla \log \pi(W_{(k)}) + \epsilon \, \eta,
\]</span></p>
<p>where <span class="math inline">\(\epsilon\)</span> is a step size parameter, <span class="math inline">\(\nabla \log \pi(W_{(k)})\)</span> is the gradient of the log of the target density with respect to <span class="math inline">\(W_{(k)}\)</span>, and <span class="math inline">\(\eta \sim \mathcal{N}(0, I)\)</span> is a Gaussian random variable with mean 0 and independent components with unit variance.</p>
<p>By leveraging the gradient, MALA can propose moves that are more likely to be accepted, especially in high-dimensional spaces or regions of low probability density.</p>
<p>In the context of Laplace sampling for geostatistical models, the is used to construct an efficient proposal distribution. The primary objective is to generate samples from a conditional distribution of latent Gaussian processes, which is challenging due to high dimensionality and complex dependence structures.</p>
<p>The Laplace sampling method, as implemented in the <code>RiskMap</code> package, utilizes a specific form of MALA. Here, the proposal distribution is derived from a second-order Taylor expansion around the mode of the target distribution [W | Y]. Let <span class="math inline">\(\hat{w}\)</span> be the mode of this conditional distribution, and let <span class="math inline">\(\hat{\Omega}\)</span> be the inverse of the negative Hessian matrix evaluated at <span class="math inline">\(\hat{w}\)</span>, which approximates the local covariance structure of the distribution. We then define the random variable <span class="math inline">\(\tilde{W}\)</span> as</p>
<p><span class="math display">\[
\tilde{W} = \hat{\Omega}^{-1/2} (W - \hat{w})
\]</span></p>
<p>This linear transformation is applied to decorrelate the components of <span class="math inline">\(W\)</span>, making the MCMC updates more efficient <span class="citation" data-cites="geyer1994">(<a href="references.html#ref-geyer1994" role="doc-biblioref">Charles J. Geyer 1994</a>)</span>. The function <code>Laplace_sampling_MCMC</code> in <code>RiskMap</code> uses this approach where by at each iteration the variable <span class="math inline">\(\tilde{W}\)</span> using the MALA algorithm, and samples for <span class="math inline">\([W | Y]\)</span> are then obtained by inverting the linear transformation from the above equation. The logic behind using this approach is that it allows the proposal distribution to adapt to the local geometry of the posterior, thus improving convergence properties and reducing the correlation between successive samples (see <span class="citation" data-cites="christensen2004">O. F. Christensen (<a href="references.html#ref-christensen2004" role="doc-biblioref">2004</a>)</span>).</p>
<p>Once the MCMC algorithm has completed all iterations, it is important to ensure that it has converged to the target distribution. The diagnostic methods listed below can be used to assess convergence using the obtained MCMC samples.</p>
<ol type="1">
<li><p><strong>Trace Plots</strong>: Plotting the sampled values against the iterations can help visually inspect if the chains have reached a stationary distribution. A well-mixed chain should appear as a “random walk” around a stable mean value.</p></li>
<li><p><strong>Autocorrelation Plots</strong>: These plots measure the correlation between samples as a function of the lag between them. Low autocorrelation across lags indicates good mixing, suggesting convergence.</p></li>
<li>
<p><strong>Effective Sample Size (ESS)</strong>: The ESS measures the number of independent samples that an MCMC chain is equivalent to, accounting for the autocorrelation in the chain. It is calculated as: <span class="math display">\[
\text{ESS} = \frac{N}{1 + 2 \sum_{k=1}^{\infty} \rho_k},
\]</span> where <span class="math inline">\(N\)</span> is the total number of MCMC samples and <span class="math inline">\(\rho_k\)</span> is the autocorrelation at lag <span class="math inline">\(k\)</span>. A high ESS indicates that the chain has good mixing properties and the samples are nearly independent. The summation of autocorrelations up to a sufficiently large lag is used to estimate the reduction in effective sample size due to the dependence between samples. A small ESS suggests high autocorrelation and that more samples are needed to achieve the same precision as a set of independent samples.</p>
<p>A high ESS (Effective Sample Size) indicates that the chain has good mixing properties, meaning the samples are nearly independent. The summation of autocorrelations up to a sufficiently large lag is used to estimate the reduction in effective sample size due to the dependence between samples. A small ESS suggests high autocorrelation, meaning more samples are needed to achieve the same precision as a set of independent samples. In addition to those, other diagnostics can provide further assurance of convergence. For example, the Gelman-Rubin diagnostic compares the variance between multiple chains to the variance within each chain; a diagnostic value close to 1 indicates that the chains have converged to a common distribution <span class="citation" data-cites="gelman1992inference">(<a href="references.html#ref-gelman1992inference" role="doc-biblioref">Gelman and Rubin 1992</a>)</span>. Also, the Geweke diagnostic tests for convergence compares the means of the first part and last part of a single MCMC chain. If the means are not significantly different, it suggests that the chain has reached stationarity <span class="citation" data-cites="geweke1992evaluating">(<a href="references.html#ref-geweke1992evaluating" role="doc-biblioref">Geweke 1992</a>)</span>. Using a combination of these diagnostics can be used to assess whether the MCMC algorithm has adequately explored the target distribution.</p>
</li>
</ol>
<p>It is important to point out that in MCMC algorithms, to the quality of samples we need to carefully considers these three control parameters of the MCMC.</p>
<ul>
<li><p><strong>Number of Simulations</strong>: Increasing the number of simulations allows the algorithm to explore the posterior distribution more thoroughly, reducing the variability in estimates. A higher number of simulations typically leads to more accurate results but also requires more computational time.</p></li>
<li><p><strong>Burn-in</strong>: The burn-in phase refers to the initial set of iterations where the Markov chain has not yet converged to its stationary distribution. These initial samples are discarded to ensure that the remaining samples represent the target distribution more accurately. Properly setting the burn-in period helps avoid bias due to initial conditions.</p></li>
<li><p><strong>Thinning</strong>: Thinning reduces autocorrelation by only keeping every <em>n</em>-th sample from the chain. While this decreases autocorrelation between retained samples, it also reduces the overall sample size. Thinning is used when chains exhibit high autocorrelation to ensure a more independent set of samples is analyzed. Initially, these values can be set based on prior experience or general rules of thumb (e.g., a burn-in of 10-20% of the total iterations). In the next summary section, we provide more details on specific implementation of these in <code>RiskMap</code>.</p></li>
</ul>
<p>For a more thorough and complete overview of MCMC algorithms, chapters 10 to 13 of <span class="citation" data-cites="gelman1992inference">Gelman and Rubin (<a href="references.html#ref-gelman1992inference" role="doc-biblioref">1992</a>)</span> are a recommended read.</p>
</section><section id="sec-summary" class="level4" data-number="3.5.2.3"><h4 data-number="3.5.2.3" class="anchored" data-anchor-id="sec-summary">
<span class="header-section-number">3.5.2.3</span> Summary with example</h4>
<p>In summary, here are the steps required to perform Monte Carlo Maximum Likelihood (MCML):</p>
<ol type="1">
<li><p>Start by selecting an initial guess for the model parameters, denoted as <span class="math inline">\(\theta_0\)</span>.</p></li>
<li><p>Simulate Samples from <span class="math inline">\([W \mid Y; \theta_0]\)</span> using MCMC methods. Perform a check on the MCMC samples to assess convergence of the MCMC algorithm.</p></li>
<li><p>Compute and maximize the approximate likelihood function in <a href="#eq-mcml2" class="quarto-xref">Equation&nbsp;<span>3.30</span></a>.</p></li>
<li><p>Set the newly estimated parameter as <span class="math inline">\(\theta_0\)</span> for the next iteration.</p></li>
<li><p>Repeat 1 to 4 until convergence is achieved.</p></li>
<li><p>Monitor the estimates for convergence. If strict convergence criteria are set, Monte Carlo error may cause fluctuations, making it harder to achieve convergence.</p></li>
<li><p>Perform additional iterations, if necessary. For inference on model parameters, continue iterating to reduce Monte Carlo error. For spatial prediction, a pragmatic approach may involve stopping after a second iteration with 10,000 samples, as prediction is less affected by Monte Carlo error.</p></li>
</ol>
<p>In <code>RiskMap</code>, steps 1 to 3 are automated (with the exception of the check on the convervence of the MCMC algorithm in step 2), while steps 4 to 7 require manual implementation. In <a href="#sec-liberia-estim1" class="quarto-xref"><span>Section 3.3.1</span></a>, estimation is performed using a geostatistical model fitted to prevalence data. The <code>par0</code> argument in the <code>glgpm</code> function allows you to specify initial guesses for the model parameters <span class="math inline">\(\theta_0\)</span>. If no values are provided for <code>par0</code> (as in <a href="#sec-liberia-estim1" class="quarto-xref"><span>Section 3.3.1</span></a>), the following defaults are used:</p>
<ul>
<li>The initial guess for the regression coefficients <span class="math inline">\(\beta\)</span> is set to the maximum likelihood estimates obtained from a standard generalized linear model (GLM), i.e., a GLM without random effects or overdispersion.</li>
<li>The initial values for both <span class="math inline">\(\sigma^2\)</span> (the variance of the spatial Gaussian process) and <span class="math inline">\(\tau^2\)</span> (the variance of the nugget term, if included) are set to 1.</li>
<li>The initial guess for the scale parameter of the spatial correlation function <span class="math inline">\(\phi\)</span> is based on the 0.1 quantile of the distances between all pairs of locations.</li>
</ul>
<p>In our experience, this set of initial guesses works reasonably well. However, more iterations of the MCMC algorithm, as suggested in the step 7 above, are generally recommended.</p>
<p>An alternative approach for setting initial guesses for the covariance parameters <span class="math inline">\(\sigma^2\)</span>, <span class="math inline">\(\tau^2\)</span>, and <span class="math inline">\(\phi\)</span> is to apply an interpolation technique to the variogram, as proposed in the seminal work by <span class="citation" data-cites="cressie1985">N. Cressie (<a href="references.html#ref-cressie1985" role="doc-biblioref">1985</a>)</span>. However, in our experience, this approach does not consistently provide better approximations of the likelihood function compared to the method mentioned above. This may be due to the instability in estimating the variogram based on residuals from mixed models, as well as the sensitivity of empirical variogram estimation to the chosen distance bins.</p>
<p>To better illustrate some of the points above, we continue the analysis of the Liberia data from <a href="#sec-liberia-estim1" class="quarto-xref"><span>Section 3.3.1</span></a>. Diagnostic summaries on the convergence of the MCMC algorithm can be obtained with the <code>check_mcmc</code> function by passing the fitting model <code>fit_liberia</code> to the function.</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">check_mcmc</span><span class="op">(</span><span class="va">fit_liberia</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-check-mcmc-mean" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-check-mcmc-mean-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03_model-fitting_files/figure-html/fig-check-mcmc-mean-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-check-mcmc-mean-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.12: Trace plot (left panel) and autocorrelation function plot (right panel) for the averaged spatial random effects from the river-blindness data analysis. The title of the right panel also shows the effective sample size of the 1000 Markov chain Monte Carlo (MCMC) samples. The MCMC samples are obtained by running the MCMC algorithm for 12000 iterations, with a burn-in of 2000 and thinning of 10.
</figcaption></figure>
</div>
</div>
</div>
<p>The plot shown in <a href="#fig-check-mcmc-mean" class="quarto-xref">Figure&nbsp;<span>3.12</span></a> are for the MCMC samples of the averaged spatial random effect, that is <span class="math inline">\(\bar{S} = \sum_{i=1}^n S(x_i) /n\)</span>. Performing the check on <span class="math inline">\(\bar{S}\)</span> is done to avoid the need of checking the convergence for each individual component <span class="math inline">\(S(x_i)\)</span>. However, one of the risks of doing this is that if fewer components of <span class="math inline">\(\bar{S}\)</span> have not reached convergence this may not be shown through the inspection of the samples for <span class="math inline">\(\bar{S}\)</span>. However, this is an unlikely scenario when using the type of MCMC algorithm implemented in <code>RiskMap</code> (see <a href="#sec-mcmc-mala" class="quarto-xref"><span>Section 3.5.2.2</span></a>). Nonetheless, if one wants to check the convergence for individual components this can be done as follows.</p>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">check_mcmc</span><span class="op">(</span><span class="va">fit_liberia</span>, check_mean <span class="op">=</span> <span class="cn">FALSE</span>, component <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-check-comp10-mcmc" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-check-comp10-mcmc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03_model-fitting_files/figure-html/fig-check-comp10-mcmc-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-check-comp10-mcmc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.13: Trace plot (left panel) and autocorrelation function plot (right panel) for the tenth component of the spatial random effects from the river-blindness data analysis.
</figcaption></figure>
</div>
</div>
</div>
<p>Both <a href="#fig-check-mcmc-mean" class="quarto-xref">Figure&nbsp;<span>3.12</span></a> and <a href="#fig-check-comp10-mcmc" class="quarto-xref">Figure&nbsp;<span>3.13</span></a>, shows a reasonably good mixing and relatively low correlation in the samples. We point out that the number of MCMC samples in <code>glgpm</code> are set through the function <code>set_control_sim</code> passed to the argument <code>control_mcmc</code>. By default <code>set_control_sim</code> uses 12000 iterations, a burn-in of 2000 and thinning of 10, thus giving 1000 MCMC samples. This configuration can be enough for the first run of the Monte Carlo maximum Likelihood (MCML) method, however it is advisable to increase the number of iterations to obtain a larger number of samples with reduced correlation.</p>
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Update the guesses for the model parameters </span></span>
<span><span class="va">par0_liberia</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">fit_liberia</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Refit the model and increase the MCMC samples</span></span>
<span><span class="va">fit_liberia2</span> <span class="op">&lt;-</span> </span>
<span><span class="fu">glgpm</span><span class="op">(</span><span class="va">npos</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">elevation</span><span class="op">)</span> <span class="op">+</span> <span class="fu">gp</span><span class="op">(</span><span class="va">long</span>, <span class="va">lat</span>, nugget <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>,</span>
<span>      den <span class="op">=</span> <span class="va">ntest</span>, data <span class="op">=</span> <span class="va">liberia</span>,</span>
<span>      crs <span class="op">=</span> <span class="fl">4326</span>,</span>
<span>      convert_to_crs <span class="op">=</span> <span class="fl">32629</span>,</span>
<span>      par0 <span class="op">=</span> <span class="va">par0_liberia</span>, </span>
<span>      control_mcmc <span class="op">=</span> <span class="fu">set_control_sim</span><span class="op">(</span>n_sim <span class="op">=</span> <span class="fl">110000</span>, </span>
<span>                                     burnin <span class="op">=</span> <span class="fl">10000</span>, </span>
<span>                                     thin <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>      family <span class="op">=</span> <span class="st">"binomial"</span>, messages <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">check_mcmc</span><span class="op">(</span><span class="va">fit_liberia2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-mcmc-10k" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-mcmc-10k-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="03_model-fitting_files/figure-html/fig-mcmc-10k-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mcmc-10k-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.14: Trace plot (left panel) and autocorrelation function plot (right panel) for the tenth component of the spatial random effects from the river-blindness data analysis. The Markov chain Monte Carlo (MCMC) samples are obtained by running the MCMC algorithm for 110000 iterations, with a burn-in of 10000 and thinning of 10.
</figcaption></figure>
</div>
</div>
</div>
<p>The code above performs an additional step in the MCML estimation, using 10,000 MCMC samples. As shown in <a href="#fig-mcmc-10k" class="quarto-xref">Figure&nbsp;<span>3.14</span></a>, these MCMC samples exhibit good mixing and low autocorrelation, which indicates that they adequately approximate the likelihood function of the Binomial geostatistical model. Although additional MCMC iterations could be run to obtain estimates closer to the true maximum likelihood estimate (since we are approximating the likelihood function and not obtaining the exact MLE), we choose not to do so here. This decision is due to both the computational time required and the minimal impact of Monte Carlo error on spatial predictions in this case.</p>
</section><section id="alternative-approaches" class="level4" data-number="3.5.2.4"><h4 data-number="3.5.2.4" class="anchored" data-anchor-id="alternative-approaches">
<span class="header-section-number">3.5.2.4</span> Alternative approaches</h4>
<p>In the sections above, we focused specifically on the implementation of the Monte Carlo Maximum Likelihood (MCML) method in <code>RiskMap</code>. However, other approaches are available, some of which are computationally more efficient than the MCML method we have illustrated. Our preference for this estimation method is based on two main reasons: 1) it delivers robust performance across a wide range of data scenarios, and 2) it does not require the specification of arbitrary prior distributions when prior information on the model parameters is unavailable.</p>
<p>Alternative methods worth mentioning include the expectation-maximization algorithm for maximum likelihood estimation <span class="citation" data-cites="zhang2002">(<a href="references.html#ref-zhang2002" role="doc-biblioref">Zhang 2002</a>)</span>, integrated nested Laplace approximation (INLA) <span class="citation" data-cites="rue2009">(<a href="references.html#ref-rue2009" role="doc-biblioref">Rue, Martino, and Chopin 2009</a>)</span>, and implementations of the Metropolis-Adjusted Langevin Algorithm (MALA) for Bayesian inference <span class="citation" data-cites="christensen2006">(<a href="references.html#ref-christensen2006" role="doc-biblioref">O. Christensen, Roberts, and Sköld 2006</a>)</span>. While these methods are valuable, explaining and comparing them is not our focus here, as it would detract from the practical orientation of this book.</p>
</section></section><section id="sec-h-matrix" class="level3" data-number="3.5.3"><h3 data-number="3.5.3" class="anchored" data-anchor-id="sec-h-matrix">
<span class="header-section-number">3.5.3</span> The Hat matrix in linear geostatistical models</h3>
<p>We consider the geostatistical model</p>
<p><span class="math display">\[
Y_i = d(x_i)^\top \beta + S(x_i) + Z_i
\]</span></p>
<p>where $ Y_i $ is the observed response at location $ x_i $, $ d(x_i) $ is a $ p $-dimensional vector of covariates, $ $ is a $ p $ vector of regression coefficients, $ S(x_i) $ is a spatially structured random effect, and $ Z_i N(0, ^2) $ is independent Gaussian noise. The model can be rewritten as</p>
<p><span class="math display">\[
Y = D\beta + S + Z
\]</span></p>
<p>where $ Y = (Y_1, , Y_n)^$ is the $ n $ vector of observations, $ S = (S(x_1), , S(x_n))^$ is the vector of spatially dependent random effects, <span class="math inline">\(Z = (Z_1, \ldots, Z_n)\)</span> is the noise, and $ D $ is an $ n p $ matrix of covariates given by</p>
<p><span class="math display">\[
D = (d_1(X), \ldots, d_p(X))
\]</span></p>
<p>with each column $ d_j(X) = (d_j(x_1),,d_j(x_n))^$ representing the values of the $ j $-th covariate across all locations. This formulation accounts for both fixed effects through $ D$ and spatial correlation through $ S(x_i) $. The covariance matrix of $ Y $ is</p>
<p><span class="math display">\[
V = \Sigma + \tau^2 I
\]</span></p>
<p>where $ $ is the spatial covariance matrix of <span class="math inline">\(S\)</span>. Assuming the covariance parameters are known, the generalized least squares estimator for $ $ is</p>
<p><span class="math display">\[
\hat{\beta} = (D^T V^{-1} D)^{-1} D^T V^{-1} Y.
\]</span></p>
<p>The predictor for <span class="math inline">\(S\)</span> is the the conditional expectation <span class="math inline">\(E[S(x_i) \: | \: Y_i]\)</span> is</p>
<p><span class="math display">\[
\hat{S} = \Sigma V^{-1} (Y - D\hat{\beta}).
\]</span></p>
<p>so the predictors for <span class="math inline">\(Y\)</span> can be written as</p>
<p><span class="math display">\[
\hat{Y} = D\hat{\beta} + \hat{S}.
\]</span></p>
<p>The hat matrix, which projects observations onto the fitted space, is</p>
<p><span class="math display">\[
H = [D - \Sigma V^{-1} D] (D^T V^{-1} D)^{-1} D^T V^{-1} + \Sigma V^{-1}.
\]</span></p>
<p>This matrix is symmetric since it consists of symmetric components, satisfying <span class="math inline">\(H^T = H\)</span>. It is also idempotent, meaning <span class="math inline">\(H^2 = H\)</span>, which follows from the properties of projection matrices. The diagonal elements <span class="math inline">\(h_{ii}\)</span> represent the leverage of each observation, quantifying how much each $ Y_i $ influences its own fitted value. The rank of $ H $ is at most $ p $, constrained by the rank of $ D $. Unlike in ordinary least squares where the hat matrix is <span class="math inline">\(H = D (D^T D)^{-1} D^T\)</span>, here it depends on <span class="math inline">\(V^{-1}\)</span>, accounting for spatial dependence. Since <span class="math inline">\(V \neq I\)</span>, the hat matrix represents an oblique projection rather than an orthogonal one.</p>
<p>The residuals, i.e.&nbsp;the estimate of <span class="math inline">\(Z\)</span> are given by</p>
<p><span class="math display">\[
\hat{Z} = Y - \hat{Y} = (I - H) Y.
\]</span></p>
<p>We not thet the covariance structure of <span class="math inline">\(\hat{Z}\)</span> is</p>
<p><span class="math display">\[
\text{Var}(\hat{Z}) = (I - H) V (I - H)^T.
\]</span></p>
<p>Hence, the estimated residuals from a linear geostatistical model do have a correlation structure which relates to the chosen spatial correlation structure in <span class="math inline">\(\Sigma\)</span>.</p>
</section></section><section id="review-questions" class="level2" data-number="3.6"><h2 data-number="3.6" class="anchored" data-anchor-id="review-questions">
<span class="header-section-number">3.6</span> Review questions</h2>
<ul>
<li><p>Describe how you would perform exploratory analysis between counts data and covariates, distnsuighing between unbounded counts (e.g.&nbsp;Poisson), bounded counts (e.g.&nbsp;Binomial) and binary outcomes.</p></li>
<li><p>Define the theoretical and empirical variogram, making appropriate use of equations.</p></li>
<li><p>How do we use the empirical variogram to test for spatial correlation? What are the limitations of this approach?</p></li>
<li><p>Define the class of generalized linear geostatistical models and list all the assumptions.</p></li>
<li><p>Explain intuitively what are the computational challenges related to the fit of geostatistical models and what approaches can be used for parameter estimation.</p></li>
</ul></section><section id="exercises" class="level2" data-number="3.7"><h2 data-number="3.7" class="anchored" data-anchor-id="exercises">
<span class="header-section-number">3.7</span> Exercises</h2>
<ol type="1">
<li><p>Consider the Binomial mixed model with linear predictor as defined in <a href="#eq-linear-predictor-glmms-ch2" class="quarto-xref">Equation&nbsp;<span>3.7</span></a>. By editing the code for the simulation shown in <a href="#sec-overdispersion" class="quarto-xref"><span>Section 3.1.2</span></a>, generate a graph as in <a href="#fig-var-bin-glmm" class="quarto-xref">Figure&nbsp;<span>3.6</span></a> under the two following scenarios: <span class="math inline">\(i\)</span>) <span class="math inline">\(\tau^2 = 0.2\)</span> and <span class="math inline">\(n_i=100\)</span>; <span class="math inline">\(ii\)</span>) <span class="math inline">\(\tau^2 = 0.1\)</span> and <span class="math inline">\(n_i = 1\)</span>. How does the variance of <span class="math inline">\(Y_i\)</span> change under <span class="math inline">\(i\)</span>) and <span class="math inline">\(ii\)</span>) in comparison to <a href="#fig-var-bin-glmm" class="quarto-xref">Figure&nbsp;<span>3.6</span></a>? How do you explain the differences?</p></li>
<li><p>Similarly to the previous exercise, consider a Poisson mixed model with linear predictor <span class="math display">\[
    \log\left\{\mu_i\right\} = \beta_0 + Z_i,
    \]</span> where <span class="math inline">\(Z_i\)</span> are a set of mutually independent Gaussian variables with mean 0 and variance <span class="math inline">\(\tau^2\)</span>. Using the code shown in <a href="#sec-overdispersion" class="quarto-xref"><span>Section 3.1.2</span></a>, carry out a simulation study to compute the variance of <span class="math inline">\(Y_i\)</span> and generate a graph similar to <a href="#fig-var-bin-glmm" class="quarto-xref">Figure&nbsp;<span>3.6</span></a> to compare the variance of the Poisson mixed model with that of a standard Poisson model. Generate the graph for different values of <span class="math inline">\(\tau^2\)</span> and summarize your findings. NOTE: In this simulation the offset <span class="math inline">\(n_i\)</span> can be set to 1.</p></li>
<li><p>Create an R function that computes the <em>cloud variogram</em>. As explained in <a href="#sec-expl-spatial" class="quarto-xref"><span>Section 3.1.3</span></a>, the cloud variogram is obtained by plotting <span class="math inline">\(\hat{V}_{ij}\)</span> (see <a href="#eq-hat-squared-diff" class="quarto-xref">Equation&nbsp;<span>3.11</span></a>) against the distances <span class="math inline">\(u_{ij}\)</span>. The function should take as input a data-set with three columns: the variable for which the cloud variogram is to be computed; and two columns corresponding to the location of the data. Then, use this function to create the cloud variogram for the model for river-blindness in <a href="#eq-liberia-bin-mixed-elev" class="quarto-xref">Equation&nbsp;<span>3.13</span></a>. How does this compare to empirical variogram that takes the averages within predefined distance classes, as shown in <a href="#fig-liberia-variog" class="quarto-xref">Figure&nbsp;<span>3.7</span></a>?</p></li>
<li><p>Fit a Binomial mixed model to the Liberia data-set on river-blindness without any covariates, i.e.&nbsp;<span class="math display">\[
    \log\left\{\frac{p(x_i)}{1-p(x_i)}\right\} = \beta_0 + Z_i.
    \]</span> Making use of the R code presented in <a href="#sec-empirical-variog-bin" class="quarto-xref"><span>Section 3.1.3.1</span></a>, use the function <code>s_variogram</code> to generate the empirical variogram for this model and compare this to the empirical variogram of <a href="#fig-liberia-variog" class="quarto-xref">Figure&nbsp;<span>3.7</span></a>. What differences do you observe?</p></li>
<li><p>Fit a Poisson mixed model to the anopheles mosquito data using elevation as a covariate, i.e.&nbsp;<span class="math display">\[
    \log\{\mu(x_i)\} = \beta_{0} + \beta_{1} d(x_i) + Z_i
    \]</span> where <span class="math inline">\(d(x_i)\)</span> is the measured elevation at location <span class="math inline">\(x_i\)</span>. How strong is the overdispersion in the data? After fitting the model, extract the estimates of the random effects <span class="math inline">\(Z_i\)</span> and compute the empirical variogram with the 95% envelope for spatial independence. Repeat this for different classes of distances by changing the input passed to <code>bins</code> in the <code>s_variogram</code> function. How do the different specifications of <code>bins</code> affect the results?</p></li>
<li><p><em>Parametric bootstrap.</em> Using the model fitted to the Anopheles gambiae mosquitoes in <a href="#sec-anopheles-fit" class="quarto-xref"><span>Section 3.3.2</span></a>, simulate 1000 data-sets using the <code>glgpm_sim</code> function and estimate the model to each of the simulated data-set. Use the resulting 1000 estimates to compute 95<span class="math inline">\(\%\)</span> confidence intervals for each of the model parameters and compare this with the confidence intervals obtained from the model summary.</p></li>
</ol>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-amazigo2008" class="csl-entry" role="listitem">
Amazigo, U. 2008. <span>“The African Programme for Onchocerciasis Control (APOC).”</span> <em>Ann Trop Med Parasitol</em> 102 (Suppl 1): 19–22. <a href="https://doi.org/10.1179/136485908X337436">https://doi.org/10.1179/136485908X337436</a>.
</div>
<div id="ref-bates2015" class="csl-entry" role="listitem">
Bates, Douglas, Martin Mächler, Ben Bolker, and Steve Walker. 2015. <span>“Fitting Linear Mixed-Effects Models Using <span class="nocase">lme4</span>.”</span> <em>Journal of Statistical Software</em> 67 (1): 1–48. <a href="https://doi.org/10.18637/jss.v067.i01">https://doi.org/10.18637/jss.v067.i01</a>.
</div>
<div id="ref-bhattachan2023drought" class="csl-entry" role="listitem">
Bhattachan, Abhinav, Rachel Barrios, Laura Harrington, Valerie A. Paz-Soldan, and A. Marm Kilpatrick. 2023. <span>“Drought-Associated Reductions in Urban Mosquito Abundance During California’s Historic Drought.”</span> <em>Science of The Total Environment</em> 891: 164519. <a href="https://doi.org/10.1016/j.scitotenv.2023.164519">https://doi.org/10.1016/j.scitotenv.2023.164519</a>.
</div>
<div id="ref-bishop2006" class="csl-entry" role="listitem">
Bishop, Christopher M. 2006. <em>Pattern Recognition and Machine Learning</em>. Springer.
</div>
<div id="ref-bolin2023" class="csl-entry" role="listitem">
Bolin, David, and Jonas Wallin. 2023. <span>“<span class="nocase">Local scale invariance and robustness of proper scoring rules</span>.”</span> <em>Statistical Science</em> 38 (1): 140–59. <a href="https://doi.org/10.1214/22-STS864">https://doi.org/10.1214/22-STS864</a>.
</div>
<div id="ref-bolling2009vi" class="csl-entry" role="listitem">
Bolling, Bethany G., Christopher M. Barker, Chester G. Moore, W. John Pape, and Lars Eisen. 2009. <span>“Seasonal Patterns for Entomological Measures of Risk for Exposure to <em>Culex</em> Vectors and West Nile Virus in Relation to Human Disease Cases in Northeastern Colorado.”</span> <em>Journal of Medical Entomology</em> 46 (6): 1519–31. <a href="https://doi.org/10.1603/033.046.0641">https://doi.org/10.1603/033.046.0641</a>.
</div>
<div id="ref-bowman1997" class="csl-entry" role="listitem">
Bowman, A. W. 1997. <em>Applied Smoothing Techniques for Data Analysis : The Kernel Approach with s-Plus Illustrations</em>. Oxford Statistical Science Series ; 18. Oxford : New York: Clarendon Press ; Oxford University Press.
</div>
<div id="ref-breslow1993" class="csl-entry" role="listitem">
Breslow, N. E., and D. G. Clayton. 1993. <span>“Approximate Inference in Generalized Linear Mixed Models.”</span> <em>Journal of the American Statistical Association</em> 88: 9–25.
</div>
<div id="ref-brooks2011handbook" class="csl-entry" role="listitem">
Brooks, Steve, Andrew Gelman, Galin L. Jones, and Xiao-Li Meng. 2011. <em>Handbook of Markov Chain Monte Carlo</em>. CRC Press.
</div>
<div id="ref-cdph2025response" class="csl-entry" role="listitem">
California Department of Public Health. 2025. <span>“California Mosquito-Borne Virus Surveillance and Response Plan.”</span> Online.
</div>
<div id="ref-cdc_wnv_guidelines_2024" class="csl-entry" role="listitem">
Centers for Disease Control and Prevention. 2024. <span>“West Nile Virus Surveillance and Control Guidelines.”</span> CDC guidance. <a href="https://www.cdc.gov/west-nile-virus/php/surveillance-and-control-guidelines/index.html">https://www.cdc.gov/west-nile-virus/php/surveillance-and-control-guidelines/index.html</a>.
</div>
<div id="ref-chilesdelfiner2016" class="csl-entry" role="listitem">
Chilès, J-P, and P. Delfiner. 2016. <em>Geostatistics (Second Edition)</em>. Hoboken: Wiley.
</div>
<div id="ref-christensen2006" class="csl-entry" role="listitem">
Christensen, OF, GO Roberts, and M Sköld. 2006. <span>“Robust Markov Chain Monte Carlo Methods for Spatial Generalized Linear Mixed Models.”</span> <em>Journal of Computational and Graphical Statistics</em> 15 (1): 1–17.
</div>
<div id="ref-christensen2004" class="csl-entry" role="listitem">
Christensen, Ole F. 2004. <span>“Monte Carlo Maximum Likelihood in Model-Based Geostatistics.”</span> <em>Journal of Computational and Graphical Statistics</em> 13 (3): 702–18.
</div>
<div id="ref-cityofboulder_wnv_vectorindex_2025" class="csl-entry" role="listitem">
City of Boulder. 2025. <span>“West Nile Virus — Estimating Risk to People: The Vector Index.”</span> <a href="https://bouldercolorado.gov/west-nile-virus">https://bouldercolorado.gov/west-nile-virus</a>.
</div>
<div id="ref-fortcollins_wnv_program_manual_2014" class="csl-entry" role="listitem">
City of Fort Collins. 2014. <span>“West Nile Virus Program Manual.”</span> City of Fort Collins. <a href="https://www.fcgov.com/westnile/pdf/wnv_program_manual.pdf">https://www.fcgov.com/westnile/pdf/wnv_program_manual.pdf</a>.
</div>
<div id="ref-fortcollins_localdata_vi_2025" class="csl-entry" role="listitem">
———. 2025. <span>“Local Data — West Nile Virus.”</span> <a href="https://www.fcgov.com/westnile/local-data">https://www.fcgov.com/westnile/local-data</a>.
</div>
<div id="ref-cowles1996markov" class="csl-entry" role="listitem">
Cowles, Mary Kathryn, and Bradley P. Carlin. 1996. <span>“Markov Chain Monte Carlo Convergence Diagnostics: A Comparative Review.”</span> <em>Journal of the American Statistical Association</em> 91 (434): 883–904.
</div>
<div id="ref-cressie1991" class="csl-entry" role="listitem">
Cressie, N. A. C. 1991. <em>Statistics for Spatial Data</em>. New York: Wiley.
</div>
<div id="ref-cressie1985" class="csl-entry" role="listitem">
Cressie, Noel. 1985. <span>“Fitting Variogram Models by Weighted Least Squares.”</span> <em>Mathematical Geology</em> 17 (5): 563–86.
</div>
<div id="ref-czado2009" class="csl-entry" role="listitem">
Czado, Claudia, Tilmann Gneiting, and Leonhard Held. 2009. <span>“<span class="nocase">Predictive Model Assessment for Count Data</span>.”</span> <em>Biometrics</em> 65 (4): 1254–61. <a href="https://doi.org/10.1111/j.1541-0420.2009.01191.x">https://doi.org/10.1111/j.1541-0420.2009.01191.x</a>.
</div>
<div id="ref-dawid1984" class="csl-entry" role="listitem">
Dawid, A. P. 1984. <span>“Statistical Theory: The Prequential Approach.”</span> <em>Journal of the Royal Statistical Society: Series A (General)</em> 147 (2): 278–92.
</div>
<div id="ref-diggleBook2019" class="csl-entry" role="listitem">
Diggle, P J, and E Giorgi. 2019. <em>Model-Based Geostatistics for Global Public Health : Methods and Applications.</em> Chapman and Hall/CRC Interdisciplinary Statistics Ser. Milton: Chapman; Hall/CRC.
</div>
<div id="ref-diggle1998" class="csl-entry" role="listitem">
Diggle, P. J., J. A. Tawn, and R. A. Moyeed. 1998. <span>“Model-Based Geostatistics.”</span> <em>Journal of the Royal Statistical Society: Series C (Applied Statistics)</em> 47 (3): 299–350. <a href="https://doi.org/10.1111/1467-9876.00113">https://doi.org/10.1111/1467-9876.00113</a>.
</div>
<div id="ref-diggle2007book" class="csl-entry" role="listitem">
Diggle, Peter, and Paulo Justiniano Ribeiro. 2007. <em>Model-Based Geostatistics</em>. Springer Series in Statistics. Springer.
</div>
<div id="ref-dobson2008" class="csl-entry" role="listitem">
Dobson, A. J., and A. Barnett. 2008. <em>An Introduction to Generalized Linear Models</em>. Third. Chapman; Hall/CRC.
</div>
<div id="ref-efron1979" class="csl-entry" role="listitem">
Efron, Bradley. 1979. <span>“Bootstrap Methods: Another Look at the Jackknife.”</span> <em>The Annals of Statistics</em> 7 (1): 1–26.
</div>
<div id="ref-evans2021" class="csl-entry" role="listitem">
Evans, Jeffrey S., and Melanie A. Murphy. 2021. <em>spatialEco</em>. <a href="https://github.com/jeffreyevans/spatialEco">https://github.com/jeffreyevans/spatialEco</a>.
</div>
<div id="ref-fernandez2000" class="csl-entry" role="listitem">
Fernández, J. A, A Rey, and A Carballeira. 2000. <span>“An Extended Study of Heavy Metal Deposition in Galicia (NW Spain) Based on Moss Analysis.”</span> <em>Science of The Total Environment</em> 254 (1): 31–44. <a href="https://doi.org/10.1016/S0048-9697(00)00431-9">https://doi.org/10.1016/S0048-9697(00)00431-9</a>.
</div>
<div id="ref-gelman2013bayesian" class="csl-entry" role="listitem">
Gelman, Andrew, John B. Carlin, Hal S. Stern, David B. Dunson, Aki Vehtari, and Donald B. Rubin. 2013. <em>Bayesian Data Analysis</em>. 3rd ed. CRC Press.
</div>
<div id="ref-gelman1992inference" class="csl-entry" role="listitem">
Gelman, Andrew, and Donald B Rubin. 1992. <span>“Inference from Iterative Simulation Using Multiple Sequences.”</span> <em>Statistical Science</em> 7 (4): 457–72.
</div>
<div id="ref-geweke1992evaluating" class="csl-entry" role="listitem">
Geweke, John. 1992. <span>“Evaluating the Accuracy of Sampling‐based Approaches to the Calculation of Posterior Moments.”</span> Edited by Jose M. Bernardo, James O. Berger, A. Philip Dawid, and Adrian F. M. Smith, 169–93.
</div>
<div id="ref-geyer1991" class="csl-entry" role="listitem">
Geyer, Charles J. 1991. <span>“Markov Chain Monte Carlo Maximum Likelihood.”</span> <em>Journal of Computational and Graphical Statistics</em> 1 (4): 39–55.
</div>
<div id="ref-geyer1994" class="csl-entry" role="listitem">
Geyer, Charles J. 1994. <span>“Likelihood and Exponential Families.”</span> <em>Department of Statistics, University of Minnesota</em>.
</div>
<div id="ref-geyer1996" class="csl-entry" role="listitem">
———. 1996. <span>“Markov Chain Monte Carlo Maximum Likelihood.”</span> <em>Department of Statistics, University of Minnesota</em>.
</div>
<div id="ref-geyer2019handbook" class="csl-entry" role="listitem">
———. 2019. <span>“Monte Carlo Methods in MCMC.”</span> In <em>Handbook of MCMC</em>, edited by Steve Brooks, Andrew Gelman, Galin L. Jones, and Xiao-Li Meng, 3–48. CRC Press.
</div>
<div id="ref-ghanaDHS2014" class="csl-entry" role="listitem">
Ghana Statistical Service, Ghana Health Service, and ICF International. 2015. <em>Ghana Demographic and Health Survey 2014</em>. Rockville, Maryland, USA: Ghana Statistical Service, Ghana Health Service,; ICF International. <a href="https://dhsprogram.com/publications/publication-FR307-DHS-Final-Reports.cfm">https://dhsprogram.com/publications/publication-FR307-DHS-Final-Reports.cfm</a>.
</div>
<div id="ref-gneiting2007" class="csl-entry" role="listitem">
Gneiting, Tilmann, Fadoua Balabdaoui, and Adrian E Raftery. 2007. <span>“Probabilistic Forecasts, Calibration and Sharpness.”</span> <em>Journal of the Royal Statistical Society: Series B (Statistical Methodology)</em> 69 (2): 243–68.
</div>
<div id="ref-gneiting2007jasa" class="csl-entry" role="listitem">
Gneiting, Tilmann, and Adrian E Raftery. 2007. <span>“Strictly Proper Scoring Rules, Prediction, and Estimation.”</span> <em>Journal of the American Statistical Association</em> 102 (477): 359–78. <a href="https://doi.org/10.1198/016214506000001437">https://doi.org/10.1198/016214506000001437</a>.
</div>
<div id="ref-harrell2015" class="csl-entry" role="listitem">
Harrell, Frank E. 2015. <em>Regression Modeling Strategies</em>. 2nd ed. New York: Springer.
</div>
<div id="ref-hastie2001" class="csl-entry" role="listitem">
Hastie, Trevor, Robert Tibshirani, and Jerome Friedman. 2001. <em>The Elements of Statistical Learning</em>. Springer Series in Statistics. New York, NY, USA: Springer New York Inc.
</div>
<div id="ref-hastings1970monte" class="csl-entry" role="listitem">
Hastings, W. K. 1970. <span>“Monte Carlo Sampling Methods Using Markov Chains and Their Applications.”</span> <em>Biometrika</em> 57 (1): 97–109.
</div>
<div id="ref-johnson2021" class="csl-entry" role="listitem">
Johnson, Olatunji, Claudio Fronterre, Benjamin Amoah, Antonio Montresor, Emanuele Giorgi, Nicholas Midzi, Masceline Jenipher Mutsaka-Makuvaza, et al. 2021. <span>“Model-Based Geostatistical Methods Enable Efficient Design and Analysis of Prevalence Surveys for Soil-Transmitted Helminth Infection and Other Neglected Tropical Diseases.”</span> <em>Clinical Infectious Diseases</em> 72 (Supplement_3): S172–79. <a href="https://doi.org/10.1093/cid/ciab192">https://doi.org/10.1093/cid/ciab192</a>.
</div>
<div id="ref-jones2011vi" class="csl-entry" role="listitem">
Jones, Roderick C., Kingsley N. Weaver, Shamika Smith, Claudia Blanco, Cristina Flores, Kevin Gibbs, Daniel Markowski, and John-Paul Mutebi. 2011. <span>“Use of the Vector Index and Geographic Information System to Prospectively Inform West Nile Virus Interventions.”</span> <em>Journal of the American Mosquito Control Association</em> 27 (3): 315–19. <a href="https://doi.org/10.2987/10-6098.1">https://doi.org/10.2987/10-6098.1</a>.
</div>
<div id="ref-gates2020" class="csl-entry" role="listitem">
Katz, Elizabeth, and Bill &amp; Melinda Gates Foundation. 2020. <span>“Gender and Malaria Evidence Reivew.”</span> Bill &amp; Melinda Gates Foundation. <a href="https://www.gatesgenderequalitytoolbox.org/wp-content/uploads/BMGF_Malaria-Review_FC.pdf">https://www.gatesgenderequalitytoolbox.org/wp-content/uploads/BMGF_Malaria-Review_FC.pdf</a>.
</div>
<div id="ref-kilpatrick2013predicting" class="csl-entry" role="listitem">
Kilpatrick, A. Marm, and W. John Pape. 2013. <span>“Predicting Human West Nile Virus Infections with Mosquito Surveillance Data.”</span> <em>American Journal of Epidemiology</em> 178 (5): 829–35. <a href="https://doi.org/10.1093/aje/kwt046">https://doi.org/10.1093/aje/kwt046</a>.
</div>
<div id="ref-kramer2007wnv" class="csl-entry" role="listitem">
Kramer, Laura D., Jun Li, and Pei-Yong Shi. 2007. <span>“West Nile Virus.”</span> <em>The Lancet Neurology</em> 6 (2): 171–81. <a href="https://doi.org/10.1016/S1474-4422(07)70030-3">https://doi.org/10.1016/S1474-4422(07)70030-3</a>.
</div>
<div id="ref-krige1951" class="csl-entry" role="listitem">
Krige, D. G. 1951. <span>“A Statistical Approach to Some Basic Mine Valuation Problems on the Witwatersrand.”</span> <em>Journal of the Chemical, Metallurgical and Mining Society of South Africa</em> 52: 119–39.
</div>
<div id="ref-kyomuhangi2021" class="csl-entry" role="listitem">
Kyomuhangi, Irene, Tarekegn A. Abeku, Matthew J. Kirby, Gezahegn Tesfaye, and Emanuele Giorgi. 2021. <span>“Understanding the Effects of Dichotomization of Continuous Outcomes on Geostatistical Inference.”</span> <em>Spatial Statistics</em> 42: 100424. https://doi.org/<a href="https://doi.org/10.1016/j.spasta.2020.100424">https://doi.org/10.1016/j.spasta.2020.100424</a>.
</div>
<div id="ref-Lovelace2020-iq" class="csl-entry" role="listitem">
Lovelace, Robin, Jakub Nowosad, and Jannes Muenchow. 2020. <em>Geocomputation with <span>R</span></em>. London, England: CRC Press. <a href="https://r.geocompx.org/">https://r.geocompx.org/</a>.
</div>
<div id="ref-malariaAtlas" class="csl-entry" role="listitem">
Lucas, Tim C. D., Anita K. Nandi, Rosalind E. Howes, Daniel J. Weiss, Ewan Cameron, Nick Golding, and Peter W. Gething. 2020. <span>“malariaAtlas: An r Interface to Global Malariometric Data Hosted by the Malaria Atlas Project.”</span> <em>Wellcome Open Research</em> 5: 74. <a href="https://doi.org/10.12688/wellcomeopenres.15987.1">https://doi.org/10.12688/wellcomeopenres.15987.1</a>.
</div>
<div id="ref-mahoney2023" class="csl-entry" role="listitem">
Mahoney, Michael J, Lucas K Johnson, Julia Silge, Hannah Frick, Max Kuhn, and Colin M Beier. 2023. <span>“Assessing the Performance of Spatial Cross-Validation Approaches for Models of Spatially Structured Data.”</span> <a href="https://doi.org/10.48550/arXiv.2303.07334">https://doi.org/10.48550/arXiv.2303.07334</a>.
</div>
<div id="ref-matern2013" class="csl-entry" role="listitem">
Matern, B. 2013. <em>Spatial Variation</em>. Lecture Notes in Statistics. Springer New York. <a href="https://books.google.co.uk/books?id=HrbSBwAAQBAJ">https://books.google.co.uk/books?id=HrbSBwAAQBAJ</a>.
</div>
<div id="ref-matheron1963" class="csl-entry" role="listitem">
Matheron, G. 1963. <span>“Principles of Geostatistics.”</span> <em>Economic Geology</em> 58: 1246–66.
</div>
<div id="ref-metropolis1953equation" class="csl-entry" role="listitem">
Metropolis, Nicholas, Arianna W. Rosenbluth, Marshall N. Rosenbluth, Augusta H. Teller, and Edward Teller. 1953. <span>“Equation of State Calculations by Fast Computing Machines.”</span> <em>The Journal of Chemical Physics</em> 21 (6): 1087–92.
</div>
<div id="ref-neal2003" class="csl-entry" role="listitem">
Neal, Radford M. 2003. <span>“Slice Sampling.”</span> <em>The Annals of Statistics</em> 31 (3): 705–67.
</div>
<div id="ref-nelder1972" class="csl-entry" role="listitem">
Nelder, J. A., and R. W. M. Wedderburn. 1972. <span>“Generalized Linear Models.”</span> <em>Journal of the Royal Statistical Society A</em> 135: 370–84.
</div>
<div id="ref-who_underweight2024" class="csl-entry" role="listitem">
Organization, World Health. 2024. <span>“Indicator Metadata Registry: Child Malnutrition—Underweight Among Children Under Five Years of Age (Weight-for-Age &lt;-2 SD).”</span> <a href="https://www.who.int/data/gho/indicator-metadata-registry/imr-details/27" class="uri">https://www.who.int/data/gho/indicator-metadata-registry/imr-details/27</a>.
</div>
<div id="ref-pawitan2001" class="csl-entry" role="listitem">
Pawitan, Yudi. 2001. <em>In All Likelihood : Statistical Modelling and Inference Using Likelihood</em>. Oxford ; New York: Clarendon Press : Oxford University Press.
</div>
<div id="ref-petersen2013wnv" class="csl-entry" role="listitem">
Petersen, Lyle R., Aaron C. Brault, and Roger S. Nasci. 2013. <span>“West Nile Virus: Review of the Literature.”</span> <em>JAMA</em> 310 (3): 308–15. <a href="https://doi.org/10.1001/jama.2013.8042">https://doi.org/10.1001/jama.2013.8042</a>.
</div>
<div id="ref-puranik2024" class="csl-entry" role="listitem">
Puranik, Amitha, Peter J. Diggle, Maurice R. Odiere, Katherine Gass, Stella Kepha, Collins Okoyo, Charles Mwandawiro, et al. 2024. <span>“Understanding the Impact of Covariates on the Classification of Implementation Units for Soil-Transmitted Helminths Control: A Case Study from Kenya.”</span> <em>BMC Medical Research Methodology</em> 24 (1): 294. <a href="https://doi.org/10.1186/s12874-024-02420-1">https://doi.org/10.1186/s12874-024-02420-1</a>.
</div>
<div id="ref-ripley1981" class="csl-entry" role="listitem">
Ripley, B. D. 1981. <em>Spatial Statistics</em>. New York: Wiley.
</div>
<div id="ref-robert2004" class="csl-entry" role="listitem">
Robert, Christian P, and George Casella. 2004. <em>Monte Carlo Statistical Methods</em>. 2nd ed. Springer.
</div>
<div id="ref-roberts1996exponential" class="csl-entry" role="listitem">
Roberts, Gareth O., and Richard L. Tweedie. 1996. <span>“Exponential Convergence of Langevin Distributions and Their Discrete Approximations.”</span> <em>Bernoulli</em> 2 (4): 341–63.
</div>
<div id="ref-ross2013" class="csl-entry" role="listitem">
Ross, Sheldon. 2013. <em>First Course in Probability, a.</em> 9th ed. Harlow: Pearson Education UK.
</div>
<div id="ref-rossky1978brownian" class="csl-entry" role="listitem">
Rossky, Peter J., J. D. Doll, and Harold L. Friedman. 1978. <span>“Brownian Dynamics as Smart Monte Carlo Simulation.”</span> <em>The Journal of Chemical Physics</em> 69 (10): 4628–33.
</div>
<div id="ref-rue2009" class="csl-entry" role="listitem">
Rue, H., S. Martino, and N. Chopin. 2009. <span>“Approximate Bayesian Inference for Latent Gaussian Models by Using Integrated Nested Laplace Approximations.”</span> <em>Journal of the Royal Statistical Society: Series B (Statistical Methodology)</em> 71 (2): 319–92. <a href="https://doi.org/10.1111/j.1467-9868.2008.00700.x">https://doi.org/10.1111/j.1467-9868.2008.00700.x</a>.
</div>
<div id="ref-sacramento2018annual" class="csl-entry" role="listitem">
Sacramento-Yolo Mosquito and Vector Control District. 2018. <span>“2018 Annual Report.”</span> Online.
</div>
<div id="ref-shmueli2010" class="csl-entry" role="listitem">
Shmueli, Galit. 2010. <span>“To Explain or to Predict?”</span> <em>Statistical Science</em> 25 (3): 289–310.
</div>
<div id="ref-smith2007" class="csl-entry" role="listitem">
Smith, David L, Carlos A Guerra, Robert W Snow, and Simon I Hay. 2007. <span>“Standardizing Estimates of the Plasmodium Falciparum Parasite Rate.”</span> <em>Malaria Journal</em> 6 (1): 131–31.
</div>
<div id="ref-stein1999" class="csl-entry" role="listitem">
Stein, Michael L. 1999. <em>Interpolation of Spatial Data Some Theory for Kriging</em>. 1st ed. 1999. Springer Series in Statistics. New York, NY: Springer New York : Imprint: Springer.
</div>
<div id="ref-stevenson2013" class="csl-entry" role="listitem">
Stevenson, Gillian H. AND Gitonga, Jennifer C. AND Stresman. 2013. <span>“Reliability of School Surveys in Estimating Geographic Variation in Malaria Transmission in the Western Kenyan Highlands.”</span> <em>PLOS ONE</em> 8 (10). <a href="https://doi.org/10.1371/journal.pone.0077641">https://doi.org/10.1371/journal.pone.0077641</a>.
</div>
<div id="ref-fossog2015" class="csl-entry" role="listitem">
Tene Fossog, Billy, Diego Ayala, Pelayo Acevedo, Pierre Kengne, Ignacio Ngomo Abeso Mebuy, Boris Makanga, Julie Magnus, et al. 2015. <span>“Habitat Segregation and Ecological Character Displacement in Cryptic African Malaria Mosquitoes.”</span> <em>Evolutionary Applications</em> 8 (4): 326–45. <a href="https://doi.org/10.1111/eva.12242">https://doi.org/10.1111/eva.12242</a>.
</div>
<div id="ref-tobler1970" class="csl-entry" role="listitem">
Tobler, W. R. 1970. <span>“A Computer Movie Simulating Urban Growth in the Detroit Region.”</span> <em>Economic Geography</em> 46: 234–40.
</div>
<div id="ref-sdg2201meta2025" class="csl-entry" role="listitem">
United Nations Statistics Division, World Health Organization, and UNICEF. 2025. <span>“SDG Indicator 2.2.1 Metadata: Prevalence of Stunting (Height-for-Age &lt;-2 SD) Among Children Under Five Years of Age.”</span> <a href="https://unstats.un.org/sdgs/metadata/files/Metadata-02-02-01.pdf" class="uri">https://unstats.un.org/sdgs/metadata/files/Metadata-02-02-01.pdf</a>.
</div>
<div id="ref-watson1971" class="csl-entry" role="listitem">
Watson, G. S. 1971. <span>“Trend -Surface Analysis.”</span> <em>Mathematical Geology</em> 3: 215–26.
</div>
<div id="ref-watson1972" class="csl-entry" role="listitem">
———. 1972. <span>“Trend Surface Analysis and Spatial Correlation.”</span> <em>Geological Society of America Special Paper</em> 146: 39–46.
</div>
<div id="ref-weisberg2014" class="csl-entry" role="listitem">
Weisberg, Sanford. 2014. <em>Applied Linear Regression</em>. Fourth. Hoboken <span>NJ</span>: Wiley. <a href="http://z.umn.edu/alr4ed">http://z.umn.edu/alr4ed</a>.
</div>
<div id="ref-who2006" class="csl-entry" role="listitem">
WHO. 2006. <span>“WHO Child Growth Standards: Length/Height-for-Age, Weight-for-Age, Weight-for-Length, Weight-for-Height and Body Mass Index-for-Age: Methods and Development.”</span> Geneva: WHO. <a href="https://www.who.int/publications/i/item/924154693X">https://www.who.int/publications/i/item/924154693X</a>.
</div>
<div id="ref-yin2024" class="csl-entry" role="listitem">
Yin, Hui, Yutong Wang, Yuxin Wang, Zihan Li, Yujie Li, and Yuxin Wang. 2024. <span>“A Rapid Review of Clustering Algorithms.”</span> <em>arXiv Preprint arXiv:2401.07389</em>.
</div>
<div id="ref-zhang2002" class="csl-entry" role="listitem">
Zhang, Hao. 2002. <span>“On Estimation and Prediction for Spatial Generalized Linear Mixed Models.”</span> <em>Biometrics</em> 58 (1): 129–36.
</div>
<div id="ref-zhang2004" class="csl-entry" role="listitem">
———. 2004. <span>“Inconsistent Estimation and Asymptotically Equal Interpolations in Model-Based Geostatistics.”</span> <em>Journal of the American Statistical Association</em> 99 (465): 250–61.
</div>
<div id="ref-zoure2014" class="csl-entry" role="listitem">
Zouré, Honorat GM, Mounkaila Noma, Afework H Tekle, Uche V Amazigo, Peter J Diggle, Emanuele Giorgi, and Jan HF Remme. 2014. <span>“Geographic Distribution of Onchocerciasis in the 20 Participating Countries of the African Programme for Onchocerciasis Control: (2) Pre-Control Endemicity Levels and Estimated Number Infected.”</span> <em>Parasites &amp; Vectors</em> 7 (1): 326–26.
</div>
</div>
</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>The letter <span class="math inline">\(e\)</span> stands for the so called Euler’s number and represents the base of the natural logarithm. In the book, we write <span class="math inline">\(\log(\cdot)\)</span> to mean the “natural logarithm of <span class="math inline">\(\cdot\)</span>”.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./02_handling-spatial-data.html" class="pagination-link" aria-label="Handling of spatial data in R">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Handling of spatial data in R</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./04_geostatistical-prediction.html" class="pagination-link" aria-label="Geostatistical prediction">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Geostatistical prediction</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>