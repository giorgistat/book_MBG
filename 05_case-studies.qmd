---
filters:
  - line-highlight
execute: 
  freeze: auto
fig-width: 5
fig-asp: 0.75
---

```{r, eval=TRUE, echo=FALSE,message=FALSE}
waz_fit <- readRDS("data/waz_fit.rds")
haz_fit <- readRDS("data/haz_fit.rds")
stunting_prev <- readRDS("data/stuntin_prev.rds")
underw_prev <- readRDS("data/underw_prev.rds")
assess_haz <- readRDS("data/assess_haz.rds")
assess_waz <- readRDS("data/assess_waz.rds")
```
# Case studies {#sec-case-studies}

## Mapping stunting and underwieght risk in Ghana

Malnutrition remains a critical public health issue in many low- and middle-income countries, particularly affecting children under five years of age. It can have long-term consequences on physical growth, cognitive development, and susceptibility to disease. Monitoring childhood nutritional status is essential for evaluating the effectiveness of health interventions and informing policy decisions.

Two widely used anthropometric indicators derived from child growth measurements are:

- Height-for-Age Z-score (HAZ): A measure of stunting, which reflects chronic malnutrition. Children with a HAZ below -2 standard deviations from the WHO growth reference median are considered stunted, indicating long-term nutritional deprivation or repeated infections.

- Weight-for-Age Z-score (WAZ): A composite indicator of underweight, capturing both acute and chronic malnutrition. Children with WAZ below -2 are considered underweight. This measure is commonly used in population-based surveys because it is relatively easy to collect and interpret.

These Z-scores are calculated by comparing individual anthropometric measurements to the WHO Child Growth Standards, which were developed based on data from healthy children under optimal environmental and nutritional conditions [@who2006].

Geostatistical models applied to HAZ and WAZ, or to the prevalence of stunting and underweight derived from these scores, can help answer critical questions such as: *Where is the burden of malnutrition highest? How does it relate to socioeconomic or environmental factors? And which areas should be prioritized for targeted nutritional interventions?*

In this case study, we analyse HAZ and WAZ as continuous outcomes to assess the spatial variation in child malnutrition across Ghana and its association with socioeconomic and demographic covariates.

### Exploratory analysis

We begin by loading the necessary R packages and the `malnutrition` dataset. This geostatistical dataset is derived from the 2014 Ghana Demographic and Health Survey (DHS) [@ghanaDHS2014], which provides nationally representative data on child health and nutrition. The dataset includes anthropometric measurements, household characteristics, and georeferenced sampling cluster coordinates, making it suitable for spatial analysis of child malnutrition.
```{r}
# Load packages
library(RiskMap)
library(ggplot2)
library(dplyr)
library(patchwork)

# Load the data
data(malnutrition)
```

The explanatory variables considered in this analysis are `age` and `wealth`. Figure @fig-maln-expl displays scatterplots of the two nutritional outcomes (`HAZ` and `WAZ`) against age, alongside boxplots stratified by the three levels of the `wealth` variable.

To explore the relationship between age and nutritional status, the code below applies locally estimated scatterplot smoothing (LOESS) to highlight potential non-linear trends. In addition, we fit linear splines using the function `pmax()` to model a change in slope at specified knotsâ€”2 months for HAZ and 1 month for WAZ. These change points were selected heuristically based on visual inspection of the LOESS curves.

As shown in Figure @fig-maln-expl, the linear splines (green dashed lines) closely follow the LOESS fits (solid red lines), indicating that the piecewise linear models provide an adequate approximation of the age-nutrition relationship.


```{r}
#| label: fig-maln-expl
#| fig-cap: "Exploratory analysis of HAZ and WAZ by age and wealth. The red lines correspond to LOESS smoothed curves and the green lines to linear splines with change points at 2 months (HAZ) and 1 month (WAZ) of age. Boxplots show variation by household wealth group."  

# Filter complete cases for relevant variables
mal <- malnutrition %>%
  filter(!is.na(HAZ), !is.na(WAZ), !is.na(age), !is.na(wealth))

# Fit spline model for HAZ with knot at 2 months
mod_haz <- lm(HAZ ~ age + pmax(age - 2, 0), data = mal)

# Fit spline model for WAZ with knot at 1 month
mod_waz <- lm(WAZ ~ age + pmax(age - 1, 0), data = mal)

# Prediction grid for HAZ
newdat_haz <- data.frame(age = seq(min(mal$age), max(mal$age), length.out = 200)) 
newdat_haz$fit <- predict(mod_haz, newdata = newdat_haz)

# Prediction grid for WAZ
newdat_waz <- data.frame(age = seq(min(mal$age), max(mal$age), length.out = 200)) 
newdat_waz$fit <- predict(mod_waz, newdata = newdat_waz)

# Plot HAZ vs Age
p1 <- ggplot(mal, aes(x = age, y = HAZ)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "loess", colour = "red", se = FALSE) +
  geom_line(data = newdat_haz, aes(x = age, y = fit), 
            colour = "green", linetype = "dashed", linewidth = 1.2) +
  labs(title = "HAZ vs Age", x = "Age (months)", y = "HAZ") +
  theme_minimal()

# Plot WAZ vs Age
p2 <- ggplot(mal, aes(x = age, y = WAZ)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "loess", colour = "red", se = FALSE) +
  geom_line(data = newdat_waz, aes(x = age, y = fit), 
            colour = "green", linetype = "dashed", linewidth = 1.2) +
  labs(title = "WAZ vs Age", x = "Age (months)", y = "WAZ") +
  theme_minimal()

# Boxplots for HAZ and WAZ by wealth
p3 <- ggplot(mal, aes(x = factor(wealth), y = HAZ)) +
  geom_boxplot(fill = "lightblue") +
  labs(title = "HAZ by Wealth Group", x = "Wealth (1 = Poor, 3 = Rich)", y = "HAZ") +
  theme_minimal()

p4 <- ggplot(mal, aes(x = factor(wealth), y = WAZ)) +
  geom_boxplot(fill = "lightgreen") +
  labs(title = "WAZ by Wealth Group", x = "Wealth (1 = Poor, 3 = Rich)", y = "WAZ") +
  theme_minimal()

# Combine plots
(p1 | p2) / (p3 | p4)

```

We begin by fitting a non-spatial model to assess whether there is residual spatial correlation that remains after accounting for the effects of age and wealth. Let $Y_{ij}$ represent either the HAZ or WAZ score for the $j$-th child in the $i$-th cluster. The model takes the following form:

$$
Y_{ij} = \beta_0 + \beta_1 a_{ij} + \beta_2 \max\{a_{ij} - c, 0\} + \beta_3 w_i + Z_i + U_{ij},
$$ {#eq-model-haz-waz}

where $a_{ij}$ denotes the age in months of child $j$ in cluster $i$, and $w_i$ is the wealth score associated with cluster $i$; as previously stated, the change point $c$ of the linear spline is set to 2 months for HAZ and 1 month for WAZ. The term $Z_i$ is a Gaussian random effect with mean zero and variance $\tau^2$, capturing between-cluster variation not explained by the covariates. The error term $U_{ij}$ represents child-specific residual variation and is assumed to be Gaussian with mean zero and variance $\omega^2$.

To fit this model, we create a cluster ID variable based on the sampling coordinates and include it as a random intercept in the `lmer` function to incorporate the term $Z_i$.
```{r}
# Create ID for the location
malnutrition <- malnutrition %>%
  group_by(lng, lat) %>%
  mutate(loc_id = cur_group_id()) %>%
  ungroup()
```

We then fit the models using the `lmer` function.
```{r}
library(lme4)
haz_lmer <- 
lmer(HAZ ~ age + pmax(age - 2, 0) + wealth + (1 | loc_id), data = malnutrition)

summary(haz_lmer)

waz_lmer <- 
  lmer(WAZ ~ age + pmax(age - 1, 0) + wealth + (1 | loc_id), data = malnutrition)
summary(waz_lmer)
```
Of particular interest in the summary of the fitted models above are the estimates of the variances associated with the random effects: $\tau^2$ for the cluster-level terms $Z_i$, and $\omega^2$ for the child-specific residuals $U_{ij}$. The estimates suggest that $\omega^2$ is more than twenty times larger than $\tau^2$, indicating that the majority of the unexplained variation occurs at the individual child level rather than between clusters. This has important implications for interpretation: any subsequent mapping of the prevalence of stunting or underweight should acknowledge the high degree of within-cluster variability as a limitation. In particular, predictions at unsampled locations may be subject to substantial uncertainty driven by this fine-scale heterogeneity.


### Assessing residual spatial correlation and model fitting

We next explore the residual spatial correlation through the empirical variogram. Hence, we extract the estimate of the random effects from @eq-model-haz-waz and input these into the `s_variogram` function that generates the empirical variogram.

```{r}
#| label: fig-maln-vari
#| fig-cap: "Empirical variograms for HAZ and WAZ based on the estimated random effects from @eq-model-haz-waz."  
#| 
# Extract random effects for HAZ and WAZ and combine them
re <- data.frame(
  loc_id = as.numeric(rownames(ranef(haz_lmer)$loc_id)),
  Z_hat_haz = ranef(haz_lmer)$loc_id[,1],
  Z_hat_waz = ranef(waz_lmer)$loc_id[,1]
)

# Extract one row per location with coordinates
loc_coords <- malnutrition %>%
  select(loc_id, lng, lat) %>%
  distinct()

# Merge coordinates into random effects
re <- left_join(re, loc_coords, by = "loc_id")

# Convert to sf and transform into UTM
library(sf)
re <- st_as_sf(re, coords = c("lng","lat"), crs = 4326)
re <- st_transform(re, crs = propose_utm(re))

# Variogram for HAZ
var_haz <- s_variogram(re, "Z_hat_haz", scale_to_km = TRUE,
                       n_permutation = 1000)
var_waz <- s_variogram(re, "Z_hat_waz", scale_to_km = TRUE,
                       n_permutation = 1000)
library(patchwork)

# Create ggplot objects
p_haz <- plot_s_variogram(var_haz, plot_envelope = TRUE) + 
  ggtitle("HAZ")

p_waz <- plot_s_variogram(var_waz, plot_envelope = TRUE) + 
  ggtitle("WAZ")

p_haz + p_waz
```

@fig-maln-vari shows the variogram for both HAZ and WAZ. In both cases, we observe that is residual spatial correlation in the data that is not explained by either age or the wealth index. We next extend the model in @eq-model-haz-waz to address this issue.

For our geostatistical analysis of HAZ and WAZ, we consider the following model:

$$
Y_{ij} = \beta_0 + \beta_1 a_{ij} + \beta_2 \max\{a_{ij} - c, 0\} + \beta_3 w_i + S(x_i) + U_{ij},
$$ {#eq-model-haz-waz}

where $S(x)$ is a zero-mean, stationary, and isotropic Gaussian process with variance $\sigma^2$ and an exponential correlation function with scale parameter $\phi$. In this geostatistical extension, we replace the cluster-level random effect $Z_i$ from @eq-model-haz-waz with the spatial process $S(x_i)$. The random effect $Z_i$ was previously used in the Binomial mixed model to account for unexplained variation between clusters. It is also possible to include both $S(x_i)$ and $Z_i$ in the model, so that the total unexplained variation between clusters is decomposed into a spatially structured component, $S(x_i)$, and an unstructured component, $Z_i$. However, this approach is not recommended in the initial model specification, as it may lead to identifiability issues. It can be considered later in the analysis if justified by model diagnostics.

```{r, eval=FALSE}

# Remove missing data from the WAZ outcome
malnutrition <- malnutrition[complete.cases(malnutrition[,"WAZ"]),]

# Converting the data-frame into an sf object
malnutrition_sf <- st_as_sf(malnutrition, coords = c("lng", "lat"), crs = 4326)
malnutrition_sf <- st_transform(malnutrition_sf, crs = propose_utm(malnutrition_sf))

# Maximum likelihood estimation for the HAZ and WAZ outcomes
haz_fit <- 
glgpm(HAZ ~ age + pmax(age - 1, 0) + wealth + gp(),
      data=malnutrition_sf, family = "gaussian")

waz_fit <- 
  glgpm(HAZ ~ age + pmax(age - 1, 0) + wealth + gp(),
        data=malnutrition_sf, family = "gaussian") 
```
We then summarize the fit of models.
```{r}
summary(haz_fit)

summary(waz_fit)
```

The spatial component of the models reveals a moderate degree of spatial structure in the HAZ and WAZ outcomes. For HAZ, the estimated spatial variance is approximately 0.069, while the individual-level radom effect's variance is substantially larger at around 1.437. For WAZ, the spatial variance is estimated at 0.050, compared to the variance of the individual-level radom effect's variance of 1.125. In both models, as already observed when fitting Binomial mixed models, this indicates that the majority of the residual variation is due to individual-level noise or unstructured heterogeneity rather than spatially structured effects. The relative contribution of the spatial process to the total unexplained variation is therefore relatively small. Nevertheless, geostatistical analysis remains valuable also in this context. Even when spatial effects explain only a modest proportion of the variation, the model still enables spatial prediction of the average spatial pattern for the outcome of interest across the study area. This is useful for identifying areas where child malnutrition is systematically higher or lower, guiding targeted interventions and informing resource allocation. We explore these implications further in the next section on geostatistical prediction for HAZ and WAZ.

### Prediction and assessment of predictive performance

Stunting and underweight are standard indicators used to assess child malnutrition. A child is defined as \textit{stunted} if their height-for-age $z$-score (HAZ) is below $-2$ standard deviations from the median of the WHO Child Growth Standards, i.e., HAZ < -2. Similarly, a child is considered \textit{underweight} if their weight-for-age $z$-score (WAZ) falls below $-2$, i.e., WAZ < -2 [@sdg2201meta2025]. These thresholds are based on the World Health Organization (WHO) growth reference standards, which provide a normative basis for assessing nutritional status in children under five years of age [@who_underweight2024].

We now define the predictive targets for stunting and underweight prevalence based on the adopted geostatistical model. Since both stunting and prevalence are defined as $Y < -2$ where $Y(x)$ is either the HAZ or WAZ score of a child at a location $x$, prevalence is then formally defined as
$$
T(x) = P\left\{Y(x) < -1  \: \middle | S(x)\:   \right\} = \Phi\left\{-\frac{\mu + S(x) +  2}{\omega}\right\}
$$
where
```{r, eval=FALSE}
# Boundaries of Ghana
library(rgeoboundaries)
ghana <- geoboundaries(country = "Ghana", adm_lvl = "adm0")
ghana <- st_transform(ghana, st_crs(malnutrition_sf))

ghana_grid <- create_grid(ghana, spat_res = 10)

n_pred <- nrow(st_coordinates(ghana_grid))

# Prediction of S(x) and covariates effects over the grid for

# HAZ
haz_pred_grid <- pred_over_grid(haz_fit,
                                grid_pred = ghana_grid,
                                predictors = data.frame(
                                  # Setting age to 2 months
                                  age = rep(2, n_pred),
                                  # Setting wealth to 1 (least wealthy)
                                  wealth = rep(1, n_pred)
                                ))
# WAZ
waz_pred_grid <- pred_over_grid(waz_fit,
                                grid_pred = ghana_grid,
                                predictors = data.frame(
                                  # Setting age to 1 month
                                  age = rep(1, n_pred),
                                  # Setting wealth to 1 (least wealthy)
                                  wealth = rep(1, n_pred)
                                ))
```

```{r, eval=FALSE}
# Prediction of stunting prevalence
sd_ind_haz <- sqrt(coef(haz_fit)$sigma2_me)
stunting_prev <-
pred_target_grid(haz_pred_grid,
                 f_target = list(prev = function(x) pnorm((-2-x)/sd_ind_haz)),
                 pd_summary = list(mean = mean,
                                       cv = function(x) sd(x)/mean(x)))

# Prediction of underweight prevalence
sd_ind_waz <- sqrt(coef(waz_fit)$sigma2_me)
underw_prev <-
  pred_target_grid(waz_pred_grid,
                   f_target = list(prev = function(x) pnorm((-2-x)/sd_ind_waz)),
                   pd_summary = list(mean = mean,
                                     cv = function(x) sd(x)/mean(x)))
```

```{r}
#| label: fig-maln-pred
#| fig-cap: "Predictive mean and coefficient of variation for stunting and underweight prevalence estimates. The top row shows predictions for stunting, while the bottom row corresponds to underweight. For each indicator, the left panel shows the predictive mean and the right panel the coefficient of variation."
#| fig-width: 10
#| fig-height: 8

# Set up a 2x2 layout
layout(matrix(1:4, nrow = 2, byrow = TRUE))
par(mar = c(4, 4, 4, 5))  # Adjust margins

# Top row: stunting
plot(stunting_prev, which_target = "prev", which_summary = "mean",
     main = "Stunting: Predictive Mean")
plot(stunting_prev, which_target = "prev", which_summary = "cv",
     main = "Stunting: Coefficient of Variation")

# Bottom row: underweight
plot(underw_prev, which_target = "prev", which_summary = "mean",
     main = "Underweight: Predictive Mean")
plot(underw_prev, which_target = "prev", which_summary = "cv",
     main = "Underweight: Coefficient of Variation")
```

```{r, eval=FALSE}
# HAZ
assess_haz <-
assess_pp(list(HAZ = haz_fit),
          n_size = 100,
          min_dist = 5,
          iter = 10,
          method = "regularized")

# WAZ
assess_waz <-
  assess_pp(list(WAZ = waz_fit),
            n_size = 100,
            min_dist = 5,
            iter = 10,
            method = "regularized")

```

```{r}
#| label: fig-maln-anpit
#| fig-cap: "Assessment of predictive performance and calibration. The left panel shows the aggregated PIT histogram for HAZ, and the right panel for WAZ."
#| fig-subcap: ["PIT: HAZ", "PIT: WAZ"]
#| fig-width: 10
#| fig-height: 4

# Generate PIT plots
p_haz <- plot_AnPIT(assess_haz, mode = "all")
p_waz <- plot_AnPIT(assess_waz, mode = "all")

# Arrange side-by-side
library(gridExtra)
grid.arrange(p_haz, p_waz, ncol = 2)
```



## Mapping river blindness in Malawi

## Mapping mosquitoes abundance in Cameroon
