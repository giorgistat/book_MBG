# Model formulation and parameter estimation

## List of the main functions {.unnumbered}

| Function | R Package | Used for                                |
|----------|-----------|-----------------------------------------|
| `lmer`   | `lme4`    | Fitting linear mixed models             |
| `glmer`  | `lme4`    | Fitting generalized linear mixed models |
| `glgm`   | `RiskMap` | Fitting generalized linear mixed models |

# Exploratory analysis

As illustrated in @fig-stages, exploratory analysis is the first step that should be carried out in a statistical analysis. This stage is essential to inform how covariates should be introduced in the model and, in our case, whether the variation unexplained by those covariates exhibits spatial correlation.

In the exploratory analysis of count data, we will also look at how overdispersion, which is a necessary, though not sufficient, condition for residual spatial correlation.

## Exploring association with risk factors

Assessment of the association between the health outcome of interest and non-categorical (i.e. continuous) risk factors, can be carried through scatter plots. The graphical exploration of the empirical association between the outcome and the covariates is especially useful to identify non-linear patterns in the relationship which should then be accounted for in the model formulation.

Let us first consider the example of the riverblindess data in Liberia, and examine the association between prevalence and elevation. We first generate a plot of the prevalence against the measured elevation at each of the sample locations

```{r, echo=FALSE}
library(ggplot2)
load("data/liberia.rdata")

```

```{r, collapse=TRUE}
#| label: fig-prev-elev-liberia
#| fig-cap: "Scatter plot of the empirical prevalence for riverblindess against elevation, measured in meters."
liberia$logit <- liberia$npos/liberia$ntest

ggplot(liberia, aes(x = elevation, y = logit)) + geom_point() +
  labs(x="Elevation (meters)",y="Empirical logit")
```

The plot shown in @fig-prev-elev-liberia shows that, when elevation increases from 0 to around 100 meters, prevalence rapidly increases to around 0.25 and, for larger values in elevation, the relationship levels off. This begs the question of how we can account for this in a regression model. However, the plot in @fig-prev-elev-liberia cannot be used to inform this decision because, when modelling prevalence data, regression relationships are specified on the logit-transformed prevalence (log-odds) scale; see Section @sec-geostat-models . The approach we follow to explore relationships in the case of prevalence data is to the so called empirical logit, defined as

$$
e_{i} = \log\left\{\frac{y_i + 1/2}{n_i - y_i + 1/2}\right\}
$$ {#eq-empirical-logit}

where $y_i$ are the number of individuals who tested positive for riverblindness and $n_i$ is the total number of people tested at a location. The reason for using the empirical logit, rather than the standard logit transformation applied directly to the empirical prevalence, is that it allows to generate finite values for empirical prevalence values of 0 and 1, for which the standard logit function is not defined.

```{r, collapse=TRUE}
#| label: fig-elogit-elev-liberia
#| fig-cap: "Scatter plot of the empirical prevalence for riverblindess against elevation, measured in meters."

ggplot(liberia, aes(x = elevation, y = logit)) + geom_point() +
  labs(x="Elevation (meters)",y="Empirical logit") +
  stat_smooth(method = "gam", formula = y ~ s(x),se=FALSE)+
  stat_smooth(method = "lm", formula = y ~ x + I((x-150)*(x>150)),
              col="red",lty="dashed",se=FALSE) +
  stat_smooth(method = "lm", formula = y ~ log(x),
              col="green",lty="dashed",se=FALSE)
 

```

## Exploring overdispersion in count data

## Exploring residual spatial correlation

# Linear Gaussian model

# Generalized linear geostatistical models
